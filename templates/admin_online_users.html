{% extends "hub/base.html" %}

{% block title %}Online Users{% endblock %}

{% block content %}

<!-- Header -->
<div class="glass rounded-3xl p-8 md:p-12 mb-8" data-aos="fade-down">
    <div class="flex items-center justify-between mb-4">
        <div class="flex items-center gap-4">
            <div class="w-16 h-16 rounded-2xl bg-success/20 flex items-center justify-center">
                <i data-lucide="users" class="w-10 h-10 text-success"></i>
            </div>
            <div>
                <h1 class="text-3xl md:text-4xl font-bold text-white">Online Users</h1>
                <p class="text-white/70 mt-1">Aktuelle Benutzer-Aktivität · <span id="current-time">{{ current_time }}</span></p>
            </div>
        </div>
        <a href="{{ url_for('admin.admin_dashboard') }}" class="btn btn-ghost gap-2">
            <i data-lucide="arrow-left" class="w-5 h-5"></i>
            <span>Zurück</span>
        </a>
    </div>
</div>

<!-- Stats -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
    <div class="glass rounded-2xl p-6" data-aos="fade-up" data-aos-delay="100">
        <div class="flex items-center gap-3 mb-3">
            <i data-lucide="activity" class="w-6 h-6 text-success"></i>
            <h3 class="font-semibold text-white">Aktuell Online</h3>
        </div>
        <div class="text-4xl font-bold text-success" id="online-count">{{ online_users|length }}</div>
        <p class="text-white/60 text-sm mt-2">Aktive Sessions</p>
    </div>

    <div class="glass rounded-2xl p-6" data-aos="fade-up" data-aos-delay="200">
        <div class="flex items-center gap-3 mb-3">
            <i data-lucide="clock" class="w-6 h-6 text-primary"></i>
            <h3 class="font-semibold text-white">Timeout</h3>
        </div>
        <div class="text-4xl font-bold text-primary">15</div>
        <p class="text-white/60 text-sm mt-2">Minuten Inaktivität</p>
    </div>

    <div class="glass rounded-2xl p-6" data-aos="fade-up" data-aos-delay="300">
        <div class="flex items-center gap-3 mb-3">
            <i data-lucide="refresh-cw" class="w-6 h-6 text-info"></i>
            <h3 class="font-semibold text-white">Auto-Refresh</h3>
        </div>
        <div class="text-4xl font-bold text-info">30s</div>
        <p class="text-white/60 text-sm mt-2">Nächstes Update in <span id="countdown">30</span>s</p>
    </div>
</div>

<!-- Online Users List -->
<div class="glass rounded-3xl p-8" data-aos="fade-up" data-aos-delay="400">
    <div class="flex items-center justify-between mb-6">
        <h2 class="text-2xl font-bold text-white flex items-center gap-3">
            <i data-lucide="users" class="w-6 h-6 text-success"></i>
            Aktive Benutzer
        </h2>
        <button data-action="refreshOnlineUsers" class="btn btn-sm btn-ghost gap-2">
            <i data-lucide="refresh-cw" class="w-4 h-4"></i>
            Aktualisieren
        </button>
    </div>

    <div id="online-users-container">
        {% if online_users %}
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {% for user in online_users %}
            <div class="bg-white/5 rounded-xl p-4 hover:bg-white/10 transition-all" data-aos="zoom-in" data-aos-delay="{{ loop.index * 50 }}">
                <div class="flex items-center gap-3 mb-3">
                    <div class="avatar placeholder">
                        <div class="bg-success/20 text-success rounded-full w-12 h-12 flex items-center justify-center">
                            <i data-lucide="user" class="w-6 h-6"></i>
                        </div>
                    </div>
                    <div class="flex-1">
                        <div class="font-bold text-white">{{ user.username }}</div>
                        <div class="text-sm text-white/60">
                            {% if user.minutes_ago == 0 %}
                            Gerade aktiv
                            {% elif user.minutes_ago == 1 %}
                            Vor 1 Minute
                            {% else %}
                            Vor {{ user.minutes_ago }} Minuten
                            {% endif %}
                        </div>
                    </div>
                    <div class="badge badge-success badge-sm gap-1">
                        <span class="w-2 h-2 rounded-full bg-success animate-pulse"></span>
                        Online
                    </div>
                </div>
                <div class="text-xs text-white/50 flex items-center gap-2">
                    <i data-lucide="clock" class="w-3 h-3"></i>
                    {{ user.last_activity }}
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-12">
            <i data-lucide="users-x" class="w-16 h-16 text-white/30 mx-auto mb-4"></i>
            <p class="text-white/60 text-lg">Keine Benutzer online</p>
            <p class="text-white/40 text-sm mt-2">Sessions werden nach 15 Minuten Inaktivität als offline markiert</p>
        </div>
        {% endif %}
    </div>
</div>

<script nonce="{{ csp_nonce }}">
// Auto-refresh configuration
let countdown = 30;
let countdownInterval;
let refreshInterval;

// Countdown timer
function startCountdown() {
    countdownInterval = setInterval(() => {
        countdown--;
        document.getElementById('countdown').textContent = countdown;

        if (countdown <= 0) {
            countdown = 30;
        }
    }, 1000);
}

// Refresh online users from API (CSP-compliant wrapper)
window.refreshOnlineUsers = async function(e) {
    try {
        const response = await fetch('/admin/api/activity/online-users');
        const data = await response.json();

        if (data.success) {
            // Update count
            document.getElementById('online-count').textContent = data.count;

            // Update time
            const now = new Date();
            document.getElementById('current-time').textContent =
                now.toLocaleDateString('de-DE') + ' ' + now.toLocaleTimeString('de-DE', {hour: '2-digit', minute: '2-digit'});

            // Update user list
            const container = document.getElementById('online-users-container');

            if (data.online_users.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <i data-lucide="users-x" class="w-16 h-16 text-white/30 mx-auto mb-4"></i>
                        <p class="text-white/60 text-lg">Keine Benutzer online</p>
                        <p class="text-white/40 text-sm mt-2">Sessions werden nach 15 Minuten Inaktivität als offline markiert</p>
                    </div>
                `;
            } else {
                const usersHTML = data.online_users.map(user => `
                    <div class="bg-white/5 rounded-xl p-4 hover:bg-white/10 transition-all">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="avatar placeholder">
                                <div class="bg-success/20 text-success rounded-full w-12 h-12 flex items-center justify-center">
                                    <i data-lucide="user" class="w-6 h-6"></i>
                                </div>
                            </div>
                            <div class="flex-1">
                                <div class="font-bold text-white">${user.username}</div>
                                <div class="text-sm text-white/60">
                                    ${user.minutes_ago === 0 ? 'Gerade aktiv' :
                                      user.minutes_ago === 1 ? 'Vor 1 Minute' :
                                      `Vor ${user.minutes_ago} Minuten`}
                                </div>
                            </div>
                            <div class="badge badge-success badge-sm gap-1">
                                <span class="w-2 h-2 rounded-full bg-success animate-pulse"></span>
                                Online
                            </div>
                        </div>
                        <div class="text-xs text-white/50 flex items-center gap-2">
                            <i data-lucide="clock" class="w-3 h-3"></i>
                            ${user.last_activity}
                        </div>
                    </div>
                `).join('');

                container.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">${usersHTML}</div>`;
            }

            // Re-initialize Lucide icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }

            // Reset countdown
            countdown = 30;
        }
    } catch (error) {
        console.error('Fehler beim Aktualisieren der Online-Users:', error);
    }
};

// Start auto-refresh on page load
document.addEventListener('DOMContentLoaded', () => {
    // Start countdown
    startCountdown();

    // Auto-refresh every 30 seconds
    refreshInterval = setInterval(refreshOnlineUsers, 30000);

    // Stop refresh when page is hidden
    document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
            clearInterval(refreshInterval);
            clearInterval(countdownInterval);
        } else {
            startCountdown();
            refreshInterval = setInterval(refreshOnlineUsers, 30000);
        }
    });
});
</script>

{% endblock %}
