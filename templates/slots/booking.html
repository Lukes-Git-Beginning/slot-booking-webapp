{% extends "slots/base.html" %}

{% block title %}Termin buchen{% endblock %}

{% block header_title %}Neuen Termin buchen{% endblock %}
{% block header_subtitle %}Wähle deinen bevorzugten Berater und buche deinen Termin{% endblock %}

{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Main Booking Form Column (2/3) -->
    <div class="lg:col-span-2">
        <!-- Step 1: Berater Selection -->
        <div class="glass rounded-3xl p-8 mb-6" data-aos="fade-up">
            <h3 class="text-2xl font-bold text-white mb-6 flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl bg-primary/20 flex items-center justify-center">
                    <i data-lucide="user-check" class="w-6 h-6 text-primary"></i>
                </div>
                Schritt 1: Berater wählen
            </h3>

            <!-- Berater Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="berater-selection">
                <!-- Mock berater data -->
                {% set mock_berater = [
                    {"name": "Sara", "specialty": "Allgemeine Beratung", "rating": 4.8, "available": true},
                    {"name": "Marcus", "specialty": "Technische Beratung", "rating": 4.6, "available": true},
                    {"name": "Lisa", "specialty": "Sales-Coaching", "rating": 4.9, "available": false},
                    {"name": "Thomas", "specialty": "Prozessoptimierung", "rating": 4.7, "available": true}
                ] %}

                {% for berater in mock_berater %}
                <div class="relative bg-white/5 rounded-xl p-4 cursor-pointer transition-all hover:bg-white/10 hover:scale-[1.02] berater-card"
                     data-berater="{{ berater.name }}"
                     onclick="selectBerater(this, '{{ berater.name }}')">
                    <!-- Availability Indicator -->
                    <div class="absolute top-3 right-3">
                        {% if berater.available %}
                        <div class="w-3 h-3 rounded-full bg-success animate-pulse"></div>
                        {% else %}
                        <div class="w-3 h-3 rounded-full bg-warning"></div>
                        {% endif %}
                    </div>

                    <div class="flex items-center gap-3 mb-3">
                        <!-- Avatar -->
                        <div class="w-12 h-12 rounded-full bg-gradient-to-br from-primary to-secondary flex items-center justify-center font-bold text-white">
                            {{ berater.name[0] }}{% if berater.name|length > 1 %}{{ berater.name[1] }}{% endif %}
                        </div>

                        <div class="flex-1">
                            <h5 class="font-bold text-white">{{ berater.name }}</h5>
                            <div class="text-sm text-white/60">{{ berater.specialty }}</div>

                            <!-- Star Rating -->
                            <div class="flex items-center gap-1 mt-1">
                                {% for i in range((berater.rating)|int) %}
                                <i data-lucide="star" class="w-3 h-3 text-warning fill-warning"></i>
                                {% endfor %}
                                {% if berater.rating % 1 >= 0.5 %}
                                <i data-lucide="star-half" class="w-3 h-3 text-warning fill-warning"></i>
                                {% endif %}
                                {% for i in range(5 - (berater.rating|round)|int) %}
                                <i data-lucide="star" class="w-3 h-3 text-white/30"></i>
                                {% endfor %}
                                <span class="text-xs text-white/60 ml-1">({{ berater.rating }}/5)</span>
                            </div>
                        </div>
                    </div>

                    <div class="flex items-center gap-2 mt-3">
                        <div class="badge badge-primary badge-sm">60 Min Standard</div>
                        {% if berater.available %}
                        <div class="badge badge-success badge-sm gap-1">
                            <i data-lucide="check" class="w-3 h-3"></i>
                            Verfügbar
                        </div>
                        {% else %}
                        <div class="badge badge-warning badge-sm gap-1">
                            <i data-lucide="clock" class="w-3 h-3"></i>
                            Beschäftigt
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Step 2: Calendar Selection -->
        <div id="calendar-section" class="glass rounded-3xl p-8 mb-6 hidden" data-aos="fade-up" data-aos-delay="100">
            <h3 class="text-2xl font-bold text-white mb-6 flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl bg-success/20 flex items-center justify-center">
                    <i data-lucide="calendar" class="w-6 h-6 text-success"></i>
                </div>
                Schritt 2: Datum wählen
            </h3>

            <div class="bg-white/5 rounded-xl p-6">
                <!-- Calendar Header -->
                <div class="flex items-center justify-between mb-6">
                    <button class="btn btn-ghost btn-sm" onclick="navigateBookingCalendar('prev')">
                        <i data-lucide="chevron-left" class="w-5 h-5"></i>
                    </button>
                    <span id="booking-calendar-month-year" class="text-xl font-bold text-white"></span>
                    <button class="btn btn-ghost btn-sm" onclick="navigateBookingCalendar('next')">
                        <i data-lucide="chevron-right" class="w-5 h-5"></i>
                    </button>
                </div>

                <!-- Calendar Grid -->
                <div class="grid grid-cols-7 gap-2" id="booking-calendar-grid">
                    <!-- Calendar will be generated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Step 3: Time Selection -->
        <div id="time-section" class="glass rounded-3xl p-8 mb-6 hidden" data-aos="fade-up" data-aos-delay="200">
            <h3 class="text-2xl font-bold text-white mb-6 flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl bg-info/20 flex items-center justify-center">
                    <i data-lucide="clock" class="w-6 h-6 text-info"></i>
                </div>
                Schritt 3: Zeit wählen
            </h3>

            <div class="alert alert-info mb-6">
                <i data-lucide="info" class="w-5 h-5"></i>
                <span>Verfügbare Zeiten für <strong id="selected-date-display"></strong></span>
            </div>

            <div id="available-times" class="grid grid-cols-2 md:grid-cols-4 gap-3">
                <!-- Time slots will be loaded via JavaScript -->
            </div>
        </div>

        <!-- Step 4: Booking Details -->
        <div id="details-section" class="glass rounded-3xl p-8 mb-6 hidden" data-aos="fade-up" data-aos-delay="300">
            <h3 class="text-2xl font-bold text-white mb-6 flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl bg-warning/20 flex items-center justify-center">
                    <i data-lucide="edit" class="w-6 h-6 text-warning"></i>
                </div>
                Schritt 4: Details angeben
            </h3>

            <form id="booking-form" onsubmit="submitSlotBooking(event)">
                <input type="hidden" id="selected-berater" name="berater">
                <input type="hidden" id="selected-date" name="date">
                <input type="hidden" id="selected-time" name="time">

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <!-- Duration -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text text-white">Dauer</span>
                        </label>
                        <select class="select select-bordered bg-white/10 border-white/20 text-white" name="duration">
                            <option value="60">60 Minuten (Standard)</option>
                            <option value="90">90 Minuten (Erweitert)</option>
                            <option value="120">120 Minuten (Intensiv)</option>
                        </select>
                    </div>

                    <!-- Urgency -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text text-white">Dringlichkeit</span>
                        </label>
                        <select class="select select-bordered bg-white/10 border-white/20 text-white" name="urgency">
                            <option value="normal">Normal</option>
                            <option value="high">Hoch</option>
                            <option value="urgent">Dringend</option>
                        </select>
                    </div>
                </div>

                <!-- Topic -->
                <div class="form-control mb-4">
                    <label class="label">
                        <span class="label-text text-white">Thema/Grund des Termins</span>
                    </label>
                    <input type="text" class="input input-bordered bg-white/10 border-white/20 text-white placeholder:text-white/40"
                           name="topic" placeholder="z.B. Beratung zu Verkaufsstrategie, Problemlösung, etc.">
                </div>

                <!-- Notes -->
                <div class="form-control mb-4">
                    <label class="label">
                        <span class="label-text text-white">Zusätzliche Notizen</span>
                    </label>
                    <textarea class="textarea textarea-bordered bg-white/10 border-white/20 text-white placeholder:text-white/40"
                              name="notes" rows="3"
                              placeholder="Spezifische Fragen oder Vorbereitungen für den Termin..."></textarea>
                </div>

                <!-- Confirmation Checkbox -->
                <div class="form-control mb-6">
                    <label class="label cursor-pointer justify-start gap-3">
                        <input type="checkbox" class="checkbox checkbox-primary" id="confirm-booking" required>
                        <span class="label-text text-white">
                            Ich bestätige die Buchungsdetails und bin zum gewählten Zeitpunkt verfügbar
                        </span>
                    </label>
                </div>

                <!-- Submit Button -->
                <button type="submit" id="slot-book-button" class="btn btn-primary btn-lg w-full gap-2" disabled>
                    <i data-lucide="calendar-check" class="w-5 h-5"></i>
                    Termin buchen
                </button>
            </form>
        </div>
    </div>

    <!-- Sidebar (1/3) -->
    <div class="lg:col-span-1">
        <!-- Booking Summary -->
        <div class="glass rounded-2xl p-6 mb-6" data-aos="fade-up" data-aos-delay="400">
            <h5 class="font-bold text-white mb-4 flex items-center gap-2">
                <i data-lucide="clipboard-list" class="w-5 h-5 text-primary"></i>
                Buchungsübersicht
            </h5>

            <div id="booking-summary">
                <div class="text-white/60 text-center py-6">
                    <i data-lucide="arrow-left" class="w-8 h-8 mx-auto mb-2"></i>
                    <p class="text-sm">Wähle einen Berater um zu beginnen</p>
                </div>
            </div>

            <div id="booking-summary-content" class="hidden space-y-3">
                <div class="flex justify-between items-center py-2 border-b border-white/10">
                    <span class="text-white/70">Berater:</span>
                    <span class="font-semibold text-white" id="summary-berater">-</span>
                </div>
                <div class="flex justify-between items-center py-2 border-b border-white/10">
                    <span class="text-white/70">Datum:</span>
                    <span class="font-semibold text-white" id="summary-date">-</span>
                </div>
                <div class="flex justify-between items-center py-2 border-b border-white/10">
                    <span class="text-white/70">Zeit:</span>
                    <span class="font-semibold text-white" id="summary-time">-</span>
                </div>
                <div class="flex justify-between items-center py-2 border-b border-white/10">
                    <span class="text-white/70">Dauer:</span>
                    <span class="font-semibold text-white" id="summary-duration">60 Minuten</span>
                </div>
                <div class="flex justify-between items-center py-2">
                    <span class="text-white/70">Thema:</span>
                    <span class="font-semibold text-white" id="summary-topic">-</span>
                </div>
            </div>
        </div>

        <!-- Booking Tips -->
        <div class="glass rounded-2xl p-6 mb-6" data-aos="fade-up" data-aos-delay="500">
            <h5 class="font-bold text-white mb-4 flex items-center gap-2">
                <i data-lucide="lightbulb" class="w-5 h-5 text-warning"></i>
                Tipps für deinen Termin
            </h5>
            <ul class="space-y-2">
                <li class="flex items-start gap-2 text-white/80">
                    <i data-lucide="check-circle" class="w-4 h-4 text-success mt-1 flex-shrink-0"></i>
                    <span class="text-sm">Bereite spezifische Fragen vor</span>
                </li>
                <li class="flex items-start gap-2 text-white/80">
                    <i data-lucide="check-circle" class="w-4 h-4 text-success mt-1 flex-shrink-0"></i>
                    <span class="text-sm">Halte relevante Unterlagen bereit</span>
                </li>
                <li class="flex items-start gap-2 text-white/80">
                    <i data-lucide="check-circle" class="w-4 h-4 text-success mt-1 flex-shrink-0"></i>
                    <span class="text-sm">Sorge für eine ruhige Umgebung</span>
                </li>
                <li class="flex items-start gap-2 text-white/80">
                    <i data-lucide="check-circle" class="w-4 h-4 text-success mt-1 flex-shrink-0"></i>
                    <span class="text-sm">Notiere dir wichtige Punkte</span>
                </li>
                <li class="flex items-start gap-2 text-white/80">
                    <i data-lucide="check-circle" class="w-4 h-4 text-success mt-1 flex-shrink-0"></i>
                    <span class="text-sm">Sei pünktlich zum Termin</span>
                </li>
            </ul>
        </div>

        <!-- Popular Times -->
        <div class="glass rounded-2xl p-6 mb-6" data-aos="fade-up" data-aos-delay="600">
            <h5 class="font-bold text-white mb-4 flex items-center gap-2">
                <i data-lucide="trending-up" class="w-5 h-5 text-info"></i>
                Beliebte Zeiten
            </h5>
            <div class="space-y-4">
                <div>
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-sm font-medium text-white">09:00 - 11:00</span>
                        <span class="text-xs text-white/60">Sehr beliebt</span>
                    </div>
                    <div class="w-full h-2 bg-white/10 rounded-full overflow-hidden">
                        <div class="h-full bg-gradient-to-r from-primary to-secondary rounded-full" style="width: 80%"></div>
                    </div>
                </div>
                <div>
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-sm font-medium text-white">14:00 - 16:00</span>
                        <span class="text-xs text-white/60">Am beliebtesten</span>
                    </div>
                    <div class="w-full h-2 bg-white/10 rounded-full overflow-hidden">
                        <div class="h-full bg-gradient-to-r from-primary to-secondary rounded-full" style="width: 95%"></div>
                    </div>
                </div>
                <div>
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-sm font-medium text-white">16:00 - 18:00</span>
                        <span class="text-xs text-white/60">Verfügbar</span>
                    </div>
                    <div class="w-full h-2 bg-white/10 rounded-full overflow-hidden">
                        <div class="h-full bg-gradient-to-r from-primary to-secondary rounded-full" style="width: 60%"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Support -->
        <div class="glass rounded-2xl p-6" data-aos="fade-up" data-aos-delay="700">
            <h5 class="font-bold text-white mb-3 flex items-center gap-2">
                <i data-lucide="headphones" class="w-5 h-5 text-success"></i>
                Brauchen Sie Hilfe?
            </h5>
            <p class="text-sm text-white/70 mb-4">
                Bei Fragen zur Buchung oder terminlichen Problemen:
            </p>
            <a href="mailto:support@business-hub.de" class="btn btn-outline btn-primary btn-sm w-full gap-2">
                <i data-lucide="mail" class="w-4 h-4"></i>
                Support kontaktieren
            </a>
        </div>
    </div>
</div>

<!-- Success Modal -->
<dialog id="slotSuccessModal" class="modal">
    <div class="modal-box max-w-md glass">
        <div class="flex items-center gap-3 mb-6">
            <div class="w-12 h-12 rounded-full bg-success/20 flex items-center justify-center">
                <i data-lucide="check-circle" class="w-8 h-8 text-success"></i>
            </div>
            <h3 class="text-2xl font-bold text-white">Buchung erfolgreich!</h3>
        </div>

        <div class="text-center mb-6">
            <div class="mb-4">
                <i data-lucide="calendar-check" class="w-16 h-16 text-success mx-auto"></i>
            </div>
            <h4 class="text-xl font-bold text-white mb-2">Dein Termin ist gebucht!</h4>
            <p class="text-white/70">Du erhältst eine Bestätigung per E-Mail mit allen Details.</p>
        </div>

        <div class="alert alert-info mb-6">
            <i data-lucide="info" class="w-5 h-5"></i>
            <div class="text-left">
                <div class="font-semibold">Buchungs-ID: <span id="modal-booking-id">-</span></div>
                <div>Berater: <span id="modal-berater">-</span></div>
                <div>Termin: <span id="modal-datetime">-</span></div>
            </div>
        </div>

        <div class="flex gap-3">
            <button class="btn btn-ghost flex-1" onclick="window.location.href='{{ url_for('slots.index') }}'">
                Zum Slot-Dashboard
            </button>
            <button class="btn btn-primary flex-1" onclick="window.location.href='{{ url_for('hub.dashboard') }}'">
                Zum Hub
            </button>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>
{% endblock %}

{% block extra_js %}
<script nonce="{{ csp_nonce }}">
// Booking process state
let slotBookingState = {
    berater: null,
    date: null,
    time: null,
    step: 1
};

// Calendar functionality for booking
let bookingCurrentDate = new Date();

function selectBerater(element, beraterName) {
    // Remove previous selection
    document.querySelectorAll('.berater-card').forEach(card => {
        card.classList.remove('ring-2', 'ring-primary', 'bg-primary/20');
    });

    // Select current card
    element.classList.add('ring-2', 'ring-primary', 'bg-primary/20');

    // Update state
    slotBookingState.berater = beraterName;
    slotBookingState.step = 2;

    // Show calendar section
    const calendarSection = document.getElementById('calendar-section');
    calendarSection.classList.remove('hidden');
    calendarSection.scrollIntoView({ behavior: 'smooth', block: 'start' });

    // Update summary
    updateSlotBookingSummary();

    // Generate calendar
    generateBookingCalendar();

    // Re-initialize icons
    lucide.createIcons();
}

function generateBookingCalendar() {
    const calendarGrid = document.getElementById('booking-calendar-grid');
    const monthYear = document.getElementById('booking-calendar-month-year');

    const year = bookingCurrentDate.getFullYear();
    const month = bookingCurrentDate.getMonth();

    monthYear.textContent = bookingCurrentDate.toLocaleDateString('de-DE', { month: 'long', year: 'numeric' });

    // Clear calendar
    calendarGrid.innerHTML = '';

    // Add weekday headers
    const weekdays = ['Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa', 'So'];
    weekdays.forEach(day => {
        const dayHeader = document.createElement('div');
        dayHeader.className = 'text-center text-xs font-bold text-white/60 py-2';
        dayHeader.textContent = day;
        calendarGrid.appendChild(dayHeader);
    });

    // Get first day of month and number of days
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const daysInMonth = lastDay.getDate();

    // Get start day (Monday = 0)
    let startDay = firstDay.getDay() - 1;
    if (startDay === -1) startDay = 6;

    // Add empty cells for days before month starts
    for (let i = 0; i < startDay; i++) {
        const emptyDay = document.createElement('div');
        emptyDay.className = 'aspect-square';
        calendarGrid.appendChild(emptyDay);
    }

    // Add days of the month
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    for (let day = 1; day <= daysInMonth; day++) {
        const dayElement = document.createElement('div');
        const currentDay = new Date(year, month, day);
        currentDay.setHours(0, 0, 0, 0);

        dayElement.className = 'aspect-square flex items-center justify-center rounded-lg text-sm font-medium transition-all';
        dayElement.textContent = day;
        dayElement.dataset.date = currentDay.toISOString().split('T')[0];

        // Disable past dates
        if (currentDay < today) {
            dayElement.className += ' text-white/30 cursor-not-allowed';
        } else {
            dayElement.className += ' text-white bg-white/5 hover:bg-primary/20 cursor-pointer';
            dayElement.onclick = () => selectBookingDate(dayElement, dayElement.dataset.date);
        }

        calendarGrid.appendChild(dayElement);
    }

    // Re-initialize icons
    lucide.createIcons();
}

function navigateBookingCalendar(direction) {
    if (direction === 'prev') {
        bookingCurrentDate.setMonth(bookingCurrentDate.getMonth() - 1);
    } else {
        bookingCurrentDate.setMonth(bookingCurrentDate.getMonth() + 1);
    }
    generateBookingCalendar();
}

function selectBookingDate(element, dateStr) {
    if (element.classList.contains('cursor-not-allowed')) return;

    // Remove previous selection
    document.querySelectorAll('#booking-calendar-grid > div').forEach(day => {
        day.classList.remove('bg-primary', 'ring-2', 'ring-primary');
    });

    // Select current day
    element.classList.add('bg-primary', 'ring-2', 'ring-primary');

    // Update state
    slotBookingState.date = dateStr;
    slotBookingState.step = 3;

    // Show time section
    const timeSection = document.getElementById('time-section');
    timeSection.classList.remove('hidden');
    document.getElementById('selected-date-display').textContent = new Date(dateStr).toLocaleDateString('de-DE');

    // Load available times
    loadAvailableTimesForBooking(dateStr);

    // Update summary
    updateSlotBookingSummary();

    // Scroll to time section
    setTimeout(() => {
        timeSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 100);

    // Re-initialize icons
    lucide.createIcons();
}

function loadAvailableTimesForBooking(dateStr) {
    const timesContainer = document.getElementById('available-times');
    timesContainer.innerHTML = '<div class="col-span-full text-center text-white/60"><i data-lucide="loader" class="w-6 h-6 animate-spin mx-auto"></i></div>';
    lucide.createIcons();

    // Simulate API call to get available times
    setTimeout(() => {
        const availableTimes = [
            { time: '09:00', available: true, duration: 60 },
            { time: '10:30', available: true, duration: 60 },
            { time: '13:00', available: false, duration: 60 },
            { time: '14:30', available: true, duration: 60 },
            { time: '16:00', available: true, duration: 60 }
        ];

        let timesHtml = '';
        availableTimes.forEach(slot => {
            const isAvailable = slot.available;
            const bgClass = isAvailable ? 'bg-white/5 hover:bg-success/20 cursor-pointer' : 'bg-white/5 opacity-50 cursor-not-allowed';
            const onclick = isAvailable ? `selectBookingTime(this, '${slot.time}')` : '';

            timesHtml += `
                <div class="time-slot p-4 rounded-xl ${bgClass} transition-all text-center" ${onclick ? `onclick="${onclick}"` : ''}>
                    <div class="text-lg font-bold text-white">${slot.time}</div>
                    <div class="text-xs text-white/60">${slot.duration} Min</div>
                    ${!isAvailable ? '<div class="badge badge-error badge-xs mt-2">Belegt</div>' : ''}
                </div>
            `;
        });

        timesContainer.innerHTML = timesHtml;
        lucide.createIcons();
    }, 800);
}

function selectBookingTime(element, timeStr) {
    // Remove previous selection
    document.querySelectorAll('.time-slot').forEach(slot => {
        slot.classList.remove('ring-2', 'ring-success', 'bg-success/20');
    });

    // Select current time
    element.classList.add('ring-2', 'ring-success', 'bg-success/20');

    // Update state
    slotBookingState.time = timeStr;
    slotBookingState.step = 4;

    // Show details section
    const detailsSection = document.getElementById('details-section');
    detailsSection.classList.remove('hidden');

    // Update form hidden fields
    document.getElementById('selected-berater').value = slotBookingState.berater;
    document.getElementById('selected-date').value = slotBookingState.date;
    document.getElementById('selected-time').value = slotBookingState.time;

    // Update summary
    updateSlotBookingSummary();

    // Scroll to details section
    setTimeout(() => {
        detailsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 100);

    // Re-initialize icons
    lucide.createIcons();
}

function updateSlotBookingSummary() {
    const summaryContainer = document.getElementById('booking-summary');
    const summaryContent = document.getElementById('booking-summary-content');

    if (slotBookingState.berater) {
        summaryContainer.classList.add('hidden');
        summaryContent.classList.remove('hidden');

        document.getElementById('summary-berater').textContent = slotBookingState.berater;

        if (slotBookingState.date) {
            document.getElementById('summary-date').textContent = new Date(slotBookingState.date).toLocaleDateString('de-DE');
        }

        if (slotBookingState.time) {
            document.getElementById('summary-time').textContent = slotBookingState.time;
        }
    }

    // Re-initialize icons
    lucide.createIcons();
}

function submitSlotBooking(event) {
    event.preventDefault();

    const form = document.getElementById('booking-form');
    const formData = new FormData(form);
    const bookButton = document.getElementById('slot-book-button');

    // Disable button
    bookButton.disabled = true;
    bookButton.innerHTML = '<i data-lucide="loader" class="w-5 h-5 animate-spin"></i><span>Buche...</span>';
    lucide.createIcons();

    // Get form data
    const bookingData = {
        berater: formData.get('berater'),
        date: formData.get('date'),
        time: formData.get('time'),
        duration: formData.get('duration'),
        urgency: formData.get('urgency'),
        topic: formData.get('topic'),
        notes: formData.get('notes')
    };

    // Update summary with additional details
    document.getElementById('summary-duration').textContent = formData.get('duration') + ' Minuten';
    document.getElementById('summary-topic').textContent = formData.get('topic') || 'Allgemeine Beratung';

    // Simulate booking API call
    fetch('/slots/book', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify(bookingData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update modal with booking details
            document.getElementById('modal-booking-id').textContent = data.booking_id || 'SB-' + Math.random().toString(36).substr(2, 8).toUpperCase();
            document.getElementById('modal-berater').textContent = bookingData.berater;
            document.getElementById('modal-datetime').textContent = `${new Date(bookingData.date).toLocaleDateString('de-DE')} um ${bookingData.time}`;

            // Show success modal
            document.getElementById('slotSuccessModal').showModal();
            lucide.createIcons();
        } else {
            alert('Fehler: ' + (data.error || 'Unbekannter Fehler beim Buchen'));
        }
    })
    .catch(error => {
        console.error('Booking error:', error);
        alert('Unerwarteter Fehler beim Buchen');
    })
    .finally(() => {
        // Reset button
        bookButton.disabled = false;
        bookButton.innerHTML = '<i data-lucide="calendar-check" class="w-5 h-5"></i><span>Termin buchen</span>';
        lucide.createIcons();
    });
}

// Form validation
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('booking-form');
    const bookButton = document.getElementById('slot-book-button');

    if (form) {
        form.addEventListener('input', function() {
            const confirmBooking = form.querySelector('#confirm-booking').checked;
            bookButton.disabled = !confirmBooking;
        });

        // Duration change handler
        const durationSelect = form.querySelector('[name="duration"]');
        durationSelect.addEventListener('change', function() {
            document.getElementById('summary-duration').textContent = this.value + ' Minuten';
        });

        // Topic change handler
        const topicInput = form.querySelector('[name="topic"]');
        topicInput.addEventListener('input', function() {
            document.getElementById('summary-topic').textContent = this.value || 'Allgemeine Beratung';
        });
    }

    // Re-initialize icons after Alpine loads
    setTimeout(() => lucide.createIcons(), 200);
});
</script>
{% endblock %}
