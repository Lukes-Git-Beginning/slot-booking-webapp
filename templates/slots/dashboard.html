{% extends "slots/base.html" %}

{% block title %}Slot-Booking Dashboard - Business Tool Hub{% endblock %}

{% block header_title %}Slot-Booking System{% endblock %}
{% block header_subtitle %}Buche deine Termine mit unseren erfahrenen Beratern und verwalte deine Buchungen{% endblock %}

{% block content %}
<!-- Quick Action Buttons -->
<div class="flex flex-wrap gap-3 mb-8" data-aos="fade-up">
    <a href="{{ url_for('slots.day_view', date_str=current_date.strftime('%Y-%m-%d')) }}"
       class="btn btn-ghost gap-2">
        <i data-lucide="calendar-days" class="w-5 h-5"></i>
        <span>Heute</span>
    </a>
    <a href="{{ url_for('slots.booking_page') }}"
       class="btn btn-primary gap-2">
        <i data-lucide="plus-circle" class="w-5 h-5"></i>
        <span>Neuer Termin</span>
    </a>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Main Content -->
    <div class="lg:col-span-2 space-y-6">
        <!-- Quick Stats -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4" data-aos="fade-up" data-aos-delay="100">
            <div class="glass rounded-2xl p-4 text-center">
                <div class="text-3xl font-bold text-primary mb-1">{{ stats.total_bookings }}</div>
                <div class="text-xs text-white/60">Gesamt-Buchungen</div>
            </div>
            <div class="glass rounded-2xl p-4 text-center">
                <div class="text-3xl font-bold text-success mb-1">{{ stats.this_week }}</div>
                <div class="text-xs text-white/60">Diese Woche</div>
            </div>
            <div class="glass rounded-2xl p-4 text-center">
                <div class="text-3xl font-bold text-warning mb-1">{{ stats.success_rate }}%</div>
                <div class="text-xs text-white/60">Erfolgsrate</div>
            </div>
            <div class="glass rounded-2xl p-4 text-center">
                <div class="text-3xl font-bold text-info mb-1">{{ available_today|length }}</div>
                <div class="text-xs text-white/60">Verfügbar heute</div>
            </div>
        </div>

        <!-- Nächster Termin -->
        {% if stats.next_appointment %}
        <div class="glass rounded-2xl p-6" data-aos="fade-up" data-aos-delay="200">
            <div class="flex items-center gap-3 mb-4">
                <div class="w-10 h-10 rounded-lg bg-primary/20 flex items-center justify-center">
                    <i data-lucide="clock" class="w-5 h-5 text-primary"></i>
                </div>
                <h3 class="text-xl font-bold text-white">Nächster Termin</h3>
            </div>
            <p class="text-white/80 mb-3">
                <strong>{{ stats.next_appointment.date }}</strong> um <strong>{{ stats.next_appointment.time }}</strong>
                mit <strong>{{ stats.next_appointment.berater }}</strong>
            </p>
            <a href="{{ url_for('slots.day_view', date_str=stats.next_appointment.date) }}"
               class="btn btn-sm btn-primary gap-2">
                <i data-lucide="eye" class="w-4 h-4"></i>
                <span>Details anzeigen</span>
            </a>
        </div>
        {% endif %}

        <!-- Verfügbare Berater heute -->
        <div class="glass rounded-2xl p-6" data-aos="fade-up" data-aos-delay="300">
            <div class="flex items-center gap-3 mb-6">
                <div class="w-10 h-10 rounded-lg bg-success/20 flex items-center justify-center">
                    <i data-lucide="users" class="w-5 h-5 text-success"></i>
                </div>
                <h3 class="text-xl font-bold text-white">Verfügbare Berater heute</h3>
            </div>

            {% if available_today %}
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                {% for berater_name, slots in available_today.items() %}
                <div class="glass rounded-xl p-4 hover:bg-white/10 transition-all">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-full bg-gradient-to-br from-primary to-secondary flex items-center justify-center font-bold text-white">
                            {{ berater_name[0] }}{{ berater_name[1] if berater_name|length > 1 else '' }}
                        </div>
                        <div class="flex-1">
                            <h5 class="font-bold text-white">{{ berater_name }}</h5>
                            <div class="text-sm text-white/60">Termin-Beratung</div>
                            {% if slots > 0 %}
                            <div class="badge badge-success badge-sm mt-1">{{ slots }} Slots verfügbar</div>
                            {% else %}
                            <div class="badge badge-warning badge-sm mt-1">Ausgebucht</div>
                            {% endif %}
                        </div>
                        <div>
                            {% if slots > 0 %}
                            <a href="{{ url_for('slots.day_view', date_str=current_date.strftime('%Y-%m-%d')) }}#berater-{{ berater_name }}"
                               class="btn btn-sm btn-primary">
                                Buchen
                            </a>
                            {% else %}
                            <button class="btn btn-sm btn-ghost" disabled>
                                Ausgebucht
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-8 text-white/60">
                <i data-lucide="calendar-x" class="w-16 h-16 mx-auto mb-4"></i>
                <h5 class="text-lg font-semibold text-white mb-2">Heute keine Berater verfügbar</h5>
                <p class="mb-4">Schaue dir die Verfügbarkeit für andere Tage an.</p>
                <a href="{{ url_for('slots.calendar_view') }}" class="btn btn-primary gap-2">
                    <i data-lucide="calendar" class="w-4 h-4"></i>
                    <span>Kalender öffnen</span>
                </a>
            </div>
            {% endif %}
        </div>

        <!-- Letzte Buchungen -->
        <div class="glass rounded-2xl p-6" data-aos="fade-up" data-aos-delay="400">
            <div class="flex items-center gap-3 mb-6">
                <div class="w-10 h-10 rounded-lg bg-info/20 flex items-center justify-center">
                    <i data-lucide="history" class="w-5 h-5 text-info"></i>
                </div>
                <h3 class="text-xl font-bold text-white">Letzte Buchungen</h3>
            </div>

            {% if recent_bookings %}
            <div class="overflow-x-auto">
                <table class="table w-full">
                    <thead>
                        <tr>
                            <th class="text-white">Datum</th>
                            <th class="text-white">Zeit</th>
                            <th class="text-white">Berater</th>
                            <th class="text-white">Status</th>
                            <th class="text-white">Aktionen</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for booking in recent_bookings %}
                        <tr class="hover:bg-white/5">
                            <td class="text-white/80">{{ booking.date }}</td>
                            <td class="text-white/80">{{ booking.time }}</td>
                            <td class="text-white/80">{{ booking.berater }}</td>
                            <td>
                                <div class="badge badge-{% if booking.status == 'confirmed' %}success{% elif booking.status == 'pending' %}warning{% else %}ghost{% endif %}">
                                    {{ booking.status|title }}
                                </div>
                            </td>
                            <td>
                                <a href="{{ url_for('slots.day_view', date_str=booking.date) }}"
                                   class="btn btn-sm btn-ghost gap-1">
                                    <i data-lucide="eye" class="w-3 h-3"></i>
                                    <span>Details</span>
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-8 text-white/60">
                <i data-lucide="calendar-plus" class="w-12 h-12 mx-auto mb-3"></i>
                <h6 class="font-semibold text-white mb-2">Noch keine Buchungen</h6>
                <p class="mb-4">Buche deinen ersten Termin!</p>
                <a href="{{ url_for('slots.booking_page') }}" class="btn btn-primary gap-2">
                    <i data-lucide="calendar-check" class="w-4 h-4"></i>
                    <span>Termin buchen</span>
                </a>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Sidebar -->
    <div class="space-y-6">
        <!-- Gamification Widget -->
        {% if gamification %}
        <div class="glass rounded-2xl p-6" data-aos="fade-up" data-aos-delay="200">
            <div class="flex items-center gap-3 mb-4">
                <div class="w-10 h-10 rounded-lg bg-warning/20 flex items-center justify-center">
                    <i data-lucide="trophy" class="w-5 h-5 text-warning"></i>
                </div>
                <h5 class="font-bold text-white">Dein Fortschritt</h5>
            </div>

            <div class="text-center mb-4">
                <div class="text-5xl font-bold text-warning mb-1">{{ gamification.level }}</div>
                <div class="text-sm text-white/60">Level</div>
            </div>

            <div class="grid grid-cols-3 gap-4 mb-4 text-center">
                <div>
                    <div class="font-bold text-white">{{ gamification.xp }}</div>
                    <div class="text-xs text-white/60">XP</div>
                </div>
                <div>
                    <div class="font-bold text-white">{{ gamification.badges|length }}</div>
                    <div class="text-xs text-white/60">Badges</div>
                </div>
                <div>
                    <div class="font-bold text-white">{{ stats.this_week }}</div>
                    <div class="text-xs text-white/60">Diese Woche</div>
                </div>
            </div>

            <div class="w-full bg-white/10 rounded-full h-2 mb-2">
                <div class="bg-gradient-to-r from-warning to-primary h-2 rounded-full transition-all"
                     style="width: {{ (gamification.xp / gamification.xp_next_level * 100)|round }}%"></div>
            </div>

            <div class="text-center text-xs text-white/70 mb-4">
                {{ gamification.xp }} / {{ gamification.xp_next_level }} XP bis Level {{ gamification.level + 1 }}
            </div>

            {% if gamification.recent_achievements %}
            <div class="mb-4">
                <h6 class="text-white/80 text-sm mb-2">Neue Achievements</h6>
                <div class="space-y-1">
                    {% for achievement in gamification.recent_achievements[:3] %}
                    <div class="badge badge-ghost w-full justify-start gap-2">
                        <span>{{ achievement.icon }}</span>
                        <span>{{ achievement.name }}</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <a href="{{ url_for('slots.gamification') }}" class="btn btn-sm btn-ghost w-full gap-2">
                <i data-lucide="award" class="w-4 h-4"></i>
                <span>Alle Achievements</span>
            </a>
        </div>
        {% endif %}

        <!-- Quick Actions -->
        <div class="glass rounded-2xl p-6" data-aos="fade-up" data-aos-delay="300">
            <div class="flex items-center gap-3 mb-4">
                <div class="w-10 h-10 rounded-lg bg-primary/20 flex items-center justify-center">
                    <i data-lucide="zap" class="w-5 h-5 text-primary"></i>
                </div>
                <h5 class="font-bold text-white">Schnellzugriff</h5>
            </div>

            <div class="space-y-2">
                <a href="{{ url_for('slots.booking_page') }}" class="btn btn-primary w-full gap-2 justify-start">
                    <i data-lucide="plus-circle" class="w-4 h-4"></i>
                    <span>Neuen Termin buchen</span>
                </a>
                <a href="{{ url_for('slots.day_view', date_str=current_date.strftime('%Y-%m-%d')) }}"
                   class="btn btn-ghost w-full gap-2 justify-start">
                    <i data-lucide="calendar-days" class="w-4 h-4"></i>
                    <span>Heutiger Tag</span>
                </a>
                <a href="{{ url_for('slots.calendar_view') }}"
                   class="btn btn-ghost w-full gap-2 justify-start">
                    <i data-lucide="calendar" class="w-4 h-4"></i>
                    <span>Kalender-Ansicht</span>
                </a>
                <a href="{{ url_for('slots.profile') }}"
                   class="btn btn-ghost w-full gap-2 justify-start">
                    <i data-lucide="user" class="w-4 h-4"></i>
                    <span>Mein Profil</span>
                </a>
            </div>
        </div>

        <!-- Mini-Kalender -->
        <div class="glass rounded-2xl p-6" data-aos="fade-up" data-aos-delay="400">
            <div class="flex items-center gap-3 mb-4">
                <div class="w-10 h-10 rounded-lg bg-secondary/20 flex items-center justify-center">
                    <i data-lucide="calendar" class="w-5 h-5 text-secondary"></i>
                </div>
                <h5 class="font-bold text-white">Mini-Kalender</h5>
            </div>

            <div class="calendar-widget">
                <div class="flex items-center justify-between mb-3">
                    <button class="btn btn-sm btn-ghost" onclick="navigateCalendar('prev')">
                        <i data-lucide="chevron-left" class="w-4 h-4"></i>
                    </button>
                    <span id="mini-calendar-month-year" class="font-semibold text-white">{{ current_date.strftime('%B %Y') }}</span>
                    <button class="btn btn-sm btn-ghost" onclick="navigateCalendar('next')">
                        <i data-lucide="chevron-right" class="w-4 h-4"></i>
                    </button>
                </div>
                <div id="mini-calendar-grid"></div>
            </div>
        </div>

        <!-- Help & Support -->
        <div class="glass rounded-2xl p-6" data-aos="fade-up" data-aos-delay="500">
            <div class="flex items-center gap-3 mb-4">
                <div class="w-10 h-10 rounded-lg bg-info/20 flex items-center justify-center">
                    <i data-lucide="help-circle" class="w-5 h-5 text-info"></i>
                </div>
                <h5 class="font-bold text-white">Hilfe & Support</h5>
            </div>

            <div class="mb-4">
                <h6 class="font-semibold text-white/80 mb-2">Häufige Fragen</h6>
                <ul class="space-y-1 text-sm text-white/70">
                    <li><a href="#" class="hover:text-primary transition-colors">Wie buche ich einen Termin?</a></li>
                    <li><a href="#" class="hover:text-primary transition-colors">Kann ich Termine ändern?</a></li>
                    <li><a href="#" class="hover:text-primary transition-colors">Was ist das Gamification-System?</a></li>
                </ul>
            </div>

            <a href="mailto:support@business-hub.de" class="btn btn-sm btn-ghost w-full gap-2">
                <i data-lucide="mail" class="w-4 h-4"></i>
                <span>Support kontaktieren</span>
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ super() }}
<script>
// Mini-Kalender
let currentDate = new Date('{{ current_date.strftime('%Y-%m-%d') }}');

function generateMiniCalendar() {
    const calendarGrid = document.getElementById('mini-calendar-grid');
    if (!calendarGrid) return;

    const monthYear = document.getElementById('mini-calendar-month-year');
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();

    monthYear.textContent = currentDate.toLocaleDateString('de-DE', { month: 'long', year: 'numeric' });

    // Clear calendar
    calendarGrid.innerHTML = '';
    calendarGrid.className = 'grid grid-cols-7 gap-1';

    // Add weekday headers
    const weekdays = ['Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa', 'So'];
    weekdays.forEach(day => {
        const dayHeader = document.createElement('div');
        dayHeader.className = 'text-center font-semibold text-white/60 text-xs py-2';
        dayHeader.textContent = day;
        calendarGrid.appendChild(dayHeader);
    });

    // Get first day of month and number of days
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const daysInMonth = lastDay.getDate();

    // Get start day (Monday = 0)
    let startDay = firstDay.getDay() - 1;
    if (startDay === -1) startDay = 6;

    // Add empty cells for days before month starts
    for (let i = 0; i < startDay; i++) {
        const emptyDay = document.createElement('div');
        emptyDay.className = 'aspect-square flex items-center justify-center opacity-30';
        calendarGrid.appendChild(emptyDay);
    }

    // Add days of the month
    const today = new Date();
    for (let day = 1; day <= daysInMonth; day++) {
        const dayElement = document.createElement('div');
        const currentDay = new Date(year, month, day);

        dayElement.className = 'aspect-square flex items-center justify-center rounded-lg cursor-pointer text-sm transition-all hover:bg-primary/20 text-white';
        dayElement.textContent = day;
        dayElement.dataset.date = currentDay.toISOString().split('T')[0];

        // Highlight today
        if (currentDay.toDateString() === today.toDateString()) {
            dayElement.className = 'aspect-square flex items-center justify-center rounded-lg cursor-pointer text-sm bg-primary text-white font-bold';
        }

        // Add click handler
        dayElement.onclick = () => {
            window.location.href = `/slots/day/${dayElement.dataset.date}`;
        };

        calendarGrid.appendChild(dayElement);
    }

    // Refresh icons
    setTimeout(() => lucide.createIcons(), 10);
}

function navigateCalendar(direction) {
    if (direction === 'prev') {
        currentDate.setMonth(currentDate.getMonth() - 1);
    } else {
        currentDate.setMonth(currentDate.getMonth() + 1);
    }
    generateMiniCalendar();
}

// Initialize calendar on page load
document.addEventListener('DOMContentLoaded', function() {
    generateMiniCalendar();
});
</script>
{% endblock %}
