{% extends "hub/base.html" %}

{% block title %}Slot Buchung{% endblock %}

{% block extra_head %}
<!-- Slot Booking Styles -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/slots.css') }}">
{% endblock %}

{% block content %}

<!-- Achievement Notification Container -->
<div id="achievementContainer"></div>

<!-- Level Up Modal -->
<dialog id="levelUpModal" class="modal">
  <div class="modal-box glass bg-gradient-to-br from-success/20 to-primary/20 max-w-md">
    <div class="text-center">
      <div class="text-6xl mb-4 animate-bounce">üéâ</div>
      <h3 class="text-3xl font-bold text-white mb-2">LEVEL UP!</h3>
      <p class="text-lg text-white/80 mb-4">Du bist aufgestiegen!</p>

      <div class="flex items-center justify-center gap-4 text-2xl font-bold mb-4">
        <span class="text-white/70">Level <span id="oldLevel">1</span></span>
        <span class="text-3xl text-warning">‚Üí</span>
        <span class="text-warning">Level <span id="newLevel">2</span></span>
      </div>

      <div class="text-warning font-bold mb-6">
        +<span id="xpGained">0</span> XP gewonnen!
      </div>

      <button data-action="closeModal" data-args='["levelUpModal"]' class="btn btn-primary">
        <i data-lucide="check" class="w-5 h-5 mr-2"></i>
        Schlie√üen
      </button>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button>Schlie√üen</button>
  </form>
</dialog>

<!-- Quick Actions Modal -->
<dialog id="quickActionsModal" class="modal">
  <div class="modal-box glass max-w-lg">
    <h3 class="text-2xl font-bold text-white mb-4 flex items-center gap-2">
      <i data-lucide="zap" class="w-6 h-6 text-primary"></i>
      Quick Actions
    </h3>

    <div class="space-y-2">
      <div class="glass rounded-xl p-3 hover:bg-white/10 cursor-pointer transition-all" data-action="quickActionToggleSidebar">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <i data-lucide="sidebar" class="w-5 h-5 text-primary"></i>
            <span class="text-white">Sidebar toggle</span>
          </div>
          <kbd class="kbd kbd-sm">S</kbd>
        </div>
      </div>

      <div class="glass rounded-xl p-3 hover:bg-white/10 cursor-pointer transition-all" data-action="quickActionNavigate" data-args='["/my-calendar"]'>
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <i data-lucide="user" class="w-5 h-5 text-secondary"></i>
            <span class="text-white">Meine Buchungen</span>
          </div>
          <kbd class="kbd kbd-sm">M</kbd>
        </div>
      </div>

      <div class="glass rounded-xl p-3 hover:bg-white/10 cursor-pointer transition-all" data-action="quickActionNavigate" data-args='["{{ url_for('scoreboard.scoreboard') }}"]'>
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <i data-lucide="trophy" class="w-5 h-5 text-warning"></i>
            <span class="text-white">Scoreboard</span>
          </div>
          <kbd class="kbd kbd-sm">P</kbd>
        </div>
      </div>

      <div class="glass rounded-xl p-3 hover:bg-white/10 cursor-pointer transition-all" data-action="quickActionDay" data-args='[1]'>
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <i data-lucide="arrow-right" class="w-5 h-5 text-accent"></i>
            <span class="text-white">N√§chster Tag</span>
          </div>
          <kbd class="kbd kbd-sm">‚Üí</kbd>
        </div>
      </div>

      <div class="glass rounded-xl p-3 hover:bg-white/10 cursor-pointer transition-all" data-action="quickActionDay" data-args='[-1]'>
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <i data-lucide="arrow-left" class="w-5 h-5 text-accent"></i>
            <span class="text-white">Vorheriger Tag</span>
          </div>
          <kbd class="kbd kbd-sm">‚Üê</kbd>
        </div>
      </div>

      {% if is_admin %}
      <div class="glass rounded-xl p-3 hover:bg-white/10 cursor-pointer transition-all" data-action="quickActionNavigate" data-args='["{{ url_for('admin.admin_dashboard') }}"]'>
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <i data-lucide="shield" class="w-5 h-5 text-error"></i>
            <span class="text-white">Admin Dashboard</span>
          </div>
          <kbd class="kbd kbd-sm">A</kbd>
        </div>
      </div>
      {% endif %}
    </div>

    <div class="mt-6 pt-4 border-t border-white/10 text-center text-sm text-white/60">
      <kbd class="kbd kbd-sm">ESC</kbd> zum Schlie√üen ‚Ä¢
      <kbd class="kbd kbd-sm">Ctrl</kbd>+<kbd class="kbd kbd-sm">K</kbd> √∂ffnet Quick Actions
    </div>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button>Schlie√üen</button>
  </form>
</dialog>

<!-- Sidebar -->
<div id="sidebar" class="fixed left-0 top-20 h-[calc(100vh-5rem)] w-80 glass z-40 transform -translate-x-full pointer-events-none transition-transform duration-300 overflow-y-auto">
  <div class="p-6">
    <div class="flex items-center justify-between mb-6">
      <h3 class="text-xl font-bold text-white flex items-center gap-2">
        <i data-lucide="bar-chart-3" class="w-6 h-6 text-primary"></i>
        Wochenauslastung
      </h3>
      <button data-action="toggleSidebar" class="btn btn-ghost btn-sm btn-circle">
        <i data-lucide="x" class="w-5 h-5"></i>
      </button>
    </div>

    {% for week in weekly_summary %}
    <a href="{{ url_for('main.day_view', date_str=week.start_date) }}"
       class="block glass rounded-xl p-4 mb-3 hover:bg-white/10 transition-all {% if week.current %}ring-2 ring-primary{% endif %}">
      <div class="flex items-center justify-between mb-2">
        <span class="font-semibold text-white">{{ week.label }}</span>
        <span class="text-sm text-white/70">{{ week.usage_pct }}%</span>
      </div>

      <div class="w-full bg-white/10 rounded-full h-2 mb-2">
        <div class="h-2 rounded-full transition-all duration-300
          {% if week.usage < 0.5 %}bg-success
          {% elif week.usage < 0.8 %}bg-warning
          {% elif week.usage < 0.95 %}bg-orange-500
          {% else %}bg-error{% endif %}"
          style="width: {{ week.usage_pct }}%"></div>
      </div>

      <div class="text-xs text-white/60">
        {{ week.booked }}/{{ week.possible }} gebucht ‚Ä¢ {{ week.range }}
      </div>
    </a>
    {% endfor %}

    <!-- Level Display in Sidebar -->
    {% if user_level %}
    <div class="mt-6">
      {% include 'level_display.html' %}
    </div>
    {% endif %}
  </div>
</div>

<!-- Sidebar Toggle Button -->
<button id="sidebarToggle" data-action="toggleSidebar"
        class="fixed left-4 top-24 z-40 btn btn-circle glass hover:scale-110 transition-transform"
        title="Men√º">
  <i data-lucide="menu" class="w-5 h-5"></i>
</button>

<!-- Main Content -->
<div id="mainContent" class="transition-all duration-300">

  <!-- Flash Messages -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
      <div class="alert alert-{{ 'success' if category == 'success' else 'error' if category == 'error' else 'info' }} mb-6" data-aos="fade-down">
        <i data-lucide="{{ 'check-circle' if category == 'success' else 'alert-circle' }}" class="w-5 h-5"></i>
        <span>{{ message }}</span>
      </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <!-- Quick Links -->
  <div class="glass rounded-3xl p-8 mb-8" data-aos="fade-down">
    <h2 class="text-2xl font-bold text-white mb-4 flex items-center gap-2">
      <i data-lucide="link" class="w-6 h-6 text-primary"></i>
      Quick Links
    </h2>

    <div class="flex flex-wrap gap-3">
      <a href="https://calendar.google.com/calendar/u/0/r?cid=emVudHJhbGthbGVuZGVyemZhQGdtYWlsLmNvbQ"
         target="_blank" class="btn btn-primary btn-sm gap-2">
        <i data-lucide="calendar" class="w-4 h-4"></i>
        Zentralkalender
      </a>
      <a href="/my-calendar" class="btn btn-secondary btn-sm gap-2">
        <i data-lucide="list" class="w-4 h-4"></i>
        Meine Buchungen
      </a>
      <a href="{{ url_for('calendar.calendar_view') }}" class="btn btn-accent btn-sm gap-2">
        <i data-lucide="calendar-days" class="w-4 h-4"></i>
        Kalender-Ansicht
      </a>
      <a href="{{ url_for('scoreboard.scoreboard') }}" class="btn btn-warning btn-sm gap-2">
        <i data-lucide="trophy" class="w-4 h-4"></i>
        Scoreboard
      </a>
      <a href="{{ url_for('scoreboard.badges') }}" class="btn btn-info btn-sm gap-2">
        <i data-lucide="award" class="w-4 h-4"></i>
        Badges
      </a>
      <a href="{{ url_for('scoreboard.gamification_dashboard') }}" class="btn gap-2 bg-secondary hover:bg-accent border-0 text-white btn-sm">
        <i data-lucide="gamepad-2" class="w-4 h-4"></i>
        Gamification
      </a>
    </div>
  </div>

  <!-- 4-Wochen Auslastung -->
  <div class="glass rounded-3xl p-8 mb-8" data-aos="fade-up" data-aos-delay="100">
    <h2 class="text-2xl font-bold text-white mb-6 flex items-center gap-2">
      <i data-lucide="bar-chart-2" class="w-6 h-6 text-primary"></i>
      Wochenauslastung (n√§chste 4 Wochen)
    </h2>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
      {% for w in weekly_summary[:4] %}
        {% set ratio = (w.booked / (w.possible + 0.001)) if w.possible > 0 else 0 %}
        {% set color_class = 'success' if ratio < 0.5 else 'warning' if ratio < 0.8 else 'orange-500' if ratio < 1 else 'error' %}

        <a href="{{ url_for('main.day_view', date_str=w.start_date) }}"
           class="glass rounded-2xl p-6 text-center hover:scale-105 transition-transform block cursor-pointer">
          <div class="text-sm text-white/70 mb-2">{{ w.label }}</div>
          <div class="text-4xl font-bold text-{{ color_class }} mb-2">{{ w.usage_pct }}%</div>
          <div class="text-sm text-white/80 mb-1">{{ w.booked }} / {{ w.possible }} gebucht</div>
          <div class="text-xs text-white/60">{{ w.range }}</div>
        </a>
      {% endfor %}
    </div>

    {% if slot_suggestions %}
    <div class="glass rounded-2xl p-4">
      <div class="flex items-center gap-2 text-sm text-white/70 mb-3">
        <i data-lucide="target" class="w-4 h-4 text-primary"></i>
        Empfohlene Slots (mit Punkten)
      </div>
      <div class="flex flex-wrap gap-2">
        {% for s in slot_suggestions[:5] %}
        <div class="badge badge-lg gap-2">
          <span>{{ s.date }}</span> ‚Ä¢
          <span>{{ s.hour }}</span> ‚Ä¢
          <span class="text-success">{{ s.punkte }} Pkt</span> ‚Ä¢
          <span class="text-accent">{{ s.freie }} frei</span>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}
  </div>

  <!-- Slot-Buchung -->
  <div class="glass rounded-3xl p-8" data-aos="fade-up" data-aos-delay="200">
    <h2 class="text-2xl font-bold text-white mb-4 flex items-center gap-2">
      <i data-lucide="calendar-check" class="w-6 h-6 text-primary"></i>
      Slot-Buchung f√ºr {{ date.strftime('%A, %d.%m.%Y') }}
    </h2>

    <!-- Day Navigation -->
    <div class="flex gap-2 mb-6 overflow-x-auto pb-2">
      {% for d in days %}
      <a href="{{ url_for('main.day_view', date_str=d.strftime('%Y-%m-%d')) }}"
         class="btn btn-sm {% if d == date %}btn-primary{% else %}btn-ghost{% endif %} whitespace-nowrap">
        {{ d.strftime('%a, %d.%m') }}
      </a>
      {% endfor %}
    </div>

    <!-- Quick Actions -->
    <div class="flex flex-wrap gap-2 mb-6">
      <button data-action="expandAll" class="btn btn-sm btn-ghost gap-2">
        <i data-lucide="chevrons-down" class="w-4 h-4"></i>
        Alle aufklappen
      </button>
      <button data-action="collapseAll" class="btn btn-sm btn-ghost gap-2">
        <i data-lucide="chevrons-up" class="w-4 h-4"></i>
        Alle zuklappen
      </button>
      <button data-action="jumpToEvening" class="btn btn-sm btn-ghost gap-2">
        <i data-lucide="moon" class="w-4 h-4"></i>
        Zu Abendterminen
      </button>
    </div>

    <!-- Slots -->
    <div class="space-y-3">
      {% for hour, slot in slots.items() %}
        {% set total = slot.total %}
        {% set booked = slot.booked %}
        {% set ratio = (booked / (total + 0.001)) if total > 0 else 0 %}
        {% set color = 'success' %}
        {% if slot.overbooked or ratio >= 1.0 %}
          {% set color = 'error' %}
        {% elif ratio >= 0.8 %}
          {% set color = 'warning' %}
        {% elif ratio >= 0.5 %}
          {% set color = 'yellow-500' %}
        {% endif %}

        <div class="slot-section glass rounded-2xl overflow-hidden" data-hour="{{ hour }}">
          <!-- Header -->
          <div class="slot-header p-4 hover:bg-white/5 transition-colors" data-action="toggleSlot">
            <div class="flex items-center justify-between gap-4">
              <div class="flex-1 flex flex-wrap items-center gap-3">
                <div class="flex items-center gap-2 font-bold text-white">
                  <i data-lucide="clock" class="w-5 h-5 text-primary"></i>
                  {{ hour }} Uhr
                </div>

                <div class="flex flex-wrap items-center gap-2 text-sm text-white/70">
                  <span class="flex items-center gap-1">
                    <i data-lucide="users" class="w-4 h-4"></i>
                    {{ slot.available_beraters }} Berater
                  </span>
                  <span>‚Ä¢</span>
                  <span>{{ total }} Pl√§tze</span>
                  <span>‚Ä¢</span>
                  {% if slot.free_count == 0 %}
                    <span class="badge badge-error gap-1">
                      <i data-lucide="x" class="w-3 h-3"></i>
                      Ausgebucht
                    </span>
                  {% elif slot.free_count <= 2 %}
                    <span class="badge badge-warning gap-1">
                      <i data-lucide="alert-triangle" class="w-3 h-3"></i>
                      {{ slot.free_count }} frei
                    </span>
                  {% else %}
                    <span class="badge badge-success gap-1">
                      <i data-lucide="check" class="w-3 h-3"></i>
                      {{ slot.free_count }} frei
                    </span>
                  {% endif %}

                  {% if slot.using_default %}
                    <span class="badge badge-info gap-1">
                      <i data-lucide="sparkles" class="w-3 h-3"></i>
                      Standard
                    </span>
                  {% endif %}
                </div>
              </div>

              <button class="btn btn-ghost btn-sm btn-circle">
                <i data-lucide="chevron-down" class="w-4 h-4 toggle-icon"></i>
              </button>
            </div>
          </div>

          <!-- Content -->
          <div class="slot-content collapsed" style="max-height: 0;">
            <div class="p-6 pt-4 border-t border-white/10">
              {% if slot.using_default %}
              <div class="mb-6 text-sm text-white/80">
                Detaillierte √úbersicht:
                <strong>Kein spezifischer Berater</strong> |
                <strong>2-4 Termine</strong> buchbar |
                <strong>{{ booked }}</strong> bereits gebucht
              </div>
              {% else %}
              <div class="mb-6 text-sm text-white/80">
                Detaillierte √úbersicht:
                <strong>{{ slot.available_beraters }}</strong> Berater verf√ºgbar |
                <strong>{{ total }}</strong> Kapazit√§t |
                <strong>{{ booked }}</strong> bereits gebucht
              </div>
              {% endif %}

              {% if slot.using_default %}
              <div class="alert alert-info mb-6">
                <i data-lucide="info" class="w-5 h-5"></i>
                <div>
                  <strong>Standard-Verf√ºgbarkeit</strong>
                  <p class="text-sm">Kein spezifischer Berater zugewiesen. Es k√∂nnen 2-4 Termine gebucht werden, ein verf√ºgbarer Berater wird zugewiesen.</p>
                </div>
              </div>
              {% endif %}

              {% if slot.overbooked %}
                <div class="alert alert-error mb-6">
                  <i data-lucide="alert-triangle" class="w-5 h-5"></i>
                  <span><strong>ACHTUNG:</strong> √úberbuchung! Es sind zu wenige Berater f√ºr {{ booked }} Termine!</span>
                </div>
              {% elif slot.free_count == 0 %}
                <div class="alert mb-6">
                  <i data-lucide="info" class="w-5 h-5"></i>
                  <span>Alle {{ total }} Slots um {{ hour }} Uhr sind bereits belegt.</span>
                </div>
              {% else %}
                <div class="alert alert-success mb-6">
                  <i data-lucide="check-circle" class="w-5 h-5"></i>
                  <span>Noch {{ slot.free_count }} von {{ total }} Slots verf√ºgbar</span>
                </div>
              {% endif %}

              {% if not slot.overbooked and slot.free_count > 0 %}
              <form method="POST" action="{{ url_for('booking.book') }}" class="space-y-4" data-submit="handleBookingSubmitForm">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="date" value="{{ date.strftime('%Y-%m-%d') }}">
                <input type="hidden" name="hour" value="{{ hour }}">

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div class="form-control">
                    <input type="text" name="first_name" placeholder="Vorname" required maxlength="50"
                           class="input input-bordered w-full">
                  </div>
                  <div class="form-control">
                    <input type="text" name="last_name" placeholder="Nachname" required maxlength="50"
                           class="input input-bordered w-full">
                  </div>
                </div>

                <div class="form-control">
                  <textarea name="description" placeholder="Beschreibung (optional)" maxlength="500"
                            class="textarea textarea-bordered w-full" rows="3"></textarea>
                </div>

                <div class="form-control">
                  <select name="color" required class="select select-bordered w-full">
                    <option value="2">üü¢ Normales Potential</option>
                    <option value="7">üîµ Top Potential</option>
                    <option value="5">üü° Closer n√∂tig</option>
                    <option value="3">üü£ R√ºckholung</option>
                  </select>
                </div>

                <button type="submit" class="btn btn-primary w-full gap-2 mt-2">
                  <i data-lucide="calendar-check" class="w-5 h-5"></i>
                  <span class="button-text">Slot buchen</span>
                  <span class="loading loading-spinner loading-sm hidden"></span>
                </button>
              </form>
              {% endif %}
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<!-- Slot Booking JavaScript -->
<script src="{{ url_for('static', filename='js/slots.js') }}"></script>

<!-- Template-specific initialization -->
<script nonce="{{ csp_nonce }}">
// Initialize Achievement System (template-specific)
let achievementSystem;
{% if user_level %}
achievementSystem = new AchievementSystem();
{% endif %}

// Navigation function with template date
function navigateDay(direction) {
  window.navigateDay(direction, "{{ date.strftime('%Y-%m-%d') }}");
}

// Level Up Check (template-specific)
{% if user_level %}
window.addEventListener('load', checkForLevelUp);
{% endif %}

// Setup keyboard shortcuts with template URL
window.setupKeyboardShortcuts("{{ url_for('scoreboard.scoreboard') }}");

// Store current date for navigation
window.currentDateStr = "{{ date.strftime('%Y-%m-%d') }}";
</script>
{% endblock %}
