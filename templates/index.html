{% extends "hub/base.html" %}

{% block title %}Slot Buchung{% endblock %}

{% block extra_head %}
<style>
/* Achievement Notification System */
.achievement-notification {
  position: fixed;
  top: 20px;
  right: 20px;
  z-index: 2000;
  max-width: 400px;
  transform: translateX(450px);
  transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
  opacity: 0;
  pointer-events: none;
}

.achievement-notification.show {
  transform: translateX(0);
  opacity: 1;
  pointer-events: all;
}

/* Rarity Glow Effects */
.achievement-notification.rarity-common { box-shadow: 0 20px 60px rgba(16,185,129,0.3); }
.achievement-notification.rarity-uncommon { box-shadow: 0 20px 60px rgba(59,130,246,0.3); }
.achievement-notification.rarity-rare { box-shadow: 0 20px 60px rgba(139,92,246,0.3); }
.achievement-notification.rarity-epic { box-shadow: 0 20px 60px rgba(245,158,11,0.3); }
.achievement-notification.rarity-legendary { box-shadow: 0 20px 60px rgba(234,179,8,0.4); }
.achievement-notification.rarity-mythic { box-shadow: 0 20px 60px rgba(236,72,153,0.4); }

.achievement-badge {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto 15px;
  font-size: 40px;
  animation: badgePulse 2s ease infinite;
}

.achievement-badge.rarity-common { background: linear-gradient(135deg, #10b981, #059669); }
.achievement-badge.rarity-uncommon { background: linear-gradient(135deg, #3b82f6, #2563eb); }
.achievement-badge.rarity-rare { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
.achievement-badge.rarity-epic { background: linear-gradient(135deg, #f59e0b, #d97706); }
.achievement-badge.rarity-legendary { background: linear-gradient(135deg, #eab308, #ca8a04); }
.achievement-badge.rarity-mythic { background: linear-gradient(135deg, #ec4899, #db2777); }

@keyframes badgePulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.05); }
}

/* Confetti Animation */
.confetti {
  position: fixed;
  width: 10px;
  height: 10px;
  z-index: 2999;
  animation: confettiFall 3s linear;
}

@keyframes confettiFall {
  to { transform: translateY(100vh) rotate(360deg); opacity: 0; }
}

/* Slot Sections */
.slot-section {
  transition: all 0.3s ease;
}

.slot-header {
  cursor: pointer;
  user-select: none;
  transition: all 0.2s ease;
}

.slot-header:hover {
  transform: translateY(-1px);
}

.slot-content {
  overflow: hidden;
  transition: max-height 0.3s ease, opacity 0.3s ease;
}

.slot-content.collapsed {
  max-height: 0 !important;
  opacity: 0;
}

.toggle-icon {
  transition: transform 0.3s ease;
}

.slot-section.expanded .toggle-icon {
  transform: rotate(180deg);
}

/* Quick Actions Modal */
.quick-actions-modal {
  transition: all 0.2s ease;
}

.quick-actions-modal.show {
  display: flex !important;
}

/* Mobile adjustments */
@media (max-width: 768px) {
  .achievement-notification {
    top: 10px;
    right: 10px;
    left: 10px;
    max-width: none;
    transform: translateY(-100px);
  }

  .achievement-notification.show {
    transform: translateY(0);
  }
}
</style>
{% endblock %}

{% block content %}

<!-- Achievement Notification Container -->
<div id="achievementContainer"></div>

<!-- Level Up Modal -->
<dialog id="levelUpModal" class="modal">
  <div class="modal-box glass bg-gradient-to-br from-success/20 to-primary/20 max-w-md">
    <div class="text-center">
      <div class="text-6xl mb-4 animate-bounce">üéâ</div>
      <h3 class="text-3xl font-bold text-white mb-2">LEVEL UP!</h3>
      <p class="text-lg text-white/80 mb-4">Du bist aufgestiegen!</p>

      <div class="flex items-center justify-center gap-4 text-2xl font-bold mb-4">
        <span class="text-white/70">Level <span id="oldLevel">1</span></span>
        <span class="text-3xl text-warning">‚Üí</span>
        <span class="text-warning">Level <span id="newLevel">2</span></span>
      </div>

      <div class="text-warning font-bold mb-6">
        +<span id="xpGained">0</span> XP gewonnen!
      </div>

      <button onclick="document.getElementById('levelUpModal').close()" class="btn btn-primary">
        <i data-lucide="check" class="w-5 h-5 mr-2"></i>
        Schlie√üen
      </button>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button>Schlie√üen</button>
  </form>
</dialog>

<!-- Quick Actions Modal -->
<dialog id="quickActionsModal" class="modal">
  <div class="modal-box glass max-w-lg">
    <h3 class="text-2xl font-bold text-white mb-4 flex items-center gap-2">
      <i data-lucide="zap" class="w-6 h-6 text-primary"></i>
      Quick Actions
    </h3>

    <div class="space-y-2">
      <div class="glass rounded-xl p-3 hover:bg-white/10 cursor-pointer transition-all" onclick="toggleSidebar(); document.getElementById('quickActionsModal').close()">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <i data-lucide="sidebar" class="w-5 h-5 text-primary"></i>
            <span class="text-white">Sidebar toggle</span>
          </div>
          <kbd class="kbd kbd-sm">S</kbd>
        </div>
      </div>

      <div class="glass rounded-xl p-3 hover:bg-white/10 cursor-pointer transition-all" onclick="window.location.href='/my-calendar'; document.getElementById('quickActionsModal').close()">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <i data-lucide="user" class="w-5 h-5 text-secondary"></i>
            <span class="text-white">Meine Buchungen</span>
          </div>
          <kbd class="kbd kbd-sm">M</kbd>
        </div>
      </div>

      <div class="glass rounded-xl p-3 hover:bg-white/10 cursor-pointer transition-all" onclick="window.location.href='{{ url_for('scoreboard.scoreboard') }}'; document.getElementById('quickActionsModal').close()">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <i data-lucide="trophy" class="w-5 h-5 text-warning"></i>
            <span class="text-white">Scoreboard</span>
          </div>
          <kbd class="kbd kbd-sm">P</kbd>
        </div>
      </div>

      <div class="glass rounded-xl p-3 hover:bg-white/10 cursor-pointer transition-all" onclick="navigateDay(1); document.getElementById('quickActionsModal').close()">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <i data-lucide="arrow-right" class="w-5 h-5 text-accent"></i>
            <span class="text-white">N√§chster Tag</span>
          </div>
          <kbd class="kbd kbd-sm">‚Üí</kbd>
        </div>
      </div>

      <div class="glass rounded-xl p-3 hover:bg-white/10 cursor-pointer transition-all" onclick="navigateDay(-1); document.getElementById('quickActionsModal').close()">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <i data-lucide="arrow-left" class="w-5 h-5 text-accent"></i>
            <span class="text-white">Vorheriger Tag</span>
          </div>
          <kbd class="kbd kbd-sm">‚Üê</kbd>
        </div>
      </div>

      {% if is_admin %}
      <div class="glass rounded-xl p-3 hover:bg-white/10 cursor-pointer transition-all" onclick="window.location.href='{{ url_for('admin.admin_dashboard') }}'; document.getElementById('quickActionsModal').close()">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <i data-lucide="shield" class="w-5 h-5 text-error"></i>
            <span class="text-white">Admin Dashboard</span>
          </div>
          <kbd class="kbd kbd-sm">A</kbd>
        </div>
      </div>
      {% endif %}
    </div>

    <div class="mt-6 pt-4 border-t border-white/10 text-center text-sm text-white/60">
      <kbd class="kbd kbd-sm">ESC</kbd> zum Schlie√üen ‚Ä¢
      <kbd class="kbd kbd-sm">Ctrl</kbd>+<kbd class="kbd kbd-sm">K</kbd> √∂ffnet Quick Actions
    </div>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button>Schlie√üen</button>
  </form>
</dialog>

<!-- Sidebar -->
<div id="sidebar" class="fixed left-0 top-20 h-[calc(100vh-5rem)] w-80 glass z-30 transform -translate-x-full transition-transform duration-300 overflow-y-auto">
  <div class="p-6">
    <div class="flex items-center justify-between mb-6">
      <h3 class="text-xl font-bold text-white flex items-center gap-2">
        <i data-lucide="bar-chart-3" class="w-6 h-6 text-primary"></i>
        Wochenauslastung
      </h3>
      <button onclick="toggleSidebar()" class="btn btn-ghost btn-sm btn-circle">
        <i data-lucide="x" class="w-5 h-5"></i>
      </button>
    </div>

    {% for week in weekly_summary %}
    <a href="{{ url_for('main.day_view', date_str=week.start_date) }}"
       class="block glass rounded-xl p-4 mb-3 hover:bg-white/10 transition-all {% if week.current %}ring-2 ring-primary{% endif %}">
      <div class="flex items-center justify-between mb-2">
        <span class="font-semibold text-white">{{ week.label }}</span>
        <span class="text-sm text-white/70">{{ week.usage_pct }}%</span>
      </div>

      <div class="w-full bg-white/10 rounded-full h-2 mb-2">
        <div class="h-2 rounded-full transition-all duration-300
          {% if week.usage < 0.5 %}bg-success
          {% elif week.usage < 0.8 %}bg-warning
          {% elif week.usage < 0.95 %}bg-orange-500
          {% else %}bg-error{% endif %}"
          style="width: {{ week.usage_pct }}%"></div>
      </div>

      <div class="text-xs text-white/60">
        {{ week.booked }}/{{ week.possible }} gebucht ‚Ä¢ {{ week.range }}
      </div>
    </a>
    {% endfor %}

    <!-- Level Display in Sidebar -->
    {% if user_level %}
    <div class="mt-6">
      {% include 'level_display.html' %}
    </div>
    {% endif %}
  </div>
</div>

<!-- Sidebar Toggle Button -->
<button id="sidebarToggle" onclick="toggleSidebar()"
        class="fixed left-4 top-24 z-40 btn btn-circle glass hover:scale-110 transition-transform"
        title="Men√º">
  <i data-lucide="menu" class="w-5 h-5"></i>
</button>

<!-- Main Content -->
<div id="mainContent" class="transition-all duration-300">

  <!-- Flash Messages -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
      <div class="alert alert-{{ 'success' if category == 'success' else 'error' if category == 'error' else 'info' }} mb-6" data-aos="fade-down">
        <i data-lucide="{{ 'check-circle' if category == 'success' else 'alert-circle' }}" class="w-5 h-5"></i>
        <span>{{ message }}</span>
      </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <!-- Quick Links -->
  <div class="glass rounded-3xl p-8 mb-8" data-aos="fade-down">
    <h2 class="text-2xl font-bold text-white mb-4 flex items-center gap-2">
      <i data-lucide="link" class="w-6 h-6 text-primary"></i>
      Quick Links
    </h2>

    <div class="flex flex-wrap gap-3">
      <a href="https://calendar.google.com/calendar/u/0/r?cid=emVudHJhbGthbGVuZGVyemZhQGdtYWlsLmNvbQ"
         target="_blank" class="btn btn-primary btn-sm gap-2">
        <i data-lucide="calendar" class="w-4 h-4"></i>
        Zentralkalender
      </a>
      <a href="/my-calendar" class="btn btn-secondary btn-sm gap-2">
        <i data-lucide="list" class="w-4 h-4"></i>
        Meine Buchungen
      </a>
      <a href="{{ url_for('calendar.calendar_view') }}" class="btn btn-accent btn-sm gap-2">
        <i data-lucide="calendar-days" class="w-4 h-4"></i>
        Kalender-Ansicht
      </a>
      <a href="{{ url_for('scoreboard.scoreboard') }}" class="btn btn-warning btn-sm gap-2">
        <i data-lucide="trophy" class="w-4 h-4"></i>
        Scoreboard
      </a>
      <a href="{{ url_for('scoreboard.badges') }}" class="btn btn-info btn-sm gap-2">
        <i data-lucide="award" class="w-4 h-4"></i>
        Badges
      </a>
      <a href="{{ url_for('scoreboard.gamification_dashboard') }}" class="btn gap-2 bg-purple-600 hover:bg-purple-700 border-0 text-white btn-sm">
        <i data-lucide="gamepad-2" class="w-4 h-4"></i>
        Gamification
      </a>
    </div>
  </div>

  <!-- 4-Wochen Auslastung -->
  <div class="glass rounded-3xl p-8 mb-8" data-aos="fade-up" data-aos-delay="100">
    <h2 class="text-2xl font-bold text-white mb-6 flex items-center gap-2">
      <i data-lucide="bar-chart-2" class="w-6 h-6 text-primary"></i>
      Wochenauslastung (n√§chste 4 Wochen)
    </h2>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
      {% for w in weekly_summary[:4] %}
        {% set ratio = (w.booked / (w.possible + 0.001)) if w.possible > 0 else 0 %}
        {% set color_class = 'success' if ratio < 0.5 else 'warning' if ratio < 0.8 else 'orange-500' if ratio < 1 else 'error' %}

        <div class="glass rounded-2xl p-6 text-center hover:scale-105 transition-transform">
          <div class="text-sm text-white/70 mb-2">{{ w.label }}</div>
          <div class="text-4xl font-bold text-{{ color_class }} mb-2">{{ w.usage_pct }}%</div>
          <div class="text-sm text-white/80 mb-1">{{ w.booked }} / {{ w.possible }} gebucht</div>
          <div class="text-xs text-white/60">{{ w.range }}</div>
        </div>
      {% endfor %}
    </div>

    {% if slot_suggestions %}
    <div class="glass rounded-2xl p-4">
      <div class="flex items-center gap-2 text-sm text-white/70 mb-3">
        <i data-lucide="target" class="w-4 h-4 text-primary"></i>
        Empfohlene Slots (mit Punkten)
      </div>
      <div class="flex flex-wrap gap-2">
        {% for s in slot_suggestions[:5] %}
        <div class="badge badge-lg gap-2">
          <span>{{ s.date }}</span> ‚Ä¢
          <span>{{ s.hour }}</span> ‚Ä¢
          <span class="text-success">{{ s.punkte }} Pkt</span> ‚Ä¢
          <span class="text-accent">{{ s.freie }} frei</span>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}
  </div>

  <!-- Slot-Buchung -->
  <div class="glass rounded-3xl p-8" data-aos="fade-up" data-aos-delay="200">
    <h2 class="text-2xl font-bold text-white mb-4 flex items-center gap-2">
      <i data-lucide="calendar-check" class="w-6 h-6 text-primary"></i>
      Slot-Buchung f√ºr {{ date.strftime('%A, %d.%m.%Y') }}
    </h2>

    <!-- Day Navigation -->
    <div class="flex gap-2 mb-6 overflow-x-auto pb-2">
      {% for d in days %}
      <a href="{{ url_for('main.day_view', date_str=d.strftime('%Y-%m-%d')) }}"
         class="btn btn-sm {% if d == date %}btn-primary{% else %}btn-ghost{% endif %} whitespace-nowrap">
        {{ d.strftime('%a, %d.%m') }}
      </a>
      {% endfor %}
    </div>

    <!-- Quick Actions -->
    <div class="flex flex-wrap gap-2 mb-6">
      <button onclick="expandAll()" class="btn btn-sm btn-ghost gap-2">
        <i data-lucide="chevrons-down" class="w-4 h-4"></i>
        Alle aufklappen
      </button>
      <button onclick="collapseAll()" class="btn btn-sm btn-ghost gap-2">
        <i data-lucide="chevrons-up" class="w-4 h-4"></i>
        Alle zuklappen
      </button>
      <button onclick="jumpToEvening()" class="btn btn-sm btn-ghost gap-2">
        <i data-lucide="moon" class="w-4 h-4"></i>
        Zu Abendterminen
      </button>
    </div>

    <!-- Slots -->
    <div class="space-y-3">
      {% for hour, slot in slots.items() %}
        {% set total = slot.total %}
        {% set booked = slot.booked %}
        {% set ratio = (booked / (total + 0.001)) if total > 0 else 0 %}
        {% set color = 'success' %}
        {% if slot.overbooked or ratio >= 1.0 %}
          {% set color = 'error' %}
        {% elif ratio >= 0.8 %}
          {% set color = 'warning' %}
        {% elif ratio >= 0.5 %}
          {% set color = 'yellow-500' %}
        {% endif %}

        <div class="slot-section glass rounded-2xl overflow-hidden" data-hour="{{ hour }}">
          <!-- Header -->
          <div class="slot-header p-4 hover:bg-white/5 transition-colors" onclick="toggleSlot(this)">
            <div class="flex items-center justify-between gap-4">
              <div class="flex-1 flex flex-wrap items-center gap-3">
                <div class="flex items-center gap-2 font-bold text-white">
                  <i data-lucide="clock" class="w-5 h-5 text-primary"></i>
                  {{ hour }} Uhr
                </div>

                <div class="flex flex-wrap items-center gap-2 text-sm text-white/70">
                  <span class="flex items-center gap-1">
                    <i data-lucide="users" class="w-4 h-4"></i>
                    {{ slot.available_beraters }} Berater
                  </span>
                  <span>‚Ä¢</span>
                  <span>{{ total }} Pl√§tze</span>
                  <span>‚Ä¢</span>
                  {% if slot.free_count == 0 %}
                    <span class="badge badge-error gap-1">
                      <i data-lucide="x" class="w-3 h-3"></i>
                      Ausgebucht
                    </span>
                  {% elif slot.free_count <= 2 %}
                    <span class="badge badge-warning gap-1">
                      <i data-lucide="alert-triangle" class="w-3 h-3"></i>
                      {{ slot.free_count }} frei
                    </span>
                  {% else %}
                    <span class="badge badge-success gap-1">
                      <i data-lucide="check" class="w-3 h-3"></i>
                      {{ slot.free_count }} frei
                    </span>
                  {% endif %}

                  {% if slot.using_default %}
                    <span class="badge badge-info gap-1">
                      <i data-lucide="sparkles" class="w-3 h-3"></i>
                      Standard
                    </span>
                  {% endif %}
                </div>
              </div>

              <button class="btn btn-ghost btn-sm btn-circle">
                <i data-lucide="chevron-down" class="w-4 h-4 toggle-icon"></i>
              </button>
            </div>
          </div>

          <!-- Content -->
          <div class="slot-content collapsed" style="max-height: 0;">
            <div class="p-4 pt-0 border-t border-white/10">
              <div class="mb-4 text-sm text-white/80">
                Detaillierte √úbersicht:
                <strong>{{ slot.available_beraters }}</strong> Berater verf√ºgbar |
                <strong>{{ total }}</strong> Kapazit√§t |
                <strong>{{ booked }}</strong> bereits gebucht
              </div>

              {% if slot.using_default %}
              <div class="alert alert-info mb-4">
                <i data-lucide="info" class="w-5 h-5"></i>
                <div>
                  <strong>Standard-Verf√ºgbarkeit</strong>
                  <p class="text-sm">F√ºr diesen Termin werden Standard-Berater verwendet. Buchungen sind bis zu 12 Wochen im Voraus m√∂glich.</p>
                </div>
              </div>
              {% endif %}

              {% if slot.overbooked %}
                <div class="alert alert-error mb-4">
                  <i data-lucide="alert-triangle" class="w-5 h-5"></i>
                  <span><strong>ACHTUNG:</strong> √úberbuchung! Es sind zu wenige Berater f√ºr {{ booked }} Termine!</span>
                </div>
              {% elif slot.free_count == 0 %}
                <div class="alert mb-4">
                  <i data-lucide="info" class="w-5 h-5"></i>
                  <span>Alle {{ total }} Slots um {{ hour }} Uhr sind bereits belegt.</span>
                </div>
              {% else %}
                <div class="alert alert-success mb-4">
                  <i data-lucide="check-circle" class="w-5 h-5"></i>
                  <span>Noch {{ slot.free_count }} von {{ total }} Slots verf√ºgbar</span>
                </div>
              {% endif %}

              {% if not slot.overbooked and slot.free_count > 0 %}
              <form method="POST" action="{{ url_for('booking.book') }}" class="space-y-3" onsubmit="return handleBookingSubmit(this)">
                <input type="hidden" name="date" value="{{ date.strftime('%Y-%m-%d') }}">
                <input type="hidden" name="hour" value="{{ hour }}">

                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                  <div class="form-control">
                    <input type="text" name="first_name" placeholder="Vorname" required maxlength="50"
                           class="input input-bordered w-full">
                  </div>
                  <div class="form-control">
                    <input type="text" name="last_name" placeholder="Nachname" required maxlength="50"
                           class="input input-bordered w-full">
                  </div>
                </div>

                <div class="form-control">
                  <textarea name="description" placeholder="Beschreibung (optional)" maxlength="500"
                            class="textarea textarea-bordered w-full" rows="2"></textarea>
                </div>

                <div class="form-control">
                  <select name="color" required class="select select-bordered w-full">
                    <option value="2">üü¢ Normales Potential</option>
                    <option value="7">üîµ Top Potential</option>
                    <option value="5">üü° Closer n√∂tig</option>
                    <option value="3">üü£ R√ºckholung</option>
                  </select>
                </div>

                <button type="submit" class="btn btn-primary w-full gap-2">
                  <i data-lucide="calendar-check" class="w-5 h-5"></i>
                  <span class="button-text">Slot buchen</span>
                  <span class="loading loading-spinner loading-sm hidden"></span>
                </button>
              </form>
              {% endif %}
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// ============================================================================
// ACHIEVEMENT SYSTEM
// ============================================================================
class AchievementSystem {
  constructor() {
    this.notificationQueue = [];
    this.isShowingNotification = false;
    this.pollingInterval = 60000;
    this.maxPollingInterval = 300000;
    this.lastActivity = Date.now();
    this.isPageVisible = true;
    this.consecutiveEmptyResponses = 0;
    this.init();
  }

  init() {
    this.setupPageVisibilityAPI();
    this.setupActivityTracking();
    this.checkForNewBadges();
    this.startSmartPolling();
  }

  setupPageVisibilityAPI() {
    document.addEventListener('visibilitychange', () => {
      this.isPageVisible = !document.hidden;
      if (this.isPageVisible) {
        this.resetPollingInterval();
      } else {
        this.slowDownPolling();
      }
    });
  }

  setupActivityTracking() {
    const activityEvents = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart'];
    let activityThrottle = null;

    const updateActivity = () => {
      this.lastActivity = Date.now();
      this.resetPollingInterval();
    };

    activityEvents.forEach(event => {
      document.addEventListener(event, () => {
        if (!activityThrottle) {
          activityThrottle = setTimeout(() => {
            updateActivity();
            activityThrottle = null;
          }, 5000);
        }
      }, { passive: true });
    });
  }

  startSmartPolling() {
    this.scheduleNextPoll();
  }

  scheduleNextPoll() {
    if (this.pollTimer) clearTimeout(this.pollTimer);

    const interval = this.calculatePollingInterval();
    this.pollTimer = setTimeout(() => {
      this.checkForNewBadges().then(() => {
        this.scheduleNextPoll();
      });
    }, interval);
  }

  calculatePollingInterval() {
    const now = Date.now();
    const timeSinceActivity = now - this.lastActivity;

    if (!this.isPageVisible) {
      return Math.min(this.maxPollingInterval, this.pollingInterval * 3);
    }

    if (timeSinceActivity < 120000) {
      return this.pollingInterval;
    }

    const inactiveMinutes = Math.floor(timeSinceActivity / 60000);
    const backoffFactor = Math.min(Math.pow(1.5, inactiveMinutes), 5);
    return Math.min(this.maxPollingInterval, this.pollingInterval * backoffFactor);
  }

  resetPollingInterval() {
    this.pollingInterval = 60000;
    this.consecutiveEmptyResponses = 0;
  }

  slowDownPolling() {
    this.pollingInterval = Math.min(this.maxPollingInterval, this.pollingInterval * 2);
  }

  async checkForNewBadges() {
    try {
      if (!this.isPageVisible && (Date.now() - this.lastActivity) > 600000) {
        return;
      }

      const response = await fetch('/api/user/badges');
      if (response.ok) {
        const data = await response.json();

        if (data.new_badges && data.new_badges.length > 0) {
          this.resetPollingInterval();
          this.consecutiveEmptyResponses = 0;

          for (const badge of data.new_badges) {
            this.showAchievementNotification(badge);
          }

          await fetch('/api/user/badges/mark-seen', { method: 'POST' });
        } else {
          this.consecutiveEmptyResponses++;
          if (this.consecutiveEmptyResponses >= 5) {
            this.pollingInterval = Math.min(this.maxPollingInterval, this.pollingInterval * 1.2);
          }
        }
      } else {
        this.slowDownPolling();
      }
    } catch (error) {
      console.error('Error checking for new badges:', error);
      this.slowDownPolling();
    }
  }

  showAchievementNotification(badge) {
    this.notificationQueue.push(badge);
    if (!this.isShowingNotification) {
      this.processNotificationQueue();
    }
  }

  async processNotificationQueue() {
    if (this.notificationQueue.length === 0) {
      this.isShowingNotification = false;
      return;
    }

    this.isShowingNotification = true;
    const badge = this.notificationQueue.shift();

    const notification = this.createNotificationElement(badge);
    document.getElementById('achievementContainer').appendChild(notification);

    if (badge.rarity === 'legendary' || badge.rarity === 'mythic') {
      this.createConfetti();
    }

    requestAnimationFrame(() => {
      notification.classList.add('show');
    });

    const hideTimeout = setTimeout(() => {
      this.hideNotification(notification);
    }, 5000);

    const closeBtn = notification.querySelector('.achievement-close');
    closeBtn.addEventListener('click', () => {
      clearTimeout(hideTimeout);
      this.hideNotification(notification);
    });

    setTimeout(() => {
      this.processNotificationQueue();
    }, 6000);
  }

  createNotificationElement(badge) {
    const notification = document.createElement('div');
    notification.className = `achievement-notification glass rounded-2xl overflow-hidden rarity-${badge.rarity}`;

    notification.innerHTML = `
      <div class="bg-gradient-to-r from-primary/20 to-secondary/20 p-4 flex items-center justify-between border-b border-white/10">
        <h4 class="font-bold text-primary uppercase text-sm">Achievement Unlocked!</h4>
        <button class="achievement-close btn btn-ghost btn-sm btn-circle">
          <i data-lucide="x" class="w-4 h-4"></i>
        </button>
      </div>
      <div class="p-6 text-center">
        <div class="achievement-badge rarity-${badge.rarity} mx-auto">
          ${badge.emoji}
        </div>
        <h3 class="text-xl font-bold text-white mb-2">${badge.name}</h3>
        <p class="text-sm text-white/70 mb-3">${badge.description}</p>
        <span class="badge badge-${badge.rarity === 'mythic' ? 'error' : badge.rarity === 'legendary' ? 'warning' : 'primary'}">
          ‚ú® ${badge.rarity.charAt(0).toUpperCase() + badge.rarity.slice(1)}
        </span>
      </div>
    `;

    // Re-initialize Lucide icons in the notification
    setTimeout(() => lucide.createIcons(), 100);

    return notification;
  }

  hideNotification(notification) {
    notification.classList.remove('show');
    setTimeout(() => {
      if (notification.parentNode) {
        notification.parentNode.removeChild(notification);
      }
    }, 500);
  }

  createConfetti() {
    const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#f9ca24', '#f0932b', '#eb4d4b', '#6c5ce7'];

    for (let i = 0; i < 50; i++) {
      const confetti = document.createElement('div');
      confetti.className = 'confetti';
      confetti.style.left = Math.random() * 100 + '%';
      confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
      confetti.style.top = '-10px';

      document.body.appendChild(confetti);

      setTimeout(() => {
        if (confetti.parentNode) {
          confetti.parentNode.removeChild(confetti);
        }
      }, 3000);
    }
  }
}

// Initialize Achievement System
let achievementSystem;
{% if user_level %}
achievementSystem = new AchievementSystem();
{% endif %}

// ============================================================================
// SIDEBAR TOGGLE
// ============================================================================
let sidebarOpen = false;

function toggleSidebar() {
  sidebarOpen = !sidebarOpen;
  const sidebar = document.getElementById('sidebar');
  const mainContent = document.getElementById('mainContent');
  const sidebarToggle = document.getElementById('sidebarToggle');

  if (sidebarOpen) {
    sidebar.classList.remove('-translate-x-full');
    mainContent.classList.add('md:ml-80');
    sidebarToggle.classList.add('md:left-[21rem]');
  } else {
    sidebar.classList.add('-translate-x-full');
    mainContent.classList.remove('md:ml-80');
    sidebarToggle.classList.remove('md:left-[21rem]');
  }

  localStorage.setItem('sidebar-open', sidebarOpen);

  // Re-initialize Lucide icons
  setTimeout(() => lucide.createIcons(), 100);
}

// Restore sidebar state
if (localStorage.getItem('sidebar-open') === 'true' && window.innerWidth >= 768) {
  toggleSidebar();
}

// ============================================================================
// SLOT COLLAPSE/EXPAND
// ============================================================================
function toggleSlot(header) {
  const section = header.parentElement;
  const content = section.querySelector('.slot-content');
  const isExpanded = section.classList.contains('expanded');

  if (isExpanded) {
    content.style.maxHeight = '0';
    content.classList.add('collapsed');
    section.classList.remove('expanded');
  } else {
    content.style.maxHeight = content.scrollHeight + 'px';
    content.classList.remove('collapsed');
    section.classList.add('expanded');
  }
}

function expandAll() {
  document.querySelectorAll('.slot-section').forEach(section => {
    const content = section.querySelector('.slot-content');
    content.style.maxHeight = content.scrollHeight + 'px';
    content.classList.remove('collapsed');
    section.classList.add('expanded');
  });
}

function collapseAll() {
  document.querySelectorAll('.slot-section').forEach(section => {
    const content = section.querySelector('.slot-content');
    content.style.maxHeight = '0';
    content.classList.add('collapsed');
    section.classList.remove('expanded');
  });
}

function jumpToEvening() {
  const eveningSlot = document.querySelector('[data-hour="18:00"]');
  if (eveningSlot) {
    eveningSlot.scrollIntoView({ behavior: 'smooth', block: 'center' });
    const header = eveningSlot.querySelector('.slot-header');
    if (!eveningSlot.classList.contains('expanded')) {
      toggleSlot(header);
    }
  }
}

// Collapse all on mobile by default
if (window.innerWidth < 768) {
  collapseAll();
}

// ============================================================================
// BOOKING FORM HANDLING
// ============================================================================
function handleBookingSubmit(form) {
  const btn = form.querySelector('button[type="submit"]');
  const btnText = btn.querySelector('.button-text');
  const spinner = btn.querySelector('.loading');

  btn.disabled = true;
  btnText.classList.add('hidden');
  spinner.classList.remove('hidden');

  return true;
}

// ============================================================================
// NAVIGATION
// ============================================================================
function navigateDay(direction) {
  const currentDate = new Date("{{ date.strftime('%Y-%m-%d') }}");
  currentDate.setDate(currentDate.getDate() + direction);

  // Skip weekends
  if (currentDate.getDay() === 0) {
    currentDate.setDate(currentDate.getDate() + (direction > 0 ? 1 : -2));
  } else if (currentDate.getDay() === 6) {
    currentDate.setDate(currentDate.getDate() + (direction > 0 ? 2 : -1));
  }

  const dateStr = currentDate.toISOString().split('T')[0];
  window.location.href = `/day/${dateStr}`;
}

// ============================================================================
// LEVEL UP CHECK
// ============================================================================
{% if user_level %}
function checkForLevelUp() {
  fetch('/api/level/check-up')
    .then(response => response.json())
    .then(data => {
      if (data.level_up) {
        showLevelUpModal(data.level_up);
      }
    })
    .catch(error => console.error('Level up check error:', error));
}

function showLevelUpModal(levelUpData) {
  document.getElementById('oldLevel').textContent = levelUpData.old_level;
  document.getElementById('newLevel').textContent = levelUpData.new_level;
  document.getElementById('xpGained').textContent = levelUpData.xp_gained;

  document.getElementById('levelUpModal').showModal();

  // Confetti
  const colors = ['#fbbf24', '#ef4444', '#3b82f6', '#10b981', '#8b5cf6'];
  for (let i = 0; i < 100; i++) {
    const confetti = document.createElement('div');
    confetti.className = 'confetti';
    confetti.style.left = Math.random() * 100 + '%';
    confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
    confetti.style.top = '-10px';
    document.body.appendChild(confetti);
    setTimeout(() => confetti.remove(), 3000);
  }

  // Re-initialize Lucide icons
  setTimeout(() => lucide.createIcons(), 100);
}

// Check on page load
window.addEventListener('load', checkForLevelUp);
{% endif %}

// ============================================================================
// KEYBOARD SHORTCUTS
// ============================================================================
document.addEventListener('keydown', function(e) {
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
    return;
  }

  // Ctrl/Cmd + K - Quick Actions
  if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
    e.preventDefault();
    document.getElementById('quickActionsModal').showModal();
    return;
  }

  // Single key shortcuts
  switch(e.key.toLowerCase()) {
    case 's':
      e.preventDefault();
      toggleSidebar();
      break;
    case 'm':
      e.preventDefault();
      window.location.href = "/my-calendar";
      break;
    case 'p':
      e.preventDefault();
      window.location.href = "{{ url_for('scoreboard.scoreboard') }}";
      break;
    case 'e':
      e.preventDefault();
      jumpToEvening();
      break;
    case 'arrowright':
      e.preventDefault();
      navigateDay(1);
      break;
    case 'arrowleft':
      e.preventDefault();
      navigateDay(-1);
      break;
  }
});

// ============================================================================
// INITIALIZE
// ============================================================================
setTimeout(() => {
  lucide.createIcons();
}, 100);
</script>
{% endblock %}
