<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Slot Buchung</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="{{ url_for('static', filename='admin_style.css') }}">
  <link href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@2.47.0/tabler-icons.min.css" rel="stylesheet">

  <style>
    .panel { padding:16px; margin-bottom:16px; }
    .chip { display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:10px; border:1px solid var(--box-border); background: var(--box-bg); }
    #sidebar-tab {
      position: fixed; left: 14px; top: 18px; z-index: 60;
      width: 40px; height: 40px; border-radius: 50%;
      display:flex; align-items:center; justify-content:center;
      border:1px solid var(--box-border); background: var(--box-bg);
      backdrop-filter: blur(8px) saturate(120%);
      transition: left 0.25s ease;
    }
    body.sidebar-open #sidebar-tab {
      left: 306px;
    }
    
    /* Enhanced Loading States */
    .loading-indicator {
      position: fixed;
      top: 20px;
      right: 20px;
      background: linear-gradient(135deg, var(--accent), #3d8bfd);
      color: white;
      padding: 10px 20px;
      border-radius: 25px;
      display: none;
      z-index: 1000;
      font-weight: 500;
      box-shadow: 0 4px 15px rgba(90,177,255,0.4);
      animation: slideInRight 0.3s ease;
    }
    .loading-indicator.show { display: flex; align-items: center; gap: 10px; }
    .loading-indicator::before {
      content: '';
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    @keyframes slideInRight {
      from { transform: translateX(100px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    /* Button Loading State */
    button.loading {
      position: relative;
      color: transparent !important;
      pointer-events: none;
    }
    button.loading::after {
      content: '';
      position: absolute;
      width: 16px;
      height: 16px;
      top: 50%;
      left: 50%;
      margin-left: -8px;
      margin-top: -8px;
      border: 2px solid var(--accent);
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 0.6s linear infinite;
    }
    
    /* Success Animation */
    .success-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0);
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
      padding: 30px 40px;
      border-radius: 20px;
      z-index: 2000;
      text-align: center;
      box-shadow: 0 10px 40px rgba(16,185,129,0.4);
      animation: successPop 0.6s ease forwards;
    }
    
    .success-popup .icon {
      font-size: 48px;
      margin-bottom: 10px;
      animation: successCheck 0.8s ease 0.3s forwards;
      opacity: 0;
    }
    
    .success-popup .text {
      font-size: 18px;
      font-weight: 600;
      animation: fadeInUp 0.5s ease 0.4s forwards;
      opacity: 0;
    }
    
    @keyframes successPop {
      0% { transform: translate(-50%, -50%) scale(0); }
      50% { transform: translate(-50%, -50%) scale(1.1); }
      100% { transform: translate(-50%, -50%) scale(1); }
    }
    
    @keyframes successCheck {
      0% { transform: scale(0) rotate(-45deg); opacity: 0; }
      50% { transform: scale(1.2) rotate(0deg); opacity: 1; }
      100% { transform: scale(1) rotate(0deg); opacity: 1; }
    }
    
    @keyframes fadeInUp {
      to { transform: translateY(0); opacity: 1; }
      from { transform: translateY(10px); opacity: 0; }
    }
    
    /* Slot Hover Effect */
    .time-section {
      transition: all 0.3s ease;
    }
    .time-section:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(0,0,0,0.2);
    }
    
    /* Form Submit Animation */
    .slot form.submitting {
      animation: pulse 1s ease infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    
    /* Keyboard Shortcut Hints */
    .kbd-hint {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background: var(--box-bg);
      border: 1px solid var(--box-border);
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 12px;
      color: var(--muted);
      display: none;
      z-index: 100;
      backdrop-filter: blur(10px);
    }
    .kbd-hint.show { display: block; animation: fadeIn 0.3s ease; }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .kbd {
      background: rgba(255,255,255,0.1);
      padding: 2px 6px;
      border-radius: 4px;
      border: 1px solid rgba(255,255,255,0.2);
      font-family: monospace;
      margin: 0 2px;
    }
    
    /* Quick Actions Panel */
    .quick-actions {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.95);
      background: var(--box-bg);
      border: 1px solid var(--box-border);
      border-radius: 16px;
      padding: 20px;
      width: 90%;
      max-width: 500px;
      z-index: 1500;
      opacity: 0;
      pointer-events: none;
      transition: all 0.2s ease;
      backdrop-filter: blur(20px);
    }
    
    .quick-actions.show {
      transform: translate(-50%, -50%) scale(1);
      opacity: 1;
      pointer-events: all;
    }
    
    .quick-actions h3 {
      margin: 0 0 15px;
      color: var(--accent);
    }
    
    .quick-actions .action-item {
      padding: 10px;
      margin: 5px 0;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .quick-actions .action-item:hover {
      background: rgba(90,177,255,0.1);
      transform: translateX(5px);
    }
    
    .quick-actions .shortcut {
      margin-left: auto;
      opacity: 0.6;
    }
    
    /* Overlay for modals */
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1400;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    
    .overlay.show {
      opacity: 1;
      pointer-events: all;
    }
    
    /* External Links Button Style */
    .external-links {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }
    
    .external-links a {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      background: var(--box-bg);
      border: 1px solid var(--box-border);
      border-radius: 10px;
      color: var(--text-color);
      text-decoration: none;
      transition: all 0.2s ease;
      font-size: 14px;
    }
    
    .external-links a:hover {
      transform: translateY(-2px);
      border-color: var(--accent);
      background: rgba(90,177,255,0.1);
    }
  </style>
</head>
<body>
  <!-- Loading Indicator (Enhanced) -->
  <div class="loading-indicator" id="loadingIndicator">L√§dt...</div>
  
  <!-- Success Popup -->
  <div class="success-popup" id="successPopup" style="display:none;">
    <div class="icon">‚úÖ</div>
    <div class="text">Erfolgreich gebucht!</div>
  </div>
  
  <!-- Keyboard Hints -->
  <div class="kbd-hint" id="kbdHint">
    Dr√ºcke <kbd>?</kbd> f√ºr Tastaturk√ºrzel
  </div>
  
  <!-- Quick Actions Panel (Command Palette) -->
  <div class="overlay" id="overlay"></div>
  <div class="quick-actions" id="quickActions">
    <h3>‚ö° Quick Actions</h3>
    <div class="action-item" data-action="toggle-sidebar">
      <span>üìä Sidebar toggle</span>
      <span class="shortcut"><kbd>S</kbd></span>
    </div>
    <div class="action-item" data-action="toggle-theme">
      <span>üåô Theme wechseln</span>
      <span class="shortcut"><kbd>T</kbd></span>
    </div>
    <div class="action-item" data-action="my-calendar">
      <span>üë§ Meine Buchungen</span>
      <span class="shortcut"><kbd>M</kbd></span>
    </div>
    <div class="action-item" data-action="scoreboard">
      <span>üèÜ Scoreboard</span>
      <span class="shortcut"><kbd>P</kbd></span>
    </div>
    <div class="action-item" data-action="next-day">
      <span‚û°Ô∏è N√§chster Tag</span>
      <span class="shortcut"><kbd>‚Üí</kbd></span>
    </div>
    <div class="action-item" data-action="prev-day">
      <span>‚¨ÖÔ∏è Vorheriger Tag</span>
      <span class="shortcut"><kbd>‚Üê</kbd></span>
    </div>
    <div style="margin-top:15px; padding-top:15px; border-top:1px solid var(--box-border); color:var(--muted); font-size:12px;">
      <kbd>ESC</kbd> zum Schlie√üen ‚Ä¢ <kbd>Ctrl+K</kbd> oder <kbd>Cmd+K</kbd> √∂ffnet diese Ansicht
    </div>
  </div>
  
  <!-- Light/Dark Toggle -->
  <button id="mode-toggle" aria-label="Modus wechseln">üåô</button>
  <!-- Sidebar Toggle -->
  <button id="sidebar-tab" title="Men√º">‚â°</button>

  <!-- Sidebar -->
  <div class="sidebar collapsed" id="sidebar">
    <p><strong>üìä Wochenauslastung</strong></p>
    {% for week in weekly_summary %}
      <a href="{{ url_for('day_view', date_str=week.start_date) }}"
         class="kw-link{% if week.current %} active{% endif %}">
        {{ week.label }} ({{ week.range }})
        <span style="float:right; font-size:0.95em; color:#999;">{{ week.usage_pct }}%</span>
      </a>
      <div style="background-color:#444; height:8px; border-radius:4px; overflow:hidden; margin-bottom:10px;">
        <div style="background-color:
          {% if week.usage < 0.5 %}var(--green)
          {% elif week.usage < 0.8 %}var(--yellow)
          {% elif week.usage < 0.95 %}var(--orange)
          {% else %}var(--red){% endif %};
          width: {{ week.usage_pct }}%; height:100%; transition: width 0.3s ease;"></div>
      </div>
      <div class="text-sm text-muted">{{ week.booked }}/{{ week.possible }} gebucht</div>
    {% endfor %}

    <div class="slot-suggest-box">
      <div class="slot-suggest-title">üí° Slot-Vorschl√§ge</div>
      {% if slot_suggestions %}
        <table class="slot-suggest-table">
          <thead><tr><th>Datum</th><th>Uhrzeit</th><th>Punkte</th><th>Frei</th></tr></thead>
          <tbody>
            {% for s in slot_suggestions %}
              <tr><td>{{ s.date }}</td><td>{{ s.hour }}</td><td class="slot-suggest-pts">{{ s.punkte }}</td><td>{{ s.freie }}</td></tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <div style="font-size:0.96em; color:var(--yellow);">Aktuell keine Vorschl√§ge.</div>
      {% endif %}
    </div>
  </div>

  <!-- Main -->
  <div class="main" id="main">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% for category, message in messages %}
        <div class="flash-{{ category }}">{{ message }}</div>
      {% endfor %}
    {% endwith %}

    <!-- Quick Links -->
    <section class="glass panel">
      <h2>üîó Quick Links</h2>
      <div class="external-links">
        <a href="https://calendar.google.com" target="_blank">
          üìÖ Google Kalender √∂ffnen
        </a>
        <a href="{{ url_for('my_calendar') }}">
          üìã Meine Buchungen
        </a>
        <a href="{{ url_for('scoreboard') }}">
          üèÜ Scoreboard
        </a>
      </div>
    </section>

    <!-- 4‚ÄëWochen Auslastung -->
    <section id="auslastung" class="glass panel">
      <h2>üìä Wochenauslastung (n√§chste 4 Wochen)</h2>
      <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:16px;">
        {% for w in weekly_summary[:4] %}
          {% set ratio = (w.booked / (w.possible + 0.001)) if w.possible > 0 else 0 %}
          {% set cls = "background:rgba(16,185,129,.20); border-color:rgba(16,185,129,.35);" if ratio < 0.5 else
                       "background:rgba(234,179,8,.20); border-color:rgba(234,179,8,.35);" if ratio < 0.8 else
                       "background:rgba(249,115,22,.20); border-color:rgba(249,115,22,.35);" if ratio < 1 else
                       "background:rgba(239,68,68,.20); border-color:rgba(239,68,68,.35);" %}
          <div class="glass-soft" style="padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,.12); {{ cls }}">
            <div style="font-size:.9em; color:#cbd5e1">{{ w.label }}</div>
            <div style="font-size:1.6em; font-weight:700">{{ w.usage_pct }}%</div>
            <div style="font-size:.85em; color:#94a3b8">{{ w.booked }} / {{ w.possible }} gebucht</div>
            <div style="font-size:.8em; color:#94a3b8">{{ w.range }}</div>
          </div>
        {% endfor %}
      </div>

      {% if slot_suggestions %}
      <div class="glass-soft" style="padding:12px; margin-top:12px;">
        <div class="text-sm" style="color:#cbd5e1; margin-bottom:6px;">üéØ Empfohlene Slots (mit Punkten)</div>
        <div style="display:flex; flex-wrap:wrap; gap:8px;">
          {% for s in slot_suggestions[:5] %}
            <div class="chip">
              <span>{{ s.date }}</span> ‚Ä¢ 
              <span>{{ s.hour }}</span> ‚Ä¢ 
              <span style="color:var(--green);">{{ s.punkte }} Pkt</span> ‚Ä¢ 
              <span style="color:var(--accent);">{{ s.freie }} frei</span>
            </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}
    </section>

    <!-- Buchung -->
    <section id="buchung" class="glass panel">
      <h2>üìù Slot-Buchung f√ºr {{ date.strftime('%A, %d.%m.%Y') }}</h2>
      <div class="nav">
        {% for d in days %}
          <a href="{{ url_for('day_view', date_str=d.strftime('%Y-%m-%d')) }}" class="{% if d == date %}active{% endif %}">
            {{ d.strftime('%a, %d.%m') }}
          </a>
        {% endfor %}
      </div>

      {% for hour, slot in slots.items() %}
        {% set total = slot.total %}
        {% set booked = slot.booked %}
        {% set ratio = (booked / (total + 0.001)) if total > 0 else 0 %}
        {% set color = 'green' %}
        {% if slot.overbooked %}
          {% set color = 'red' %}
        {% elif ratio >= 1.0 %}
          {% set color = 'red' %}
        {% elif ratio >= 0.8 %}
          {% set color = 'orange' %}
        {% elif ratio >= 0.5 %}
          {% set color = 'yellow' %}
        {% endif %}

        <div class="time-section {{ color }}">
          <div class="info" style="width:100%;">
            <div><strong>üïí {{ hour }} Uhr</strong></div>
            <div>
              Berater verf√ºgbar: <strong>{{ slot.available_beraters }}</strong> | 
              Kapazit√§t: <strong>{{ total }}</strong> Pl√§tze | 
              Gebucht: <strong>{{ booked }}</strong>
            </div>

            {% if slot.overbooked %}
              <div style="color: var(--red); font-weight: bold; margin: 5px 0;">
                ‚ö†Ô∏è ACHTUNG: √úberbuchung! Es sind zu wenige Berater f√ºr {{ booked }} Termine!
              </div>
            {% elif slot.free_count == 0 %}
              <div style="color:#ccc; font-style: italic;">
                ‚ö†Ô∏è Alle {{ total }} Slots um {{ hour }} Uhr sind bereits belegt.
              </div>
            {% else %}
              <div style="color: var(--green); margin: 5px 0;">
                ‚úÖ Noch {{ slot.free_count }} von {{ total }} Slots verf√ºgbar
              </div>
            {% endif %}

            {% if not slot.overbooked and slot.free_count > 0 %}
              {% for s in slot.events %}
                <div class="slot">
                  <form method="POST" action="{{ url_for('book') }}" onsubmit="showLoading()">
                    <input type="hidden" name="slot_id" value="{{ s.id }}">
                    <input type="hidden" name="date" value="{{ date.strftime('%Y-%m-%d') }}">
                    <input type="hidden" name="hour" value="{{ hour }}">
                    <input type="text" name="first_name" placeholder="Vorname" required maxlength="50">
                    <input type="text" name="last_name" placeholder="Nachname" required maxlength="50">
                    <textarea name="description" placeholder="Beschreibung (optional)" maxlength="500"></textarea>
                    <select name="color" required style="margin-left:8px;">
                      <option value="2">üü¢ Normales Potential</option>
                      <option value="7">üîµ Top Potential</option>
                      <option value="5">üü° Closer n√∂tig</option>
<option value="3">üü£ R√ºckholung</option>
                    </select>
                    <button type="submit">Slot buchen</button>
                  </form>
                </div>
              {% endfor %}
            {% endif %}
          </div>
        </div>
      {% endfor %}
    </section>
  </div>

  <script>
    // Enhanced Loading States
    function showLoading(text = 'L√§dt...') {
      const indicator = document.getElementById('loadingIndicator');
      indicator.textContent = text;
      indicator.classList.add('show');
    }
    
    function hideLoading() {
      document.getElementById('loadingIndicator').classList.remove('show');
    }
    
    // Success Animation
    function showSuccess(message = 'Erfolgreich gebucht!') {
      const popup = document.getElementById('successPopup');
      popup.querySelector('.text').textContent = message;
      popup.style.display = 'block';
      
      // Entferne nach Animation
      setTimeout(() => {
        popup.style.display = 'none';
      }, 2000);
    }
    
    // Enhanced Form Submit with Loading States
    document.querySelectorAll('.slot form').forEach(form => {
      form.addEventListener('submit', function(e) {
        const btn = this.querySelector('button[type="submit"]');
        btn.classList.add('loading');
        btn.disabled = true;
        this.classList.add('submitting');
        showLoading('Buchung wird verarbeitet...');
        
        // Success wird vom Server via Flash Message getriggert
        setTimeout(() => {
          if (document.querySelector('.flash-success')) {
            showSuccess();
          }
        }, 500);
      });
    });
    
    // Theme Toggle mit LocalStorage und Animation
    const body = document.body;
    const modeToggle = document.getElementById("mode-toggle");
    
    function setMode(dark, animate = true) {
      if (animate) {
        body.style.transition = 'background 0.3s ease';
      }
      body.classList.toggle('lightmode', !dark);
      body.classList.toggle('darkmode', dark);
      modeToggle.innerHTML = dark ? 'üåô' : '‚òÄÔ∏è';
      localStorage.setItem('theme', dark ? 'dark' : 'light');
    }
    
    // Theme beim Laden setzen
    window.addEventListener('DOMContentLoaded', () => {
      const savedTheme = localStorage.getItem('theme');
      setMode(savedTheme !== 'light', false);
      
      // Show keyboard hint after 3 seconds
      setTimeout(() => {
        document.getElementById('kbdHint').classList.add('show');
        setTimeout(() => {
          document.getElementById('kbdHint').classList.remove('show');
        }, 5000);
      }, 3000);
    });
    
    modeToggle.onclick = () => setMode(!body.classList.contains('darkmode'));

    // Sidebar Toggle mit Animation
    const sidebar = document.getElementById("sidebar");
    const main = document.getElementById("main");
    const sidebarTab = document.getElementById("sidebar-tab");
    
    function toggleSidebar() {
      const collapsed = sidebar.classList.toggle("collapsed");
      main.classList.toggle("with-sidebar", !collapsed);
      body.classList.toggle("sidebar-open", !collapsed);
      localStorage.setItem('sidebar-open', !collapsed);
    }
    
    // Sidebar Status aus LocalStorage laden
    const sidebarOpen = localStorage.getItem('sidebar-open') === 'true';
    if (sidebarOpen) {
      sidebar.classList.remove("collapsed");
      main.classList.add("with-sidebar");
      body.classList.add("sidebar-open");
    }
    
    sidebarTab.addEventListener("click", toggleSidebar);
    
    // KEYBOARD SHORTCUTS
    const quickActions = document.getElementById('quickActions');
    const overlay = document.getElementById('overlay');
    
    function showQuickActions() {
      quickActions.classList.add('show');
      overlay.classList.add('show');
    }
    
    function hideQuickActions() {
      quickActions.classList.remove('show');
      overlay.classList.remove('show');
    }
    
    // Quick Actions Click Handler
    document.querySelectorAll('.action-item').forEach(item => {
      item.addEventListener('click', function() {
        const action = this.dataset.action;
        hideQuickActions();
        
        switch(action) {
          case 'toggle-sidebar':
            toggleSidebar();
            break;
          case 'toggle-theme':
            setMode(!body.classList.contains('darkmode'));
            break;
          case 'my-calendar':
            window.location.href = "{{ url_for('my_calendar') }}";
            break;
          case 'scoreboard':
            window.location.href = "{{ url_for('scoreboard') }}";
            break;
          case 'next-day':
            navigateDay(1);
            break;
          case 'prev-day':
            navigateDay(-1);
            break;
        }
      });
    });
    
    // Navigate days
    function navigateDay(direction) {
      const currentDate = new Date("{{ date.strftime('%Y-%m-%d') }}");
      currentDate.setDate(currentDate.getDate() + direction);
      
      // Skip weekends
      if (currentDate.getDay() === 0) { // Sunday
        currentDate.setDate(currentDate.getDate() + (direction > 0 ? 1 : -2));
      } else if (currentDate.getDay() === 6) { // Saturday
        currentDate.setDate(currentDate.getDate() + (direction > 0 ? 2 : -1));
      }
      
      const dateStr = currentDate.toISOString().split('T')[0];
      window.location.href = `/day/${dateStr}`;
    }
    
    // Keyboard Event Listener
    document.addEventListener('keydown', function(e) {
      // Ignoriere wenn in Input/Textarea
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
        return;
      }
      
      // Cmd/Ctrl + K - Quick Actions
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault();
        showQuickActions();
        return;
      }
      
      // ESC - Close modals
      if (e.key === 'Escape') {
        hideQuickActions();
        if (!sidebar.classList.contains('collapsed')) {
          toggleSidebar();
        }
        return;
      }
      
      // ? - Show help
      if (e.key === '?' && !e.shiftKey) {
        e.preventDefault();
        showQuickActions();
        return;
      }
      
      // Single key shortcuts (not in modals)
      if (!quickActions.classList.contains('show')) {
        switch(e.key.toLowerCase()) {
          case 's':
            e.preventDefault();
            toggleSidebar();
            break;
          case 't':
            e.preventDefault();
            setMode(!body.classList.contains('darkmode'));
            break;
          case 'm':
            e.preventDefault();
            window.location.href = "{{ url_for('my_calendar') }}";
            break;
          case 'p':
            e.preventDefault();
            window.location.href = "{{ url_for('scoreboard') }}";
            break;
          case 'arrowright':
            e.preventDefault();
            navigateDay(1);
            break;
          case 'arrowleft':
            e.preventDefault();
            navigateDay(-1);
            break;
        }
      }
    });
    
    // Close Quick Actions on overlay click
    overlay.addEventListener('click', hideQuickActions);
    
    // Check for success message on page load
    window.addEventListener('load', () => {
      const successMsg = document.querySelector('.flash-success');
      if (successMsg) {
        setTimeout(() => showSuccess(successMsg.textContent), 500);
      }
    });
  </script>
</body>
</html>