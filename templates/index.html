<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Slot Buchung</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="{{ url_for('static', filename='admin_style.css') }}">
  <link href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@2.47.0/tabler-icons.min.css" rel="stylesheet">

  <style>
    .panel { padding:16px; margin-bottom:16px; }
    .chip { display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:10px; border:1px solid var(--box-border); background: var(--box-bg); }
    #sidebar-tab {
      position: fixed; left: 14px; top: 18px; z-index: 60;
      width: 40px; height: 40px; border-radius: 50%;
      display:flex; align-items:center; justify-content:center;
      border:1px solid var(--box-border); background: var(--box-bg);
      backdrop-filter: blur(8px) saturate(120%);
      transition: left 0.25s ease;
    }
    body.sidebar-open #sidebar-tab {
      left: 306px;
    }
    /* Achievement Popup System */
.achievement-notification {
  position: fixed;
  top: 20px;
  right: 20px;
  z-index: 2000;
  max-width: 400px;
  background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(255,255,255,0.85));
  border: 1px solid rgba(255,255,255,0.2);
  border-radius: 20px;
  padding: 0;
  box-shadow: 0 20px 60px rgba(0,0,0,0.3);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  transform: translateX(450px);
  transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
  opacity: 0;
  pointer-events: none;
  overflow: hidden;
}

.achievement-notification.show {
  transform: translateX(0);
  opacity: 1;
  pointer-events: all;
}

/* Dark Mode Anpassungen */
body.darkmode .achievement-notification {
  background: linear-gradient(135deg, rgba(30,41,59,0.95), rgba(30,41,59,0.85));
  border-color: rgba(255,255,255,0.1);
}

/* Rarity Glow Effects */
.achievement-notification.rarity-common { box-shadow: 0 20px 60px rgba(16,185,129,0.2), 0 0 40px rgba(16,185,129,0.1); }
.achievement-notification.rarity-uncommon { box-shadow: 0 20px 60px rgba(59,130,246,0.2), 0 0 40px rgba(59,130,246,0.1); }
.achievement-notification.rarity-rare { box-shadow: 0 20px 60px rgba(139,92,246,0.2), 0 0 40px rgba(139,92,246,0.1); }
.achievement-notification.rarity-epic { box-shadow: 0 20px 60px rgba(245,158,11,0.2), 0 0 40px rgba(245,158,11,0.1); }
.achievement-notification.rarity-legendary { box-shadow: 0 20px 60px rgba(234,179,8,0.3), 0 0 40px rgba(234,179,8,0.2); }
.achievement-notification.rarity-mythic { box-shadow: 0 20px 60px rgba(236,72,153,0.3), 0 0 40px rgba(236,72,153,0.2); }

.achievement-header {
  background: linear-gradient(135deg, rgba(90,177,255,0.1), rgba(90,177,255,0.05));
  padding: 15px 20px 10px;
  border-bottom: 1px solid rgba(255,255,255,0.1);
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.achievement-title {
  color: var(--accent);
  font-size: 14px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 1px;
  margin: 0;
}

.achievement-close {
  background: none;
  border: none;
  color: var(--muted);
  font-size: 20px;
  cursor: pointer;
  padding: 0;
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  transition: all 0.2s ease;
}

.achievement-close:hover {
  background: rgba(255,255,255,0.1);
  transform: scale(1.1);
}

.achievement-content {
  padding: 20px;
  text-align: center;
}

.achievement-badge {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto 15px;
  position: relative;
  font-size: 40px;
  transition: all 0.3s ease;
  animation: badgePulse 2s ease infinite;
}

/* Rarity Badge Backgrounds */
.achievement-badge.rarity-common { background: linear-gradient(135deg, #10b981, #059669); }
.achievement-badge.rarity-uncommon { background: linear-gradient(135deg, #3b82f6, #2563eb); }
.achievement-badge.rarity-rare { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
.achievement-badge.rarity-epic { background: linear-gradient(135deg, #f59e0b, #d97706); }
.achievement-badge.rarity-legendary { background: linear-gradient(135deg, #eab308, #ca8a04); }
.achievement-badge.rarity-mythic { background: linear-gradient(135deg, #ec4899, #db2777); }

.achievement-badge::before {
  content: '';
  position: absolute;
  top: -3px;
  left: -3px;
  right: -3px;
  bottom: -3px;
  border-radius: 50%;
  background: inherit;
  opacity: 0.3;
  animation: ripple 1.5s ease infinite;
}

.achievement-name {
  font-size: 20px;
  font-weight: 700;
  color: var(--text-color);
  margin: 0 0 8px;
  line-height: 1.2;
}

.achievement-description {
  font-size: 14px;
  color: var(--muted);
  margin: 0 0 15px;
  line-height: 1.4;
}

.achievement-rarity {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.achievement-rarity.rarity-common { background: rgba(16,185,129,0.2); color: #10b981; border: 1px solid rgba(16,185,129,0.3); }
.achievement-rarity.rarity-uncommon { background: rgba(59,130,246,0.2); color: #3b82f6; border: 1px solid rgba(59,130,246,0.3); }
.achievement-rarity.rarity-rare { background: rgba(139,92,246,0.2); color: #8b5cf6; border: 1px solid rgba(139,92,246,0.3); }
.achievement-rarity.rarity-epic { background: rgba(245,158,11,0.2); color: #f59e0b; border: 1px solid rgba(245,158,11,0.3); }
.achievement-rarity.rarity-legendary { background: rgba(234,179,8,0.2); color: #eab308; border: 1px solid rgba(234,179,8,0.3); }
.achievement-rarity.rarity-mythic { background: rgba(236,72,153,0.2); color: #ec4899; border: 1px solid rgba(236,72,153,0.3); }

/* Animations */
@keyframes badgePulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.05); }
}

@keyframes ripple {
  0% { transform: scale(0.8); opacity: 1; }
  100% { transform: scale(1.4); opacity: 0; }
}

@keyframes celebrate {
  0%, 100% { transform: scale(1) rotate(0deg); }
  25% { transform: scale(1.1) rotate(-5deg); }
  75% { transform: scale(1.1) rotate(5deg); }
}

/* Confetti Animation */
.confetti {
  position: absolute;
  width: 10px;
  height: 10px;
  background: var(--accent);
  animation: confettiFall 3s linear infinite;
}

@keyframes confettiFall {
  to {
    transform: translateY(100vh) rotate(360deg);
  }
}

/* Mobile Anpassungen */
@media (max-width: 768px) {
  .achievement-notification {
    top: 10px;
    right: 10px;
    left: 10px;
    max-width: none;
    transform: translateY(-100px);
  }
  
  .achievement-notification.show {
    transform: translateY(0);
  }
  
  .achievement-content {
    padding: 15px;
  }
  
  .achievement-badge {
    width: 60px;
    height: 60px;
    font-size: 30px;
  }
}

/* Sound Wave Effect f√ºr besonders seltene Badges */
.achievement-notification.rarity-legendary .achievement-badge,
.achievement-notification.rarity-mythic .achievement-badge {
  animation: badgePulse 2s ease infinite, celebrate 0.6s ease;
}

.achievement-notification.rarity-mythic {
  animation: shake 0.5s ease;
}

@keyframes shake {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-5px); }
  75% { transform: translateX(5px); }
}
    /* Enhanced Loading States */
    .loading-indicator {
      position: fixed;
      top: 20px;
      right: 20px;
      background: linear-gradient(135deg, var(--accent), #3d8bfd);
      color: white;
      padding: 10px 20px;
      border-radius: 25px;
      display: none;
      z-index: 1000;
      font-weight: 500;
      box-shadow: 0 4px 15px rgba(90,177,255,0.4);
      animation: slideInRight 0.3s ease;
    }
    .loading-indicator.show { display: flex; align-items: center; gap: 10px; }
    .loading-indicator::before {
      content: '';
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    @keyframes slideInRight {
      from { transform: translateX(100px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    /* Button Loading State */
    button.loading {
      position: relative;
      color: transparent !important;
      pointer-events: none;
    }
    button.loading::after {
      content: '';
      position: absolute;
      width: 16px;
      height: 16px;
      top: 50%;
      left: 50%;
      margin-left: -8px;
      margin-top: -8px;
      border: 2px solid var(--accent);
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 0.6s linear infinite;
    }
    
    /* Success Animation */
    .success-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0);
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
      padding: 30px 40px;
      border-radius: 20px;
      z-index: 2000;
      text-align: center;
      box-shadow: 0 10px 40px rgba(16,185,129,0.4);
      animation: successPop 0.6s ease forwards;
    }
    
    .success-popup .icon {
      font-size: 48px;
      margin-bottom: 10px;
      animation: successCheck 0.8s ease 0.3s forwards;
      opacity: 0;
    }
    
    .success-popup .text {
      font-size: 18px;
      font-weight: 600;
      animation: fadeInUp 0.5s ease 0.4s forwards;
      opacity: 0;
    }
    
    @keyframes successPop {
      0% { transform: translate(-50%, -50%) scale(0); }
      50% { transform: translate(-50%, -50%) scale(1.1); }
      100% { transform: translate(-50%, -50%) scale(1); }
    }
    
    @keyframes successCheck {
      0% { transform: scale(0) rotate(-45deg); opacity: 0; }
      50% { transform: scale(1.2) rotate(0deg); opacity: 1; }
      100% { transform: scale(1) rotate(0deg); opacity: 1; }
    }
    
    @keyframes fadeInUp {
      to { transform: translateY(0); opacity: 1; }
      from { transform: translateY(10px); opacity: 0; }
    }
    
    /* Kollabierbare Slot-Styles */
    .time-section {
      transition: all 0.3s ease;
      margin-bottom: 12px;
      overflow: hidden;
    }
    
    .time-section.collapsible {
      padding: 0;
    }
    
    /* Farbcodierte Header basierend auf Verf√ºgbarkeit */
    .slot-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 16px;
      cursor: pointer;
      user-select: none;
      transition: all 0.2s ease;
      border-radius: var(--radius-lg);
      border: 1px solid var(--box-border);
      background: var(--box-bg);
    }
    
    /* Farbcodierung f√ºr Header */
    .time-section.green .slot-header {
      background: linear-gradient(135deg, rgba(16,185,129,0.08), rgba(16,185,129,0.03));
      border-color: rgba(16,185,129,0.25);
    }
    
    .time-section.yellow .slot-header {
      background: linear-gradient(135deg, rgba(234,179,8,0.08), rgba(234,179,8,0.03));
      border-color: rgba(234,179,8,0.25);
    }
    
    .time-section.orange .slot-header {
      background: linear-gradient(135deg, rgba(249,115,22,0.08), rgba(249,115,22,0.03));
      border-color: rgba(249,115,22,0.25);
    }
    
    .time-section.red .slot-header {
      background: linear-gradient(135deg, rgba(239,68,68,0.08), rgba(239,68,68,0.03));
      border-color: rgba(239,68,68,0.25);
    }
    
    .slot-header:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .slot-header-info {
      display: flex;
      align-items: center;
      gap: 20px;
      flex-wrap: wrap;
    }
    
    .slot-time {
      font-size: 16px;
      min-width: 120px;
      font-weight: 600;
    }
    
    .slot-stats {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      color: var(--muted);
    }
    
    .stat-item {
      white-space: nowrap;
    }
    
    .stat-divider {
      opacity: 0.3;
    }
    
    /* Status-Badges */
    .status-badge {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    
    .status-badge.available {
      background: rgba(16,185,129,0.15);
      color: #10b981;
      border: 1px solid rgba(16,185,129,0.3);
    }
    
    .status-badge.limited {
      background: rgba(234,179,8,0.15);
      color: #eab308;
      border: 1px solid rgba(234,179,8,0.3);
    }
    
    .status-badge.full {
      background: rgba(239,68,68,0.15);
      color: #ef4444;
      border: 1px solid rgba(239,68,68,0.3);
    }
    
    .slot-toggle {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: rgba(255,255,255,0.05);
      transition: all 0.3s ease;
    }
    
    .toggle-icon {
      font-size: 12px;
      transition: transform 0.3s ease;
      color: var(--muted);
    }
    
    .time-section.expanded .toggle-icon {
      transform: rotate(180deg);
    }
    
    .slot-content {
      padding: 16px;
      border-top: 1px solid var(--box-border);
      animation: slideDown 0.3s ease;
    }
    
    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    /* Form Submit Animation */
    .slot form.submitting {
      animation: pulse 1s ease infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    
    /* Keyboard Shortcut Hints */
    .kbd-hint {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background: var(--box-bg);
      border: 1px solid var(--box-border);
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 12px;
      color: var(--muted);
      display: none;
      z-index: 100;
      backdrop-filter: blur(10px);
    }
    .kbd-hint.show { display: block; animation: fadeIn 0.3s ease; }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .kbd {
      background: rgba(255,255,255,0.1);
      padding: 2px 6px;
      border-radius: 4px;
      border: 1px solid rgba(255,255,255,0.2);
      font-family: monospace;
      margin: 0 2px;
    }
    
    /* Quick Actions Panel */
    .quick-actions {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.95);
      background: var(--box-bg);
      border: 1px solid var(--box-border);
      border-radius: 16px;
      padding: 20px;
      width: 90%;
      max-width: 500px;
      z-index: 1500;
      opacity: 0;
      pointer-events: none;
      transition: all 0.2s ease;
      backdrop-filter: blur(20px);
    }
    
    .quick-actions.show {
      transform: translate(-50%, -50%) scale(1);
      opacity: 1;
      pointer-events: all;
    }
    
    .quick-actions h3 {
      margin: 0 0 15px;
      color: var(--accent);
    }
    
    .quick-actions .action-item {
      padding: 10px;
      margin: 5px 0;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .quick-actions .action-item:hover {
      background: rgba(90,177,255,0.1);
      transform: translateX(5px);
    }
    
    .quick-actions .shortcut {
      margin-left: auto;
      opacity: 0.6;
    }
    
    /* Overlay for modals */
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1400;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    
    .overlay.show {
      opacity: 1;
      pointer-events: all;
    }
    
    /* External Links Button Style */
    .external-links {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }
    
    .external-links a {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      background: var(--box-bg);
      border: 1px solid var(--box-border);
      border-radius: 10px;
      color: var(--text-color);
      text-decoration: none;
      transition: all 0.2s ease;
      font-size: 14px;
    }
    
    .external-links a:hover {
      transform: translateY(-2px);
      border-color: var(--accent);
      background: rgba(90,177,255,0.1);
    }
    
    /* Admin Dashboard Link Styling */
    .admin-dashboard-link {
      background: linear-gradient(135deg, #ff6b6b, #ee5a24) !important;
      color: white !important;
      border-color: #ff6b6b !important;
    }
    
    .admin-dashboard-link:hover {
      background: linear-gradient(135deg, #ee5a24, #ff6b6b) !important;
      transform: translateY(-2px);
    }
    
    /* Mobile Responsive */
    @media (max-width: 768px) {
      .slot-header-info {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }
      
      .slot-stats {
        font-size: 12px;
      }
    }
    
    /* Visueller Indikator f√ºr Abendtermine */
    .time-section[data-hour="18:00"],
    .time-section[data-hour="20:00"] {
      position: relative;
    }
    
    .time-section[data-hour="18:00"]::before {
      content: "üåÜ Abend";
      position: absolute;
      top: -10px;
      left: 16px;
      font-size: 11px;
      color: var(--muted);
      background: var(--box-bg);
      padding: 2px 8px;
      border-radius: 6px;
      z-index: 1;
    }
    
    /* Highlight Animation */
    @keyframes highlight {
      0% { box-shadow: 0 0 0 0 rgba(90,177,255,0.5); }
      50% { box-shadow: 0 0 20px 10px rgba(90,177,255,0.3); }
      100% { box-shadow: 0 0 0 0 rgba(90,177,255,0); }
    }
  </style>
</head>
<body>
  <!-- Loading Indicator (Enhanced) -->
  <div class="loading-indicator" id="loadingIndicator">L√§dt...</div>
  
  <!-- Success Popup -->
  <div class="success-popup" id="successPopup" style="display:none;">
    <div class="icon">‚úÖ</div>
    <div class="text">Erfolgreich gebucht!</div>
  </div>
  
  <!-- Keyboard Hints -->
  <div class="kbd-hint" id="kbdHint">
    Dr√ºcke <kbd>?</kbd> f√ºr Tastaturk√ºrzel
  </div>
  
  <!-- Quick Actions Panel (Command Palette) -->
  <div class="overlay" id="overlay"></div>
  <div class="quick-actions" id="quickActions">
    <h3>‚ö° Quick Actions</h3>
    <div class="action-item" data-action="toggle-sidebar">
      <span>üìä Sidebar toggle</span>
      <span class="shortcut"><kbd>S</kbd></span>
    </div>
    <div class="action-item" data-action="toggle-theme">
      <span>üåô Theme wechseln</span>
      <span class="shortcut"><kbd>T</kbd></span>
    </div>
    <div class="action-item" data-action="my-calendar">
      <span>üë§ Meine Buchungen</span>
      <span class="shortcut"><kbd>M</kbd></span>
    </div>
    <div class="action-item" data-action="scoreboard">
      <span>üèÜ Scoreboard</span>
      <span class="shortcut"><kbd>P</kbd></span>
    </div>
    {% if session.get('user') in ['admin', 'administrator', 'Jose', 'Simon'] %}
    <div class="action-item" data-action="admin-dashboard">
      <span>ü§ñ Admin Dashboard</span>
      <span class="shortcut"><kbd>A</kbd></span>
    </div>
    {% endif %}
    <div class="action-item" data-action="next-day">
      <span>‚û°Ô∏è N√§chster Tag</span>
      <span class="shortcut"><kbd>‚Üí</kbd></span>
    </div>
    <div class="action-item" data-action="prev-day">
      <span>‚¨ÖÔ∏è Vorheriger Tag</span>
      <span class="shortcut"><kbd>‚Üê</kbd></span>
    </div>
    <div style="margin-top:15px; padding-top:15px; border-top:1px solid var(--box-border); color:var(--muted); font-size:12px;">
      <kbd>ESC</kbd> zum Schlie√üen ‚Ä¢ <kbd>Ctrl+K</kbd> oder <kbd>Cmd+K</kbd> √∂ffnet diese Ansicht
    </div>
  </div>
  
  <!-- Light/Dark Toggle -->
  <button id="mode-toggle" aria-label="Modus wechseln">üåô</button>
  <!-- Sidebar Toggle -->
  <button id="sidebar-tab" title="Men√º">‚â°</button>

  <!-- Sidebar -->
  <div class="sidebar collapsed" id="sidebar">
    <p><strong>üìä Wochenauslastung</strong></p>
    {% for week in weekly_summary %}
      <a href="{{ url_for('day_view', date_str=week.start_date) }}"
         class="kw-link{% if week.current %} active{% endif %}">
        {{ week.label }} ({{ week.range }})
        <span style="float:right; font-size:0.95em; color:#999;">{{ week.usage_pct }}%</span>
      </a>
      <div style="background-color:#444; height:8px; border-radius:4px; overflow:hidden; margin-bottom:10px;">
        <div style="background-color:
          {% if week.usage < 0.5 %}var(--green)
          {% elif week.usage < 0.8 %}var(--yellow)
          {% elif week.usage < 0.95 %}var(--orange)
          {% else %}var(--red){% endif %};
          width: {{ week.usage_pct }}%; height:100%; transition: width 0.3s ease;"></div>
      </div>
      <div class="text-sm text-muted">{{ week.booked }}/{{ week.possible }} gebucht</div>
    {% endfor %}

    <div class="slot-suggest-box">
      <div class="slot-suggest-title">üí° Slot-Vorschl√§ge</div>
      {% if slot_suggestions %}
        <table class="slot-suggest-table">
          <thead><tr><th>Datum</th><th>Uhrzeit</th><th>Punkte</th><th>Frei</th></tr></thead>
          <tbody>
            {% for s in slot_suggestions %}
              <tr><td>{{ s.date }}</td><td>{{ s.hour }}</td><td class="slot-suggest-pts">{{ s.punkte }}</td><td>{{ s.freie }}</td></tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <div style="font-size:0.96em; color:var(--yellow);">Aktuell keine Vorschl√§ge.</div>
      {% endif %}
    </div>
  </div>

  <!-- Main -->
  <div class="main" id="main">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% for category, message in messages %}
        <div class="flash-{{ category }}">{{ message }}</div>
      {% endfor %}
    {% endwith %}

    <!-- Quick Links -->
    <section class="glass panel">
      <h2>üîó Quick Links</h2>
      <div class="external-links">
        <a href="https://calendar.google.com/calendar/u/0/r?cid=emVudHJhbGthbGVuZGVyemZhQGdtYWlsLmNvbQ" target="_blank">
          üìÖ Zentralkalender √∂ffnen
        </a>
        <a href="{{ url_for('my_calendar') }}">
          üìã Meine Buchungen
        </a>
        <a href="{{ url_for('scoreboard') }}">
          üèÜ Scoreboard
        </a>
        <a href="{{ url_for('badges') }}">
          üéñÔ∏è Badges
        </a>
        <a href="{{ url_for('admin_dashboard') }}" class="admin-dashboard-link" style="display: {% if session.get('user') in ['admin', 'administrator', 'Jose', 'Simon'] %}inline-flex{% else %}none{% endif %};">
          ü§ñ Admin Dashboard
        </a>
      </div>
    </section>

    <!-- 4‚ÄëWochen Auslastung -->
    <section id="auslastung" class="glass panel">
      <h2>üìä Wochenauslastung (n√§chste 4 Wochen)</h2>
      <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:16px;">
        {% for w in weekly_summary[:4] %}
          {% set ratio = (w.booked / (w.possible + 0.001)) if w.possible > 0 else 0 %}
          {% set cls = "background:rgba(16,185,129,.20); border-color:rgba(16,185,129,.35);" if ratio < 0.5 else
                       "background:rgba(234,179,8,.20); border-color:rgba(234,179,8,.35);" if ratio < 0.8 else
                       "background:rgba(249,115,22,.20); border-color:rgba(249,115,22,.35);" if ratio < 1 else
                       "background:rgba(239,68,68,.20); border-color:rgba(239,68,68,.35);" %}
          <div class="glass-soft" style="padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,.12); {{ cls }}">
            <div style="font-size:.9em; color:#cbd5e1">{{ w.label }}</div>
            <div style="font-size:1.6em; font-weight:700">{{ w.usage_pct }}%</div>
            <div style="font-size:.85em; color:#94a3b8">{{ w.booked }} / {{ w.possible }} gebucht</div>
            <div style="font-size:.8em; color:#94a3b8">{{ w.range }}</div>
          </div>
        {% endfor %}
      </div>

      {% if slot_suggestions %}
      <div class="glass-soft" style="padding:12px; margin-top:12px;">
        <div class="text-sm" style="color:#cbd5e1; margin-bottom:6px;">üéØ Empfohlene Slots (mit Punkten)</div>
        <div style="display:flex; flex-wrap:wrap; gap:8px;">
          {% for s in slot_suggestions[:5] %}
            <div class="chip">
              <span>{{ s.date }}</span> ‚Ä¢ 
              <span>{{ s.hour }}</span> ‚Ä¢ 
              <span style="color:var(--green);">{{ s.punkte }} Pkt</span> ‚Ä¢ 
              <span style="color:var(--accent);">{{ s.freie }} frei</span>
            </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}
    </section>

    <!-- Buchung mit kollabierbaren Slots -->
    <section id="buchung" class="glass panel">
      <h2>üìù Slot-Buchung f√ºr {{ date.strftime('%A, %d.%m.%Y') }}</h2>
      <div class="nav">
        {% for d in days %}
          <a href="{{ url_for('day_view', date_str=d.strftime('%Y-%m-%d')) }}" class="{% if d == date %}active{% endif %}">
            {{ d.strftime('%a, %d.%m') }}
          </a>
        {% endfor %}
      </div>

      <!-- Schnell-Actions -->
      <div style="margin: 15px 0; display: flex; gap: 10px; flex-wrap: wrap;">
        <button onclick="expandAll()" class="glass-soft" style="padding: 6px 12px; font-size: 13px;">
          ‚ûï Alle aufklappen
        </button>
        <button onclick="collapseAll()" class="glass-soft" style="padding: 6px 12px; font-size: 13px;">
          ‚ûñ Alle zuklappen
        </button>
        <button onclick="jumpToEvening()" class="glass-soft" style="padding: 6px 12px; font-size: 13px;">
          üåô Zu Abendterminen
        </button>
      </div>

      {% for hour, slot in slots.items() %}
        {% set total = slot.total %}
        {% set booked = slot.booked %}
        {% set ratio = (booked / (total + 0.001)) if total > 0 else 0 %}
        {% set color = 'green' %}
        {% if slot.overbooked %}
          {% set color = 'red' %}
        {% elif ratio >= 1.0 %}
          {% set color = 'red' %}
        {% elif ratio >= 0.8 %}
          {% set color = 'orange' %}
        {% elif ratio >= 0.5 %}
          {% set color = 'yellow' %}
        {% endif %}

        <div class="time-section {{ color }} collapsible" data-hour="{{ hour }}">
          <!-- Kollabierbare Header-Zeile -->
          <div class="slot-header" onclick="toggleSlot(this)">
            <div class="slot-header-info">
              <span class="slot-time">
                <strong>üïí {{ hour }} Uhr</strong>
              </span>
              <span class="slot-stats">
                <span class="stat-item">üë• {{ slot.available_beraters }} Berater</span>
                <span class="stat-divider">|</span>
                <span class="stat-item">üìä {{ total }} Pl√§tze</span>
                <span class="stat-divider">|</span>
                <span class="stat-item">
                  {% if slot.free_count == 0 %}
                    <span class="status-badge full">‚ùå Ausgebucht</span>
                  {% elif slot.free_count <= 2 %}
                    <span class="status-badge limited">‚ö†Ô∏è Nur {{ slot.free_count }} frei</span>
                  {% else %}
                    <span class="status-badge available">‚úÖ {{ slot.free_count }} frei</span>
                  {% endif %}
                </span>
              </span>
            </div>
            <div class="slot-toggle">
              <span class="toggle-icon">‚ñº</span>
            </div>
          </div>

          <!-- Ausklappbarer Inhalt -->
          <div class="slot-content" style="display: none;">
            <div class="info" style="width:100%;">
              <div style="margin-bottom: 10px;">
                Detaillierte √úbersicht: 
                <strong>{{ slot.available_beraters }}</strong> Berater verf√ºgbar | 
                <strong>{{ total }}</strong> Kapazit√§t | 
                <strong>{{ booked }}</strong> bereits gebucht
              </div>

              {% if slot.overbooked %}
                <div style="color: var(--red); font-weight: bold; margin: 10px 0;">
                  ‚ö†Ô∏è ACHTUNG: √úberbuchung! Es sind zu wenige Berater f√ºr {{ booked }} Termine!
                </div>
              {% elif slot.free_count == 0 %}
                <div style="color:#ccc; font-style: italic; margin: 10px 0;">
                  ‚ö†Ô∏è Alle {{ total }} Slots um {{ hour }} Uhr sind bereits belegt.
                </div>
              {% else %}
                <div style="color: var(--green); margin: 10px 0;">
                  ‚úÖ Noch {{ slot.free_count }} von {{ total }} Slots verf√ºgbar
                </div>
              {% endif %}

              {% if not slot.overbooked and slot.free_count > 0 %}
                {% for s in slot.events %}
                  <div class="slot" style="margin-top: 15px;">
                    <form method="POST" action="{{ url_for('book') }}" onsubmit="showLoading()">
                      <input type="hidden" name="slot_id" value="{{ s.id }}">
                      <input type="hidden" name="date" value="{{ date.strftime('%Y-%m-%d') }}">
                      <input type="hidden" name="hour" value="{{ hour }}">
                      <input type="text" name="first_name" placeholder="Vorname" required maxlength="50">
                      <input type="text" name="last_name" placeholder="Nachname" required maxlength="50">
                      <textarea name="description" placeholder="Beschreibung (optional)" maxlength="500"></textarea>
                      <select name="color" required style="margin-left:8px;">
                        <option value="2">üü¢ Normales Potential</option>
                        <option value="7">üîµ Top Potential</option>
                        <option value="5">üü° Closer n√∂tig</option>
                        <option value="3">üü£ R√ºckholung</option>
                      </select>
                      <button type="submit">Slot buchen</button>
                    </form>
                  </div>
                {% endfor %}
              {% endif %}
            </div>
          </div>
        </div>
      {% endfor %}
    </section>
  </div>

  <script>
    // Enhanced Loading States
    function showLoading(text = 'L√§dt...') {
      const indicator = document.getElementById('loadingIndicator');
      indicator.textContent = text;
      indicator.classList.add('show');
    }
    
    function hideLoading() {
      document.getElementById('loadingIndicator').classList.remove('show');
    }
    
    // Success Animation
    function showSuccess(message = 'Erfolgreich gebucht!') {
      const popup = document.getElementById('successPopup');
      popup.querySelector('.text').textContent = message;
      popup.style.display = 'block';
      
      setTimeout(() => {
        popup.style.display = 'none';
      }, 2000);
    }
    // Achievement System Class
class AchievementSystem {
  constructor() {
    this.notificationQueue = [];
    this.isShowingNotification = false;
    this.soundEnabled = true;
    this.init();
  }
  
  init() {
    // Event Listener f√ºr Badge-API Updates
    this.checkForNewBadges();
    
    // Alle 30 Sekunden auf neue Badges pr√ºfen
    setInterval(() => this.checkForNewBadges(), 30000);
  }
  
  async checkForNewBadges() {
    try {
      const response = await fetch('/api/user/badges');
      if (response.ok) {
        const data = await response.json();
        
        if (data.new_badges && data.new_badges.length > 0) {
          // Zeige neue Badges
          for (const badge of data.new_badges) {
            this.showAchievementNotification(badge);
          }
          
          // Markiere Badges als gesehen
          await fetch('/api/user/badges/mark-seen', { method: 'POST' });
        }
      }
    } catch (error) {
      console.error('Error checking for new badges:', error);
    }
  }
  
  showAchievementNotification(badge) {
    // F√ºge zur Queue hinzu
    this.notificationQueue.push(badge);
    
    // Starte Anzeige wenn nicht bereits aktiv
    if (!this.isShowingNotification) {
      this.processNotificationQueue();
    }
  }
  
  async processNotificationQueue() {
    if (this.notificationQueue.length === 0) {
      this.isShowingNotification = false;
      return;
    }
    
    this.isShowingNotification = true;
    const badge = this.notificationQueue.shift();
    
    // Erstelle Notification Element
    const notification = this.createNotificationElement(badge);
    document.body.appendChild(notification);
    
    // Spezial-Effekte f√ºr seltene Badges
    if (badge.rarity === 'legendary' || badge.rarity === 'mythic') {
      this.createConfetti();
      this.flashScreen(badge.color);
    }
    
    // Animiere rein
    requestAnimationFrame(() => {
      notification.classList.add('show');
    });
    
    // Sound abspielen
    this.playSoundForRarity(badge.rarity);
    
    // Nach 5 Sekunden entfernen (oder bei Click)
    const hideTimeout = setTimeout(() => {
      this.hideNotification(notification);
    }, 5000);
    
    // Click Handler f√ºr vorzeitiges Schlie√üen
    const closeBtn = notification.querySelector('.achievement-close');
    closeBtn.addEventListener('click', () => {
      clearTimeout(hideTimeout);
      this.hideNotification(notification);
    });
    
    // Warte 6 Sekunden bevor n√§chste Notification
    setTimeout(() => {
      this.processNotificationQueue();
    }, 6000);
  }
  
  createNotificationElement(badge) {
    const notification = document.createElement('div');
    notification.className = `achievement-notification rarity-${badge.rarity}`;
    
    notification.innerHTML = `
      <div class="achievement-header">
        <h4 class="achievement-title">Achievement Unlocked!</h4>
        <button class="achievement-close">&times;</button>
      </div>
      <div class="achievement-content">
        <div class="achievement-badge rarity-${badge.rarity}">
          ${badge.emoji}
        </div>
        <h3 class="achievement-name">${badge.name}</h3>
        <p class="achievement-description">${badge.description}</p>
        <span class="achievement-rarity rarity-${badge.rarity}">
          ‚ú® ${badge.rarity.charAt(0).toUpperCase() + badge.rarity.slice(1)}
        </span>
      </div>
    `;
    
    return notification;
  }
  
  hideNotification(notification) {
    notification.classList.remove('show');
    
    setTimeout(() => {
      if (notification.parentNode) {
        notification.parentNode.removeChild(notification);
      }
    }, 500);
  }
  
  createConfetti() {
    // Erstelle Konfetti-Effekt f√ºr seltene Badges
    const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#f9ca24', '#f0932b', '#eb4d4b', '#6c5ce7'];
    
    for (let i = 0; i < 50; i++) {
      const confetti = document.createElement('div');
      confetti.className = 'confetti';
      confetti.style.left = Math.random() * 100 + '%';
      confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
      confetti.style.animationDelay = Math.random() * 3 + 's';
      confetti.style.animationDuration = (Math.random() * 3 + 2) + 's';
      
      document.body.appendChild(confetti);
      
      // Entferne nach Animation
      setTimeout(() => {
        if (confetti.parentNode) {
          confetti.parentNode.removeChild(confetti);
        }
      }, 5000);
    }
  }
  
  flashScreen(color) {
    // Screen-Flash f√ºr mythische Badges
    const flash = document.createElement('div');
    flash.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: ${color || '#ec4899'};
      opacity: 0;
      pointer-events: none;
      z-index: 10000;
      transition: opacity 0.1s ease;
    `;
    
    document.body.appendChild(flash);
    
    requestAnimationFrame(() => {
      flash.style.opacity = '0.3';
      
      setTimeout(() => {
        flash.style.opacity = '0';
        setTimeout(() => {
          if (flash.parentNode) {
            flash.parentNode.removeChild(flash);
          }
        }, 100);
      }, 100);
    });
  }
  
  playSoundForRarity(rarity) {
    if (!this.soundEnabled) return;
    
    // Einfacher Beep-Sound f√ºr verschiedene Seltenheiten
    const context = new (window.AudioContext || window.webkitAudioContext)();
    
    const frequencies = {
      common: 440,
      uncommon: 523,
      rare: 659,
      epic: 784,
      legendary: 880,
      mythic: 1047
    };
    
    const frequency = frequencies[rarity] || 440;
    const oscillator = context.createOscillator();
    const gainNode = context.createGain();
    
    oscillator.connect(gainNode);
    gainNode.connect(context.destination);
    
    oscillator.frequency.value = frequency;
    oscillator.type = 'sine';
    
    gainNode.gain.setValueAtTime(0.1, context.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.001, context.currentTime + 0.5);
    
    oscillator.start(context.currentTime);
    oscillator.stop(context.currentTime + 0.5);
  }
}

// Achievement-System initialisieren
let achievementSystem;

// DAS HIER ZUR BESTEHENDEN DOMContentLoaded EVENT HINZUF√úGEN:
window.addEventListener('DOMContentLoaded', () => {
  // ... bestehender Code ...
  
  // NEU: Achievement System initialisieren
  achievementSystem = new AchievementSystem();
});

// Test-Funktion f√ºr Development (optional)
function testAchievementPopup() {
  const testBadge = {
    id: 'test_badge',
    name: 'Test Champion üèÜ',
    description: 'Dies ist ein Test-Badge',
    emoji: 'üèÜ',
    rarity: 'legendary',
    color: '#eab308'
  };
  
  achievementSystem.showAchievementNotification(testBadge);
}

// Keyboard Shortcut f√ºr Test (nur im Development)
document.addEventListener('keydown', function(e) {
  if (e.ctrlKey && e.shiftKey && e.key === 'T') {
    testAchievementPopup();
  }
});
    // Toggle einzelnen Slot
    function toggleSlot(header) {
      const section = header.parentElement;
      const content = section.querySelector('.slot-content');
      const isExpanded = section.classList.contains('expanded');
      
      if (isExpanded) {
        content.style.display = 'none';
        section.classList.remove('expanded');
      } else {
        content.style.display = 'block';
        section.classList.add('expanded');
      }
    }
    
    // Alle aufklappen
    function expandAll() {
      document.querySelectorAll('.time-section.collapsible').forEach(section => {
        section.classList.add('expanded');
        section.querySelector('.slot-content').style.display = 'block';
      });
    }
    
    // Alle zuklappen
    function collapseAll() {
      document.querySelectorAll('.time-section.collapsible').forEach(section => {
        section.classList.remove('expanded');
        section.querySelector('.slot-content').style.display = 'none';
      });
    }
    
    // Zu Abendterminen springen
    function jumpToEvening() {
      const eveningSlot = document.querySelector('[data-hour="18:00"]');
      if (eveningSlot) {
        eveningSlot.scrollIntoView({ behavior: 'smooth', block: 'center' });
        if (!eveningSlot.classList.contains('expanded')) {
          toggleSlot(eveningSlot.querySelector('.slot-header'));
        }
        eveningSlot.style.animation = 'highlight 1s ease';
        setTimeout(() => {
          eveningSlot.style.animation = '';
        }, 1000);
      }
    }
    
    // Enhanced Form Submit with Loading States
    document.querySelectorAll('.slot form').forEach(form => {
      form.addEventListener('submit', function(e) {
        const btn = this.querySelector('button[type="submit"]');
        btn.classList.add('loading');
        btn.disabled = true;
        this.classList.add('submitting');
        showLoading('Buchung wird verarbeitet...');
        
        setTimeout(() => {
          if (document.querySelector('.flash-success')) {
            showSuccess();
          }
        }, 500);
      });
    });
    
    // Theme Toggle mit LocalStorage und Animation
    const body = document.body;
    const modeToggle = document.getElementById("mode-toggle");
    
    function setMode(dark, animate = true) {
      if (animate) {
        body.style.transition = 'background 0.3s ease';
      }
      body.classList.toggle('lightmode', !dark);
      body.classList.toggle('darkmode', dark);
      modeToggle.innerHTML = dark ? 'üåô' : '‚òÄÔ∏è';
      localStorage.setItem('theme', dark ? 'dark' : 'light');
    }
    
    // Theme beim Laden setzen
    window.addEventListener('DOMContentLoaded', () => {
      const savedTheme = localStorage.getItem('theme');
      setMode(savedTheme !== 'light', false);
      
      // Show keyboard hint after 3 seconds
      setTimeout(() => {
        document.getElementById('kbdHint').classList.add('show');
        setTimeout(() => {
          document.getElementById('kbdHint').classList.remove('show');
        }, 5000);
      }, 3000);
      
      // Auf Mobile standardm√§√üig zugeklappt
      if (window.innerWidth < 768) {
        collapseAll();
      }
    });
    
    modeToggle.onclick = () => setMode(!body.classList.contains('darkmode'));

    // Sidebar Toggle mit Animation
    const sidebar = document.getElementById("sidebar");
    const main = document.getElementById("main");
    const sidebarTab = document.getElementById("sidebar-tab");
    
    function toggleSidebar() {
      const collapsed = sidebar.classList.toggle("collapsed");
      main.classList.toggle("with-sidebar", !collapsed);
      body.classList.toggle("sidebar-open", !collapsed);
      localStorage.setItem('sidebar-open', !collapsed);
    }
    
    // Sidebar Status aus LocalStorage laden
    const sidebarOpen = localStorage.getItem('sidebar-open') === 'true';
    if (sidebarOpen) {
      sidebar.classList.remove("collapsed");
      main.classList.add("with-sidebar");
      body.classList.add("sidebar-open");
    }
    
    sidebarTab.addEventListener("click", toggleSidebar);
    
    // KEYBOARD SHORTCUTS
    const quickActions = document.getElementById('quickActions');
    const overlay = document.getElementById('overlay');
    
    function showQuickActions() {
      quickActions.classList.add('show');
      overlay.classList.add('show');
    }
    
    function hideQuickActions() {
      quickActions.classList.remove('show');
      overlay.classList.remove('show');
    }
    
    // Quick Actions Click Handler
    document.querySelectorAll('.action-item').forEach(item => {
      item.addEventListener('click', function() {
        const action = this.dataset.action;
        hideQuickActions();
        
        switch(action) {
          case 'toggle-sidebar':
            toggleSidebar();
            break;
          case 'toggle-theme':
            setMode(!body.classList.contains('darkmode'));
            break;
          case 'my-calendar':
            window.location.href = "{{ url_for('my_calendar') }}";
            break;
          case 'scoreboard':
            window.location.href = "{{ url_for('scoreboard') }}";
            break;
          case 'admin-dashboard':
            {% if session.get('user') in ['admin', 'administrator', 'Jose', 'Simon'] %}
            window.location.href = "{{ url_for('admin_dashboard') }}";
            {% endif %}
            break;
          case 'next-day':
            navigateDay(1);
            break;
          case 'prev-day':
            navigateDay(-1);
            break;
        }
      });
    });
    
    // Navigate days
    function navigateDay(direction) {
      const currentDate = new Date("{{ date.strftime('%Y-%m-%d') }}");
      currentDate.setDate(currentDate.getDate() + direction);
      
      // Skip weekends
      if (currentDate.getDay() === 0) { // Sunday
        currentDate.setDate(currentDate.getDate() + (direction > 0 ? 1 : -2));
      } else if (currentDate.getDay() === 6) { // Saturday
        currentDate.setDate(currentDate.getDate() + (direction > 0 ? 2 : -1));
      }
      
      const dateStr = currentDate.toISOString().split('T')[0];
      window.location.href = `/day/${dateStr}`;
    }
    
    // Keyboard Event Listener
    document.addEventListener('keydown', function(e) {
      // Ignoriere wenn in Input/Textarea
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
        return;
      }
      
      // Cmd/Ctrl + K - Quick Actions
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault();
        showQuickActions();
        return;
      }
      
      // ESC - Close modals
      if (e.key === 'Escape') {
        hideQuickActions();
        if (!sidebar.classList.contains('collapsed')) {
          toggleSidebar();
        }
        return;
      }
      
      // ? - Show help
      if (e.key === '?' && !e.shiftKey) {
        e.preventDefault();
        showQuickActions();
        return;
      }
      
      // Single key shortcuts (not in modals)
      if (!quickActions.classList.contains('show')) {
        switch(e.key.toLowerCase()) {
          case 's':
            e.preventDefault();
            toggleSidebar();
            break;
          case 't':
            e.preventDefault();
            setMode(!body.classList.contains('darkmode'));
            break;
          case 'm':
            e.preventDefault();
            window.location.href = "{{ url_for('my_calendar') }}";
            break;
          case 'p':
            e.preventDefault();
            window.location.href = "{{ url_for('scoreboard') }}";
            break;
          case 'a':
            e.preventDefault();
            {% if session.get('user') in ['admin', 'administrator', 'Jose', 'Simon'] %}
            window.location.href = "{{ url_for('admin_dashboard') }}";
            {% endif %}
            break;
          case 'e':
            e.preventDefault();
            jumpToEvening();
            break;
          case '+':
            e.preventDefault();
            expandAll();
            break;
          case '-':
            e.preventDefault();
            collapseAll();
            break;
          case 'arrowright':
            e.preventDefault();
            navigateDay(1);
            break;
          case 'arrowleft':
            e.preventDefault();
            navigateDay(-1);
            break;
        }
      }
    });
    
    // Close Quick Actions on overlay click
    overlay.addEventListener('click', hideQuickActions);
    
    // Check for success message on page load
    window.addEventListener('load', () => {
      const successMsg = document.querySelector('.flash-success');
      if (successMsg) {
        setTimeout(() => showSuccess(successMsg.textContent), 500);
      }
    });
  </script>
</body>
</html>