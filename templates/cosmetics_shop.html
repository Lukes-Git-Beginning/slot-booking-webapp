{% extends "hub/base.html" %}

{% block title %}Cosmetics Shop - {{ current_user }}{% endblock %}

{% block content %}

<!-- Hero Section -->
<div class="glass rounded-3xl p-8 md:p-12 mb-8 relative overflow-hidden" data-aos="fade-down">
    <div class="gradient-bg absolute inset-0 opacity-20"></div>

    <div class="relative z-10">
        <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-4">
                <div class="w-16 h-16 rounded-2xl bg-accent/20 flex items-center justify-center">
                    <i data-lucide="shopping-bag" class="w-10 h-10 text-accent"></i>
                </div>
                <div>
                    <h1 class="text-4xl md:text-5xl font-bold text-white">üõçÔ∏è Cosmetics Shop</h1>
                    <p class="text-xl text-white/80 mt-2">Personalisiere deinen Style</p>
                </div>
            </div>
            <div class="text-right">
                <div class="text-3xl font-bold text-warning">{{ user_coins }}</div>
                <div class="text-sm text-white/70">Verf√ºgbare Punkte</div>
            </div>
        </div>
    </div>
</div>

<!-- Category Tabs -->
<div class="glass rounded-2xl p-2 mb-8 flex gap-2 flex-wrap" data-aos="fade-up" data-aos-delay="100" x-data="{ activeTab: 'titles' }">
    <button
        @click="activeTab = 'titles'"
        :class="activeTab === 'titles' ? 'bg-primary text-white' : 'text-white/70 hover:text-white hover:bg-white/5'"
        class="flex-1 min-w-[120px] px-6 py-3 rounded-xl font-semibold transition-all duration-300 flex items-center justify-center gap-2">
        <i data-lucide="award" class="w-5 h-5"></i>
        <span>Titel</span>
    </button>
    <button
        @click="activeTab = 'themes'"
        :class="activeTab === 'themes' ? 'bg-primary text-white' : 'text-white/70 hover:text-white hover:bg-white/5'"
        class="flex-1 min-w-[120px] px-6 py-3 rounded-xl font-semibold transition-all duration-300 flex items-center justify-center gap-2">
        <i data-lucide="palette" class="w-5 h-5"></i>
        <span>Themes</span>
    </button>
    <button
        @click="activeTab = 'avatars'"
        :class="activeTab === 'avatars' ? 'bg-primary text-white' : 'text-white/70 hover:text-white hover:bg-white/5'"
        class="flex-1 min-w-[120px] px-6 py-3 rounded-xl font-semibold transition-all duration-300 flex items-center justify-center gap-2">
        <i data-lucide="user-circle" class="w-5 h-5"></i>
        <span>Avatare</span>
    </button>
    <button
        @click="activeTab = 'effects'"
        :class="activeTab === 'effects' ? 'bg-primary text-white' : 'text-white/70 hover:text-white hover:bg-white/5'"
        class="flex-1 min-w-[120px] px-6 py-3 rounded-xl font-semibold transition-all duration-300 flex items-center justify-center gap-2">
        <i data-lucide="sparkles" class="w-5 h-5"></i>
        <span>Effekte</span>
    </button>

    <!-- Titles Tab -->
    <div x-show="activeTab === 'titles'" x-transition class="w-full pt-6">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {% for title in shop_items.titles %}
            <div class="glass rounded-2xl p-6 hover:scale-105 transition-transform">
                <div class="flex items-center justify-between mb-4">
                    <div class="badge
                        {% if title.rarity == 'legendary' %}badge-warning
                        {% elif title.rarity == 'epic' %}badge-info
                        {% elif title.rarity == 'rare' %}badge-primary
                        {% else %}badge-ghost{% endif %}">
                        {{ title.rarity|title }}
                    </div>
                    {% if title.owned %}
                    <i data-lucide="check-circle" class="w-5 h-5 text-success"></i>
                    {% endif %}
                </div>

                <h3 class="text-xl font-bold text-white mb-2">{{ title.name }}</h3>
                <p class="text-sm text-white/60 mb-4">{{ title.description }}</p>

                <div class="flex items-center justify-between">
                    {% if title.owned %}
                        {% if title.equipped %}
                        <button class="btn btn-sm btn-success" disabled>
                            <i data-lucide="check" class="w-4 h-4 mr-1"></i>
                            Ausger√ºstet
                        </button>
                        {% else %}
                        <button class="btn btn-sm btn-primary" onclick="equipItem('title', '{{ title.id }}')">
                            Ausr√ºsten
                        </button>
                        {% endif %}
                    {% else %}
                        <button class="btn btn-sm btn-accent" onclick="purchaseItem('title', '{{ title.id }}')">
                            <i data-lucide="shopping-cart" class="w-4 h-4 mr-1"></i>
                            {{ title.price }} Punkte
                        </button>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Themes Tab -->
    <div x-show="activeTab === 'themes'" x-transition class="w-full pt-6">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {% for theme in shop_items.themes %}
            <div class="glass rounded-2xl p-6 hover:scale-105 transition-transform">
                <!-- Theme Preview with Gradient -->
                <div class="w-full h-32 rounded-xl mb-4 overflow-hidden relative"
                     style="background: linear-gradient(135deg,
                            {{ theme.colors.primary if theme.colors.primary != 'rainbow' else '#ff0000' }} 0%,
                            {{ theme.colors.secondary if theme.colors.secondary != 'rainbow' else '#00ff00' }} 50%,
                            {{ theme.colors.accent if theme.colors.accent != 'rainbow' else '#0000ff' }} 100%);">
                    <div class="absolute inset-0 flex items-center justify-center">
                        <span class="text-white/90 font-bold text-lg drop-shadow-lg">Vorschau</span>
                    </div>
                </div>

                <h3 class="text-xl font-bold text-white mb-2">{{ theme.name }}</h3>
                <p class="text-sm text-white/60 mb-4">{{ theme.description }}</p>

                <div class="flex items-center justify-between">
                    {% if theme.owned %}
                        {% if theme.active %}
                        <button class="btn btn-sm btn-success" disabled>
                            <i data-lucide="check" class="w-4 h-4 mr-1"></i>
                            Aktiv
                        </button>
                        {% else %}
                        <button class="btn btn-sm btn-primary" onclick="activateTheme('{{ theme.id }}')">
                            Aktivieren
                        </button>
                        {% endif %}
                    {% else %}
                        <button class="btn btn-sm btn-accent" onclick="purchaseItem('theme', '{{ theme.id }}')">
                            <i data-lucide="shopping-cart" class="w-4 h-4 mr-1"></i>
                            {{ theme.price }} Punkte
                        </button>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Avatars Tab -->
    <div x-show="activeTab === 'avatars'" x-transition class="w-full pt-6" x-data="{ genderFilter: 'all' }">
        <!-- Gender Filter Buttons -->
        <div class="flex justify-center gap-4 mb-8">
            <button
                @click="genderFilter = 'all'"
                :class="genderFilter === 'all' ? 'bg-primary text-white' : 'bg-white/10 text-white/70 hover:bg-white/20'"
                class="px-6 py-2 rounded-xl font-semibold transition-all duration-300">
                Alle Avatare
            </button>
            <button
                @click="genderFilter = 'male'"
                :class="genderFilter === 'male' ? 'bg-blue-600 text-white' : 'bg-white/10 text-white/70 hover:bg-white/20'"
                class="px-6 py-2 rounded-xl font-semibold transition-all duration-300 flex items-center gap-2">
                <span>‚ôÇ</span> M√§nnlich
            </button>
            <button
                @click="genderFilter = 'female'"
                :class="genderFilter === 'female' ? 'bg-pink-600 text-white' : 'bg-white/10 text-white/70 hover:bg-white/20'"
                class="px-6 py-2 rounded-xl font-semibold transition-all duration-300 flex items-center gap-2">
                <span>‚ôÄ</span> Weiblich
            </button>
        </div>

        <!-- Avatars Grid -->
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">
            {% for avatar in shop_items.avatars %}
            <div class="glass rounded-2xl p-6 text-center hover:scale-105 transition-transform"
                 x-show="genderFilter === 'all' || '{{ avatar.gender }}' === genderFilter"
                 x-transition>

                <!-- Avatar Image -->
                <div class="relative w-32 h-32 mx-auto mb-4 rounded-2xl overflow-hidden
                            {% if avatar.gender == 'male' %}bg-gradient-to-br from-blue-500/20 to-cyan-500/20
                            {% else %}bg-gradient-to-br from-pink-500/20 to-purple-500/20{% endif %}
                            flex items-center justify-center shadow-lg">
                    <img src="{{ avatar.image }}"
                         alt="{{ avatar.name }}"
                         class="w-full h-full object-contain p-2"
                         loading="lazy">
                </div>

                <!-- Gender Badge -->
                <div class="flex justify-center mb-2">
                    <span class="badge badge-sm
                        {% if avatar.gender == 'male' %}bg-blue-600/50 text-white border-blue-400
                        {% else %}bg-pink-600/50 text-white border-pink-400{% endif %}">
                        {% if avatar.gender == 'male' %}‚ôÇ M√§nnlich{% else %}‚ôÄ Weiblich{% endif %}
                    </span>
                </div>

                <!-- Avatar Info -->
                <h3 class="font-bold text-white text-lg mb-1">{{ avatar.name }}</h3>
                <p class="text-xs text-white/60 mb-3">{{ avatar.description }}</p>

                <!-- Price Badge -->
                <div class="flex justify-center mb-4">
                    <span class="badge badge-warning gap-1">
                        <i data-lucide="coins" class="w-3 h-3"></i>
                        {{ avatar.price }}
                    </span>
                </div>

                <!-- Action Button -->
                <div class="flex justify-center">
                    {% if avatar.owned %}
                        {% if avatar.equipped %}
                        <button class="btn btn-sm btn-success gap-2" disabled>
                            <i data-lucide="check" class="w-4 h-4"></i>
                            Ausger√ºstet
                        </button>
                        {% else %}
                        <button class="btn btn-sm btn-primary gap-2" onclick="equipItem('avatar', '{{ avatar.id }}')">
                            <i data-lucide="sparkles" class="w-4 h-4"></i>
                            Ausr√ºsten
                        </button>
                        {% endif %}
                    {% else %}
                        <button class="btn btn-sm btn-accent gap-2" onclick="purchaseItem('avatar', '{{ avatar.id }}')">
                            <i data-lucide="shopping-cart" class="w-4 h-4"></i>
                            Kaufen
                        </button>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Effects Tab -->
    <div x-show="activeTab === 'effects'" x-transition class="w-full pt-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            {% for effect in shop_items.effects %}
            <div class="glass rounded-2xl p-6 hover:scale-105 transition-transform">
                <div class="flex items-center gap-4 mb-4">
                    <div class="w-16 h-16 rounded-xl bg-gradient-to-br from-accent/20 to-warning/20 flex items-center justify-center text-3xl">
                        {{ effect.icon }}
                    </div>
                    <div class="flex-1">
                        <h3 class="text-xl font-bold text-white">{{ effect.name }}</h3>
                        <p class="text-sm text-white/60">{{ effect.description }}</p>
                    </div>
                    <div class="badge
                        {% if effect.rarity == 'legendary' %}badge-warning
                        {% elif effect.rarity == 'epic' %}badge-info
                        {% else %}badge-primary{% endif %}">
                        {{ effect.rarity|title }}
                    </div>
                </div>

                <div class="mb-4">
                    <div class="text-sm text-white/70 mb-2">Vorschau:</div>
                    <div class="bg-white/5 rounded-lg p-4 relative overflow-hidden">
                        {% if effect.effect == 'sparkle_cursor' %}
                        <div class="flex items-center gap-2 text-white/80">
                            <span class="animate-pulse">‚ú®</span> Glitzer bei Klicks
                        </div>
                        {% elif effect.effect == 'keyboard_sounds' %}
                        <div class="flex items-center gap-2 text-white/80">
                            <span class="animate-bounce">‚å®Ô∏è</span> Mechanische Sounds
                        </div>
                        {% elif effect.effect == 'booking_fanfare' %}
                        <div class="flex items-center gap-2 text-white/80">
                            <span class="animate-ping">üé∫</span> Epische Musik
                        </div>
                        {% elif effect.effect == 'achievement_confetti' %}
                        <div class="flex items-center gap-2 text-white/80">
                            <span class="animate-spin">üéâ</span> Konfetti-Regen
                        </div>
                        {% elif effect.effect == 'screen_shake' %}
                        <div class="flex items-center gap-2 text-white/80 animate-bounce">
                            <span>üì≥</span> Bildschirm vibriert
                        </div>
                        {% endif %}
                    </div>
                </div>

                <div class="flex items-center justify-between">
                    {% if effect.owned %}
                        {% if effect.active %}
                        <button class="btn btn-sm btn-success" disabled>
                            <i data-lucide="check" class="w-4 h-4 mr-1"></i>
                            Aktiv
                        </button>
                        {% else %}
                        <button class="btn btn-sm btn-primary" onclick="activateEffect('{{ effect.id }}')">
                            Aktivieren
                        </button>
                        {% endif %}
                    {% else %}
                        <button class="btn btn-sm btn-accent" onclick="purchaseItem('effect', '{{ effect.id }}')">
                            <i data-lucide="shopping-cart" class="w-4 h-4 mr-1"></i>
                            {{ effect.price }} Punkte
                        </button>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Owned Items Summary -->
{% if owned_items %}
<div class="glass rounded-3xl p-8 mb-8" data-aos="fade-up" data-aos-delay="200">
    <div class="flex items-center gap-3 mb-6">
        <div class="w-12 h-12 rounded-xl bg-success/20 flex items-center justify-center">
            <i data-lucide="package" class="w-7 h-7 text-success"></i>
        </div>
        <h2 class="text-2xl font-bold text-white">Deine Sammlung</h2>
    </div>

    <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
        <div class="text-center">
            <div class="text-4xl font-bold text-primary mb-2">{{ owned_items.titles }}</div>
            <div class="text-sm text-white/60">Titel</div>
        </div>
        <div class="text-center">
            <div class="text-4xl font-bold text-secondary mb-2">{{ owned_items.themes }}</div>
            <div class="text-sm text-white/60">Themes</div>
        </div>
        <div class="text-center">
            <div class="text-4xl font-bold text-accent mb-2">{{ owned_items.avatars }}</div>
            <div class="text-sm text-white/60">Avatare</div>
        </div>
        <div class="text-center">
            <div class="text-4xl font-bold text-warning mb-2">{{ owned_items.effects }}</div>
            <div class="text-sm text-white/60">Effekte</div>
        </div>
    </div>
</div>
{% endif %}

<!-- Action Buttons -->
<div class="flex justify-center gap-4 flex-wrap" data-aos="fade-up" data-aos-delay="300">
    <a href="{{ url_for('scoreboard.gamification_dashboard') }}" class="btn btn-primary gap-2">
        <i data-lucide="trophy" class="w-5 h-5"></i>
        <span>Dashboard</span>
    </a>
    <a href="{{ url_for('gamification.daily_quests') }}" class="btn btn-secondary gap-2">
        <i data-lucide="target" class="w-5 h-5"></i>
        <span>Quests</span>
    </a>
    <a href="{{ url_for('gamification.prestige_dashboard') }}" class="btn gap-2 bg-secondary hover:bg-accent border-0 text-white">
        <i data-lucide="crown" class="w-5 h-5"></i>
        <span>Prestige</span>
    </a>
</div>

{% endblock %}

{% block extra_js %}
<script nonce="{{ csp_nonce }}">
    function purchaseItem(type, itemId) {
        if (confirm('M√∂chtest du dieses Item wirklich kaufen?')) {
            fetch('/slots/cosmetics/purchase', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    item_type: type,
                    item_id: itemId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Fehler: ' + data.message);
                }
            });
        }
    }

    function equipItem(type, itemId) {
        fetch('/slots/cosmetics/equip', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                item_type: type,
                item_id: itemId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Fehler: ' + data.message);
            }
        });
    }

    function activateTheme(themeId) {
        fetch('/slots/cosmetics/equip', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                item_type: 'themes',
                item_id: themeId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Fehler: ' + data.message);
            }
        });
    }

    function activateEffect(effectId) {
        fetch('/slots/cosmetics/equip', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                item_type: 'effects',
                item_id: effectId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Fehler: ' + data.message);
            }
        });
    }

    // Refresh Lucide icons
    setTimeout(() => {
        lucide.createIcons();
    }, 100);
</script>
{% endblock %}
