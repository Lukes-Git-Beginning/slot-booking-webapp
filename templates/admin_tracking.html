<!DOCTYPE html>
<html lang="de" class="dark">
<head>
  <meta charset="UTF-8">
  <title>ðŸ“Š Tracking Analytics - Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="csrf-token" content="{{ csrf_token() }}">

  <!-- Tailwind CSS + DaisyUI (Local) -->
  <script src="{{ url_for('static', filename='tailwind.min.js') }}"></script>
  <link href="{{ url_for('static', filename='daisyui.min.css') }}" rel="stylesheet" type="text/css" />

  <!-- Lucide Icons (Local) -->
  <script src="{{ url_for('static', filename='lucide.js') }}"></script>

  <!-- ApexCharts (Local) -->
  <script src="{{ url_for('static', filename='js/apexcharts.min.js') }}"></script>

  <!-- AOS Animations (Local) -->
  <link href="{{ url_for('static', filename='aos.css') }}" rel="stylesheet">
  <script src="{{ url_for('static', filename='aos.js') }}"></script>

  <!-- Tailwind Config -->
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            'primary': '#d4af6a',
            'primary-dark': '#c2ae7f',
            'secondary': '#207487',
            'accent': '#294c5d',
          },
        },
      },
    }
  </script>

  <style>
    body {
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      min-height: 100vh;
    }

    .glass {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .stat-card {
      transition: all 0.3s ease;
    }

    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 40px rgba(212, 175, 106, 0.2);
    }
  </style>
</head>
<body class="p-4 md:p-8">

  <!-- Header -->
  <div class="max-w-7xl mx-auto mb-8" data-aos="fade-down">
    <div class="flex items-center justify-between mb-4">
      <div class="flex items-center gap-4">
        <a href="{{ url_for('admin.admin_dashboard') }}" class="btn btn-ghost btn-circle hover:bg-white/10">
          <i data-lucide="arrow-left" class="w-5 h-5 text-white"></i>
        </a>
        <div>
          <h1 class="text-3xl md:text-4xl font-bold text-white flex items-center gap-3">
            <i data-lucide="bar-chart-3" class="w-10 h-10 text-primary"></i>
            Tracking Analytics
          </h1>
          <p class="text-white/60 mt-1">Show/No-Show Statistiken Â· Stand: {{ current_date }}</p>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="flex items-center gap-2">
        <!-- Export Dropdown -->
        <div class="dropdown dropdown-end">
          <label tabindex="0" class="btn btn-ghost hover:bg-white/10 gap-2">
            <i data-lucide="download" class="w-5 h-5 text-primary"></i>
            <span class="hidden md:inline text-white">Export</span>
          </label>
          <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow-lg bg-base-200 rounded-box w-52">
            <li>
              <a href="{{ url_for('admin.export_tracking_excel') }}" class="flex items-center gap-2">
                <i data-lucide="file-spreadsheet" class="w-4 h-4 text-success"></i>
                Excel (.xlsx)
              </a>
            </li>
            <li>
              <a href="{{ url_for('admin.export_tracking_csv') }}" class="flex items-center gap-2">
                <i data-lucide="file-text" class="w-4 h-4 text-info"></i>
                CSV (Tagesstatistik)
              </a>
            </li>
            <li>
              <a href="{{ url_for('admin.export_tracking_csv') }}?type=summary" class="flex items-center gap-2">
                <i data-lucide="file-bar-chart" class="w-4 h-4 text-warning"></i>
                CSV (Zusammenfassung)
              </a>
            </li>
          </ul>
        </div>

        <!-- Refresh Button -->
        <button onclick="location.reload()" class="btn btn-circle btn-ghost hover:bg-white/10">
          <i data-lucide="refresh-cw" class="w-5 h-5 text-primary"></i>
        </button>
      </div>
    </div>
  </div>

  <div class="max-w-7xl mx-auto space-y-8">

    <!-- Letzte 5 Werktage -->
    <div class="glass rounded-2xl p-6 md:p-8" data-aos="fade-up">
      <div class="flex items-center gap-3 mb-6">
        <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-primary/20 to-secondary/20 flex items-center justify-center">
          <i data-lucide="calendar-days" class="w-6 h-6 text-primary"></i>
        </div>
        <div>
          <h2 class="text-2xl font-bold text-white">Letzte 5 Werktage</h2>
          <p class="text-white/60 text-sm">TÃ¤gliche Termin-Ãœbersicht</p>
        </div>
      </div>

      <!-- Tabelle -->
      <div class="overflow-x-auto">
        <table class="table table-zebra w-full">
          <thead>
            <tr class="bg-white/5 border-b border-white/10">
              <th class="text-white font-bold">Datum</th>
              <th class="text-white font-bold">Wochentag</th>
              <th class="text-white font-bold text-center">Gelegte Termine</th>
              <th class="text-white font-bold text-center">Erschienen</th>
              <th class="text-white font-bold text-center">Nicht erschienen</th>
              <th class="text-white font-bold text-center">Abgesagt</th>
              <th class="text-white font-bold text-center">Verschoben</th>
              <th class="text-white font-bold text-center">Auftauchquote</th>
            </tr>
          </thead>
          <tbody>
            {% if last_5_workdays %}
              {% for day in last_5_workdays %}
              <tr class="hover:bg-white/5 transition-colors">
                <td class="text-white font-medium">{{ day.date }}</td>
                <td class="text-white/80">{{ day.weekday_de }}</td>
                <td class="text-center">
                  <span class="badge badge-primary badge-lg">{{ day.total_slots }}</span>
                </td>
                <td class="text-center">
                  <span class="badge badge-success badge-lg">{{ day.completed }}</span>
                </td>
                <td class="text-center">
                  <span class="badge badge-error badge-lg">{{ day.no_shows }}</span>
                </td>
                <td class="text-center">
                  <span class="badge badge-warning badge-lg">{{ day.cancelled }}</span>
                </td>
                <td class="text-center">
                  <span class="badge badge-lg" style="background: #8b5cf6; color: white;">{{ day.rescheduled }}</span>
                </td>
                <td class="text-center">
                  {% if day.appearance_rate >= 80 %}
                    <span class="badge badge-success badge-lg font-bold">{{ day.appearance_rate }}%</span>
                  {% elif day.appearance_rate >= 60 %}
                    <span class="badge badge-warning badge-lg font-bold">{{ day.appearance_rate }}%</span>
                  {% else %}
                    <span class="badge badge-error badge-lg font-bold">{{ day.appearance_rate }}%</span>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="7" class="text-center text-white/60 py-8">
                  <i data-lucide="inbox" class="w-12 h-12 mx-auto mb-2 opacity-50"></i>
                  <p>Keine Daten fÃ¼r die letzten 5 Werktage verfÃ¼gbar</p>
                </td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Seit Go-Live (01.09.2025) -->
    <div class="glass rounded-2xl p-6 md:p-8" data-aos="fade-up" data-aos-delay="100">
      <div class="flex items-center gap-3 mb-6">
        <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-primary/20 to-secondary/20 flex items-center justify-center">
          <i data-lucide="trending-up" class="w-6 h-6 text-primary"></i>
        </div>
        <div>
          <h2 class="text-2xl font-bold text-white">Seit Go-Live (01.09.2025)</h2>
          <p class="text-white/60 text-sm">Gesamtstatistik Â· {{ since_golive.days_tracked }} Tage mit Daten</p>
        </div>
      </div>

      <!-- Stats Cards -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
        <!-- Total Slots -->
        <div class="stat-card glass rounded-xl p-6">
          <div class="flex items-center justify-between mb-2">
            <span class="text-white/60 text-sm font-medium">Gelegte Termine</span>
            <i data-lucide="calendar-check" class="w-5 h-5 text-primary"></i>
          </div>
          <p class="text-4xl font-bold text-white">{{ since_golive.total_slots }}</p>
        </div>

        <!-- Erschienen -->
        <div class="stat-card glass rounded-xl p-6">
          <div class="flex items-center justify-between mb-2">
            <span class="text-white/60 text-sm font-medium">Erschienen</span>
            <i data-lucide="check-circle-2" class="w-5 h-5 text-success"></i>
          </div>
          <p class="text-4xl font-bold text-success">{{ since_golive.completed }}</p>
        </div>

        <!-- No-Shows -->
        <div class="stat-card glass rounded-xl p-6">
          <div class="flex items-center justify-between mb-2">
            <span class="text-white/60 text-sm font-medium">Nicht erschienen</span>
            <i data-lucide="x-circle" class="w-5 h-5 text-error"></i>
          </div>
          <p class="text-4xl font-bold text-error">{{ since_golive.no_shows }}</p>
        </div>

        <!-- Auftauchquote -->
        <div class="stat-card glass rounded-xl p-6">
          <div class="flex items-center justify-between mb-2">
            <span class="text-white/60 text-sm font-medium">Auftauchquote</span>
            <i data-lucide="percent" class="w-5 h-5 text-primary"></i>
          </div>
          {% if since_golive.appearance_rate >= 80 %}
            <p class="text-4xl font-bold text-success">{{ since_golive.appearance_rate }}%</p>
          {% elif since_golive.appearance_rate >= 60 %}
            <p class="text-4xl font-bold text-warning">{{ since_golive.appearance_rate }}%</p>
          {% else %}
            <p class="text-4xl font-bold text-error">{{ since_golive.appearance_rate }}%</p>
          {% endif %}
        </div>
      </div>

      <!-- Charts Grid -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Trend Chart -->
        <div class="glass rounded-xl p-6">
          <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
            <i data-lucide="line-chart" class="w-5 h-5 text-primary"></i>
            Auftauchquote im Zeitverlauf
          </h3>
          <div id="trendChart"></div>
        </div>

        <!-- Donut Chart -->
        <div class="glass rounded-xl p-6">
          <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
            <i data-lucide="pie-chart" class="w-5 h-5 text-primary"></i>
            Terminverteilung
          </h3>
          <div id="donutChart"></div>
        </div>
      </div>

      <!-- ZusÃ¤tzliche Metriken -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6">
        <div class="glass rounded-xl p-4 text-center">
          <p class="text-white/60 text-sm mb-1">Completion Rate</p>
          <p class="text-2xl font-bold text-white">{{ since_golive.completion_rate }}%</p>
        </div>
        <div class="glass rounded-xl p-4 text-center">
          <p class="text-white/60 text-sm mb-1">No-Show Rate</p>
          <p class="text-2xl font-bold text-white">{{ since_golive.no_show_rate }}%</p>
        </div>
        <div class="glass rounded-xl p-4 text-center">
          <p class="text-white/60 text-sm mb-1">Abgesagt</p>
          <p class="text-2xl font-bold text-white">{{ since_golive.cancelled }}</p>
        </div>
      </div>
    </div>

    <!-- Berater-Ranking -->
    <div class="glass rounded-2xl p-6 md:p-8" data-aos="fade-up" data-aos-delay="200">
      <div class="flex items-center justify-between mb-6">
        <div class="flex items-center gap-3">
          <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-primary/20 to-secondary/20 flex items-center justify-center">
            <i data-lucide="trophy" class="w-6 h-6 text-primary"></i>
          </div>
          <div>
            <h2 class="text-2xl font-bold text-white">Berater-Ranking</h2>
            <p class="text-white/60 text-sm">Kombinierte Leistungsbewertung</p>
          </div>
        </div>

        <!-- Ranking Tabs -->
        <div class="tabs tabs-boxed bg-white/5">
          <a class="tab tab-active" data-tab="combined" onclick="switchRankingTab('combined')">Kombiniert</a>
          <a class="tab" data-tab="showrates" onclick="switchRankingTab('showrates')">Erschienen-Quoten</a>
        </div>
      </div>

      <!-- Loading State -->
      <div id="rankingLoading" class="text-center py-8">
        <span class="loading loading-spinner loading-lg text-primary"></span>
        <p class="text-white/60 mt-2">Lade Ranking-Daten...</p>
      </div>

      <!-- Ranking Grid -->
      <div id="rankingGrid" class="hidden">
        <!-- Will be populated by JavaScript -->
      </div>

      <!-- Summary Stats -->
      <div id="rankingSummary" class="hidden grid grid-cols-1 md:grid-cols-4 gap-4 mt-6 pt-6 border-t border-white/10">
        <div class="text-center">
          <p class="text-white/60 text-sm">Durchschn. Erschienen-Quote</p>
          <p id="avgShowRate" class="text-xl font-bold text-white">--</p>
        </div>
        <div class="text-center">
          <p class="text-white/60 text-sm">Durchschn. Tel. Zielerreichung</p>
          <p id="avgAchievement" class="text-xl font-bold text-white">--</p>
        </div>
        <div class="text-center">
          <p class="text-white/60 text-sm">Top-Performer</p>
          <p id="highPerformers" class="text-xl font-bold text-success">--</p>
        </div>
        <div class="text-center">
          <p class="text-white/60 text-sm">Verbesserungsbedarf</p>
          <p id="lowPerformers" class="text-xl font-bold text-warning">--</p>
        </div>
      </div>
    </div>

  </div>

  <!-- Initialize Scripts -->
  <script>
    // Initialize Lucide Icons
    lucide.createIcons();

    // Initialize AOS
    AOS.init({
      duration: 800,
      once: true
    });

    // Trend Chart Data
    const trendData = {{ since_golive.daily_data | tojson | default('[]') }};
    console.log('Trend data loaded:', trendData.length, 'entries');

    // Trend Chart
    if (trendData && Array.isArray(trendData) && trendData.length > 0) {
      try {
      const trendOptions = {
        series: [{
          name: 'Auftauchquote',
          data: trendData.map(d => d.appearance_rate)
        }],
        chart: {
          type: 'line',
          height: 300,
          background: 'transparent',
          toolbar: {
            show: false
          }
        },
        stroke: {
          curve: 'smooth',
          width: 3,
          colors: ['#d4af6a']
        },
        markers: {
          size: 4,
          colors: ['#d4af6a'],
          strokeColors: '#fff',
          strokeWidth: 2
        },
        xaxis: {
          categories: trendData.map(d => d.date),
          labels: {
            style: {
              colors: 'rgba(255, 255, 255, 0.7)',
              fontSize: '10px'
            },
            rotate: -45,
            formatter: function(val) {
              // Zeige nur jeden 5. Tag
              const date = new Date(val);
              return date.getDate() + '.' + (date.getMonth() + 1);
            }
          }
        },
        yaxis: {
          min: 0,
          max: 100,
          labels: {
            style: {
              colors: 'rgba(255, 255, 255, 0.7)'
            },
            formatter: function(val) {
              return val.toFixed(0) + '%';
            }
          }
        },
        grid: {
          borderColor: 'rgba(255, 255, 255, 0.1)',
          strokeDashArray: 4
        },
        tooltip: {
          theme: 'dark',
          y: {
            formatter: function(val) {
              return val.toFixed(1) + '%';
            }
          }
        }
      };

      const trendChart = new ApexCharts(document.querySelector("#trendChart"), trendOptions);
      trendChart.render();
      } catch (e) {
        console.error('Trend chart error:', e);
        document.querySelector("#trendChart").innerHTML = '<p class="text-center text-error py-20">Chart-Fehler: ' + e.message + '</p>';
      }
    } else {
      console.warn('No trend data available, length:', trendData ? trendData.length : 'null');
      document.querySelector("#trendChart").innerHTML = '<p class="text-center text-white/60 py-20">Keine Daten verfÃ¼gbar (' + (trendData ? trendData.length : 0) + ' EintrÃ¤ge)</p>';
    }

    // Donut Chart
    try {
    const donutData = [{{ since_golive.completed | default(0) }}, {{ since_golive.no_shows | default(0) }}, {{ since_golive.cancelled | default(0) }}, {{ since_golive.rescheduled | default(0) }}];
    console.log('Donut data:', donutData);
    const donutOptions = {
      series: donutData,
      chart: {
        type: 'donut',
        height: 300,
        background: 'transparent'
      },
      labels: ['Erschienen', 'Nicht erschienen', 'Abgesagt', 'Verschoben'],
      colors: ['#10b981', '#ef4444', '#f59e0b', '#8b5cf6'],
      legend: {
        position: 'bottom',
        labels: {
          colors: 'rgba(255, 255, 255, 0.9)'
        }
      },
      dataLabels: {
        enabled: true,
        style: {
          fontSize: '14px',
          fontWeight: 'bold',
          colors: ['#fff']
        }
      },
      plotOptions: {
        pie: {
          donut: {
            size: '65%',
            labels: {
              show: true,
              total: {
                show: true,
                label: 'Gesamt',
                fontSize: '14px',
                color: 'rgba(255, 255, 255, 0.7)',
                formatter: function (w) {
                  return w.globals.seriesTotals.reduce((a, b) => a + b, 0);
                }
              },
              value: {
                show: true,
                fontSize: '24px',
                fontWeight: 'bold',
                color: '#fff'
              }
            }
          }
        }
      },
      tooltip: {
        theme: 'dark'
      }
    };

    const donutChart = new ApexCharts(document.querySelector("#donutChart"), donutOptions);
    donutChart.render();
    } catch (e) {
      console.error('Donut chart error:', e);
      document.querySelector("#donutChart").innerHTML = '<p class="text-center text-error py-20">Chart-Fehler: ' + e.message + '</p>';
    }

    // ========== BERATER-RANKING ==========

    let currentRankingData = null;
    let currentTab = 'combined';

    // Load ranking data on page load
    loadRankingData();

    async function loadRankingData() {
      try {
        const response = await fetch('/admin/tracking/api/combined-ranking', {
          credentials: 'same-origin'
        });
        const result = await response.json();

        if (result.success) {
          currentRankingData = result.data;
          renderRanking(currentRankingData, currentTab);

          // Update summary
          const summary = currentRankingData.summary;
          document.getElementById('avgShowRate').textContent = summary.avg_show_rate + '%';
          document.getElementById('avgAchievement').textContent = summary.avg_achievement + '%';
          document.getElementById('highPerformers').textContent = summary.high_performers;
          document.getElementById('lowPerformers').textContent = summary.low_performers + summary.medium_performers;

          document.getElementById('rankingLoading').classList.add('hidden');
          document.getElementById('rankingGrid').classList.remove('hidden');
          document.getElementById('rankingSummary').classList.remove('hidden');
        } else {
          showRankingError(result.error);
        }
      } catch (error) {
        showRankingError(error.message);
      }
    }

    function showRankingError(message) {
      document.getElementById('rankingLoading').innerHTML = `
        <div class="text-center py-8">
          <i data-lucide="alert-circle" class="w-12 h-12 mx-auto text-error mb-2"></i>
          <p class="text-white/60">Fehler beim Laden: ${message}</p>
        </div>
      `;
      lucide.createIcons();
    }

    function switchRankingTab(tab) {
      currentTab = tab;

      // Update tab styles
      document.querySelectorAll('[data-tab]').forEach(t => {
        t.classList.remove('tab-active');
        if (t.dataset.tab === tab) t.classList.add('tab-active');
      });

      if (currentRankingData) {
        renderRanking(currentRankingData, tab);
      }
    }

    function renderRanking(data, tab) {
      const rankings = data.rankings || [];
      const grid = document.getElementById('rankingGrid');

      if (rankings.length === 0) {
        grid.innerHTML = '<p class="text-center text-white/60 py-8">Keine Ranking-Daten verfÃ¼gbar</p>';
        return;
      }

      // German category labels
      const categoryLabels = { 'high': 'TOP', 'medium': 'MITTEL', 'low': 'NIEDRIG' };

      let html = '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">';

      rankings.forEach((r, idx) => {
        const medal = getMedal(idx);
        const categoryClass = getCategoryClass(r.category);
        const score = tab === 'combined' ? r.combined_score : r.show_rate;
        const label = tab === 'combined' ? 'Gesamt-Score' : 'Erschienen-Quote';
        const categoryLabel = categoryLabels[r.category] || r.category.toUpperCase();

        html += `
          <div class="glass rounded-xl p-4 ${categoryClass} transition-all hover:scale-105">
            <div class="flex items-center justify-between mb-3">
              <div class="flex items-center gap-2">
                ${medal}
                <span class="text-white font-bold text-lg">#${r.rank}</span>
              </div>
              <span class="badge ${getBadgeClass(r.category)}">${categoryLabel}</span>
            </div>
            <h3 class="text-xl font-bold text-white mb-2">${r.name}</h3>
            <div class="space-y-1 text-sm">
              <div class="flex justify-between">
                <span class="text-white/60">${label}</span>
                <span class="text-white font-semibold">${score}%</span>
              </div>
              ${tab === 'combined' ? `
                <div class="flex justify-between">
                  <span class="text-white/60">Erschienen-Quote</span>
                  <span class="text-white">${r.show_rate}%</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-white/60">Tel. Zielerreichung</span>
                  <span class="text-white">${r.telefonie_achievement}%</span>
                </div>
              ` : `
                <div class="flex justify-between">
                  <span class="text-white/60">Termine</span>
                  <span class="text-white">${r.total_slots}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-white/60">Erschienen</span>
                  <span class="text-success">${r.completed}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-white/60">Nicht erschienen</span>
                  <span class="text-error">${r.no_shows}</span>
                </div>
              `}
            </div>
          </div>
        `;
      });

      html += '</div>';
      grid.innerHTML = html;
      lucide.createIcons();
    }

    function getMedal(idx) {
      if (idx === 0) return '<i data-lucide="trophy" class="w-6 h-6 text-yellow-400"></i>';
      if (idx === 1) return '<i data-lucide="medal" class="w-6 h-6 text-gray-300"></i>';
      if (idx === 2) return '<i data-lucide="award" class="w-6 h-6 text-amber-600"></i>';
      return '';
    }

    function getCategoryClass(category) {
      if (category === 'high') return 'border-l-4 border-success';
      if (category === 'medium') return 'border-l-4 border-warning';
      return 'border-l-4 border-error';
    }

    function getBadgeClass(category) {
      if (category === 'high') return 'badge-success';
      if (category === 'medium') return 'badge-warning';
      return 'badge-error';
    }
  </script>

</body>
</html>
