{% extends "base.html" %}

{% block title %}{% block hub_title %}ZFA Beraterwelt{% endblock %}{% endblock %}
{% block title_suffix %}{% endblock %}

{% block extra_head_imports %}
    <!-- Cosmetics Effects System -->
    <script src="{{ url_for('static', filename='cosmetics-effects.js') }}"></script>
    {% block hub_extra_imports %}{% endblock %}
{% endblock %}

{% block theme_colors %}
    {% if user_theme %}
    <style id="user-theme-colors" nonce="{{ csp_nonce }}">
        :root {
            --theme-primary: {{ user_theme.colors.primary }};
            --theme-secondary: {{ user_theme.colors.secondary }};
            --theme-accent: {{ user_theme.colors.accent }};
        }

        .glass {
            border-color: var(--theme-primary, rgba(212, 175, 106, 0.2)) !important;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--theme-primary, #d4af6a), var(--theme-secondary, #207487)) !important;
        }

        .text-primary {
            color: var(--theme-primary, #d4af6a) !important;
        }

        .bg-primary {
            background-color: var(--theme-primary, #d4af6a) !important;
        }

        .border-primary {
            border-color: var(--theme-primary, #d4af6a) !important;
        }

        .gradient-bg {
            background: linear-gradient(-45deg,
                var(--theme-accent, #294c5d),
                var(--theme-secondary, #207487),
                var(--theme-primary, #d4af6a),
                var(--theme-secondary, #207487)) !important;
            background-size: 400% 400%;
            animation: gradient 15s ease infinite;
        }

        #particles-js canvas {
            filter: hue-rotate({{ user_theme.hue_shift or 0 }}deg);
        }
    </style>
    {% endif %}
{% endblock %}

{% block body_attrs %}{% endblock %}

{% block area_css %}
    <style nonce="{{ csp_nonce }}">
        /* Light Theme - Additional Overrides */
        [data-theme="light"] .bg-gradient-to-br {
            background: linear-gradient(135deg, rgba(120, 113, 108, 0.12), rgba(168, 162, 158, 0.18)) !important;
        }

        [data-theme="light"] .bg-white\/5 {
            background: rgba(120, 113, 108, 0.10) !important;
        }

        [data-theme="light"] .bg-white\/10 {
            background: rgba(120, 113, 108, 0.15) !important;
        }

        /* Badge Colors - Light Theme */
        [data-theme="light"] .bg-success\/20 {
            background: rgba(16, 185, 129, 0.20) !important;
        }

        [data-theme="light"] .border-success\/40 {
            border-color: rgba(16, 185, 129, 0.50) !important;
        }

        [data-theme="light"] .text-success {
            color: #059669 !important;
        }

        [data-theme="light"] .bg-warning\/20 {
            background: rgba(234, 179, 8, 0.20) !important;
        }

        [data-theme="light"] .border-warning\/40 {
            border-color: rgba(234, 179, 8, 0.50) !important;
        }

        [data-theme="light"] .text-warning {
            color: #ca8a04 !important;
        }

        [data-theme="light"] .border-white\/20 {
            border-color: rgba(120, 113, 108, 0.25) !important;
        }

        /* Toast Notifications */
        @keyframes slide-in-right {
            0% {
                opacity: 0;
                transform: translateX(100%);
            }
            100% {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slide-out-right {
            0% {
                opacity: 1;
                transform: translateX(0);
            }
            100% {
                opacity: 0;
                transform: translateX(100%);
            }
        }

        .animate-slide-in-right {
            animation: slide-in-right 0.3s ease-out;
        }

        .animate-slide-out-right {
            animation: slide-out-right 0.2s ease-in;
        }

        /* Toast Container Responsive */
        @media (max-width: 640px) {
            #toastContainer {
                top: 1rem;
                right: 1rem;
                left: 1rem;
                max-width: none !important;
            }
        }

        /* Glow Effects */
        .glow-primary {
            box-shadow: 0 0 20px rgba(212, 175, 106, 0.4), 0 0 40px rgba(212, 175, 106, 0.2);
        }

        .glow-success {
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.4), 0 0 40px rgba(16, 185, 129, 0.2);
        }

        /* Theme Toggle Button */
        .theme-toggle {
            position: relative;
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            transform: scale(1.1);
        }
    </style>
{% endblock %}

{% block navbar %}
    <!-- Modern Navbar -->
    <nav class="glass sticky top-0 z-50 backdrop-blur-xl"
         x-data="{ userMenuOpen: false }"
         data-aos="fade-down">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">

                <!-- Brand -->
                <a href="{{ url_for('hub.dashboard') }}"
                   class="flex items-center hover:opacity-80 transition-opacity group">
                    <!-- Dark Mode Logo -->
                    <img src="{{ url_for('static', filename='zfa-dark.png') }}"
                         alt="Zentrum f√ºr Finanzielle Aufkl√§rung"
                         class="h-12 w-auto group-hover:scale-105 transition-transform"
                         x-show="$store.theme.current === 'dark'">
                    <!-- Light Mode Logo -->
                    <img src="{{ url_for('static', filename='zfa-light.png') }}"
                         alt="Zentrum f√ºr Finanzielle Aufkl√§rung"
                         class="h-12 w-auto group-hover:scale-105 transition-transform"
                         x-show="$store.theme.current === 'light'">
                </a>

                <!-- User Menu -->
                {% if user %}
                <div class="flex items-center gap-4">

                    <!-- Theme Toggle -->
                    <button @click="toggleTheme()"
                            class="btn btn-circle btn-ghost hover:bg-white/10 theme-toggle">
                        <i data-lucide="sun" class="w-5 h-5" x-show="$store.theme.current === 'dark'"></i>
                        <i data-lucide="moon" class="w-5 h-5" x-show="$store.theme.current === 'light'"></i>
                    </button>

                    <!-- User Dropdown -->
                    <div class="relative" @click.away="userMenuOpen = false">
                        <button @click="userMenuOpen = !userMenuOpen"
                                class="flex items-center gap-3 glass px-4 py-2 rounded-xl hover:bg-white/10 transition-all">
                            <div class="w-10 h-10 rounded-full bg-gradient-to-br from-primary to-secondary flex items-center justify-center font-bold">
                                {{ user[0]|upper }}
                            </div>
                            <div class="text-left hidden md:block">
                                <p class="font-semibold">{{ user }}</p>
                                <p class="text-xs text-gray-400">
                                    {% if is_admin %}Admin{% else %}Benutzer{% endif %}
                                </p>
                            </div>
                            <i data-lucide="chevron-down" class="w-4 h-4"></i>
                        </button>

                        <!-- User Dropdown Menu -->
                        <div x-show="userMenuOpen"
                             x-transition
                             class="absolute right-0 mt-2 w-56 glass rounded-2xl p-2 shadow-2xl">
                            <a href="{{ url_for('hub.profile') }}" class="flex items-center gap-3 px-4 py-2 hover:bg-white/10 rounded-lg transition-colors">
                                <i data-lucide="user" class="w-4 h-4"></i>
                                <span>Profil</span>
                            </a>
                            <a href="{{ url_for('hub.settings') }}" class="flex items-center gap-3 px-4 py-2 hover:bg-white/10 rounded-lg transition-colors">
                                <i data-lucide="settings" class="w-4 h-4"></i>
                                <span>Einstellungen</span>
                            </a>
                            {% if is_admin %}
                            <div class="divider my-1"></div>
                            <a href="{{ url_for('admin.admin_dashboard') }}" class="flex items-center gap-3 px-4 py-2 hover:bg-white/10 rounded-lg transition-colors">
                                <i data-lucide="shield" class="w-4 h-4"></i>
                                <span>Administration</span>
                            </a>
                            {% endif %}
                            <div class="divider my-1"></div>
                            <a href="{{ url_for('auth.logout') }}"
                               class="flex items-center gap-3 px-4 py-2 hover:bg-error/20 text-error rounded-lg transition-colors">
                                <i data-lucide="log-out" class="w-4 h-4"></i>
                                <span>Abmelden</span>
                            </a>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </nav>
{% endblock %}

{% block footer %}
    <!-- Footer -->
    <footer class="glass mt-16 backdrop-blur-xl" data-aos="fade-up">
        <div class="container mx-auto px-4 py-8">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <div>
                    <h5 class="font-bold text-lg mb-2">Beraterwelt</h5>
                    <p class="text-sm text-gray-400">Zentrum f√ºr Finanzielle Aufkl√§rung</p>
                </div>
                <div class="flex flex-col md:flex-row gap-4 items-center">
                    <a href="/health" class="flex items-center gap-2 text-gray-400 hover:text-primary transition-colors">
                        <i data-lucide="activity" class="w-4 h-4"></i>
                        <span>System Status</span>
                    </a>
                    <a href="#" class="flex items-center gap-2 text-gray-400 hover:text-primary transition-colors">
                        <i data-lucide="help-circle" class="w-4 h-4"></i>
                        <span>Hilfe</span>
                    </a>
                    <div class="text-sm text-gray-400">
                        <span>Version {{ app_version or '3.2' }}</span>
                        <span class="mx-2">‚Ä¢</span>
                        <span>{{ current_year or '2025' }}</span>
                    </div>
                </div>
            </div>
        </div>
    </footer>
{% endblock %}

{% block theme_js %}
    <!-- Alpine.js Theme Store (with backend persistence) -->
    <script nonce="{{ csp_nonce }}">
        document.addEventListener('alpine:init', () => {
            Alpine.store('theme', {
                current: localStorage.getItem('theme') || 'dark',

                init() {
                    this.apply();
                },

                apply() {
                    document.documentElement.setAttribute('data-theme', this.current);
                    localStorage.setItem('theme', this.current);
                },

                toggle() {
                    this.current = this.current === 'dark' ? 'light' : 'dark';
                    this.apply();

                    // Save to backend
                    fetch('{{ url_for("hub.update_settings") }}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            theme: this.current
                        })
                    }).catch(err => console.error('Failed to save theme:', err));
                }
            });
        });

        // Global toggle function
        function toggleTheme() {
            Alpine.store('theme').toggle();
            setTimeout(() => lucide.createIcons(), 100);
        }

        // Auto-refresh dashboard stats
        function updateDashboardStats() {
            if (typeof updateStats === 'function') {
                updateStats();
            }
        }

        setInterval(() => {
            if (!document.hidden) {
                updateDashboardStats();
            }
        }, 30000);

        // Smooth scroll
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            });
        });

        // Live clock with 5s interval and visibility awareness
        function updateClock() {
            const now = new Date();
            const clockElement = document.getElementById('live-clock');
            if (clockElement) {
                clockElement.innerHTML = `
                    <span class="font-bold">${now.toLocaleTimeString('de-DE')}</span>
                    <br>
                    <span class="text-sm text-gray-400">${now.toLocaleDateString('de-DE')}</span>
                `;
            }
        }

        setInterval(() => {
            if (!document.hidden) {
                updateClock();
            }
        }, 5000);
        updateClock();
    </script>
{% endblock %}

{% block session_monitor %}
    <!-- Session Timeout Warning System -->
    <script nonce="{{ csp_nonce }}">
    (function() {
        const SESSION_TIMEOUT = 8 * 60 * 60 * 1000;
        const WARNING_BEFORE = 5 * 60 * 1000;
        const CHECK_INTERVAL = 60 * 1000;

        let lastActivity = Date.now();
        let warningShown = false;
        let warningToastId = null;

        function updateActivity() {
            lastActivity = Date.now();
            warningShown = false;

            if (warningToastId) {
                const toastElement = document.getElementById(warningToastId);
                if (toastElement) {
                    toastElement.remove();
                }
                warningToastId = null;
            }
        }

        function showSessionWarning(minutesRemaining) {
            if (warningShown) return;

            warningShown = true;
            warningToastId = 'session-warning-toast-' + Date.now();

            const toastHTML = `
                <div id="${warningToastId}" class="alert alert-warning shadow-lg fixed bottom-4 right-4 w-96 z-50 animate-bounce">
                    <div>
                        <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current flex-shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                        </svg>
                        <div>
                            <h3 class="font-bold">Session l√§uft ab!</h3>
                            <div class="text-xs">
                                Deine Session endet in <strong>${minutesRemaining} Minute(n)</strong>.<br>
                                Bitte speichere deine Arbeit oder lade die Seite neu, um die Session zu verl√§ngern.
                            </div>
                        </div>
                    </div>
                    <div class="flex-none">
                        <button class="btn btn-sm btn-primary" data-action="reloadPage">
                            Seite neu laden
                        </button>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', toastHTML);
            console.warn('‚ö†Ô∏è Session expires in ' + minutesRemaining + ' minutes');
        }

        function handleSessionExpiry() {
            console.error('üî¥ Session expired - Redirecting to login');

            const toastHTML = `
                <div class="alert alert-error shadow-lg fixed bottom-4 right-4 w-96 z-50">
                    <div>
                        <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current flex-shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <span>Session abgelaufen. Du wirst zum Login weitergeleitet...</span>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', toastHTML);

            setTimeout(() => {
                window.location.href = '/auth/login?expired=true';
            }, 2000);
        }

        function checkSessionTimeout() {
            const now = Date.now();
            const inactiveDuration = now - lastActivity;
            const timeRemaining = SESSION_TIMEOUT - inactiveDuration;

            if (timeRemaining <= 0) {
                handleSessionExpiry();
                return;
            }

            if (timeRemaining <= WARNING_BEFORE && !warningShown) {
                const minutesRemaining = Math.ceil(timeRemaining / 60000);
                showSessionWarning(minutesRemaining);
            }
        }

        const activityEvents = ['mousedown', 'keydown', 'scroll', 'touchstart', 'click'];

        activityEvents.forEach(eventType => {
            document.addEventListener(eventType, updateActivity, { passive: true });
        });

        setInterval(checkSessionTimeout, CHECK_INTERVAL);

        updateActivity();
        console.log('‚úÖ Session Timeout Monitor initialized (Timeout: 8h, Warning: 5min before)');
    })();
    </script>
{% endblock %}
