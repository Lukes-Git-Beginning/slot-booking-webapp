{% extends "hub/base.html" %}

{% block title %}Einstellungen - {{ user }} | Business Tool Hub{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto" x-data="settingsManager()">
    <!-- Header -->
    <div class="mb-8" data-aos="fade-down">
        <h1 class="text-4xl font-bold mb-2">Einstellungen</h1>
        <p class="text-gray-400">Passe deine Präferenzen an</p>
    </div>

    <div class="space-y-6">
        <!-- Erscheinungsbild -->
        <div class="glass rounded-3xl p-6" data-aos="fade-up">
            <h3 class="text-2xl font-bold mb-4 flex items-center gap-3">
                <i data-lucide="palette" class="w-6 h-6"></i>
                Erscheinungsbild
            </h3>

            <div class="space-y-4">
                <!-- Theme -->
                <div class="flex items-center justify-between p-4 bg-base-300/30 rounded-xl">
                    <div>
                        <p class="font-semibold">Theme</p>
                        <p class="text-sm text-gray-400">Wähle dein bevorzugtes Farbschema</p>
                    </div>
                    <select x-model="settings.theme"
                            @change="saveSettings()"
                            class="select select-bordered select-primary">
                        <option value="dark">Dark</option>
                        <option value="light">Light</option>
                        <option value="auto">Auto</option>
                    </select>
                </div>

                <!-- Dashboard Layout -->
                <div class="flex items-center justify-between p-4 bg-base-300/30 rounded-xl">
                    <div>
                        <p class="font-semibold">Dashboard-Layout</p>
                        <p class="text-sm text-gray-400">Wähle wie Tools angezeigt werden</p>
                    </div>
                    <select x-model="settings.dashboard_layout"
                            @change="saveSettings()"
                            class="select select-bordered select-primary">
                        <option value="grid">Grid</option>
                        <option value="list">Liste</option>
                        <option value="compact">Kompakt</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Benachrichtigungen -->
        <div class="glass rounded-3xl p-6" data-aos="fade-up" data-aos-delay="100">
            <h3 class="text-2xl font-bold mb-4 flex items-center gap-3">
                <i data-lucide="bell" class="w-6 h-6"></i>
                Benachrichtigungen
            </h3>

            <div class="space-y-4">
                <!-- System-Benachrichtigungen -->
                <div class="flex items-center justify-between p-4 bg-base-300/30 rounded-xl">
                    <div>
                        <p class="font-semibold">System-Benachrichtigungen</p>
                        <p class="text-sm text-gray-400">Updates und wichtige Meldungen</p>
                    </div>
                    <input type="checkbox"
                           x-model="settings.notifications"
                           @change="saveSettings()"
                           class="toggle toggle-primary" />
                </div>

                <!-- E-Mail-Benachrichtigungen -->
                <div class="flex items-center justify-between p-4 bg-base-300/30 rounded-xl">
                    <div>
                        <p class="font-semibold">E-Mail-Benachrichtigungen</p>
                        <p class="text-sm text-gray-400">Wichtige Updates per E-Mail erhalten</p>
                    </div>
                    <input type="checkbox"
                           x-model="settings.email_notifications"
                           @change="saveSettings()"
                           class="toggle toggle-primary" />
                </div>
            </div>
        </div>

        <!-- Sprache & Region -->
        <div class="glass rounded-3xl p-6" data-aos="fade-up" data-aos-delay="200">
            <h3 class="text-2xl font-bold mb-4 flex items-center gap-3">
                <i data-lucide="globe" class="w-6 h-6"></i>
                Sprache & Region
            </h3>

            <div class="space-y-4">
                <div class="flex items-center justify-between p-4 bg-base-300/30 rounded-xl">
                    <div>
                        <p class="font-semibold">Sprache</p>
                        <p class="text-sm text-gray-400">Interface-Sprache</p>
                    </div>
                    <select x-model="settings.language"
                            @change="saveSettings()"
                            class="select select-bordered select-primary">
                        <option value="de">Deutsch</option>
                        <option value="en">English</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Konto -->
        <div class="glass rounded-3xl p-6" data-aos="fade-up" data-aos-delay="300">
            <h3 class="text-2xl font-bold mb-4 flex items-center gap-3">
                <i data-lucide="shield" class="w-6 h-6"></i>
                Konto & Sicherheit
            </h3>

            <div class="space-y-4">
                <div class="flex items-center justify-between p-4 bg-base-300/30 rounded-xl">
                    <div>
                        <p class="font-semibold">Passwort ändern</p>
                        <p class="text-sm text-gray-400">Sicherheit erhöhen</p>
                    </div>
                    <button class="btn btn-outline btn-primary" onclick="passwordModal.showModal()">
                        Ändern
                    </button>
                </div>

                <div class="flex items-center justify-between p-4 bg-base-300/30 rounded-xl">
                    <div>
                        <p class="font-semibold">Zwei-Faktor-Authentifizierung</p>
                        <p class="text-sm text-gray-400" x-text="twofa_enabled ? 'Aktiviert ✓' : 'Extra Sicherheitsebene'"></p>
                    </div>
                    <button class="btn btn-outline btn-primary"
                            @click="twofa_enabled ? disable2FA() : setup2FA()">
                        <span x-text="twofa_enabled ? 'Deaktivieren' : 'Einrichten'"></span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Passwort-Änderungs-Modal -->
        <dialog id="passwordModal" class="modal">
            <div class="modal-box bg-base-200">
                <h3 class="font-bold text-lg mb-4">Passwort ändern</h3>
                <form @submit.prevent="changePassword()">
                    <div class="space-y-4">
                        <div>
                            <label class="label">Aktuelles Passwort</label>
                            <input type="password" x-model="passwordForm.old" class="input input-bordered w-full" required>
                        </div>
                        <div>
                            <label class="label">Neues Passwort</label>
                            <input type="password" x-model="passwordForm.new" class="input input-bordered w-full" required minlength="6">
                        </div>
                        <div>
                            <label class="label">Passwort bestätigen</label>
                            <input type="password" x-model="passwordForm.confirm" class="input input-bordered w-full" required>
                        </div>
                    </div>
                    <div class="modal-action">
                        <button type="button" class="btn" onclick="passwordModal.close()">Abbrechen</button>
                        <button type="submit" class="btn btn-primary">Passwort ändern</button>
                    </div>
                </form>
            </div>
        </dialog>

        <!-- 2FA-Setup-Modal -->
        <dialog id="tfaModal" class="modal">
            <div class="modal-box bg-base-200 max-w-lg">
                <h3 class="font-bold text-lg mb-4">Zwei-Faktor-Authentifizierung einrichten</h3>

                <div x-show="!twofa_setup_done">
                    <p class="mb-4 text-sm text-gray-400">Scanne den QR-Code mit deiner Authenticator-App (Google Authenticator, Authy, etc.)</p>

                    <div class="flex justify-center mb-4">
                        <img :src="'data:image/png;base64,' + qr_code" alt="QR Code" class="w-48 h-48" x-show="qr_code">
                    </div>

                    <div class="mb-4">
                        <label class="label">Oder manuell eingeben:</label>
                        <input type="text" :value="secret" readonly class="input input-bordered w-full font-mono text-sm" @click="$event.target.select()">
                    </div>

                    <div class="mb-4">
                        <label class="label">Verifizierungs-Code (6 Ziffern)</label>
                        <input type="text" x-model="verification_code" class="input input-bordered w-full text-center text-2xl tracking-widest" maxlength="6" placeholder="000000">
                    </div>

                    <div class="alert alert-info mb-4">
                        <i data-lucide="info" class="w-5 h-5"></i>
                        <span class="text-sm">Du erhältst 10 Backup-Codes für den Notfall</span>
                    </div>
                </div>

                <div x-show="twofa_setup_done">
                    <div class="alert alert-success mb-4">
                        <i data-lucide="check-circle" class="w-5 h-5"></i>
                        <span>2FA erfolgreich aktiviert!</span>
                    </div>

                    <p class="mb-2 font-semibold">Backup-Codes (sicher aufbewahren!):</p>
                    <div class="bg-base-300 p-4 rounded-lg mb-4">
                        <div class="grid grid-cols-2 gap-2 font-mono text-sm">
                            <template x-for="code in backup_codes">
                                <div x-text="code"></div>
                            </template>
                        </div>
                    </div>
                    <button @click="copyBackupCodes()" class="btn btn-sm btn-outline w-full mb-2">
                        <i data-lucide="copy" class="w-4 h-4 mr-2"></i>
                        Codes kopieren
                    </button>
                </div>

                <div class="modal-action">
                    <button type="button" class="btn" @click="close2FAModal()">
                        <span x-text="twofa_setup_done ? 'Schließen' : 'Abbrechen'"></span>
                    </button>
                    <button type="button" class="btn btn-primary" @click="enable2FA()" x-show="!twofa_setup_done">
                        Aktivieren
                    </button>
                </div>
            </div>
        </dialog>

        <!-- Save Indicator -->
        <div x-show="saveStatus"
             x-transition
             class="fixed bottom-8 right-8 glass rounded-xl p-4 shadow-2xl">
            <div class="flex items-center gap-3">
                <i data-lucide="check-circle" class="w-5 h-5 text-success"></i>
                <span class="font-semibold">Einstellungen gespeichert</span>
            </div>
        </div>
    </div>
</div>

<script>
    function settingsManager() {
        return {
            settings: {{ current_settings|tojson|safe }},
            saveStatus: false,
            twofa_enabled: false,
            passwordForm: { old: '', new: '', confirm: '' },
            qr_code: '',
            secret: '',
            verification_code: '',
            backup_codes: [],
            twofa_setup_done: false,

            async init() {
                await this.check2FAStatus();
            },

            async saveSettings() {
                try {
                    const response = await fetch('{{ url_for("hub.update_settings") }}', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(this.settings)
                    });
                    const data = await response.json();
                    if (data.success) {
                        this.saveStatus = true;
                        setTimeout(() => { this.saveStatus = false; }, 2000);

                        // Apply theme change immediately
                        if (this.settings.theme && this.settings.theme !== 'auto') {
                            document.documentElement.setAttribute('data-theme', this.settings.theme);
                            localStorage.setItem('theme', this.settings.theme);
                            if (Alpine.store('theme')) {
                                Alpine.store('theme').current = this.settings.theme;
                            }
                            // Refresh icons after theme change
                            setTimeout(() => lucide.createIcons(), 100);
                        }

                        // Apply dashboard layout change
                        if (this.settings.dashboard_layout) {
                            localStorage.setItem('dashboard_layout', this.settings.dashboard_layout);
                        }
                    }
                } catch (error) {
                    console.error('Error saving settings:', error);
                }
            },

            async changePassword() {
                if (this.passwordForm.new !== this.passwordForm.confirm) {
                    alert('Passwörter stimmen nicht überein!');
                    return;
                }

                try {
                    const response = await fetch('/security/change-password', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            old_password: this.passwordForm.old,
                            new_password: this.passwordForm.new,
                            confirm_password: this.passwordForm.confirm
                        })
                    });

                    const data = await response.json();
                    if (data.success) {
                        alert('✓ Passwort erfolgreich geändert!');
                        passwordModal.close();
                        this.passwordForm = { old: '', new: '', confirm: '' };
                    } else {
                        alert('✗ ' + data.error);
                    }
                } catch (error) {
                    alert('Fehler: ' + error);
                }
            },

            async check2FAStatus() {
                try {
                    const response = await fetch('/security/2fa/status');
                    const data = await response.json();
                    this.twofa_enabled = data.enabled;
                    this.backup_codes = data.backup_codes || [];
                } catch (error) {
                    console.error('Error checking 2FA status:', error);
                }
            },

            async setup2FA() {
                try {
                    const response = await fetch('/security/2fa/setup', { method: 'POST' });
                    const data = await response.json();
                    this.qr_code = data.qr_code;
                    this.secret = data.secret;
                    this.backup_codes = data.backup_codes;
                    this.twofa_setup_done = false;
                    tfaModal.showModal();
                    setTimeout(() => lucide.createIcons(), 100);
                } catch (error) {
                    alert('Fehler beim Setup: ' + error);
                }
            },

            async enable2FA() {
                try {
                    const response = await fetch('/security/2fa/enable', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ code: this.verification_code })
                    });

                    const data = await response.json();
                    if (data.success) {
                        this.twofa_setup_done = true;
                        this.twofa_enabled = true;
                        setTimeout(() => lucide.createIcons(), 100);
                    } else {
                        alert('✗ ' + data.error);
                    }
                } catch (error) {
                    alert('Fehler: ' + error);
                }
            },

            async disable2FA() {
                const password = prompt('Passwort zur Bestätigung:');
                if (!password) return;

                try {
                    const response = await fetch('/security/2fa/disable', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ password })
                    });

                    const data = await response.json();
                    if (data.success) {
                        alert('✓ 2FA deaktiviert');
                        this.twofa_enabled = false;
                    } else {
                        alert('✗ ' + data.error);
                    }
                } catch (error) {
                    alert('Fehler: ' + error);
                }
            },

            close2FAModal() {
                tfaModal.close();
                this.verification_code = '';
                this.twofa_setup_done = false;
            },

            copyBackupCodes() {
                const text = this.backup_codes.join('\n');
                navigator.clipboard.writeText(text);
                alert('✓ Backup-Codes kopiert!');
            }
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        lucide.createIcons();
    });
</script>
{% endblock %}
