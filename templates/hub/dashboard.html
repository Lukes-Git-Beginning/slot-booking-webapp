{% extends "hub/base.html" %}

{% block content %}

<!-- Welcome Header -->
<div class="glass rounded-3xl p-8 md:p-12 mb-8" data-aos="fade-down">
    <div class="flex flex-col md:flex-row items-center justify-between gap-6">
        <div class="flex items-center gap-4">
            <div class="w-16 h-16 rounded-2xl bg-gradient-to-br from-primary to-secondary flex items-center justify-center">
                <i data-lucide="sparkles" class="w-8 h-8 text-white"></i>
            </div>
            <div>
                <h2 class="text-3xl md:text-4xl font-bold text-white">
                    {{ greeting }}, {{ display_name }}
                    {% if is_admin %}
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-gradient-to-r from-primary/20 to-secondary/20 border border-primary/40 text-primary ml-2">
                        <i data-lucide="shield-check" class="w-3 h-3 mr-1"></i>
                        Admin
                    </span>
                    {% endif %}
                </h2>
                <p class="text-white/70 mt-1">Wähle ein Tool aus, um zu starten</p>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="flex items-center gap-3">
            <!-- Notification Dropdown -->
            <div class="dropdown dropdown-end" x-data="notificationDropdown()">
                <button @click="toggleDropdown()" tabindex="0" class="btn btn-circle btn-ghost hover:bg-white/10 relative group">
                    <i data-lucide="bell" class="w-5 h-5"></i>
                    <span x-show="unreadCount > 0" x-text="unreadCount" class="absolute -top-1 -right-1 w-5 h-5 bg-error rounded-full flex items-center justify-center text-xs font-bold">
                    </span>
                </button>
                <div x-show="isOpen" @click.outside="closeDropdown()" x-transition tabindex="0" class="dropdown-content z-50 mt-3 w-96 max-h-96 overflow-y-auto glass rounded-2xl shadow-2xl border border-white/20">
                    <div class="p-4">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-bold text-white">Benachrichtigungen</h3>
                            <span x-show="unreadCount > 0" class="badge badge-error badge-sm" x-text="unreadCount + ' neu'"></span>
                        </div>

                        <template x-if="notifications.length === 0">
                            <div class="text-center py-8 text-white/60">
                                <i data-lucide="inbox" class="w-12 h-12 mx-auto mb-2 opacity-50"></i>
                                <p>Keine Benachrichtigungen</p>
                            </div>
                        </template>

                        <div class="space-y-2">
                            <template x-for="notif in notifications" :key="notif.id">
                                <div @click="handleNotificationClick(notif)"
                                     :class="notif.read ? 'bg-white/5' : 'bg-primary/10 border-l-4 border-primary'"
                                     class="p-3 rounded-lg cursor-pointer hover:bg-white/10 transition-all group">
                                    <div class="flex items-start gap-3">
                                        <div class="w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0"
                                             :class="{
                                                 'bg-info/20 text-info': notif.type === 'info',
                                                 'bg-success/20 text-success': notif.type === 'success',
                                                 'bg-warning/20 text-warning': notif.type === 'warning',
                                                 'bg-error/20 text-error': notif.type === 'error'
                                             }">
                                            <i :data-lucide="getNotificationIcon(notif.type)" class="w-4 h-4"></i>
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <h4 class="font-semibold text-white text-sm" x-text="notif.title"></h4>
                                            <p class="text-xs text-white/70 mt-1" x-text="notif.message"></p>
                                            <span class="text-xs text-white/50 mt-1 block" x-text="formatTime(notif.timestamp)"></span>

                                            <!-- Actions -->
                                            <template x-if="notif.actions && notif.actions.length > 0">
                                                <div class="mt-2 flex gap-2">
                                                    <template x-for="action in notif.actions" :key="action.url">
                                                        <span class="inline-flex items-center gap-1 text-xs text-primary group-hover:text-primary-dark font-semibold">
                                                            <i data-lucide="arrow-right" class="w-3 h-3"></i>
                                                            <span x-text="action.text"></span>
                                                        </span>
                                                    </template>
                                                </div>
                                            </template>
                                        </div>
                                        <span x-show="!notif.read" class="w-2 h-2 bg-warning rounded-full flex-shrink-0 animate-pulse" title="Ungelesen"></span>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Tools Grid -->
<div x-data="{ layout: localStorage.getItem('dashboard_layout') || 'grid' }"
     :class="{
        'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6': layout === 'grid',
        'grid grid-cols-1 gap-4': layout === 'list',
        'grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4': layout === 'compact'
     }"
     data-aos="fade-up" data-aos-delay="200">
    {% for tool in tools %}
    <a href="{{ tool.url }}"
       class="glass rounded-2xl p-8 hover:bg-white/10 transition-all duration-300 hover:scale-105 hover:shadow-2xl group relative overflow-hidden"
       data-aos="zoom-in"
       data-aos-delay="{{ loop.index * 50 }}">

        <!-- Gradient Overlay on Hover -->
        <div class="absolute inset-0 bg-gradient-to-br from-primary/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity rounded-2xl"></div>

        <!-- Content -->
        <div class="relative z-10">
            <!-- Icon -->
            <div class="mb-6 inline-flex p-4 rounded-2xl bg-gradient-to-br from-primary/20 to-secondary/20 group-hover:from-primary/30 group-hover:to-secondary/30 transition-all">
                {% if tool.lucide_icon %}
                <i data-lucide="{{ tool.lucide_icon }}" class="w-12 h-12 text-primary"></i>
                {% else %}
                <span class="text-5xl">{{ tool.icon }}</span>
                {% endif %}
            </div>

            <!-- Tool Name -->
            <h3 class="text-2xl font-bold text-white mb-3 group-hover:text-primary transition-colors">
                {{ tool.name }}
            </h3>

            <!-- Description -->
            <p class="text-white/70 text-sm mb-4">
                {{ tool.description }}
            </p>

            <!-- Status Badge -->
            {% if tool.status == 'active' %}
            <div class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-success/20 border border-success/40 text-success text-xs font-semibold">
                <span class="w-2 h-2 bg-success rounded-full animate-pulse"></span>
                Verfügbar
            </div>
            {% elif tool.status == 'beta' %}
            <div class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-warning/20 border border-warning/40 text-warning text-xs font-semibold">
                <i data-lucide="flask-conical" class="w-3 h-3"></i>
                Beta
            </div>
            {% else %}
            <div class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-white/10 border border-white/20 text-white/60 text-xs font-semibold">
                <i data-lucide="wrench" class="w-3 h-3"></i>
                Wartung
            </div>
            {% endif %}

            <!-- Arrow Icon -->
            <div class="absolute bottom-8 right-8 opacity-0 group-hover:opacity-100 transform translate-x-2 group-hover:translate-x-0 transition-all">
                <i data-lucide="arrow-right" class="w-6 h-6 text-primary"></i>
            </div>
        </div>
    </a>
    {% endfor %}
</div>

<!-- Admin Quick Access (if admin) -->
{% if is_admin %}
<div class="glass rounded-2xl p-8 mt-8" data-aos="fade-up" data-aos-delay="300">
    <div class="flex items-center gap-3 mb-6">
        <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-primary to-secondary flex items-center justify-center">
            <i data-lucide="shield-check" class="w-5 h-5 text-white"></i>
        </div>
        <h3 class="text-xl font-bold text-white">Admin Schnellzugriff</h3>
    </div>

    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <a href="/admin/dashboard" class="flex items-center gap-3 px-4 py-3 rounded-xl bg-white/5 hover:bg-white/10 transition-all group">
            <i data-lucide="layout-dashboard" class="w-5 h-5 text-primary group-hover:scale-110 transition-transform"></i>
            <span class="text-white/90 text-sm font-medium">Dashboard</span>
        </a>

        <a href="/admin/users" class="flex items-center gap-3 px-4 py-3 rounded-xl bg-white/5 hover:bg-white/10 transition-all group">
            <i data-lucide="users" class="w-5 h-5 text-secondary group-hover:scale-110 transition-transform"></i>
            <span class="text-white/90 text-sm font-medium">Benutzer</span>
        </a>

        <a href="/admin/reports/weekly" class="flex items-center gap-3 px-4 py-3 rounded-xl bg-white/5 hover:bg-white/10 transition-all group">
            <i data-lucide="file-text" class="w-5 h-5 text-accent group-hover:scale-110 transition-transform"></i>
            <span class="text-white/90 text-sm font-medium">Berichte</span>
        </a>

        <a href="/admin/telefonie" class="flex items-center gap-3 px-4 py-3 rounded-xl bg-white/5 hover:bg-white/10 transition-all group">
            <i data-lucide="phone" class="w-5 h-5 text-info group-hover:scale-110 transition-transform"></i>
            <span class="text-white/90 text-sm font-medium">Telefonie</span>
        </a>
    </div>
</div>
{% endif %}

{% endblock %}

{% block extra_js %}
<script>
    // Notification Dropdown Component
    function notificationDropdown() {
        return {
            isOpen: false,
            notifications: {{ notifications|tojson|safe }},
            unreadCount: {{ quick_stats.unread_notifications|default(0) }},

            toggleDropdown() {
                this.isOpen = !this.isOpen;
                if (this.isOpen) {
                    // Refresh Lucide icons when dropdown opens
                    this.$nextTick(() => {
                        lucide.createIcons();
                    });
                }
            },

            closeDropdown() {
                this.isOpen = false;
            },

            async handleNotificationClick(notif) {
                // Mark as read first
                await this.markAsRead(notif.id);

                // If notification has actions, navigate to the first action URL
                if (notif.actions && notif.actions.length > 0 && notif.actions[0].url) {
                    const url = notif.actions[0].url;
                    // Close dropdown before navigation
                    this.closeDropdown();
                    // Navigate after a small delay to show visual feedback
                    setTimeout(() => {
                        window.location.href = url;
                    }, 200);
                } else {
                    // No action, just close dropdown
                    this.closeDropdown();
                }
            },

            async markAsRead(notifId) {
                const notif = this.notifications.find(n => n.id === notifId);
                if (!notif || notif.read) return;

                try {
                    const response = await fetch(`/api/notifications/${notifId}/read`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });

                    const data = await response.json();
                    if (data.success) {
                        notif.read = true;
                        this.unreadCount = Math.max(0, this.unreadCount - 1);
                    }
                } catch (error) {
                    console.error('Error marking notification as read:', error);
                }
            },

            getNotificationIcon(type) {
                const icons = {
                    'info': 'info',
                    'success': 'check-circle',
                    'warning': 'alert-triangle',
                    'error': 'x-circle'
                };
                return icons[type] || 'bell';
            },

            formatTime(timestamp) {
                if (!timestamp) return '';
                const date = new Date(timestamp);
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / 60000);

                if (diffMins < 1) return 'Gerade eben';
                if (diffMins < 60) return `vor ${diffMins} Min`;
                if (diffMins < 1440) return `vor ${Math.floor(diffMins / 60)} Std`;
                return `vor ${Math.floor(diffMins / 1440)} Tagen`;
            }
        };
    }

    // Refresh icons after dynamic content load
    // Multiple calls to ensure icons are created after AOS animations
    function initLucideIcons() {
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
            console.log('Lucide icons initialized');
        } else {
            console.error('Lucide library not loaded!');
        }
    }

    document.addEventListener('DOMContentLoaded', initLucideIcons);

    // Multiple timeouts to catch AOS animations
    setTimeout(initLucideIcons, 100);
    setTimeout(initLucideIcons, 500);
    setTimeout(initLucideIcons, 1000);
    setTimeout(initLucideIcons, 2000);
</script>
{% endblock %}
