{% extends "hub/base.html" %}

{% block title %}Scoreboard & Achievements{% endblock %}

{% block extra_head %}
<style>
/* Avatar Customizations */
.player-avatar.customized {
  background: var(--avatar-bg, linear-gradient(135deg, #d4af6a, #c2ae7f));
  border: var(--avatar-border, 2px solid #e5e7eb);
  box-shadow: var(--avatar-glow, none);
}

.avatar-effect-sparkle { animation: sparkle 2s infinite; }
.avatar-effect-floating { animation: floating 3s ease-in-out infinite; }
.avatar-effect-pulse { animation: pulse 2s infinite; }
.avatar-effect-rotate { animation: rotate 4s linear infinite; }
.avatar-effect-bounce { animation: bounce 2s infinite; }

@keyframes sparkle {
  0%, 100% { filter: brightness(1); }
  50% { filter: brightness(1.3) drop-shadow(0 0 10px rgba(255, 255, 255, 0.8)); }
}

@keyframes floating {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-5px); }
}

@keyframes pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.1); }
}

@keyframes rotate {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

@keyframes bounce {
  0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
  40% { transform: translateY(-5px); }
  60% { transform: translateY(-3px); }
}

.badge-mini {
  width: 24px;
  height: 24px;
  border-radius: 50%;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  border: 1px solid rgba(255,255,255,0.2);
  transition: all 0.2s ease;
  cursor: pointer;
}

.badge-mini:hover {
  transform: scale(1.3);
  z-index: 10;
}

.badge-mini.rarity-common { background: linear-gradient(135deg, #10b981, #059669); }
.badge-mini.rarity-uncommon { background: linear-gradient(135deg, #3b82f6, #2563eb); }
.badge-mini.rarity-rare { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
.badge-mini.rarity-epic { background: linear-gradient(135deg, #f59e0b, #d97706); }
.badge-mini.rarity-legendary { background: linear-gradient(135deg, #eab308, #ca8a04); }
.badge-mini.rarity-mythic { background: linear-gradient(135deg, #ec4899, #db2777); }
</style>
{% endblock %}

{% block content %}

<!-- Champion Section -->
{% if champion %}
<div class="glass rounded-3xl p-8 mb-8 bg-gradient-to-br from-warning/20 to-orange-500/20" data-aos="fade-down">
  <div class="text-center">
    <div class="text-6xl mb-4">👑</div>
    <div class="text-xl font-bold text-warning mb-2">Aktueller Champion</div>
    <div class="text-3xl font-bold text-white">{{ champion }}</div>
  </div>
</div>
{% endif %}

<!-- Quick Actions -->
<div class="flex flex-wrap gap-3 mb-8" data-aos="fade-down" data-aos-delay="100">
  <a href="{{ url_for('main.index') }}" class="btn btn-primary gap-2">
    <i data-lucide="arrow-left" class="w-4 h-4"></i>
    Zurück zur Buchung
  </a>
  <a href="{{ url_for('scoreboard.badges') }}" class="btn btn-secondary gap-2">
    <i data-lucide="award" class="w-4 h-4"></i>
    Alle Badges ansehen
  </a>
  <a href="/my-calendar" class="btn btn-accent gap-2">
    <i data-lucide="calendar" class="w-4 h-4"></i>
    Meine Termine
  </a>
  <a href="{{ url_for('scoreboard.gamification_dashboard') }}" class="btn gap-2 bg-secondary hover:bg-accent border-0 text-white">
    <i data-lucide="gamepad-2" class="w-4 h-4"></i>
    Gamification
  </a>
</div>

<!-- Stats Grid -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8" data-aos="fade-up" data-aos-delay="200">
  <div class="glass rounded-2xl p-6 text-center">
    <div class="text-5xl mb-3">🏆</div>
    <div class="text-3xl font-bold text-primary mb-1">{{ ranking|length }}</div>
    <div class="text-sm text-white/70">Aktive Spieler</div>
  </div>

  <div class="glass rounded-2xl p-6 text-center">
    <div class="text-5xl mb-3">🎯</div>
    <div class="text-3xl font-bold text-secondary mb-1">{{ user_score if current_user else 0 }}</div>
    <div class="text-sm text-white/70">Deine Punkte</div>
  </div>

  <div class="glass rounded-2xl p-6 text-center">
    <div class="text-5xl mb-3">📅</div>
    <div class="text-3xl font-bold text-accent mb-1">{{ month }}</div>
    <div class="text-sm text-white/70">Aktueller Monat</div>
  </div>

  <div class="glass rounded-2xl p-6 text-center">
    <div class="text-5xl mb-3">🥇</div>
    <div class="text-3xl font-bold text-warning mb-1">{{ ranking[0].points if ranking else 0 }}</div>
    <div class="text-sm text-white/70">Höchste Punktzahl</div>
  </div>
</div>

<!-- Tabs -->
<div x-data="{ activeTab: 'points' }" data-aos="fade-up" data-aos-delay="300">
  <div class="tabs tabs-boxed glass rounded-2xl p-2 mb-8">
    <a class="tab" :class="activeTab === 'points' ? 'tab-active' : ''" @click="activeTab = 'points'">
      <i data-lucide="trophy" class="w-4 h-4 mr-2"></i>
      Punkte-Ranking
    </a>
    <a class="tab" :class="activeTab === 'badges' ? 'tab-active' : ''" @click="activeTab = 'badges'">
      <i data-lucide="award" class="w-4 h-4 mr-2"></i>
      Badge-Ranking
    </a>
  </div>

  <!-- Punkte-Ranking Tab -->
  <div x-show="activeTab === 'points'" x-transition class="glass rounded-3xl p-8">
    <h2 class="text-2xl font-bold text-white mb-6 flex items-center gap-2">
      <i data-lucide="trophy" class="w-6 h-6 text-primary"></i>
      Punkte-Ranking – {{ month }}
    </h2>

    <div class="overflow-x-auto">
      <table class="table w-full">
        <thead>
          <tr>
            <th class="text-white">Rang</th>
            <th class="text-white">Spieler</th>
            <th class="text-white text-center">Level</th>
            <th class="text-white">Badges</th>
            <th class="text-white text-right">Punkte</th>
          </tr>
        </thead>
        <tbody>
          {% for player in ranking %}
          <tr class="hover:bg-white/5 cursor-pointer transition-all {% if current_user and player[0] == current_user %}bg-primary/10{% endif %}"
              onclick="window.location.href='/profile/{{ player[0] }}'">
            <!-- Rang -->
            <td class="font-bold text-center">
              {% if loop.index == 1 %}
                <span class="text-3xl">🥇</span>
              {% elif loop.index == 2 %}
                <span class="text-3xl">🥈</span>
              {% elif loop.index == 3 %}
                <span class="text-3xl">🥉</span>
              {% else %}
                <span class="text-xl text-white">{{ loop.index }}</span>
              {% endif %}
            </td>

            <!-- Spieler -->
            <td>
              <div class="flex items-center gap-3">
                <div class="avatar">
                  <div class="w-12 h-12 rounded-full bg-gradient-to-br from-primary to-secondary player-avatar" data-user="{{ player[0] }}" style="display: flex; align-items: center; justify-content: center; font-size: 1.25rem;">
                    {% set user_cosmetics_data = user_cosmetics.get(player[0], {}) %}
                    {% if user_cosmetics_data.get('avatar') %}
                      {{ user_cosmetics_data.get('avatar') }}
                    {% else %}
                      {{ player[0][0].upper() }}
                    {% endif %}
                  </div>
                </div>
                <div>
                  {% if user_cosmetics_data.get('title') %}
                  <div class="text-xs text-primary font-semibold">{{ user_cosmetics_data.get('title') }}</div>
                  {% endif %}
                  <div class="font-semibold text-white">{{ player[0] }}</div>
                </div>
              </div>
            </td>

            <!-- Level -->
            <td class="text-center">
              {% set user_level = user_levels.get(player[0], {}) %}
              <div class="flex flex-col items-center">
                <div class="text-2xl font-bold text-primary">{{ user_level.get('level', 1) }}</div>
                <div class="text-xs text-white/60 uppercase">{{ user_level.get('level_title', 'Anfänger') }}</div>
              </div>
            </td>

            <!-- Badges -->
            <td>
              <div class="flex gap-1 player-badges" data-user="{{ player[0] }}">
                <!-- Badges werden dynamisch geladen -->
              </div>
            </td>

            <!-- Punkte -->
            <td class="text-right">
              <div class="text-2xl font-bold text-success">{{ player[1] }}</div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Badge-Ranking Tab -->
  <div x-show="activeTab === 'badges'" x-transition class="glass rounded-3xl p-8">
    <h2 class="text-2xl font-bold text-white mb-6 flex items-center gap-2">
      <i data-lucide="award" class="w-6 h-6 text-secondary"></i>
      Badge-Ranking
    </h2>

    <div class="space-y-4">
      {% for player in badge_leaderboard %}
      <div class="glass rounded-2xl p-6 hover:scale-[1.02] transition-transform cursor-pointer"
           onclick="window.location.href='/profile/{{ player.user }}'">
        <div class="flex items-center justify-between gap-4">
          <!-- Player Info -->
          <div class="flex items-center gap-4">
            <div class="avatar">
              <div class="w-14 h-14 rounded-full bg-gradient-to-br from-secondary to-purple-600 player-avatar"
                   data-user="{{ player.user }}"
                   style="display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">
                {% set user_cosmetics_data = user_cosmetics.get(player.user, {}) %}
                {% if user_cosmetics_data.get('avatar') %}
                  {{ user_cosmetics_data.get('avatar') }}
                {% else %}
                  {{ player.user[0].upper() }}
                {% endif %}
              </div>
            </div>
            <div>
              {% if user_cosmetics_data.get('title') %}
              <div class="text-xs text-primary font-semibold">{{ user_cosmetics_data.get('title') }}</div>
              {% endif %}
              <div class="font-bold text-white text-lg">{{ player.user }}</div>
              <div class="flex gap-1 mt-2">
                {% for badge in player.badges[:5] %}
                <span class="badge-mini rarity-{{ badge.rarity }}" title="{{ badge.name }}">
                  {{ badge.emoji }}
                </span>
                {% endfor %}
              </div>
            </div>
          </div>

          <!-- Stats -->
          <div class="flex gap-6">
            <div class="text-center">
              <div class="text-2xl font-bold text-primary">{{ player.total_badges }}</div>
              <div class="text-xs text-white/60 uppercase">Total</div>
            </div>
            <div class="text-center">
              <div class="text-2xl font-bold text-secondary">{{ player.rarity_points }}</div>
              <div class="text-xs text-white/60 uppercase">Score</div>
            </div>
            <div class="text-center">
              <div class="text-2xl font-bold text-warning">{{ player.rarity_breakdown.get('legendary', 0) + player.rarity_breakdown.get('mythic', 0) }}</div>
              <div class="text-xs text-white/60 uppercase">Rare</div>
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// ============================================================================
// BADGE & AVATAR LOADING
// ============================================================================
document.addEventListener('DOMContentLoaded', function() {
  Promise.all([
    loadUserBadges(),
    loadUserAvatars()
  ]).catch(error => console.error('Error loading cosmetics:', error));
});

async function loadUserBadges() {
  const badgeContainers = document.querySelectorAll('.player-badges[data-user]');

  for (const container of badgeContainers) {
    const username = container.getAttribute('data-user');
    try {
      const response = await fetch(`/api/user/${username}/badges`);
      if (response.ok) {
        const data = await response.json();
        displayUserBadges(container, data.badges || []);
      }
    } catch (error) {
      console.error(`Failed to load badges for ${username}:`, error);
    }
  }
}

function displayUserBadges(container, badges) {
  container.innerHTML = '';

  if (!badges || badges.length === 0) {
    container.innerHTML = '<span class="text-xs text-white/50">Keine Badges</span>';
    return;
  }

  const rarityOrder = { mythic: 6, legendary: 5, epic: 4, rare: 3, uncommon: 2, common: 1 };
  const sortedBadges = badges.sort((a, b) => (rarityOrder[b.rarity] || 0) - (rarityOrder[a.rarity] || 0));
  const displayBadges = sortedBadges.slice(0, 5);

  displayBadges.forEach(badge => {
    const badgeElement = document.createElement('span');
    badgeElement.className = `badge-mini rarity-${badge.rarity} tooltip`;
    badgeElement.setAttribute('data-tip', badge.name);
    badgeElement.textContent = badge.emoji;
    container.appendChild(badgeElement);
  });

  if (badges.length > 5) {
    const counter = document.createElement('span');
    counter.className = 'badge badge-sm badge-primary';
    counter.textContent = `+${badges.length - 5}`;
    container.appendChild(counter);
  }
}

async function loadUserAvatars() {
  const avatarContainers = document.querySelectorAll('.player-avatar[data-user]');

  for (const avatar of avatarContainers) {
    const username = avatar.getAttribute('data-user');
    try {
      const response = await fetch(`/api/user/${username}/avatar`);
      if (response.ok) {
        const data = await response.json();
        applyAvatarCustomization(avatar, data);
      }
    } catch (error) {
      console.error(`Failed to load avatar for ${username}:`, error);
    }
  }
}

function applyAvatarCustomization(avatarElement, customization) {
  const components = {
    backgrounds: {
      "gradient_blue": "linear-gradient(135deg, #207487, #294c5d)",
      "gradient_green": "linear-gradient(135deg, #10b981, #059669)",
      "gradient_purple": "linear-gradient(135deg, #8b5cf6, #7c3aed)",
      "gradient_gold": "linear-gradient(135deg, #d4af6a, #c2ae7f)",
      "gradient_rainbow": "linear-gradient(135deg, #d4af6a, #ec4899, #8b5cf6, #207487, #10b981)",
      "starfield": "radial-gradient(circle, #1e293b 0%, #0f172a 100%)",
      "cosmic": "linear-gradient(135deg, #0c0a09, #1c1917, #d4af6a)"
    },
    borders: {
      "simple": { style: "2px solid #e5e7eb", glow: "none" },
      "glow": { style: "3px solid #d4af6a", glow: "0 0 10px rgba(212,175,106,0.5)" },
      "rainbow": { style: "3px solid transparent", glow: "none" },
      "fire": { style: "3px solid #ef4444", glow: "0 0 15px rgba(239,68,68,0.8)" },
      "diamond": { style: "4px solid #e5e7eb", glow: "0 0 20px rgba(255,255,255,0.8)" },
      "mythic": { style: "4px solid #ec4899", glow: "0 0 25px rgba(236,72,153,1)" }
    },
    avatars: {
      "cat_face": "🐱", "dog_face": "🐶", "panda_face": "🐼", "lion_face": "🦁",
      "unicorn_face": "🦄", "office_worker": "🧑‍💼", "scientist": "🧑‍🔬",
      "astronaut": "🧑‍🚀", "ninja": "🥷", "wizard": "🧙‍♂️", "vampire": "🧛‍♂️",
      "robot": "🤖", "alien": "👽", "crown": "👑", "crystal_ball": "🔮", "diamond": "💎"
    }
  };

  if (customization.avatar && components.avatars[customization.avatar]) {
    avatarElement.textContent = components.avatars[customization.avatar];
  }

  const background = components.backgrounds[customization.background] || components.backgrounds["gradient_blue"];
  avatarElement.style.setProperty('--avatar-bg', background);

  const border = components.borders[customization.border] || components.borders["simple"];
  avatarElement.style.setProperty('--avatar-border', border.style);
  avatarElement.style.setProperty('--avatar-glow', border.glow || 'none');

  avatarElement.classList.add('customized');

  if (customization.effect && customization.effect !== 'none') {
    avatarElement.classList.add(`avatar-effect-${customization.effect}`);
  }
}

// ============================================================================
// INITIALIZE
// ============================================================================
setTimeout(() => {
  lucide.createIcons();
}, 100);
</script>
{% endblock %}
