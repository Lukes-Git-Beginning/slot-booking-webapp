<!DOCTYPE html>
<html lang="de" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meine Buchungen - {{ user }} | Slot Booking</title>

    <!-- Tailwind CSS + DaisyUI -->
    <script src="{{ url_for('static', filename='tailwind.min.js') }}"></script>
    <link href="{{ url_for('static', filename='daisyui.min.css') }}" rel="stylesheet" type="text/css" />

    <!-- Lucide Icons -->
    <script src="{{ url_for('static', filename='lucide.js') }}"></script>

    <!-- AOS (Animate On Scroll) -->
    <link href="{{ url_for('static', filename='aos.css') }}" rel="stylesheet">
    <script src="{{ url_for('static', filename='aos.js') }}"></script>

    <!-- Particles.js -->
    <script src="{{ url_for('static', filename='particles.min.js') }}"></script>

    <!-- SortableJS for Drag & Drop -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

    <!-- Custom Tailwind Config -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'primary': '#d4af6a',
                        'primary-dark': '#c2ae7f',
                        'secondary': '#207487',
                        'accent': '#294c5d',
                    },
                },
            },
        }
    </script>

    <!-- Custom Styles -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');

        body {
            font-family: 'Inter', sans-serif;
        }

        .glass {
            background: rgba(18, 24, 32, 0.65);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.12);
        }

        #particles-js {
            position: fixed;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            z-index: 0;
            pointer-events: none;
        }

        /* Kanban Card Hover Effects */
        .kanban-card {
            transition: all 0.3s ease;
        }

        .kanban-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 30px rgba(212, 175, 106, 0.2);
        }

        .kanban-card.sortable-ghost {
            opacity: 0.4;
            transform: rotate(3deg) scale(1.05);
        }

        .kanban-card.sortable-drag {
            opacity: 1;
            box-shadow: 0 15px 40px rgba(212, 175, 106, 0.4);
        }

        /* Kanban Column Scrolling */
        .kanban-column {
            max-height: 70vh;
            overflow-y: auto;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(212, 175, 106, 0.3);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(212, 175, 106, 0.6);
        }

        /* Table Row Transitions */
        tbody tr {
            transition: all 0.2s ease;
        }

        /* Undo Button Animation */
        @keyframes slideInLeft {
            from {
                transform: translateX(-100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .undo-enter {
            animation: slideInLeft 0.3s ease;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-900 via-[#294c5d] to-slate-900 text-white min-h-screen">

    <!-- Particle Background -->
    <div id="particles-js"></div>

    <!-- Main Container -->
    <div class="relative z-10">
        <!-- Header -->
        <nav class="glass backdrop-blur-xl sticky top-0 z-50" data-aos="fade-down">
            <div class="container mx-auto px-4 py-4">
                <div class="flex items-center justify-between">
                    <a href="{{ url_for('main.index') }}" class="btn btn-ghost gap-2 hover:bg-white/10">
                        <i data-lucide="arrow-left" class="w-5 h-5"></i>
                        ZurÃ¼ck
                    </a>
                    <h1 class="text-xl font-bold">Meine Buchungen</h1>

                    <!-- View Toggle -->
                    <div class="btn-group">
                        <a href="?view=table" class="btn btn-sm {% if view_mode == 'table' %}btn-primary{% else %}btn-ghost{% endif %}">
                            <i data-lucide="table" class="w-4 h-4"></i>
                            <span class="hidden md:inline ml-2">Tabelle</span>
                        </a>
                        <a href="?view=kanban" class="btn btn-sm {% if view_mode == 'kanban' %}btn-primary{% else %}btn-ghost{% endif %}">
                            <i data-lucide="columns" class="w-4 h-4"></i>
                            <span class="hidden md:inline ml-2">Kanban</span>
                        </a>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="container mx-auto px-4 py-8">
            <!-- Page Header -->
            <div class="mb-8" data-aos="fade-down" data-aos-delay="100">
                <div class="flex items-center gap-4 mb-4">
                    <div class="w-16 h-16 rounded-2xl bg-gradient-to-br from-primary to-secondary flex items-center justify-center">
                        <i data-lucide="calendar" class="w-8 h-8"></i>
                    </div>
                    <div>
                        <h2 class="text-4xl font-bold">Meine gebuchten Kunden</h2>
                        <p class="text-gray-400">Ãœbersicht deiner Termine als Telefonist {{ user }}</p>
                    </div>
                </div>
            </div>

            <!-- Statistics Dashboard -->
            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-3 mb-8" data-aos="fade-up">
                <!-- Pending (Grau) -->
                <div class="glass rounded-xl p-4 border-l-4 border-gray-400 hover:scale-105 transition-transform">
                    <div class="flex items-center gap-2 mb-1">
                        <i data-lucide="clock" class="w-4 h-4 text-gray-400"></i>
                        <span class="text-xs text-gray-400">Pending</span>
                    </div>
                    <span class="text-2xl font-bold">{{ stats.pending or 0 }}</span>
                </div>

                <!-- Erschienen (GrÃ¼n) -->
                <div class="glass rounded-xl p-4 border-l-4 border-success hover:scale-105 transition-transform">
                    <div class="flex items-center gap-2 mb-1">
                        <i data-lucide="check-circle" class="w-4 h-4 text-success"></i>
                        <span class="text-xs text-gray-400">Erschienen</span>
                    </div>
                    <span class="text-2xl font-bold text-success">{{ stats.erschienen or 0 }}</span>
                    <div class="text-xs text-gray-400 mt-1">{{ stats.show_rate or 0 }}%</div>
                </div>

                <!-- RÃ¼ckholung (Purple) -->
                <div class="glass rounded-xl p-4 border-l-4 border-purple-500 hover:scale-105 transition-transform">
                    <div class="flex items-center gap-2 mb-1">
                        <i data-lucide="refresh-cw" class="w-4 h-4 text-purple-400"></i>
                        <span class="text-xs text-gray-400">RÃ¼ckholung</span>
                    </div>
                    <span class="text-2xl font-bold text-purple-400">{{ stats.rÃ¼ckholung or 0 }}</span>
                </div>

                <!-- Sonderkunden (Gelb) -->
                <div class="glass rounded-xl p-4 border-l-4 border-warning hover:scale-105 transition-transform">
                    <div class="flex items-center gap-2 mb-1">
                        <i data-lucide="star" class="w-4 h-4 text-warning"></i>
                        <span class="text-xs text-warning/70">Sonderkunden</span>
                    </div>
                    <span class="text-2xl font-bold text-warning">{{ stats.sonderkunden or 0 }}</span>
                </div>

                <!-- Verschoben (Info/Orange) -->
                <div class="glass rounded-xl p-4 border-l-4 border-info hover:scale-105 transition-transform">
                    <div class="flex items-center gap-2 mb-1">
                        <i data-lucide="calendar-x" class="w-4 h-4 text-info"></i>
                        <span class="text-xs text-info/70">Verschoben</span>
                    </div>
                    <span class="text-2xl font-bold text-info">{{ stats.verschoben or 0 }}</span>
                </div>

                <!-- Nicht Erschienen (Rot) -->
                <div class="glass rounded-xl p-4 border-l-4 border-error hover:scale-105 transition-transform">
                    <div class="flex items-center gap-2 mb-1">
                        <i data-lucide="x-circle" class="w-4 h-4 text-error"></i>
                        <span class="text-xs text-error/70">Nicht ersch.</span>
                    </div>
                    <span class="text-2xl font-bold text-error">{{ stats.nicht_erschienen or 0 }}</span>
                    <div class="text-xs text-error/50 mt-1">{{ stats.no_show_rate or 0 }}%</div>
                </div>

                <!-- Ghost (Dunkelrot) -->
                <div class="glass rounded-xl p-4 border-l-4 border-red-900 hover:scale-105 transition-transform">
                    <div class="flex items-center gap-2 mb-1">
                        <i data-lucide="user-x" class="w-4 h-4 text-red-300"></i>
                        <span class="text-xs text-gray-400">Ghost</span>
                    </div>
                    <span class="text-2xl font-bold text-red-300">{{ stats.ghost or 0 }}</span>
                </div>
            </div>

            {% if my_events %}

            <!-- ============================================ -->
            <!-- TABLE VIEW -->
            <!-- ============================================ -->
            {% if view_mode == 'table' %}
            <div class="glass rounded-3xl overflow-hidden" data-aos="fade-up">
                <div class="overflow-x-auto">
                    <table class="table table-zebra">
                        <thead>
                            <tr class="border-b border-white/10">
                                <th class="bg-primary/20">
                                    <div class="flex items-center gap-2">
                                        <i data-lucide="calendar-days" class="w-4 h-4"></i>
                                        Datum
                                    </div>
                                </th>
                                <th class="bg-primary/20">
                                    <div class="flex items-center gap-2">
                                        <i data-lucide="clock" class="w-4 h-4"></i>
                                        Uhrzeit
                                    </div>
                                </th>
                                <th class="bg-primary/20">
                                    <div class="flex items-center gap-2">
                                        <i data-lucide="user" class="w-4 h-4"></i>
                                        Kunde
                                    </div>
                                </th>
                                <th class="bg-primary/20">
                                    <div class="flex items-center gap-2">
                                        <i data-lucide="activity" class="w-4 h-4"></i>
                                        Status
                                    </div>
                                </th>
                                <th class="bg-primary/20">
                                    <div class="flex items-center gap-2">
                                        <i data-lucide="target" class="w-4 h-4"></i>
                                        Typ
                                    </div>
                                </th>
                                <th class="bg-primary/20">
                                    <div class="flex items-center gap-2">
                                        <i data-lucide="user-circle" class="w-4 h-4"></i>
                                        Telefonist
                                    </div>
                                </th>
                                <th class="bg-primary/20">
                                    <div class="flex items-center gap-2">
                                        <i data-lucide="file-text" class="w-4 h-4"></i>
                                        Notizen
                                    </div>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ev in my_events %}
                            <tr class="{{ ev.row_bg_class }} transition-all">
                                <td>
                                    <span class="font-semibold">{{ ev.date }}</span>
                                    {% if ev.is_future %}
                                    <span class="badge badge-ghost badge-xs ml-2">ZukÃ¼nftig</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge badge-ghost badge-lg">{{ ev.hour }}</span>
                                </td>
                                <td>
                                    <span class="font-medium">{{ ev.customer_name }}</span>
                                </td>
                                <td>
                                    <span class="badge {{ ev.badge_class }} gap-2">
                                        <i data-lucide="{{ ev.status_icon }}" class="w-3 h-3"></i>
                                        {{ ev.status_label }}
                                    </span>
                                </td>
                                <td>
                                    <span class="badge badge-sm badge-outline">{{ ev.potential }}</span>
                                </td>
                                <td>
                                    <!-- Initialen-Badge -->
                                    <div class="avatar placeholder">
                                        <div class="bg-primary text-primary-content rounded-full w-8 h-8">
                                            <span class="text-xs font-bold">{{ ev.booked_by_initials }}</span>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <span class="text-sm text-gray-400">{{ ev.desc[:50] if ev.desc != '-' else '-' }}{% if ev.desc|length > 50 %}...{% endif %}</span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}

            <!-- ============================================ -->
            <!-- KANBAN VIEW (HubSpot-Style) -->
            <!-- ============================================ -->
            {% if view_mode == 'kanban' %}
            <div class="overflow-x-auto pb-4" data-aos="fade-up">
                <div class="inline-flex gap-4 min-w-full" style="min-width: max-content;">

                    <!-- PENDING Column -->
                    <div class="w-80 flex-shrink-0">
                        <div class="glass rounded-2xl p-4 h-full">
                            <div class="flex items-center justify-between mb-4 pb-3 border-b border-gray-400/30">
                                <div class="flex items-center gap-2">
                                    <div class="w-3 h-3 rounded-full bg-gray-400"></div>
                                    <h3 class="font-bold text-gray-300 uppercase text-sm">Pending</h3>
                                </div>
                                <span class="badge badge-ghost">{{ kanban_columns.pending|length }}</span>
                            </div>

                            <div class="space-y-3 kanban-column" data-column="pending" id="column-pending">
                                {% for ev in kanban_columns.pending %}
                                <div class="kanban-card glass rounded-xl p-4 cursor-move border border-gray-400/20"
                                     data-event-id="{{ ev.id }}"
                                     data-customer-name="{{ ev.customer_name }}">
                                    <h4 class="font-bold text-lg mb-2 line-clamp-1">{{ ev.customer_name }}</h4>

                                    <div class="flex items-center gap-2 text-sm text-gray-400 mb-2">
                                        <i data-lucide="calendar" class="w-4 h-4"></i>
                                        <span>{{ ev.date }} Â· {{ ev.hour }}</span>
                                    </div>

                                    <div class="flex items-center gap-2 mb-2">
                                        <div class="avatar placeholder">
                                            <div class="bg-primary text-primary-content rounded-full w-6 h-6">
                                                <span class="text-xs">{{ ev.booked_by_initials }}</span>
                                            </div>
                                        </div>
                                        <span class="text-xs text-gray-400">{{ ev.booked_by }}</span>
                                    </div>

                                    {% if ev.days_until > 0 %}
                                    <div class="text-xs text-warning flex items-center gap-1">
                                        <i data-lucide="clock" class="w-3 h-3"></i>
                                        In {{ ev.days_until }} Tag{% if ev.days_until != 1 %}en{% endif %}
                                    </div>
                                    {% elif ev.days_until == 0 %}
                                    <div class="text-xs text-warning font-bold flex items-center gap-1">
                                        <i data-lucide="alert-circle" class="w-3 h-3"></i>
                                        Heute!
                                    </div>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>

                    <!-- ERSCHIENEN Column -->
                    <div class="w-80 flex-shrink-0">
                        <div class="glass rounded-2xl p-4 h-full">
                            <div class="flex items-center justify-between mb-4 pb-3 border-b border-success/30">
                                <div class="flex items-center gap-2">
                                    <div class="w-3 h-3 rounded-full bg-success"></div>
                                    <h3 class="font-bold text-success uppercase text-sm">Erschienen</h3>
                                </div>
                                <span class="badge badge-success">{{ kanban_columns.erschienen|length }}</span>
                            </div>

                            <div class="space-y-3 kanban-column" data-column="erschienen" id="column-erschienen">
                                {% for ev in kanban_columns.erschienen %}
                                <div class="kanban-card glass rounded-xl bg-success/5 p-4 border-l-4 border-success cursor-move"
                                     data-event-id="{{ ev.id }}"
                                     data-customer-name="{{ ev.customer_name }}">
                                    <h4 class="font-bold text-lg mb-2 line-clamp-1">{{ ev.customer_name }}</h4>

                                    <div class="flex items-center gap-2 text-sm text-gray-400 mb-2">
                                        <i data-lucide="calendar" class="w-4 h-4"></i>
                                        <span>{{ ev.date }} Â· {{ ev.hour }}</span>
                                    </div>

                                    <div class="flex items-center gap-2 mb-2">
                                        <div class="avatar placeholder">
                                            <div class="bg-primary text-primary-content rounded-full w-6 h-6">
                                                <span class="text-xs">{{ ev.booked_by_initials }}</span>
                                            </div>
                                        </div>
                                    </div>

                                    {% if ev.days_ago > 0 %}
                                    <div class="text-xs text-success flex items-center gap-1">
                                        <i data-lucide="check" class="w-3 h-3"></i>
                                        Vor {{ ev.days_ago }} Tag{% if ev.days_ago != 1 %}en{% endif %}
                                    </div>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>

                    <!-- RÃœCKHOLUNG Column -->
                    <div class="w-80 flex-shrink-0">
                        <div class="glass rounded-2xl p-4 h-full">
                            <div class="flex items-center justify-between mb-4 pb-3 border-b border-purple-500/30">
                                <div class="flex items-center gap-2">
                                    <div class="w-3 h-3 rounded-full bg-purple-500"></div>
                                    <h3 class="font-bold text-purple-400 uppercase text-sm">RÃ¼ckholung</h3>
                                </div>
                                <span class="badge badge-primary">{{ kanban_columns.rÃ¼ckholung|length }}</span>
                            </div>

                            <div class="space-y-3 kanban-column" data-column="rÃ¼ckholung" id="column-rÃ¼ckholung">
                                {% for ev in kanban_columns.rÃ¼ckholung %}
                                <div class="kanban-card glass rounded-xl p-4 border-l-4 border-purple-500 cursor-move"
                                     data-event-id="{{ ev.id }}"
                                     data-customer-name="{{ ev.customer_name }}">
                                    <h4 class="font-bold text-lg mb-2 line-clamp-1">{{ ev.customer_name }}</h4>

                                    <div class="flex items-center gap-2 text-sm text-gray-400 mb-2">
                                        <i data-lucide="calendar" class="w-4 h-4"></i>
                                        <span>{{ ev.date }} Â· {{ ev.hour }}</span>
                                    </div>

                                    <div class="flex items-center gap-2">
                                        <div class="avatar placeholder">
                                            <div class="bg-primary text-primary-content rounded-full w-6 h-6">
                                                <span class="text-xs">{{ ev.booked_by_initials }}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>

                    <!-- SONDERKUNDEN Column -->
                    <div class="w-80 flex-shrink-0">
                        <div class="glass rounded-2xl p-4 h-full">
                            <div class="flex items-center justify-between mb-4 pb-3 border-b border-warning/30">
                                <div class="flex items-center gap-2">
                                    <div class="w-3 h-3 rounded-full bg-warning"></div>
                                    <h3 class="font-bold text-warning uppercase text-sm">Sonderkunden</h3>
                                </div>
                                <span class="badge badge-warning">{{ kanban_columns.sonderkunden|length }}</span>
                            </div>

                            <div class="space-y-3 kanban-column" data-column="sonderkunden" id="column-sonderkunden">
                                {% for ev in kanban_columns.sonderkunden %}
                                <div class="kanban-card glass rounded-xl bg-warning/5 p-4 border-l-4 border-warning cursor-move"
                                     data-event-id="{{ ev.id }}"
                                     data-customer-name="{{ ev.customer_name }}">
                                    <h4 class="font-bold text-lg mb-2 line-clamp-1">{{ ev.customer_name }}</h4>

                                    <div class="flex items-center gap-2 text-sm text-gray-400 mb-2">
                                        <i data-lucide="calendar" class="w-4 h-4"></i>
                                        <span>{{ ev.date }} Â· {{ ev.hour }}</span>
                                    </div>

                                    <div class="flex items-center gap-2">
                                        <div class="avatar placeholder">
                                            <div class="bg-primary text-primary-content rounded-full w-6 h-6">
                                                <span class="text-xs">{{ ev.booked_by_initials }}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>

                    <!-- VERSCHOBEN Column -->
                    <div class="w-80 flex-shrink-0">
                        <div class="glass rounded-2xl p-4 h-full">
                            <div class="flex items-center justify-between mb-4 pb-3 border-b border-info/30">
                                <div class="flex items-center gap-2">
                                    <div class="w-3 h-3 rounded-full bg-info"></div>
                                    <h3 class="font-bold text-info uppercase text-sm">Verschoben</h3>
                                </div>
                                <span class="badge badge-info">{{ kanban_columns.verschoben|length }}</span>
                            </div>

                            <div class="space-y-3 kanban-column" data-column="verschoben" id="column-verschoben">
                                {% for ev in kanban_columns.verschoben %}
                                <div class="kanban-card glass rounded-xl bg-info/5 p-4 border-l-4 border-info cursor-move"
                                     data-event-id="{{ ev.id }}"
                                     data-customer-name="{{ ev.customer_name }}">
                                    <h4 class="font-bold text-lg mb-2 line-clamp-1">{{ ev.customer_name }}</h4>

                                    <div class="flex items-center gap-2 text-sm text-gray-400 mb-2">
                                        <i data-lucide="calendar" class="w-4 h-4"></i>
                                        <span>{{ ev.date }} Â· {{ ev.hour }}</span>
                                    </div>

                                    <div class="flex items-center gap-2">
                                        <div class="avatar placeholder">
                                            <div class="bg-primary text-primary-content rounded-full w-6 h-6">
                                                <span class="text-xs">{{ ev.booked_by_initials }}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>

                    <!-- NICHT ERSCHIENEN Column -->
                    <div class="w-80 flex-shrink-0">
                        <div class="glass rounded-2xl p-4 h-full">
                            <div class="flex items-center justify-between mb-4 pb-3 border-b border-error/30">
                                <div class="flex items-center gap-2">
                                    <div class="w-3 h-3 rounded-full bg-error"></div>
                                    <h3 class="font-bold text-error uppercase text-sm">Nicht Erschienen</h3>
                                </div>
                                <span class="badge badge-error">{{ kanban_columns.nicht_erschienen|length }}</span>
                            </div>

                            <div class="space-y-3 kanban-column" data-column="nicht_erschienen" id="column-nicht_erschienen">
                                {% for ev in kanban_columns.nicht_erschienen %}
                                <div class="kanban-card glass rounded-xl bg-error/5 p-4 border-l-4 border-error cursor-move"
                                     data-event-id="{{ ev.id }}"
                                     data-customer-name="{{ ev.customer_name }}">
                                    <h4 class="font-bold text-lg mb-2 line-clamp-1">{{ ev.customer_name }}</h4>

                                    <div class="flex items-center gap-2 text-sm text-gray-400 mb-2">
                                        <i data-lucide="calendar" class="w-4 h-4"></i>
                                        <span>{{ ev.date }} Â· {{ ev.hour }}</span>
                                    </div>

                                    <div class="flex items-center gap-2">
                                        <div class="avatar placeholder">
                                            <div class="bg-primary text-primary-content rounded-full w-6 h-6">
                                                <span class="text-xs">{{ ev.booked_by_initials }}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>

                    <!-- GHOST Column -->
                    <div class="w-80 flex-shrink-0">
                        <div class="glass rounded-2xl p-4 h-full">
                            <div class="flex items-center justify-between mb-4 pb-3 border-b border-red-900/50">
                                <div class="flex items-center gap-2">
                                    <div class="w-3 h-3 rounded-full bg-red-900"></div>
                                    <h3 class="font-bold text-red-300 uppercase text-sm">Ghost</h3>
                                </div>
                                <span class="badge bg-red-900 border-red-900 text-red-100">{{ kanban_columns.ghost|length }}</span>
                            </div>

                            <div class="space-y-3 kanban-column" data-column="ghost" id="column-ghost">
                                {% for ev in kanban_columns.ghost %}
                                <div class="kanban-card glass rounded-xl p-4 border-l-4 border-red-900 cursor-move"
                                     data-event-id="{{ ev.id }}"
                                     data-customer-name="{{ ev.customer_name }}">
                                    <h4 class="font-bold text-lg mb-2 line-clamp-1">{{ ev.customer_name }}</h4>

                                    <div class="flex items-center gap-2 text-sm text-gray-400 mb-2">
                                        <i data-lucide="calendar" class="w-4 h-4"></i>
                                        <span>{{ ev.date }} Â· {{ ev.hour }}</span>
                                    </div>

                                    <div class="flex items-center gap-2">
                                        <div class="avatar placeholder">
                                            <div class="bg-primary text-primary-content rounded-full w-6 h-6">
                                                <span class="text-xs">{{ ev.booked_by_initials }}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>

                </div>
            </div>
            {% endif %}

            {% else %}
            <!-- Empty State -->
            <div class="glass rounded-3xl p-12 text-center" data-aos="fade-up">
                <div class="w-24 h-24 mx-auto mb-6 rounded-full bg-warning/20 flex items-center justify-center">
                    <i data-lucide="calendar-x" class="w-12 h-12 text-warning"></i>
                </div>
                <h3 class="text-2xl font-bold mb-2">Keine Buchungen gefunden</h3>
                <p class="text-gray-400 mb-6">Du hast aktuell keine gebuchten Kunden in den letzten 30 Tagen.</p>
                <a href="{{ url_for('main.index') }}" class="btn btn-primary gap-2">
                    <i data-lucide="calendar-plus" class="w-4 h-4"></i>
                    Kunden buchen
                </a>
            </div>
            {% endif %}
        </main>

        <!-- Footer -->
        <footer class="glass mt-16 backdrop-blur-xl" data-aos="fade-up">
            <div class="container mx-auto px-4 py-8">
                <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                    <p class="text-sm text-gray-400">Beraterwelt v3.3.4 - ZFA</p>
                    <div class="flex gap-4">
                        <a href="{{ url_for('main.index') }}" class="text-gray-400 hover:text-primary transition-colors">Dashboard</a>
                        <a href="/health" class="text-gray-400 hover:text-primary transition-colors">Status</a>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <!-- Undo Button (Hidden by default) -->
    <button id="undo-btn" class="btn btn-warning fixed bottom-4 left-4 z-50 hidden gap-2 undo-enter" onclick="undo()">
        <i data-lucide="undo" class="w-4 h-4"></i>
        <span id="undo-text">RÃ¼ckgÃ¤ngig (3s)</span>
    </button>

    <!-- JavaScript -->
    <script>
        // Initialize Lucide Icons
        lucide.createIcons();

        // Initialize AOS
        AOS.init({
            duration: 800,
            easing: 'ease-out-cubic',
            once: true,
            offset: 50
        });

        // Initialize Particles.js
        particlesJS('particles-js', {
            particles: {
                number: { value: 60, density: { enable: true, value_area: 800 } },
                color: { value: '#d4af6a' },
                shape: { type: 'circle' },
                opacity: {
                    value: 0.3,
                    random: true,
                    anim: { enable: true, speed: 1, opacity_min: 0.1, sync: false }
                },
                size: {
                    value: 3,
                    random: true,
                    anim: { enable: true, speed: 2, size_min: 0.1, sync: false }
                },
                line_linked: {
                    enable: true,
                    distance: 150,
                    color: '#d4af6a',
                    opacity: 0.2,
                    width: 1
                },
                move: {
                    enable: true,
                    speed: 1,
                    direction: 'none',
                    random: false,
                    straight: false,
                    out_mode: 'out',
                    bounce: false
                }
            },
            interactivity: {
                detect_on: 'canvas',
                events: {
                    onhover: { enable: true, mode: 'grab' },
                    onclick: { enable: true, mode: 'push' },
                    resize: true
                },
                modes: {
                    grab: { distance: 140, line_linked: { opacity: 0.5 } },
                    push: { particles_nb: 3 }
                }
            },
            retina_detect: true
        });

        // ===================================================================
        // DRAG & DROP FUNCTIONALITY (Kanban Mode Only)
        // ===================================================================
        {% if view_mode == 'kanban' %}
        document.addEventListener('DOMContentLoaded', function() {
            const columns = document.querySelectorAll('.kanban-column');

            columns.forEach(column => {
                new Sortable(column, {
                    group: 'kanban',
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                    dragClass: 'sortable-drag',

                    onEnd: function(evt) {
                        const eventId = evt.item.dataset.eventId;
                        const customerName = evt.item.dataset.customerName;
                        const newColumn = evt.to.dataset.column;
                        const oldColumn = evt.from.dataset.column;

                        console.log(`Moved ${customerName} from ${oldColumn} to ${newColumn}`);

                        // If dropped into PENDING column -> Show reschedule modal
                        if (newColumn === 'pending') {
                            showRescheduleModal(eventId, customerName, evt.item);
                        } else {
                            // Otherwise: Update status
                            updateEventStatus(eventId, customerName, newColumn, oldColumn);
                        }
                    }
                });
            });
        });
        {% endif %}

        // ===================================================================
        // TOAST NOTIFICATIONS
        // ===================================================================
        function showToast(message, type = 'info') {
            const alertClass = type === 'success' ? 'alert-success' : type === 'error' ? 'alert-error' : 'alert-info';
            const toast = document.createElement('div');
            toast.className = `alert ${alertClass} fixed bottom-4 right-4 w-auto max-w-md z-50 shadow-lg`;
            toast.innerHTML = `<span>${message}</span>`;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // ===================================================================
        // UNDO FUNCTIONALITY
        // ===================================================================
        let undoData = null;
        let undoTimer = null;

        function showUndoButton(data) {
            undoData = data;
            const undoBtn = document.getElementById('undo-btn');
            undoBtn.classList.remove('hidden');

            let secondsLeft = 3;
            document.getElementById('undo-text').textContent = `RÃ¼ckgÃ¤ngig (${secondsLeft}s)`;

            undoTimer = setInterval(() => {
                secondsLeft--;
                if (secondsLeft <= 0) {
                    clearInterval(undoTimer);
                    undoBtn.classList.add('hidden');
                    undoData = null;
                } else {
                    document.getElementById('undo-text').textContent = `RÃ¼ckgÃ¤ngig (${secondsLeft}s)`;
                }
            }, 1000);
        }

        function undo() {
            if (!undoData) return;

            clearInterval(undoTimer);
            document.getElementById('undo-btn').classList.add('hidden');

            showToast('ðŸ”„ Ã„nderung wird rÃ¼ckgÃ¤ngig gemacht...', 'info');

            // Revert the status change
            fetch('/api/update-event-status', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    event_id: undoData.eventId,
                    new_status: undoData.oldColumn
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('âœ… Ã„nderung rÃ¼ckgÃ¤ngig gemacht!', 'success');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showToast('âŒ Fehler beim RÃ¼ckgÃ¤ngigmachen: ' + data.error, 'error');
                }
            })
            .catch(error => {
                showToast('âŒ Netzwerkfehler beim RÃ¼ckgÃ¤ngigmachen', 'error');
                console.error('Undo error:', error);
            });

            undoData = null;
        }

        // ===================================================================
        // STATUS UPDATE (Drag & Drop)
        // ===================================================================
        function updateEventStatus(eventId, customerName, newColumn, oldColumn) {
            showToast(`ðŸ”„ Status wird aktualisiert...`, 'info');

            fetch('/api/update-event-status', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    event_id: eventId,
                    new_status: newColumn
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast(`âœ… Status auf "${data.new_status_label}" aktualisiert!`, 'success');

                    // Show Undo button for 3 seconds
                    showUndoButton({
                        eventId: eventId,
                        oldColumn: oldColumn,
                        newColumn: newColumn,
                        customerName: customerName
                    });

                    // Reload after undo window closes
                    setTimeout(() => location.reload(), 3500);
                } else {
                    showToast('âŒ Fehler: ' + data.error, 'error');
                    setTimeout(() => location.reload(), 1500);
                }
            })
            .catch(error => {
                showToast('âŒ Netzwerkfehler beim Status-Update', 'error');
                console.error('Status update error:', error);
                setTimeout(() => location.reload(), 1500);
            });
        }

        // ===================================================================
        // RESCHEDULE MODAL
        // ===================================================================
        let currentRescheduleData = null;

        function showRescheduleModal(eventId, customerName, cardElement) {
            currentRescheduleData = { eventId, customerName, cardElement };

            // Create modal HTML
            const modalHTML = `
                <dialog id="reschedule-modal" class="modal modal-open">
                    <div class="modal-box glass w-11/12 max-w-2xl">
                        <h3 class="font-bold text-2xl mb-4 flex items-center gap-2">
                            <i data-lucide="calendar-clock" class="w-6 h-6 text-primary"></i>
                            Termin umbuchen
                        </h3>
                        <p class="text-gray-400 mb-6">Kunde: <span class="font-bold text-white">${customerName}</span></p>

                        <!-- Date Picker -->
                        <div class="form-control mb-4">
                            <label class="label">
                                <span class="label-text">Neues Datum</span>
                            </label>
                            <input type="date" id="reschedule-date"
                                   class="input input-bordered"
                                   min="${new Date().toISOString().split('T')[0]}"
                                   required />
                        </div>

                        <!-- Time Slots (dynamically loaded) -->
                        <div class="form-control mb-4">
                            <label class="label">
                                <span class="label-text">VerfÃ¼gbare Zeitslots</span>
                            </label>
                            <div id="time-slots-container" class="grid grid-cols-3 gap-2">
                                <div class="col-span-3 text-center text-gray-400 py-4">
                                    Bitte wÃ¤hle zuerst ein Datum
                                </div>
                            </div>
                        </div>

                        <!-- Consultant Dropdown (dynamically loaded) -->
                        <div class="form-control mb-4" id="consultant-container" style="display:none;">
                            <label class="label">
                                <span class="label-text">Berater</span>
                            </label>
                            <select id="reschedule-consultant" class="select select-bordered">
                                <option value="">Auto-Auswahl</option>
                            </select>
                        </div>

                        <!-- Optional Note -->
                        <div class="form-control mb-6">
                            <label class="label">
                                <span class="label-text">Notiz (optional)</span>
                            </label>
                            <textarea id="reschedule-note" class="textarea textarea-bordered"
                                      placeholder="Grund fÃ¼r Umbuchung..."></textarea>
                        </div>

                        <!-- Actions -->
                        <div class="modal-action">
                            <button class="btn btn-ghost" onclick="closeRescheduleModal()">Abbrechen</button>
                            <button class="btn btn-primary" id="confirm-reschedule-btn" disabled>
                                <i data-lucide="check" class="w-4 h-4"></i>
                                Umbuchen
                            </button>
                        </div>
                    </div>
                    <form method="dialog" class="modal-backdrop">
                        <button onclick="closeRescheduleModal()">close</button>
                    </form>
                </dialog>
            `;

            // Inject modal
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            lucide.createIcons();

            // Add event listeners
            document.getElementById('reschedule-date').addEventListener('change', loadAvailableSlots);
            document.getElementById('confirm-reschedule-btn').addEventListener('click', confirmReschedule);
        }

        function closeRescheduleModal() {
            const modal = document.getElementById('reschedule-modal');
            if (modal) {
                modal.remove();
            }
            // Reload to restore original card position
            setTimeout(() => location.reload(), 300);
        }

        function loadAvailableSlots() {
            const date = document.getElementById('reschedule-date').value;
            if (!date) return;

            const container = document.getElementById('time-slots-container');
            container.innerHTML = '<div class="col-span-3 text-center"><span class="loading loading-spinner"></span></div>';

            fetch(`/api/get-available-slots?date=${date}`)
                .then(response => response.json())
                .then(data => {
                    if (!data.success) {
                        container.innerHTML = `<div class="col-span-3 text-center text-error">${data.error}</div>`;
                        return;
                    }

                    if (data.slots.length === 0) {
                        container.innerHTML = '<div class="col-span-3 text-center text-warning">Keine verfÃ¼gbaren Slots an diesem Tag</div>';
                        return;
                    }

                    // Display available slots
                    let slotsHTML = '';
                    data.slots.forEach(slot => {
                        const consultantsText = slot.consultants.length > 0
                            ? slot.consultants.join(', ')
                            : 'Alle belegt';
                        const disabled = slot.consultants.length === 0 ? 'disabled' : '';

                        slotsHTML += `
                            <button type="button"
                                    class="btn btn-sm btn-outline ${disabled ? 'btn-disabled' : ''}"
                                    data-time="${slot.time}"
                                    data-consultants='${JSON.stringify(slot.consultants)}'
                                    onclick="selectTimeSlot(this)"
                                    ${disabled}>
                                ${slot.time}
                                ${slot.consultants.length > 0 ? `<span class="badge badge-xs">${slot.consultants.length}</span>` : ''}
                            </button>
                        `;
                    });

                    container.innerHTML = slotsHTML;
                })
                .catch(error => {
                    console.error('Error loading slots:', error);
                    container.innerHTML = '<div class="col-span-3 text-center text-error">Fehler beim Laden der Slots</div>';
                });
        }

        function selectTimeSlot(button) {
            // Deselect all
            document.querySelectorAll('#time-slots-container .btn').forEach(btn => {
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-outline');
            });

            // Select this one
            button.classList.add('btn-primary');
            button.classList.remove('btn-outline');

            // Store selected time
            button.dataset.selected = 'true';

            // Update consultant dropdown
            const consultants = JSON.parse(button.dataset.consultants);
            const consultantContainer = document.getElementById('consultant-container');
            const consultantSelect = document.getElementById('reschedule-consultant');

            consultantSelect.innerHTML = '<option value="">Auto-Auswahl</option>';
            consultants.forEach(c => {
                consultantSelect.innerHTML += `<option value="${c}">${c}</option>`;
            });

            consultantContainer.style.display = 'block';

            // Enable confirm button
            document.getElementById('confirm-reschedule-btn').disabled = false;
        }

        function confirmReschedule() {
            const date = document.getElementById('reschedule-date').value;
            const selectedSlotBtn = document.querySelector('#time-slots-container .btn[data-selected="true"]');
            const time = selectedSlotBtn ? selectedSlotBtn.dataset.time : null;
            const consultant = document.getElementById('reschedule-consultant').value;
            const note = document.getElementById('reschedule-note').value;

            if (!date || !time) {
                showToast('âŒ Bitte Datum und Zeitslot auswÃ¤hlen', 'error');
                return;
            }

            // Disable button during request
            const btn = document.getElementById('confirm-reschedule-btn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading loading-spinner loading-xs"></span> Umbuchen...';

            fetch('/api/reschedule-booking', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    event_id: currentRescheduleData.eventId,
                    new_date: date,
                    new_time: time,
                    consultant: consultant,
                    note: note
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast(`âœ… Termin erfolgreich umgebucht auf ${date} ${time}!`, 'success');
                    closeRescheduleModal();
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showToast('âŒ Fehler: ' + data.error, 'error');
                    btn.disabled = false;
                    btn.innerHTML = '<i data-lucide="check" class="w-4 h-4"></i> Umbuchen';
                    lucide.createIcons();
                }
            })
            .catch(error => {
                console.error('Reschedule error:', error);
                showToast('âŒ Netzwerkfehler beim Umbuchen', 'error');
                btn.disabled = false;
                btn.innerHTML = '<i data-lucide="check" class="w-4 h-4"></i> Umbuchen';
                lucide.createIcons();
            });
        }

        // ===================================================================
        // AUTO-REFRESH (every 5 minutes when page is visible)
        // ===================================================================
        let autoRefreshInterval = null;

        function startAutoRefresh() {
            // Refresh every 5 minutes (300,000 ms)
            autoRefreshInterval = setInterval(() => {
                if (!document.hidden) {
                    console.log('Auto-refreshing my-calendar...');
                    location.reload();
                }
            }, 5 * 60 * 1000);
        }

        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }

        // Start auto-refresh when page loads
        document.addEventListener('DOMContentLoaded', function() {
            startAutoRefresh();
        });

        // Stop auto-refresh when page is hidden/closed
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                stopAutoRefresh();
            } else {
                startAutoRefresh();
            }
        });

        // Stop on page unload
        window.addEventListener('beforeunload', stopAutoRefresh);
    </script>
</body>
</html>
