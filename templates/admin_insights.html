<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>üìà Admin Insights - Detaillierte Analytics</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- DaisyUI -->
  <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.min.css" rel="stylesheet" type="text/css" />

  <!-- AOS Animations -->
  <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">

  <!-- Admin Style CSS (fallback) -->
  <link rel="stylesheet" href="{{ url_for('static', filename='admin_style.css') }}">

  <!-- ApexCharts -->
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

  <!-- Alpine.js -->
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

  <!-- Tailwind Config -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#5ab1ff',
            secondary: '#10b981',
            accent: '#f97316',
          }
        }
      }
    }
  </script>

  <style>
    /* Glassmorphism Effect */
    .glass {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
    }

    body {
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
      min-height: 100vh;
    }

    .gradient-bg {
      background: linear-gradient(135deg, rgba(90, 177, 255, 0.15), rgba(16, 185, 129, 0.15), rgba(249, 115, 22, 0.1));
    }

    /* Chart containers */
    .chart-container {
      position: relative;
      height: 300px;
      margin-top: 15px;
    }

    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(90, 177, 255, 0.5);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: rgba(90, 177, 255, 0.7);
    }

    /* Alpine.js cloak */
    [x-cloak] {
      display: none !important;
    }
  </style>
</head>
<body class="text-gray-100">
  <!-- Include Admin Navigation -->
  {% include 'admin_nav.html' %}

  <div class="max-w-[1600px] mx-auto px-4 py-8" x-data="{ activeTab: 'overview' }">
    <!-- Quick Actions -->
    <div class="flex flex-wrap gap-4 mb-8" data-aos="fade-down">
      <a href="{{ url_for('admin.admin_dashboard') }}" class="btn btn-ghost glass hover:bg-primary/20 transition-all duration-300">
        <i data-lucide="arrow-left" class="w-5 h-5"></i>
        Zur√ºck zum Dashboard
      </a>
      <a href="/" class="btn btn-ghost glass hover:bg-secondary/20 transition-all duration-300">
        <i data-lucide="home" class="w-5 h-5"></i>
        Zur Hauptseite
      </a>
    </div>

    <!-- Header -->
    <div class="glass gradient-bg rounded-2xl p-10 mb-8 text-center border-2 border-accent/30" data-aos="fade-up">
      <h1 class="text-4xl font-bold text-accent mb-3 flex items-center justify-center gap-3">
        <i data-lucide="bar-chart-3" class="w-10 h-10"></i>
        Detaillierte Analytics & Insights
      </h1>
      <p class="text-gray-300 text-lg">Erweiterte Einblicke in Buchungsverhalten, Trends und Optimierungsm√∂glichkeiten</p>
    </div>

    <!-- Insights Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

      <!-- Peak Hours Analysis -->
      <div class="glass rounded-2xl p-6 hover:shadow-2xl transition-all duration-300" data-aos="fade-up" data-aos-delay="100">
        <h3 class="text-xl font-semibold text-accent mb-4 flex items-center gap-2">
          <i data-lucide="clock" class="w-6 h-6"></i>
          Peak Hours
        </h3>
        {% if insights.peak_hours %}
          <ul class="space-y-3 mb-4">
            {% for hour_data in insights.peak_hours[:5] %}
            <li class="flex justify-between items-center py-3 border-b border-white/10">
              <span class="text-gray-300">{{ hour_data.hour }}:00 Uhr</span>
              <span class="badge badge-accent badge-lg">{{ hour_data.bookings }} Buchungen</span>
            </li>
            {% endfor %}
          </ul>
          <div class="chart-container">
            <div id="peakHoursChart"></div>
          </div>
        {% else %}
          <div class="text-center py-12 text-gray-400 italic bg-white/5 rounded-lg border border-dashed border-white/20">
            <i data-lucide="inbox" class="w-12 h-12 mx-auto mb-3 opacity-50"></i>
            <p>Keine Peak Hours Daten verf√ºgbar</p>
          </div>
        {% endif %}
      </div>

      <!-- Popular Days -->
      <div class="glass rounded-2xl p-6 hover:shadow-2xl transition-all duration-300" data-aos="fade-up" data-aos-delay="200">
        <h3 class="text-xl font-semibold text-accent mb-4 flex items-center gap-2">
          <i data-lucide="calendar" class="w-6 h-6"></i>
          Beliebte Wochentage
        </h3>
        {% if insights.popular_days %}
          <ul class="space-y-3 mb-4">
            {% for day_data in insights.popular_days %}
            <li class="flex justify-between items-center py-3 border-b border-white/10">
              <span class="text-gray-300">{{ day_data.day_name if day_data.day_name else day_data.day }}</span>
              <span class="badge badge-secondary badge-lg">{{ day_data.bookings }} Buchungen</span>
            </li>
            {% endfor %}
          </ul>
          <div class="chart-container">
            <div id="popularDaysChart"></div>
          </div>
        {% else %}
          <div class="text-center py-12 text-gray-400 italic bg-white/5 rounded-lg border border-dashed border-white/20">
            <i data-lucide="inbox" class="w-12 h-12 mx-auto mb-3 opacity-50"></i>
            <p>Keine Wochentag-Daten verf√ºgbar</p>
          </div>
        {% endif %}
      </div>

      <!-- Customer Patterns -->
      <div class="glass rounded-2xl p-6 hover:shadow-2xl transition-all duration-300" data-aos="fade-up" data-aos-delay="300">
        <h3 class="text-xl font-semibold text-accent mb-4 flex items-center gap-2">
          <i data-lucide="users" class="w-6 h-6"></i>
          Kundenverhalten
        </h3>
        {% if insights.customer_patterns %}
          <ul class="space-y-3">
            {% for pattern_key, pattern_value in insights.customer_patterns.items() %}
            <li class="flex justify-between items-center py-3 border-b border-white/10">
              <span class="text-gray-300">{{ pattern_key | title }}</span>
              <span class="badge badge-primary badge-lg">{{ pattern_value }}</span>
            </li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="text-center py-12 text-gray-400 italic bg-white/5 rounded-lg border border-dashed border-white/20">
            <i data-lucide="inbox" class="w-12 h-12 mx-auto mb-3 opacity-50"></i>
            <p>Keine Kundenverhalten-Daten verf√ºgbar</p>
          </div>
        {% endif %}
      </div>

      <!-- Booking Trends -->
      <div class="glass rounded-2xl p-6 hover:shadow-2xl transition-all duration-300" data-aos="fade-up" data-aos-delay="400">
        <h3 class="text-xl font-semibold text-accent mb-4 flex items-center gap-2">
          <i data-lucide="trending-up" class="w-6 h-6"></i>
          Buchungstrends
        </h3>
        {% if insights.booking_trends %}
          <div class="chart-container">
            <div id="bookingTrendsChart"></div>
          </div>
        {% else %}
          <div class="text-center py-12 text-gray-400 italic bg-white/5 rounded-lg border border-dashed border-white/20">
            <i data-lucide="inbox" class="w-12 h-12 mx-auto mb-3 opacity-50"></i>
            <p>Keine Trend-Daten verf√ºgbar</p>
          </div>
        {% endif %}
      </div>

    </div>
  </div>

  <!-- AOS JS -->
  <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>

  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <script>
    // Initialize AOS
    AOS.init({
      duration: 800,
      once: true,
      offset: 100
    });

    // Initialize Lucide Icons
    lucide.createIcons();

    // Wait for DOM to load
    document.addEventListener('DOMContentLoaded', function() {

      // ApexCharts Dark Theme Configuration
      const darkTheme = {
        theme: {
          mode: 'dark'
        },
        chart: {
          background: 'transparent',
          foreColor: '#e5e7eb',
          toolbar: {
            show: true,
            tools: {
              download: true,
              selection: false,
              zoom: false,
              zoomin: false,
              zoomout: false,
              pan: false,
              reset: false
            }
          },
          animations: {
            enabled: true,
            easing: 'easeinout',
            speed: 800,
            animateGradually: {
              enabled: true,
              delay: 150
            },
            dynamicAnimation: {
              enabled: true,
              speed: 350
            }
          }
        },
        grid: {
          borderColor: 'rgba(255, 255, 255, 0.1)',
          strokeDashArray: 3
        },
        tooltip: {
          theme: 'dark',
          style: {
            fontSize: '14px'
          }
        }
      };

      // Peak Hours Chart (Bar Chart)
      {% if insights.peak_hours and insights.peak_hours|length > 0 %}
      try {
        const peakHoursData = {{ insights.peak_hours[:10] | list | tojson | safe }};

        if (peakHoursData && peakHoursData.length > 0) {
          const peakHoursOptions = {
            ...darkTheme,
            series: [{
              name: 'Buchungen pro Stunde',
              data: peakHoursData.map(item => item.bookings || 0)
            }],
            chart: {
              ...darkTheme.chart,
              type: 'bar',
              height: 300
            },
            plotOptions: {
              bar: {
                borderRadius: 8,
                distributed: false,
                horizontal: false,
                columnWidth: '60%',
                dataLabels: {
                  position: 'top'
                }
              }
            },
            dataLabels: {
              enabled: true,
              offsetY: -20,
              style: {
                fontSize: '12px',
                colors: ["#e5e7eb"]
              }
            },
            colors: ['#10b981'],
            xaxis: {
              categories: peakHoursData.map(item => (item.hour || 0) + ':00'),
              labels: {
                style: {
                  colors: '#9ca3af',
                  fontSize: '12px'
                }
              }
            },
            yaxis: {
              labels: {
                style: {
                  colors: '#9ca3af',
                  fontSize: '12px'
                }
              }
            },
            grid: darkTheme.grid,
            tooltip: {
              ...darkTheme.tooltip,
              y: {
                formatter: function(val) {
                  return val + " Buchungen"
                }
              }
            }
          };

          const peakHoursChart = new ApexCharts(document.querySelector("#peakHoursChart"), peakHoursOptions);
          peakHoursChart.render();
        }
      } catch (error) {
        console.error('Error creating Peak Hours chart:', error);
      }
      {% endif %}

      // Popular Days Chart (Donut Chart)
      {% if insights.popular_days and insights.popular_days|length > 0 %}
      try {
        const popularDaysData = {{ insights.popular_days | list | tojson | safe }};

        if (popularDaysData && popularDaysData.length > 0) {
          const dayNames = ['Sonntag', 'Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag'];

          const popularDaysOptions = {
            ...darkTheme,
            series: popularDaysData.map(item => item.bookings || 0),
            chart: {
              ...darkTheme.chart,
              type: 'donut',
              height: 300
            },
            labels: popularDaysData.map(item => item.day_name || dayNames[item.day] || `Tag ${item.day}`),
            colors: ['#8b5cf6', '#10b981', '#f59e0b', '#ef4444', '#3b82f6', '#a855f7', '#22c55e'],
            plotOptions: {
              pie: {
                donut: {
                  size: '65%',
                  labels: {
                    show: true,
                    name: {
                      show: true,
                      fontSize: '16px',
                      fontWeight: 600,
                      color: '#e5e7eb'
                    },
                    value: {
                      show: true,
                      fontSize: '24px',
                      fontWeight: 700,
                      color: '#5ab1ff'
                    },
                    total: {
                      show: true,
                      label: 'Gesamt',
                      fontSize: '14px',
                      color: '#9ca3af',
                      formatter: function (w) {
                        return w.globals.seriesTotals.reduce((a, b) => a + b, 0)
                      }
                    }
                  }
                }
              }
            },
            dataLabels: {
              enabled: true,
              style: {
                fontSize: '12px',
                fontWeight: 600
              },
              dropShadow: {
                enabled: false
              }
            },
            legend: {
              position: 'bottom',
              fontSize: '14px',
              labels: {
                colors: '#e5e7eb'
              },
              markers: {
                width: 12,
                height: 12,
                radius: 6
              }
            },
            tooltip: {
              ...darkTheme.tooltip,
              y: {
                formatter: function(val) {
                  return val + " Buchungen"
                }
              }
            }
          };

          const popularDaysChart = new ApexCharts(document.querySelector("#popularDaysChart"), popularDaysOptions);
          popularDaysChart.render();
        }
      } catch (error) {
        console.error('Error creating Popular Days chart:', error);
      }
      {% endif %}

      // Booking Trends Chart (Line Chart)
      {% if insights.booking_trends and insights.booking_trends|length > 0 %}
      try {
        const bookingTrendsData = {{ insights.booking_trends | list | tojson | safe }};

        if (bookingTrendsData && bookingTrendsData.length > 0) {
          const bookingTrendsOptions = {
            ...darkTheme,
            series: [{
              name: 'Buchungen √ºber Zeit',
              data: bookingTrendsData.map(item => item.count || 0)
            }],
            chart: {
              ...darkTheme.chart,
              type: 'area',
              height: 300
            },
            stroke: {
              curve: 'smooth',
              width: 3,
              colors: ['#3b82f6']
            },
            fill: {
              type: 'gradient',
              gradient: {
                shadeIntensity: 1,
                opacityFrom: 0.7,
                opacityTo: 0.1,
                stops: [0, 90, 100],
                colorStops: [
                  {
                    offset: 0,
                    color: '#3b82f6',
                    opacity: 0.5
                  },
                  {
                    offset: 100,
                    color: '#3b82f6',
                    opacity: 0.1
                  }
                ]
              }
            },
            markers: {
              size: 5,
              colors: ['#3b82f6'],
              strokeColors: '#fff',
              strokeWidth: 2,
              hover: {
                size: 7
              }
            },
            xaxis: {
              categories: bookingTrendsData.map(item => item.date || 'Unbekannt'),
              labels: {
                style: {
                  colors: '#9ca3af',
                  fontSize: '12px'
                },
                rotate: -45,
                rotateAlways: false
              }
            },
            yaxis: {
              labels: {
                style: {
                  colors: '#9ca3af',
                  fontSize: '12px'
                }
              }
            },
            grid: darkTheme.grid,
            tooltip: {
              ...darkTheme.tooltip,
              y: {
                formatter: function(val) {
                  return val + " Buchungen"
                }
              }
            }
          };

          const bookingTrendsChart = new ApexCharts(document.querySelector("#bookingTrendsChart"), bookingTrendsOptions);
          bookingTrendsChart.render();
        }
      } catch (error) {
        console.error('Error creating Booking Trends chart:', error);
      }
      {% endif %}
    });
  </script>
</body>
</html>
