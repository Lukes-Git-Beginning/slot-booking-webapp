<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>ðŸ“ˆ Admin Insights - Detaillierte Analytics</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="{{ url_for('static', filename='admin_style.css') }}">
  <link href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@2.47.0/tabler-icons.min.css" rel="stylesheet">

  <!-- Chart.js fÃ¼r Grafiken -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

  <style>
    .admin-content {
      max-width: 1600px;
      margin: 0 auto;
      padding: 20px;
    }

    .insights-header {
      background: linear-gradient(135deg, rgba(16,185,129,0.15), rgba(139,92,246,0.15), rgba(245,158,11,0.1));
      border-radius: var(--radius-lg);
      padding: 40px;
      margin-bottom: 30px;
      text-align: center;
      border: 1px solid var(--accent);
      box-shadow: 0 10px 30px rgba(16,185,129,0.1);
    }

    .insights-title {
      font-size: 32px;
      font-weight: 700;
      color: var(--accent);
      margin: 0 0 10px;
    }

    .insights-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .insight-card {
      background: var(--box-bg);
      border: 1px solid var(--box-border);
      border-radius: var(--radius-lg);
      padding: 25px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    /* Light mode override for better contrast */
    body.lightmode .insight-card {
      background: rgba(255,255,255,0.8);
      border: 1px solid rgba(0,0,0,0.1);
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .insight-card h3 {
      color: var(--accent);
      margin: 0 0 15px;
      font-size: 18px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .chart-container {
      position: relative;
      height: 300px;
      margin-top: 15px;
    }

    .insight-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .insight-list li {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      color: var(--text);
    }

    .insight-list li:last-child {
      border-bottom: none;
    }

    .insight-value {
      font-weight: 600;
      color: var(--accent);
    }

    .no-data {
      text-align: center;
      color: var(--muted);
      font-style: italic;
      padding: 40px 20px;
      background: rgba(255,255,255,0.05);
      border-radius: var(--radius);
      border: 1px dashed rgba(255,255,255,0.2);
    }

    .quick-actions {
      display: flex;
      gap: 15px;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }

    .action-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 12px 20px;
      border-radius: var(--radius);
      text-decoration: none;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .action-btn.primary {
      background: var(--accent);
      color: white;
    }

    .action-btn.primary:hover {
      background: var(--accent-hover);
      transform: translateY(-2px);
    }

    .action-btn.secondary {
      background: var(--box-bg);
      color: var(--text);
      border: 1px solid var(--box-border);
    }

    .action-btn.secondary:hover {
      background: var(--accent);
      color: white;
      transform: translateY(-2px);
    }
  </style>
</head>
<body>
  <!-- Include Admin Navigation -->
  {% include 'admin_nav.html' %}

  <div class="admin-content">
    <!-- Quick Actions -->
    <div class="quick-actions">
      <a href="{{ url_for('admin.admin_dashboard') }}" class="action-btn secondary">
        <i class="ti ti-arrow-left"></i>
        ZurÃ¼ck zum Dashboard
      </a>
      <a href="/" class="action-btn secondary">
        <i class="ti ti-home"></i>
        Zur Hauptseite
      </a>
    </div>

    <div class="insights-header">
      <h1 class="insights-title">ðŸ“ˆ Detaillierte Analytics & Insights</h1>
      <p>Erweiterte Einblicke in Buchungsverhalten, Trends und OptimierungsmÃ¶glichkeiten</p>
    </div>

    <div class="insights-grid">
      <!-- Peak Hours Analysis -->
      <div class="insight-card">
        <h3><i class="ti ti-clock"></i> Peak Hours</h3>
        {% if insights.peak_hours %}
          <ul class="insight-list">
            {% for hour_data in insights.peak_hours[:5] %}
            <li>
              {{ hour_data.hour }}:00 Uhr
              <span class="insight-value">{{ hour_data.bookings }} Buchungen</span>
            </li>
            {% endfor %}
          </ul>
          <div class="chart-container">
            <canvas id="peakHoursChart"></canvas>
          </div>
        {% else %}
          <div class="no-data">Keine Peak Hours Daten verfÃ¼gbar</div>
        {% endif %}
      </div>

      <!-- Popular Days -->
      <div class="insight-card">
        <h3><i class="ti ti-calendar"></i> Beliebte Wochentage</h3>
        {% if insights.popular_days %}
          <ul class="insight-list">
            {% for day_data in insights.popular_days %}
            <li>
              {{ day_data.day_name if day_data.day_name else day_data.day }}
              <span class="insight-value">{{ day_data.bookings }} Buchungen</span>
            </li>
            {% endfor %}
          </ul>
          <div class="chart-container">
            <canvas id="popularDaysChart"></canvas>
          </div>
        {% else %}
          <div class="no-data">Keine Wochentag-Daten verfÃ¼gbar</div>
        {% endif %}
      </div>

      <!-- Customer Patterns -->
      <div class="insight-card">
        <h3><i class="ti ti-users"></i> Kundenverhalten</h3>
        {% if insights.customer_patterns %}
          <ul class="insight-list">
            {% for pattern_key, pattern_value in insights.customer_patterns.items() %}
            <li>
              {{ pattern_key | title }}
              <span class="insight-value">{{ pattern_value }}</span>
            </li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="no-data">Keine Kundenverhalten-Daten verfÃ¼gbar</div>
        {% endif %}
      </div>

      <!-- Booking Trends -->
      <div class="insight-card">
        <h3><i class="ti ti-trending-up"></i> Buchungstrends</h3>
        {% if insights.booking_trends %}
          <div class="chart-container">
            <canvas id="bookingTrendsChart"></canvas>
          </div>
        {% else %}
          <div class="no-data">Keine Trend-Daten verfÃ¼gbar</div>
        {% endif %}
      </div>
    </div>
  </div>

  <script>
    // Wait for DOM to load
    document.addEventListener('DOMContentLoaded', function() {
      // Peak Hours Chart
      {% if insights.peak_hours and insights.peak_hours|length > 0 %}
      try {
        const peakHoursCanvas = document.getElementById('peakHoursChart');
        if (peakHoursCanvas) {
          const peakHoursCtx = peakHoursCanvas.getContext('2d');
          const peakHoursData = {{ insights.peak_hours[:10] | list | tojson | safe }};

          if (peakHoursData && peakHoursData.length > 0) {
            new Chart(peakHoursCtx, {
              type: 'bar',
              data: {
                labels: peakHoursData.map(item => (item.hour || 0) + ':00'),
                datasets: [{
                  label: 'Buchungen pro Stunde',
                  data: peakHoursData.map(item => item.bookings || 0),
                  backgroundColor: 'rgba(16, 185, 129, 0.8)',
                  borderColor: 'rgba(16, 185, 129, 1)',
                  borderWidth: 1,
                  borderRadius: 4
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: {
                    display: true,
                    position: 'top'
                  }
                },
                scales: {
                  y: {
                    beginAtZero: true,
                    grid: {
                      color: 'rgba(255, 255, 255, 0.1)'
                    }
                  },
                  x: {
                    grid: {
                      color: 'rgba(255, 255, 255, 0.1)'
                    }
                  }
                }
              }
            });
          }
        }
      } catch (error) {
        console.error('Error creating Peak Hours chart:', error);
      }
      {% endif %}

      // Popular Days Chart
      {% if insights.popular_days and insights.popular_days|length > 0 %}
      try {
        const popularDaysCanvas = document.getElementById('popularDaysChart');
        if (popularDaysCanvas) {
          const popularDaysCtx = popularDaysCanvas.getContext('2d');
          const popularDaysData = {{ insights.popular_days | list | tojson | safe }};

          if (popularDaysData && popularDaysData.length > 0) {
            const dayNames = ['Sonntag', 'Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag'];

            new Chart(popularDaysCtx, {
              type: 'doughnut',
              data: {
                labels: popularDaysData.map(item => item.day_name || dayNames[item.day] || `Tag ${item.day}`),
                datasets: [{
                  label: 'Buchungen',
                  data: popularDaysData.map(item => item.bookings || 0),
                  backgroundColor: [
                    'rgba(139, 92, 246, 0.8)',
                    'rgba(16, 185, 129, 0.8)',
                    'rgba(245, 158, 11, 0.8)',
                    'rgba(239, 68, 68, 0.8)',
                    'rgba(59, 130, 246, 0.8)',
                    'rgba(168, 85, 247, 0.8)',
                    'rgba(34, 197, 94, 0.8)'
                  ],
                  borderWidth: 2,
                  borderColor: 'rgba(255, 255, 255, 0.2)'
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: {
                    position: 'bottom'
                  }
                }
              }
            });
          }
        }
      } catch (error) {
        console.error('Error creating Popular Days chart:', error);
      }
      {% endif %}

      // Booking Trends Chart
      {% if insights.booking_trends and insights.booking_trends|length > 0 %}
      try {
        const bookingTrendsCanvas = document.getElementById('bookingTrendsChart');
        if (bookingTrendsCanvas) {
          const bookingTrendsCtx = bookingTrendsCanvas.getContext('2d');
          const bookingTrendsData = {{ insights.booking_trends | list | tojson | safe }};

          if (bookingTrendsData && bookingTrendsData.length > 0) {
            new Chart(bookingTrendsCtx, {
              type: 'line',
              data: {
                labels: bookingTrendsData.map(item => item.date || 'Unbekannt'),
                datasets: [{
                  label: 'Buchungen Ã¼ber Zeit',
                  data: bookingTrendsData.map(item => item.count || 0),
                  borderColor: 'rgba(59, 130, 246, 1)',
                  backgroundColor: 'rgba(59, 130, 246, 0.1)',
                  tension: 0.4,
                  fill: true,
                  pointBackgroundColor: 'rgba(59, 130, 246, 1)',
                  pointBorderColor: 'rgba(255, 255, 255, 0.8)',
                  pointBorderWidth: 2,
                  pointRadius: 4
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: {
                    display: true,
                    position: 'top'
                  }
                },
                scales: {
                  y: {
                    beginAtZero: true,
                    grid: {
                      color: 'rgba(255, 255, 255, 0.1)'
                    }
                  },
                  x: {
                    grid: {
                      color: 'rgba(255, 255, 255, 0.1)'
                    }
                  }
                }
              }
            });
          }
        }
      } catch (error) {
        console.error('Error creating Booking Trends chart:', error);
      }
      {% endif %}
    });
  </script>
</body>
</html>