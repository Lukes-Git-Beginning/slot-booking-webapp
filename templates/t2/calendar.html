{% extends "t2/base.html" %}

{% block title %}T2 Kalender{% endblock %}

{% block content %}
<!-- Header -->
<div class="t2-header">
    <h1 class="t2-title">
        <i class="ti ti-calendar"></i> T2-Kalender
    </h1>
    <p class="t2-subtitle">
        Deine gebuchten T2-Termine im √úberblick
    </p>
</div>

<!-- Calendar View -->
<div style="max-width: 1000px; margin: 0 auto;">

    <!-- Current Month Display -->
    <div style="background: var(--box-bg); backdrop-filter: blur(10px); border: 1px solid var(--box-border); border-radius: var(--radius-lg); padding: var(--spacing-xl); margin-bottom: var(--spacing-xl); text-align: center;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-lg);">
            <button onclick="previousMonth()" class="btn-t2" style="padding: var(--spacing-sm) var(--spacing-md);">
                <i class="ti ti-chevron-left"></i>
            </button>
            <h2 id="current-month" style="font-size: var(--text-2xl); font-weight: var(--font-bold); color: var(--text-color); margin: 0;"></h2>
            <button onclick="nextMonth()" class="btn-t2" style="padding: var(--spacing-sm) var(--spacing-md);">
                <i class="ti ti-chevron-right"></i>
            </button>
        </div>

        <!-- Calendar Grid -->
        <div id="calendar-grid" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: var(--spacing-xs);">
            <!-- Weekday headers -->
            <div style="padding: var(--spacing-sm); font-weight: var(--font-semibold); color: var(--muted); font-size: var(--text-sm);">Mo</div>
            <div style="padding: var(--spacing-sm); font-weight: var(--font-semibold); color: var(--muted); font-size: var(--text-sm);">Di</div>
            <div style="padding: var(--spacing-sm); font-weight: var(--font-semibold); color: var(--muted); font-size: var(--text-sm);">Mi</div>
            <div style="padding: var(--spacing-sm); font-weight: var(--font-semibold); color: var(--muted); font-size: var(--text-sm);">Do</div>
            <div style="padding: var(--spacing-sm); font-weight: var(--font-semibold); color: var(--muted); font-size: var(--text-sm);">Fr</div>
            <div style="padding: var(--spacing-sm); font-weight: var(--font-semibold); color: var(--muted); font-size: var(--text-sm);">Sa</div>
            <div style="padding: var(--spacing-sm); font-weight: var(--font-semibold); color: var(--muted); font-size: var(--text-sm);">So</div>
            <!-- Days will be populated by JS -->
        </div>
    </div>

    <!-- Upcoming Appointments -->
    <div style="background: var(--box-bg); backdrop-filter: blur(10px); border: 1px solid var(--box-border); border-radius: var(--radius-lg); padding: var(--spacing-xl);">
        <h3 style="font-size: var(--text-xl); font-weight: var(--font-semibold); color: var(--text-color); margin: 0 0 var(--spacing-lg);">
            <i class="ti ti-clock"></i> Kommende Termine
        </h3>

        <div id="appointments-list">
            <!-- Appointments will be populated by JS -->
            <div style="color: var(--muted); text-align: center; padding: var(--spacing-lg);">
                Lade Termine...
            </div>
        </div>
    </div>

    <!-- Back Button -->
    <div style="text-align: center; margin-top: var(--spacing-lg);">
        <a href="{{ url_for('t2.dashboard') }}" class="btn-t2">
            <i class="ti ti-arrow-left"></i>
            Zur√ºck zum Dashboard
        </a>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentDate = new Date();
let userBookings = [];

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    loadUserBookings();
});

function loadUserBookings() {
    fetch('/t2/api/my-bookings')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                userBookings = data.bookings || [];
                renderCalendar();
                renderAppointmentsList();
            }
        })
        .catch(error => {
            console.error('Error loading bookings:', error);
        });
}

function renderCalendar() {
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();

    // Update month display
    const monthNames = ['Januar', 'Februar', 'M√§rz', 'April', 'Mai', 'Juni',
                       'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];
    document.getElementById('current-month').textContent = `${monthNames[month]} ${year}`;

    // Get first day of month and number of days
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const daysInMonth = lastDay.getDate();

    // Get day of week (0 = Sunday, adjust to Monday = 0)
    let startDay = firstDay.getDay() - 1;
    if (startDay < 0) startDay = 6;

    // Clear calendar grid (keep headers)
    const grid = document.getElementById('calendar-grid');
    while (grid.children.length > 7) {
        grid.removeChild(grid.lastChild);
    }

    // Add empty cells for days before month starts
    for (let i = 0; i < startDay; i++) {
        const emptyDay = document.createElement('div');
        emptyDay.style.cssText = 'padding: var(--spacing-sm);';
        grid.appendChild(emptyDay);
    }

    // Add day cells
    for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const hasBooking = userBookings.some(b => b.date === dateStr);
        const isToday = new Date().toISOString().split('T')[0] === dateStr;

        const dayCell = document.createElement('div');
        dayCell.style.cssText = `
            padding: var(--spacing-sm);
            background: ${hasBooking ? 'var(--success-bg)' : 'var(--input-bg)'};
            border: 1px solid ${hasBooking ? 'var(--success-bd)' : 'var(--input-bd)'};
            ${isToday ? 'border-color: var(--accent); border-width: 2px;' : ''}
            border-radius: var(--radius-md);
            text-align: center;
            cursor: ${hasBooking ? 'pointer' : 'default'};
            transition: all 0.2s;
        `;

        dayCell.innerHTML = `
            <div style="color: ${hasBooking ? 'var(--green)' : 'var(--text-color)'}; font-weight: ${isToday ? 'var(--font-bold)' : 'var(--font-medium)'};">
                ${day}
            </div>
            ${hasBooking ? '<div style="font-size: 12px; margin-top: 2px;">‚óè</div>' : ''}
        `;

        if (hasBooking) {
            dayCell.onmouseover = () => {
                dayCell.style.transform = 'scale(1.05)';
                dayCell.style.borderColor = 'var(--green)';
            };
            dayCell.onmouseout = () => {
                dayCell.style.transform = 'scale(1)';
                dayCell.style.borderColor = 'var(--success-bd)';
            };
        }

        grid.appendChild(dayCell);
    }
}

function renderAppointmentsList() {
    const container = document.getElementById('appointments-list');

    // Filter upcoming bookings
    const today = new Date().toISOString().split('T')[0];
    const upcoming = userBookings
        .filter(b => b.date >= today)
        .sort((a, b) => {
            const dateA = new Date(a.date + 'T' + a.time);
            const dateB = new Date(b.date + 'T' + b.time);
            return dateA - dateB;
        });

    if (upcoming.length === 0) {
        container.innerHTML = '<div style="color: var(--muted); text-align: center; padding: var(--spacing-lg);">Keine kommenden Termine</div>';
        return;
    }

    container.innerHTML = '';
    upcoming.forEach(booking => {
        const appointmentDiv = document.createElement('div');
        appointmentDiv.style.cssText = `
            padding: var(--spacing-md);
            background: var(--input-bg);
            border: 1px solid var(--input-bd);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-sm);
        `;

        const date = new Date(booking.date);
        const formattedDate = date.toLocaleDateString('de-DE', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

        appointmentDiv.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <div style="font-weight: var(--font-semibold); color: var(--text-color); margin-bottom: var(--spacing-xs);">
                        <i class="ti ti-calendar"></i> ${formattedDate}
                    </div>
                    <div style="color: var(--muted); font-size: var(--text-sm);">
                        <i class="ti ti-clock"></i> ${booking.time} Uhr
                    </div>
                    <div style="color: var(--accent); font-size: var(--text-sm); margin-top: var(--spacing-xs);">
                        <i class="ti ti-user"></i> Closer: ${booking.closer}
                    </div>
                    ${booking.topic ? `<div style="color: var(--muted); font-size: var(--text-sm); margin-top: var(--spacing-xs);"><i class="ti ti-file-text"></i> ${booking.topic}</div>` : ''}
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 32px;">üìÖ</div>
                </div>
            </div>
        `;

        container.appendChild(appointmentDiv);
    });
}

function previousMonth() {
    currentDate.setMonth(currentDate.getMonth() - 1);
    renderCalendar();
}

function nextMonth() {
    currentDate.setMonth(currentDate.getMonth() + 1);
    renderCalendar();
}
</script>
{% endblock %}
