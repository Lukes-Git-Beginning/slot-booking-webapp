{% extends "t2/base.html" %}

{% block title %}T2 Kalender{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="glass rounded-3xl p-8 mb-8" data-aos="fade-up">
    <div class="text-center">
        <h1 class="text-4xl md:text-5xl font-bold text-white mb-2">
            <i data-lucide="calendar" class="inline w-10 h-10 mr-3"></i>
            T2-Kalender
        </h1>
        <p class="text-lg text-gray-300">
            Deine gebuchten T2-Termine im √úberblick
        </p>
    </div>
</div>

<!-- Calendar View -->
<div class="max-w-5xl mx-auto">

    <!-- Current Month Display -->
    <div class="glass rounded-3xl p-8 mb-8" data-aos="fade-up" data-aos-delay="100">
        <div class="flex justify-between items-center mb-8">
            <button data-action="previousMonth" class="btn btn-circle btn-primary">
                <i data-lucide="chevron-left" class="w-6 h-6"></i>
            </button>
            <h2 id="current-month" class="text-3xl md:text-4xl font-bold text-white"></h2>
            <button data-action="nextMonth" class="btn btn-circle btn-primary">
                <i data-lucide="chevron-right" class="w-6 h-6"></i>
            </button>
        </div>

        <!-- Calendar Grid -->
        <div id="calendar-grid" class="grid grid-cols-7 gap-2">
            <!-- Weekday headers -->
            <div class="p-3 font-bold text-gray-400 text-center text-lg">Mo</div>
            <div class="p-3 font-bold text-gray-400 text-center text-lg">Di</div>
            <div class="p-3 font-bold text-gray-400 text-center text-lg">Mi</div>
            <div class="p-3 font-bold text-gray-400 text-center text-lg">Do</div>
            <div class="p-3 font-bold text-gray-400 text-center text-lg">Fr</div>
            <div class="p-3 font-bold text-gray-400 text-center text-lg">Sa</div>
            <div class="p-3 font-bold text-gray-400 text-center text-lg">So</div>
            <!-- Days will be populated by JS -->
        </div>
    </div>

    <!-- Upcoming Appointments -->
    <div class="glass rounded-3xl p-8" data-aos="fade-up" data-aos-delay="200">
        <h3 class="text-3xl font-bold text-white mb-6 flex items-center gap-3">
            <i data-lucide="clock" class="w-8 h-8 text-t2-purple"></i>
            Kommende Termine
        </h3>

        <div id="appointments-list">
            <!-- Appointments will be populated by JS -->
            <div class="text-gray-400 text-center text-lg py-8">
                Lade Termine...
            </div>
        </div>
    </div>

    <!-- Back Button -->
    <div class="text-center mt-8" data-aos="fade-up" data-aos-delay="300">
        <a href="{{ url_for('t2.dashboard') }}" class="btn btn-primary btn-lg gap-3">
            <i data-lucide="arrow-left" class="w-6 h-6"></i>
            <span class="text-lg">Zur√ºck zum Dashboard</span>
        </a>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script nonce="{{ csp_nonce }}">
let currentDate = new Date();
let userBookings = [];

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    loadUserBookings();
});

function loadUserBookings() {
    fetch('/t2/api/my-bookings')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                userBookings = data.bookings || [];
                renderCalendar();
                renderAppointmentsList();
            }
        })
        .catch(error => {
            console.error('Error loading bookings:', error);
            renderCalendar();
        });
}

function renderCalendar() {
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();

    // Update month display
    const monthNames = ['Januar', 'Februar', 'M√§rz', 'April', 'Mai', 'Juni',
                       'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];
    document.getElementById('current-month').textContent = `${monthNames[month]} ${year}`;

    // Get first day of month and number of days
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const daysInMonth = lastDay.getDate();

    // Get day of week (0 = Sunday, adjust to Monday = 0)
    let startDay = firstDay.getDay() - 1;
    if (startDay < 0) startDay = 6;

    // Clear calendar grid (keep headers)
    const grid = document.getElementById('calendar-grid');
    while (grid.children.length > 7) {
        grid.removeChild(grid.lastChild);
    }

    // Add empty cells for days before month starts
    for (let i = 0; i < startDay; i++) {
        const emptyDay = document.createElement('div');
        emptyDay.className = 'p-3';
        grid.appendChild(emptyDay);
    }

    // Add day cells
    for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const hasBooking = userBookings.some(b => b.date === dateStr);
        const isToday = new Date().toISOString().split('T')[0] === dateStr;

        const dayCell = document.createElement('div');
        dayCell.className = `
            p-3 rounded-xl text-center transition-all cursor-pointer
            ${hasBooking ? 'glass bg-green-500/20 border-2 border-green-500' : 'glass'}
            ${isToday ? 'ring-2 ring-t2-purple' : ''}
            hover:scale-105 hover:bg-white/10
        `;

        dayCell.innerHTML = `
            <div class="text-lg font-semibold ${hasBooking ? 'text-green-400' : 'text-white'}">
                ${day}
            </div>
            ${hasBooking ? '<div class="text-2xl mt-1">‚óè</div>' : ''}
        `;

        grid.appendChild(dayCell);
    }

    // Re-init Lucide icons
    setTimeout(() => lucide.createIcons(), 100);
}

function renderAppointmentsList() {
    const container = document.getElementById('appointments-list');

    // Filter upcoming bookings
    const today = new Date().toISOString().split('T')[0];
    const upcoming = userBookings
        .filter(b => b.date >= today)
        .sort((a, b) => {
            const dateA = new Date(a.date + 'T' + a.time);
            const dateB = new Date(b.date + 'T' + b.time);
            return dateA - dateB;
        });

    if (upcoming.length === 0) {
        container.innerHTML = '<div class="text-gray-400 text-center text-lg py-8">Keine kommenden Termine</div>';
        return;
    }

    container.innerHTML = '';
    upcoming.forEach(booking => {
        const appointmentDiv = document.createElement('div');
        appointmentDiv.className = 'glass rounded-2xl p-6 mb-4 hover:bg-white/5 transition-all';

        const date = new Date(booking.date);
        const formattedDate = date.toLocaleDateString('de-DE', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

        appointmentDiv.innerHTML = `
            <div class="flex justify-between items-center flex-wrap gap-4">
                <div class="flex-1">
                    <div class="font-bold text-white text-xl mb-2 flex items-center gap-2">
                        <i data-lucide="calendar" class="w-5 h-5"></i>
                        ${formattedDate}
                    </div>
                    <div class="text-gray-400 text-lg mb-2 flex items-center gap-2">
                        <i data-lucide="clock" class="w-5 h-5"></i>
                        ${booking.time} Uhr
                    </div>
                    <div class="text-t2-purple text-lg font-semibold flex items-center gap-2">
                        <i data-lucide="user" class="w-5 h-5"></i>
                        Closer: ${booking.closer}
                    </div>
                    ${booking.topic ? `<div class="text-gray-400 text-base mt-2 flex items-center gap-2"><i data-lucide="file-text" class="w-4 h-4"></i> ${booking.topic}</div>` : ''}
                </div>
                <div class="text-7xl">üìÖ</div>
            </div>
        `;

        container.appendChild(appointmentDiv);
    });

    // Re-init Lucide icons
    setTimeout(() => lucide.createIcons(), 100);
}

window.previousMonth = function(e) {
    currentDate.setMonth(currentDate.getMonth() - 1);
    renderCalendar();
};

window.nextMonth = function(e) {
    currentDate.setMonth(currentDate.getMonth() + 1);
    renderCalendar();
};
</script>
{% endblock %}
