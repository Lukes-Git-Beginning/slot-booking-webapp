{% extends "t2/base.html" %}

{% block title %}T2 Termin buchen{% endblock %}

{% block content %}
<!-- Header -->
<div class="t2-header">
    <h1 class="t2-title">
        <i class="ti ti-calendar-plus"></i> T2-Termin buchen
    </h1>
    <p class="t2-subtitle">
        Buche deinen 2-Stunden Termin mit {{ assigned_closer }}
    </p>
</div>

<!-- Booking Form -->
<div style="max-width: 700px; margin: 0 auto;">

    <!-- Zugewiesener Closer -->
    <div style="background: var(--box-bg); backdrop-filter: blur(10px); border: 1px solid var(--box-border); border-radius: var(--radius-lg); padding: var(--spacing-xl); margin-bottom: var(--spacing-xl); text-align: center;">
        <h3 style="font-size: var(--text-lg); font-weight: var(--font-semibold); color: var(--muted); margin: 0 0 var(--spacing-md);">
            Dein Closer f√ºr diesen Termin
        </h3>

        <div style="font-size: 48px; margin-bottom: var(--spacing-sm);">üë§</div>
        <div style="font-size: var(--text-2xl); font-weight: var(--font-bold); color: var(--accent); margin-bottom: var(--spacing-xs);">
            {{ assigned_closer }}
        </div>
        <div style="color: var(--muted); font-size: var(--text-sm);">
            2-Stunden Premium-Beratung
        </div>
    </div>

    <form id="booking-form">
        <!-- Datum w√§hlen -->
        <div style="background: var(--box-bg); backdrop-filter: blur(10px); border: 1px solid var(--box-border); border-radius: var(--radius-lg); padding: var(--spacing-xl); margin-bottom: var(--spacing-xl);">
            <h3 style="font-size: var(--text-xl); font-weight: var(--font-semibold); color: var(--text-color); margin: 0 0 var(--spacing-lg);">
                <i class="ti ti-calendar"></i> Datum ausw√§hlen
            </h3>

            <div>
                <label style="display: block; color: var(--muted); font-size: var(--text-sm); margin-bottom: var(--spacing-xs);">W√§hle ein Datum</label>
                <input type="date" id="booking-date" name="date" required
                       min="{{ (datetime.now() + timedelta(days=1)).strftime('%Y-%m-%d') }}"
                       max="{{ (datetime.now() + timedelta(days=14)).strftime('%Y-%m-%d') }}"
                       style="width: 100%; padding: var(--spacing-sm); background: var(--input-bg); border: 1px solid var(--input-bd); border-radius: var(--radius-md); color: var(--text-color); font-size: var(--text-base);">
            </div>
        </div>

        <!-- Uhrzeit w√§hlen -->
        <div id="time-section" style="background: var(--box-bg); backdrop-filter: blur(10px); border: 1px solid var(--box-border); border-radius: var(--radius-lg); padding: var(--spacing-xl); margin-bottom: var(--spacing-xl); display: none;">
            <h3 style="font-size: var(--text-xl); font-weight: var(--font-semibold); color: var(--text-color); margin: 0 0 var(--spacing-lg);">
                <i class="ti ti-clock"></i> Uhrzeit ausw√§hlen
            </h3>

            <div id="time-slots-container" style="display: flex; flex-wrap: wrap; gap: var(--spacing-xs);">
                <!-- Time slots will be populated -->
            </div>
        </div>

        <!-- Thema (optional) -->
        <div id="details-section" style="background: var(--box-bg); backdrop-filter: blur(10px); border: 1px solid var(--box-border); border-radius: var(--radius-lg); padding: var(--spacing-xl); margin-bottom: var(--spacing-xl); display: none;">
            <h3 style="font-size: var(--text-xl); font-weight: var(--font-semibold); color: var(--text-color); margin: 0 0 var(--spacing-lg);">
                <i class="ti ti-file-text"></i> Thema (optional)
            </h3>

            <div>
                <label style="display: block; color: var(--muted); font-size: var(--text-sm); margin-bottom: var(--spacing-xs);">Worum geht es?</label>
                <input type="text" id="booking-topic" name="topic" placeholder="z.B. Verkaufsstrategie, Teamf√ºhrung..."
                       style="width: 100%; padding: var(--spacing-sm); background: var(--input-bg); border: 1px solid var(--input-bd); border-radius: var(--radius-md); color: var(--text-color); font-size: var(--text-base);">
            </div>
        </div>

        <!-- Zusammenfassung & Buchung -->
        <div id="summary-section" style="background: var(--box-bg); backdrop-filter: blur(10px); border: 1px solid var(--box-border); border-radius: var(--radius-lg); padding: var(--spacing-xl); display: none;">
            <h3 style="font-size: var(--text-xl); font-weight: var(--font-semibold); color: var(--text-color); margin: 0 0 var(--spacing-lg);">
                <i class="ti ti-check"></i> Zusammenfassung
            </h3>

            <div id="booking-summary" style="margin-bottom: var(--spacing-lg); padding: var(--spacing-md); background: var(--input-bg); border-radius: var(--radius-md);">
                <!-- Summary will be populated -->
            </div>

            <button type="submit" id="submit-booking" class="btn-t2 btn-t2-success" style="width: 100%; padding: var(--spacing-md); font-size: var(--text-lg);">
                <i class="ti ti-check"></i> Verbindlich buchen
            </button>

            <div style="text-align: center; margin-top: var(--spacing-md); color: var(--muted); font-size: var(--text-sm);">
                Verbleibende Tickets: <strong>{{ tickets_remaining }}</strong>
            </div>
        </div>

        <input type="hidden" id="selected-time" name="time">
    </form>

    <!-- Zur√ºck Button -->
    <div style="text-align: center; margin-top: var(--spacing-lg);">
        <a href="{{ url_for('t2.dashboard') }}" class="btn-t2">
            <i class="ti ti-arrow-left"></i>
            Zur√ºck zum Dashboard
        </a>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let bookingData = {
    date: null,
    time: null,
    topic: ''
};

// Datum Auswahl
document.getElementById('booking-date').addEventListener('change', function(e) {
    bookingData.date = e.target.value;

    loadTimeSlots(bookingData.date);

    document.getElementById('time-section').style.display = 'block';
    document.getElementById('time-section').scrollIntoView({ behavior: 'smooth' });
});

function loadTimeSlots(date) {
    const container = document.getElementById('time-slots-container');
    container.innerHTML = '<div style="color: var(--muted);">Lade verf√ºgbare Zeiten...</div>';

    fetch(`/t2/api/availability/${date}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.slots.length > 0) {
                container.innerHTML = '';
                data.slots.forEach(slot => {
                    const btn = document.createElement('div');
                    btn.className = slot.available ? 'time-slot available' : 'time-slot booked';
                    btn.textContent = slot.time;

                    if (slot.available) {
                        btn.onclick = () => selectTime(btn, slot.time);
                    }

                    container.appendChild(btn);
                });
            } else {
                container.innerHTML = '<div style="color: var(--muted);">Keine verf√ºgbaren Zeiten.</div>';
            }
        })
        .catch(error => {
            container.innerHTML = '<div style="color: var(--red);">Fehler beim Laden.</div>';
        });
}

function selectTime(element, time) {
    // Deselect all
    document.querySelectorAll('.time-slot').forEach(slot => {
        slot.classList.remove('selected');
    });

    // Select clicked
    element.classList.add('selected');
    bookingData.time = time;
    document.getElementById('selected-time').value = time;

    // Show next sections
    document.getElementById('details-section').style.display = 'block';
    document.getElementById('summary-section').style.display = 'block';

    updateSummary();
    document.getElementById('summary-section').scrollIntoView({ behavior: 'smooth' });
}

function updateSummary() {
    const summary = document.getElementById('booking-summary');

    summary.innerHTML = `
        <div style="margin-bottom: var(--spacing-md);">
            <div style="font-weight: var(--font-semibold); color: var(--text-color); margin-bottom: var(--spacing-xs);">
                <i class="ti ti-user"></i> Closer: {{ assigned_closer }}
            </div>
        </div>
        <div style="margin-bottom: var(--spacing-xs); color: var(--text-color);">
            <i class="ti ti-calendar"></i> <strong>Datum:</strong> ${new Date(bookingData.date).toLocaleDateString('de-DE')}
        </div>
        <div style="margin-bottom: var(--spacing-xs); color: var(--text-color);">
            <i class="ti ti-clock"></i> <strong>Uhrzeit:</strong> ${bookingData.time}
        </div>
        <div style="color: var(--text-color);">
            <i class="ti ti-hourglass"></i> <strong>Dauer:</strong> 2 Stunden
        </div>
    `;
}

// Form Submit
document.getElementById('booking-form').addEventListener('submit', function(e) {
    e.preventDefault();

    bookingData.topic = document.getElementById('booking-topic').value;

    const submitBtn = document.getElementById('submit-booking');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="ti ti-loader" style="animation: spin 1s linear infinite;"></i> Buche...';

    fetch('/t2/api/book', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(bookingData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess('T2-Termin erfolgreich gebucht!');
            setTimeout(() => {
                window.location.href = '{{ url_for("t2.dashboard") }}';
            }, 1500);
        } else {
            showError(data.error || 'Fehler beim Buchen');
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="ti ti-check"></i> Verbindlich buchen';
        }
    })
    .catch(error => {
        showError('Buchungsfehler');
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="ti ti-check"></i> Verbindlich buchen';
    });
});

// Spin animation
const style = document.createElement('style');
style.textContent = `
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}
