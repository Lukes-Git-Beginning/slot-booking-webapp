{% extends "t2/base.html" %}

{% block title %}T2 Kalender{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="glass rounded-3xl p-8 mb-8" data-aos="fade-up">
    <div class="text-center">
        <h1 class="text-4xl md:text-5xl font-bold text-white mb-2">
            <i data-lucide="calendar" class="inline w-10 h-10 mr-3"></i>
            T2-Kalender
        </h1>
        <p class="text-lg text-gray-300">
            {% if is_closer %}
                Deine Termine und Verfügbarkeit
            {% else %}
                Verfügbare Termine und deine Buchungen
            {% endif %}
        </p>
    </div>
</div>

<!-- Closer Selection (only for Openers) -->
{% if not is_closer %}
<div class="max-w-5xl mx-auto mb-8" data-aos="fade-up" data-aos-delay="100">
    <div class="glass rounded-2xl p-6">
        <label class="text-white font-semibold text-lg mb-3 block">Closer auswählen:</label>
        <select id="closer-select" class="select select-bordered w-full max-w-md text-lg bg-white/10 border-white/20 text-white">
            {% for closer in closers_list %}
            <option value="{{ closer }}">{{ closer }}</option>
            {% endfor %}
        </select>
    </div>
</div>
{% endif %}

<!-- Calendar View -->
<div class="max-w-6xl mx-auto">
    <!-- Calendar Grid -->
    <div class="glass rounded-3xl p-8 mb-8" data-aos="fade-up" data-aos-delay="200">
        <div class="flex justify-between items-center mb-8">
            <button onclick="previousMonth()" class="btn btn-circle btn-primary">
                <i data-lucide="chevron-left" class="w-6 h-6"></i>
            </button>
            <h2 id="current-month" class="text-3xl md:text-4xl font-bold text-white"></h2>
            <button onclick="nextMonth()" class="btn btn-circle btn-primary">
                <i data-lucide="chevron-right" class="w-6 h-6"></i>
            </button>
        </div>

        <!-- Calendar Grid -->
        <div id="calendar-grid" class="grid grid-cols-7 gap-2">
            <!-- Headers -->
            <div class="p-3 font-bold text-gray-400 text-center">Mo</div>
            <div class="p-3 font-bold text-gray-400 text-center">Di</div>
            <div class="p-3 font-bold text-gray-400 text-center">Mi</div>
            <div class="p-3 font-bold text-gray-400 text-center">Do</div>
            <div class="p-3 font-bold text-gray-400 text-center">Fr</div>
            <div class="p-3 font-bold text-gray-400 text-center">Sa</div>
            <div class="p-3 font-bold text-gray-400 text-center">So</div>
            <!-- Days will be populated by JS -->
        </div>
    </div>

    <!-- Kommende Termine -->
    <div class="glass rounded-3xl p-8" data-aos="fade-up" data-aos-delay="300">
        <h3 class="text-3xl font-bold text-white mb-6 flex items-center gap-3">
            <i data-lucide="clock" class="w-8 h-8 text-t2-purple"></i>
            Kommende Termine
        </h3>
        <div id="upcoming-appointments" class="space-y-4">
            <div class="text-gray-400 text-center py-8">Lade Termine...</div>
        </div>
    </div>
</div>

<!-- Fullscreen Modal for Day Details -->
<div id="day-modal" class="fixed inset-0 bg-black/80 backdrop-blur-lg z-50 hidden flex items-center justify-center p-4">
    <div class="glass rounded-3xl max-w-4xl w-full max-h-[90vh] overflow-y-auto p-8 relative">
        <!-- Close Button -->
        <button onclick="closeModal()" class="absolute top-6 right-6 btn btn-circle btn-ghost">
            <i data-lucide="x" class="w-6 h-6"></i>
        </button>

        <!-- Modal Content -->
        <div id="modal-content">
            <!-- Will be populated by JS -->
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.calendar-day {
    @apply glass rounded-xl p-3 text-center cursor-pointer transition-all hover:scale-105 hover:bg-white/10 relative;
    min-height: 80px;
}

.calendar-day.today {
    @apply ring-2 ring-t2-purple;
}

.calendar-day.has-events {
    @apply bg-white/5;
}

.day-number {
    @apply text-lg font-semibold text-white mb-2;
}

.day-indicator {
    @apply absolute bottom-2 left-1/2 transform -translate-x-1/2 flex gap-1;
}

.dot {
    @apply w-2 h-2 rounded-full;
}

.dot-green {
    @apply bg-green-500;
}

.dot-yellow {
    @apply bg-yellow-500;
}

.dot-purple {
    @apply bg-purple-500;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Global state
const IS_CLOSER = {{ 'true' if is_closer else 'false' }};
const CURRENT_USER = '{{ user }}';
let currentDate = new Date();
let selectedCloser = IS_CLOSER ? CURRENT_USER : '{{ closers_list[0] }}';
let availabilityData = {};
let eventsData = {};

// Init
document.addEventListener('DOMContentLoaded', function() {
    lucide.createIcons();

    if (!IS_CLOSER) {
        // Setup closer select
        document.getElementById('closer-select').addEventListener('change', function(e) {
            selectedCloser = e.target.value;
            loadAvailability();
            renderCalendar();
        });
    }

    loadAvailability();
    loadUpcomingAppointments();
});

function loadAvailability() {
    if (IS_CLOSER) {
        // Load closer's own events
        // For now, just render calendar
        renderCalendar();
    } else {
        // Load availability for selected closer
        fetch(`/t2/api/availability-calendar/${selectedCloser}`)
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    availabilityData = data.available_dates || [];
                }
                renderCalendar();
            })
            .catch(err => console.error('Error loading availability:', err));
    }
}

function renderCalendar() {
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();

    // Update month display
    const monthNames = ['Januar', 'Februar', 'März', 'April', 'Mai', 'Juni',
                       'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];
    document.getElementById('current-month').textContent = `${monthNames[month]} ${year}`;

    // Calendar logic
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const daysInMonth = lastDay.getDate();

    let startDay = firstDay.getDay() - 1;
    if (startDay < 0) startDay = 6;

    // Clear grid
    const grid = document.getElementById('calendar-grid');
    while (grid.children.length > 7) {
        grid.removeChild(grid.lastChild);
    }

    // Empty cells
    for (let i = 0; i < startDay; i++) {
        const empty = document.createElement('div');
        empty.className = 'p-3';
        grid.appendChild(empty);
    }

    // Day cells
    const today = new Date().toISOString().split('T')[0];

    for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const isToday = dateStr === today;

        const dayCell = document.createElement('div');
        dayCell.className = `calendar-day ${isToday ? 'today' : ''}`;
        dayCell.onclick = () => openDayModal(dateStr);

        const dayNum = document.createElement('div');
        dayNum.className = 'day-number';
        dayNum.textContent = day;
        dayCell.appendChild(dayNum);

        // Indicators
        const indicators = document.createElement('div');
        indicators.className = 'day-indicator';

        if (IS_CLOSER) {
            // TODO: Add yellow/purple dots for T2/T3
        } else {
            // Green dot if available
            if (availabilityData.includes(dateStr)) {
                const dot = document.createElement('div');
                dot.className = 'dot dot-green';
                indicators.appendChild(dot);
            }
        }

        dayCell.appendChild(indicators);
        grid.appendChild(dayCell);
    }

    lucide.createIcons();
}

function previousMonth() {
    currentDate.setMonth(currentDate.getMonth() - 1);
    renderCalendar();
}

function nextMonth() {
    currentDate.setMonth(currentDate.getMonth() + 1);
    renderCalendar();
}

function openDayModal(dateStr) {
    const modal = document.getElementById('day-modal');
    const content = document.getElementById('modal-content');

    content.innerHTML = '<div class="text-center py-8"><i data-lucide="loader" class="w-8 h-8 animate-spin mx-auto"></i></div>';
    modal.classList.remove('hidden');
    lucide.createIcons();

    if (IS_CLOSER) {
        loadCloserDayEvents(dateStr);
    } else {
        loadOpenerDaySlots(dateStr);
    }
}

function loadCloserDayEvents(dateStr) {
    fetch(`/t2/api/my-calendar-events/${dateStr}`)
        .then(r => r.json())
        .then(data => {
            const content = document.getElementById('modal-content');

            if (data.success && data.events && data.events.length > 0) {
                let html = `<h2 class="text-3xl font-bold text-white mb-6">Deine Termine am ${new Date(dateStr).toLocaleDateString('de-DE')}</h2>`;
                html += '<div class="space-y-4">';

                data.events.forEach(event => {
                    const color = event.color === 'yellow' ? 'yellow-500' : event.color === 'purple' ? 'purple-500' : 'gray-500';
                    html += `
                        <div class="glass rounded-2xl p-6 border-2 border-${color}/30">
                            <div class="flex items-center gap-3 mb-3">
                                <div class="w-4 h-4 rounded-full bg-${color}"></div>
                                <span class="font-bold text-xl text-white">${event.type}</span>
                            </div>
                            <div class="text-lg text-white mb-2"><strong>Kunde:</strong> ${event.customer}</div>
                            <div class="text-gray-300"><strong>Zeit:</strong> ${event.start ? new Date(event.start).toLocaleTimeString('de-DE', {hour: '2-digit', minute: '2-digit'}) : ''}</div>
                            ${event.description ? `<div class="text-gray-400 mt-2">${event.description}</div>` : ''}
                        </div>
                    `;
                });

                html += '</div>';
                content.innerHTML = html;
            } else {
                content.innerHTML = `<div class="text-center py-8"><p class="text-xl text-gray-300">Keine Termine an diesem Tag</p></div>`;
            }

            lucide.createIcons();
        })
        .catch(err => {
            console.error(err);
            document.getElementById('modal-content').innerHTML = '<div class="text-error text-center py-8">Fehler beim Laden</div>';
        });
}

function loadOpenerDaySlots(dateStr) {
    fetch(`/t2/api/availability/${selectedCloser}/${dateStr}`)
        .then(r => r.json())
        .then(data => {
            const content = document.getElementById('modal-content');

            if (data.success && data.available_slots && data.available_slots.length > 0) {
                let html = `<h2 class="text-3xl font-bold text-white mb-4">Verfügbare Slots - ${selectedCloser}</h2>`;
                html += `<p class="text-gray-300 mb-6">${new Date(dateStr).toLocaleDateString('de-DE', {weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'})}</p>`;
                html += '<div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-8">';

                data.available_slots.forEach(slot => {
                    html += `
                        <div class="glass rounded-xl p-4 text-center hover:bg-green-500/20 border-2 border-green-500/30 cursor-pointer" onclick="alert('Slot: ${slot}')">
                            <div class="text-2xl font-bold text-white">${slot}</div>
                            <div class="text-sm text-gray-400">2 Stunden</div>
                        </div>
                    `;
                });

                html += '</div>';
                html += `<a href="/t2/booking" class="btn btn-success btn-lg w-full gap-3"><i data-lucide="calendar-plus" class="w-6 h-6"></i> Termin buchen</a>`;
                content.innerHTML = html;
            } else {
                content.innerHTML = `<div class="text-center py-8"><p class="text-xl text-gray-300">Keine verfügbaren Slots an diesem Tag</p></div>`;
            }

            lucide.createIcons();
        })
        .catch(err => {
            console.error(err);
            document.getElementById('modal-content').innerHTML = '<div class="text-error text-center py-8">Fehler beim Laden</div>';
        });
}

function loadUpcomingAppointments() {
    const container = document.getElementById('upcoming-appointments');

    const endpoint = IS_CLOSER ? '/t2/api/my-upcoming-events' : '/t2/api/my-upcoming-bookings';

    fetch(endpoint)
        .then(r => r.json())
        .then(data => {
            const appointments = data.upcoming_events || data.upcoming_bookings || [];

            if (appointments.length === 0) {
                container.innerHTML = '<div class="text-gray-400 text-center py-8">Keine kommenden Termine</div>';
                return;
            }

            container.innerHTML = '';
            appointments.forEach(apt => {
                const card = document.createElement('div');
                card.className = 'glass rounded-2xl p-6 hover:bg-white/5 transition-all';

                if (IS_CLOSER) {
                    card.innerHTML = `
                        <div class="flex justify-between items-center flex-wrap gap-4">
                            <div class="flex-1">
                                <div class="font-bold text-white text-xl mb-2">${apt.type || 'Termin'} - ${apt.customer || 'Kunde'}</div>
                                <div class="text-gray-400 mb-1">${apt.start ? new Date(apt.start).toLocaleDateString('de-DE') : ''} - ${apt.start ? new Date(apt.start).toLocaleTimeString('de-DE', {hour: '2-digit', minute: '2-digit'}) : ''}</div>
                                ${apt.description ? `<div class="text-gray-400 text-sm">${apt.description}</div>` : ''}
                            </div>
                        </div>
                    `;
                } else {
                    card.innerHTML = `
                        <div class="flex justify-between items-center flex-wrap gap-4">
                            <div class="flex-1">
                                <div class="font-bold text-white text-xl mb-2">${apt.closer || 'Closer'}</div>
                                <div class="text-gray-400 mb-1">${apt.date || ''} um ${apt.time || ''} Uhr</div>
                                ${apt.topic ? `<div class="text-gray-400 text-sm">Thema: ${apt.topic}</div>` : ''}
                            </div>
                        </div>
                    `;
                }

                container.appendChild(card);
            });

            lucide.createIcons();
        })
        .catch(err => {
            console.error(err);
            container.innerHTML = '<div class="text-error text-center py-8">Fehler beim Laden</div>';
        });
}

function closeModal() {
    document.getElementById('day-modal').classList.add('hidden');
}
</script>
{% endblock %}
