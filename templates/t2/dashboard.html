{% extends "t2/base.html" %}

{% block title %}T2-Closer Dashboard{% endblock %}

{% block content %}
<!-- Header -->
<div class="t2-header">
    <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: var(--spacing-lg);">
        <div>
            <h1 class="t2-title">
                <i class="ti ti-users"></i> T2-Closer System
            </h1>
            <p class="t2-subtitle">
                Premium 2-Stunden-Beratungen
            </p>
        </div>
        <div class="stats-card" style="min-width: 150px;">
            <div class="stats-number">{{ tickets_remaining }}</div>
            <div class="stats-label">Tickets verf√ºgbar</div>
        </div>
    </div>
</div>

<!-- Navigation -->
<div style="display: flex; gap: var(--spacing-md); margin-bottom: var(--spacing-2xl); flex-wrap: wrap;">
    <a href="{{ url_for('t2.stats_page') }}" class="btn-t2">
        <i class="ti ti-chart-bar"></i>
        Statistiken
    </a>
    <a href="{{ url_for('t2.calendar_view') }}" class="btn-t2">
        <i class="ti ti-calendar"></i>
        Kalender
    </a>
</div>

<!-- Main Content -->
<div style="max-width: 800px; margin: 0 auto;">

    <!-- Closer W√ºrfeln Section -->
    <div style="background: var(--box-bg); backdrop-filter: blur(10px); border: 1px solid var(--box-border); border-radius: var(--radius-lg); padding: var(--spacing-2xl); margin-bottom: var(--spacing-xl); text-align: center;">

        {% if current_assigned_closer %}
        <!-- Aktuell zugewiesener Closer -->
        <div id="assigned-closer-display">
            <h2 style="font-size: var(--text-2xl); font-weight: var(--font-semibold); color: var(--text-color); margin: 0 0 var(--spacing-lg);">
                Dein zugewiesener Closer
            </h2>

            <div id="closer-card" style="background: var(--input-bg); border: 2px solid var(--box-border); border-radius: var(--radius-lg); padding: var(--spacing-xl); margin-bottom: var(--spacing-lg);">
                <div style="font-size: 64px; margin-bottom: var(--spacing-md);">üë§</div>
                <div id="closer-name" style="font-size: var(--text-3xl); font-weight: var(--font-bold); color: var(--accent); margin-bottom: var(--spacing-sm);">
                    {{ current_assigned_closer }}
                </div>
                <div style="color: var(--muted);">2-Stunden Premium-Beratung</div>
            </div>

            <div style="display: flex; gap: var(--spacing-md); justify-content: center; flex-wrap: wrap;">
                <a href="{{ url_for('t2.booking_page') }}" class="btn-t2 btn-t2-success" style="padding: var(--spacing-md) var(--spacing-2xl);">
                    <i class="ti ti-calendar-plus"></i>
                    Termin buchen
                </a>
                <button onclick="rollNewCloser()" class="btn-t2" style="padding: var(--spacing-md) var(--spacing-2xl);">
                    <i class="ti ti-refresh"></i>
                    Neuen Closer w√ºrfeln
                </button>
            </div>
        </div>

        {% else %}
        <!-- Noch kein Closer zugewiesen -->
        <div id="no-closer-display">
            <div style="font-size: 80px; margin-bottom: var(--spacing-lg);">üé≤</div>
            <h2 style="font-size: var(--text-2xl); font-weight: var(--font-semibold); color: var(--text-color); margin: 0 0 var(--spacing-md);">
                Bereit f√ºr deinen T2-Termin?
            </h2>
            <p style="color: var(--muted); margin: 0 0 var(--spacing-xl); max-width: 500px; margin-left: auto; margin-right: auto;">
                Dr√ºcke auf "Closer w√ºrfeln" und wir weisen dir automatisch einen verf√ºgbaren Berater zu.
            </p>

            <button onclick="rollNewCloser()" class="btn-t2 btn-t2-success" style="padding: var(--spacing-md) var(--spacing-2xl); font-size: var(--text-lg);">
                <i class="ti ti-dice"></i>
                Closer w√ºrfeln
            </button>
        </div>
        {% endif %}
    </div>

    <!-- N√§chste Termine -->
    {% if next_appointments %}
    <div style="background: var(--box-bg); backdrop-filter: blur(10px); border: 1px solid var(--box-border); border-radius: var(--radius-lg); padding: var(--spacing-xl); margin-bottom: var(--spacing-xl);">
        <h3 style="font-size: var(--text-xl); font-weight: var(--font-semibold); color: var(--text-color); margin: 0 0 var(--spacing-lg);">
            <i class="ti ti-clock"></i> Deine n√§chsten T2-Termine
        </h3>

        {% for appointment in next_appointments %}
        <div style="{% if not loop.last %}border-bottom: 1px solid var(--box-border); margin-bottom: var(--spacing-md); padding-bottom: var(--spacing-md);{% endif %}">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <div style="font-weight: var(--font-semibold); color: var(--text-color); margin-bottom: 4px;">
                        {{ appointment.closer }}
                    </div>
                    <div style="color: var(--muted); font-size: var(--text-sm);">
                        {{ appointment.date }} um {{ appointment.time }}
                    </div>
                    {% if appointment.topic %}
                    <div style="color: var(--muted); font-size: var(--text-sm); margin-top: 4px;">
                        Thema: {{ appointment.topic }}
                    </div>
                    {% endif %}
                </div>
                <div style="padding: 4px 12px; background: var(--success-bg); border: 1px solid var(--success-bd); color: var(--green); border-radius: var(--radius-sm); font-size: var(--text-xs);">
                    Best√§tigt
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Ticket Info -->
    <div style="background: var(--box-bg); backdrop-filter: blur(10px); border: 1px solid var(--box-border); border-radius: var(--radius-lg); padding: var(--spacing-lg);">
        <h3 style="font-size: var(--text-lg); font-weight: var(--font-semibold); color: var(--text-color); margin: 0 0 var(--spacing-md);">
            <i class="ti ti-ticket"></i> Deine T2-Tickets
        </h3>

        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <div style="font-size: var(--text-2xl); font-weight: var(--font-bold); color: var(--accent);">
                    {{ tickets_remaining }} / {{ tickets_total }}
                </div>
                <div style="color: var(--muted); font-size: var(--text-sm);">Tickets verf√ºgbar</div>
            </div>
            {% if tickets_remaining == 0 %}
            <div style="color: var(--red); font-size: var(--text-sm);">
                Reset: N√§chsten Monat
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function rollNewCloser() {
    const btn = event.target;
    btn.disabled = true;
    btn.innerHTML = '<i class="ti ti-loader" style="animation: spin 1s linear infinite;"></i> W√ºrfle...';

    fetch('/t2/api/roll-closer', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess(`${data.closer} wurde dir zugewiesen!`);

            // Seite neu laden um Closer anzuzeigen
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            showError(data.error || 'Fehler beim W√ºrfeln');
            btn.disabled = false;
            btn.innerHTML = '<i class="ti ti-dice"></i> Closer w√ºrfeln';
        }
    })
    .catch(error => {
        showError('Fehler beim W√ºrfeln');
        btn.disabled = false;
        btn.innerHTML = '<i class="ti ti-dice"></i> Closer w√ºrfeln';
    });
}

// Spin animation
const style = document.createElement('style');
style.textContent = `
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}
