{% extends "t2/base.html" %}

{% block title %}T2 Bucket Konfiguration{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="glass rounded-3xl p-8 mb-8" data-aos="fade-up">
    <div class="text-center">
        <h1 class="text-4xl md:text-5xl font-bold text-white mb-2">
            <i data-lucide="settings" class="inline w-10 h-10 mr-3"></i>
            T2 Bucket System - Admin
        </h1>
        <p class="text-lg text-gray-300">
            Wahrscheinlichkeits-Mappings & Bucket-Verwaltung
        </p>
    </div>
</div>

<!-- Quick Stats -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8" data-aos="fade-up" data-aos-delay="100">
    <div class="glass rounded-2xl p-6 text-center hover:bg-white/5 transition-all">
        <div class="text-5xl font-bold text-t2-purple mb-2">{{ bucket_stats.current_bucket_size }}</div>
        <div class="text-gray-400 text-lg">Tickets im Bucket</div>
    </div>
    <div class="glass rounded-2xl p-6 text-center hover:bg-white/5 transition-all">
        <div class="text-5xl font-bold text-yellow-500 mb-2">{{ bucket_stats.draws_until_reset }}</div>
        <div class="text-gray-400 text-lg">Draws bis Reset</div>
    </div>
    <div class="glass rounded-2xl p-6 text-center hover:bg-white/5 transition-all">
        <div class="text-5xl font-bold text-green-500 mb-2">{{ system_stats.total_all_time_draws }}</div>
        <div class="text-gray-400 text-lg">Total Draws (All-Time)</div>
    </div>
</div>

<!-- Main Container -->
<div class="max-w-7xl mx-auto">

    <!-- Probability Mappings -->
    <div class="glass rounded-3xl p-8 mb-8" data-aos="fade-up" data-aos-delay="200">
        <h2 class="text-3xl font-bold text-white mb-8 flex items-center gap-3">
            <i data-lucide="sliders" class="w-8 h-8 text-t2-purple"></i>
            Wahrscheinlichkeits-Mappings
        </h2>

        <div class="overflow-x-auto">
            <table class="w-full">
                <thead>
                    <tr class="border-b border-white/20">
                        <th class="text-left p-4 text-lg font-bold text-gray-300">Closer</th>
                        <th class="text-center p-4 text-lg font-bold text-gray-300">Aktuelle / Default</th>
                        <th class="text-center p-4 text-lg font-bold text-gray-300">Tickets im Bucket</th>
                        <th class="text-center p-4 text-lg font-bold text-gray-300">Update Wahrscheinlichkeit</th>
                    </tr>
                </thead>
                <tbody>
                    {% for closer_name, closer_info in closers.items() %}
                    <tr class="border-b border-white/10 hover:bg-white/5 transition-all">
                        <td class="p-4">
                            <div class="flex items-center gap-3">
                                <div class="w-4 h-4 rounded-full" style="background: {{ closer_info.color }};"></div>
                                <span class="text-white font-semibold text-xl">{{ closer_name }}</span>
                            </div>
                        </td>
                        <td class="p-4 text-center">
                            <div class="flex flex-col items-center gap-1">
                                <span class="text-4xl font-bold text-t2-purple">
                                    {{ "%.1f"|format(probabilities.get(closer_name, 1.0)) }}
                                </span>
                                <span class="text-sm text-gray-400">
                                    (Standard: {{ "%.1f"|format(bucket_composition.default_probabilities.get(closer_name, 1.0)) }})
                                </span>
                            </div>
                        </td>
                        <td class="p-4 text-center">
                            <span class="text-2xl font-semibold text-white">
                                {{ bucket_composition.composition.get(closer_name, 0) }}
                            </span>
                        </td>
                        <td class="p-4">
                            <div class="flex gap-2 justify-center items-center">
                                <input
                                    type="number"
                                    id="prob-{{ closer_name }}"
                                    min="0"
                                    max="100"
                                    step="0.1"
                                    value="{{ probabilities.get(closer_name, 1.0) }}"
                                    class="input input-bordered w-24 text-center text-lg font-bold bg-white/5 border-white/20 text-white focus:border-t2-purple"
                                >
                                <button
                                    data-action="updateBucketProbability" data-args='["{{ closer_name }}"]'
                                    class="btn btn-primary gap-2">
                                    <i data-lucide="check" class="w-5 h-5"></i>
                                    <span class="text-base">Update</span>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="mt-8 glass rounded-2xl p-6 flex items-start gap-3 border border-blue-500/30">
            <i data-lucide="info" class="w-6 h-6 text-blue-400 flex-shrink-0 mt-1"></i>
            <div class="text-gray-300 text-base">
                <strong class="text-white">Info:</strong> Wahrscheinlichkeit bestimmt die Anzahl der Tickets im Bucket. Höhere Werte = mehr Tickets = höhere Wahrscheinlichkeit gezogen zu werden. Mit jedem Draw sinkt die Wahrscheinlichkeit um 1. Setze auf 0, um einen Closer komplett zu deaktivieren.
            </div>
        </div>
    </div>

    <!-- Bucket Configuration -->
    <div class="glass rounded-3xl p-8 mb-8" data-aos="fade-up" data-aos-delay="250">
        <h2 class="text-3xl font-bold text-white mb-6 flex items-center gap-3">
            <i data-lucide="settings" class="w-8 h-8 text-t2-purple"></i>
            Bucket Konfiguration
        </h2>

        <div class="max-w-md">
            <label for="bucket-size-input" class="block text-base font-medium text-gray-300 mb-3">
                Max. Anzahl Draws bis Bucket Reset
            </label>
            <div class="flex gap-3">
                <input
                    type="number"
                    id="bucket-size-input"
                    min="1"
                    max="100"
                    step="1"
                    value="{{ bucket_composition.max_draws_before_reset }}"
                    class="input input-bordered flex-1 text-center text-xl font-bold bg-white/5 border-white/20 text-white focus:border-t2-purple"
                >
                <button
                    data-action="updateBucketSizeAction"
                    class="btn btn-primary gap-2">
                    <i data-lucide="check" class="w-5 h-5"></i>
                    <span class="text-base">Aktualisieren</span>
                </button>
            </div>
            <p class="text-xs text-gray-400 mt-2">
                Nach dieser Anzahl Draws wird der Bucket zurückgesetzt und Wahrscheinlichkeiten auf Standard-Werte wiederhergestellt. (Min: 1, Max: 100)
            </p>
        </div>
    </div>

    <!-- Current Bucket Composition -->
    <div class="glass rounded-3xl p-8 mb-8" data-aos="fade-up" data-aos-delay="300">
        <div class="flex justify-between items-center mb-8 flex-wrap gap-4">
            <h2 class="text-3xl font-bold text-white flex items-center gap-3">
                <i data-lucide="archive" class="w-8 h-8 text-t2-purple"></i>
                Aktueller Bucket
            </h2>
            <button data-action="resetBucketAction" class="btn btn-error gap-2">
                <i data-lucide="rotate-ccw" class="w-5 h-5"></i>
                <span class="text-base">Bucket Reset</span>
            </button>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-6 mb-8">
            {% for closer_name, ticket_count in bucket_composition.composition.items() %}
            <div class="glass rounded-2xl p-6 text-center hover:bg-white/5 transition-all">
                <div class="w-6 h-6 rounded-full mx-auto mb-3" style="background: {{ closers[closer_name].color }};"></div>
                <div class="text-white font-semibold text-lg mb-2">{{ closer_name }}</div>
                <div class="text-4xl font-bold text-t2-purple mb-1">{{ ticket_count }}</div>
                <div class="text-gray-400 text-sm">Tickets</div>
            </div>
            {% endfor %}
        </div>

        <!-- Draws Progress -->
        <div class="glass rounded-2xl p-6 text-center">
            <div class="text-gray-400 text-base mb-2">Draws dieser Cycle</div>
            <div class="text-5xl font-bold text-white mb-4">
                {{ bucket_stats.draws_this_cycle }} / {{ bucket_composition.max_draws_before_reset }}
            </div>
            <div class="w-full glass rounded-xl h-8 relative overflow-hidden">
                <div class="bg-gradient-to-r from-t2-purple to-pink-600 h-full transition-all duration-500"
                     style="width: {{ (bucket_stats.draws_this_cycle / bucket_composition.max_draws_before_reset * 100)|int }}%;"></div>
            </div>
        </div>
    </div>

    <!-- All-Time Distribution -->
    <div class="glass rounded-3xl p-8 mb-8" data-aos="fade-up" data-aos-delay="400">
        <h2 class="text-3xl font-bold text-white mb-8 flex items-center gap-3">
            <i data-lucide="bar-chart-2" class="w-8 h-8 text-t2-purple"></i>
            All-Time Verteilung
        </h2>

        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-6">
            {% for closer_name, draw_count in system_stats.closer_distribution.items() %}
            {% if closer_name in closers %}
            <div class="glass rounded-2xl p-6 text-center hover:bg-white/5 transition-all">
                <div class="w-6 h-6 rounded-full mx-auto mb-3" style="background: {{ closers[closer_name].color }};"></div>
                <div class="text-white font-semibold text-lg mb-2">{{ closer_name }}</div>
                <div class="text-4xl font-bold text-t2-purple mb-1">{{ draw_count }}</div>
                <div class="text-gray-400 text-sm">Total Draws</div>
            </div>
            {% endif %}
            {% endfor %}
        </div>
    </div>

    <!-- Closer Management -->
    <div class="glass rounded-3xl p-8 mb-8" data-aos="fade-up" data-aos-delay="450">
        <div class="flex justify-between items-center mb-8 flex-wrap gap-4">
            <h2 class="text-3xl font-bold text-white flex items-center gap-3">
                <i data-lucide="users" class="w-8 h-8 text-t2-purple"></i>
                Closer-Verwaltung
            </h2>
            <button data-action="openAddCloserModal" class="btn btn-success gap-2">
                <i data-lucide="user-plus" class="w-5 h-5"></i>
                <span class="text-base">Neuer Closer</span>
            </button>
        </div>

        <div class="overflow-x-auto">
            <table class="w-full">
                <thead>
                    <tr class="border-b border-white/20">
                        <th class="text-left p-4 text-base font-bold text-gray-300">Name</th>
                        <th class="text-left p-4 text-base font-bold text-gray-300">Vollständiger Name</th>
                        <th class="text-center p-4 text-base font-bold text-gray-300">Farbe</th>
                        <th class="text-center p-4 text-base font-bold text-gray-300">Standard-Wahrscheinlichkeit</th>
                        <th class="text-center p-4 text-base font-bold text-gray-300">Aktionen</th>
                    </tr>
                </thead>
                <tbody>
                    {% for closer_name, closer_info in closers.items() %}
                    <tr class="border-b border-white/10 hover:bg-white/5 transition-all">
                        <td class="p-4">
                            <span class="text-white font-semibold text-lg">{{ closer_name }}</span>
                        </td>
                        <td class="p-4 text-white text-base">
                            {{ closer_info.full_name }}
                        </td>
                        <td class="p-4 text-center">
                            <div class="flex items-center justify-center gap-2">
                                <div class="w-6 h-6 rounded-full" style="background: {{ closer_info.color }};"></div>
                                <span class="text-gray-400 text-sm font-mono">{{ closer_info.color }}</span>
                            </div>
                        </td>
                        <td class="p-4 text-center">
                            <span class="text-t2-purple font-bold text-lg">
                                {{ "%.1f"|format(closer_info.default_probability) }}
                            </span>
                        </td>
                        <td class="p-4">
                            <div class="flex gap-2 justify-center">
                                <button
                                    data-action="openEditCloserModal" data-args='["{{ closer_name }}", "{{ closer_info.full_name }}", "{{ closer_info.color }}"]'
                                    class="btn btn-sm btn-primary gap-1">
                                    <i data-lucide="edit-2" class="w-4 h-4"></i>
                                    <span class="text-sm">Bearbeiten</span>
                                </button>
                                <button
                                    data-action="confirmRemoveCloser" data-args='["{{ closer_name }}"]'
                                    class="btn btn-sm btn-error gap-1">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                    <span class="text-sm">Löschen</span>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="mt-6 glass rounded-2xl p-6 flex items-start gap-3 border border-yellow-500/30">
            <i data-lucide="alert-triangle" class="w-6 h-6 text-yellow-400 flex-shrink-0 mt-1"></i>
            <div class="text-gray-300 text-base">
                <strong class="text-white">Hinweis:</strong> Das Hinzufügen/Entfernen von Closern setzt den Bucket automatisch zurück.
            </div>
        </div>
    </div>

    <!-- Recent Draw History -->
    <div class="glass rounded-3xl p-8 mb-8" data-aos="fade-up" data-aos-delay="500">
        <h2 class="text-3xl font-bold text-white mb-8 flex items-center gap-3">
            <i data-lucide="history" class="w-8 h-8 text-t2-purple"></i>
            Letzte Ziehungen (20)
        </h2>

        <div class="overflow-x-auto">
            <table class="w-full">
                <thead>
                    <tr class="border-b border-white/20">
                        <th class="text-left p-4 text-base font-bold text-gray-300">User</th>
                        <th class="text-left p-4 text-base font-bold text-gray-300">Kundenname</th>
                        <th class="text-center p-4 text-base font-bold text-gray-300">Gezogener Closer</th>
                        <th class="text-center p-4 text-base font-bold text-gray-300">Prob. After</th>
                        <th class="text-center p-4 text-base font-bold text-gray-300">Typ</th>
                        <th class="text-center p-4 text-base font-bold text-gray-300">Zeitstempel</th>
                        <th class="text-center p-4 text-base font-bold text-gray-300">Bucket Size After</th>
                    </tr>
                </thead>
                <tbody>
                    {% for draw in system_stats.recent_draws[::-1] %}
                    <tr class="border-b border-white/10 hover:bg-white/5 transition-all">
                        <td class="p-4 text-white text-base">{{ draw.user }}</td>
                        <td class="p-4 text-gray-300 text-base">
                            {% if draw.customer_name %}
                                <span class="px-2 py-1 bg-blue-500/20 border border-blue-500/40 rounded-lg text-blue-300 text-sm">
                                    <i data-lucide="user" class="inline w-3 h-3 mr-1"></i>{{ draw.customer_name }}
                                </span>
                            {% else %}
                                <span class="text-gray-500 text-sm italic">-</span>
                            {% endif %}
                        </td>
                        <td class="p-4 text-center">
                            <div class="inline-flex items-center gap-2">
                                {% if draw.closer in closers %}
                                <div class="w-3 h-3 rounded-full" style="background: {{ closers[draw.closer].color }};"></div>
                                <span class="text-white font-semibold">{{ draw.closer }}</span>
                                {% else %}
                                <div class="w-3 h-3 rounded-full" style="background: #666666;"></div>
                                <span class="text-gray-500 font-semibold">{{ draw.closer }} (entfernt)</span>
                                {% endif %}
                            </div>
                        </td>
                        <td class="p-4 text-center">
                            {% if draw.probability_after %}
                                <span class="text-t2-purple font-bold text-base">{{ "%.1f"|format(draw.probability_after) }}</span>
                            {% else %}
                                <span class="text-gray-500 text-sm">-</span>
                            {% endif %}
                        </td>
                        <td class="p-4 text-center">
                            <span class="px-2 py-1 bg-green-500/20 border border-green-500/50 text-green-400 rounded-lg text-xs font-semibold">
                                {{ draw.draw_type }}
                            </span>
                        </td>
                        <td class="p-4 text-center text-gray-400 text-sm">
                            {{ draw.timestamp[:19].replace('T', ' ') }}
                        </td>
                        <td class="p-4 text-center text-white font-semibold">
                            {{ draw.bucket_size_after }}
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="7" class="text-center p-8 text-gray-400 text-lg">
                            Noch keine Ziehungen vorhanden
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Back Button -->
    <div class="text-center" data-aos="fade-up" data-aos-delay="600">
        <a href="{{ url_for('t2.dashboard') }}" class="btn btn-primary btn-lg gap-3">
            <i data-lucide="arrow-left" class="w-6 h-6"></i>
            <span class="text-lg">Zurück zum Dashboard</span>
        </a>
    </div>
</div>

<!-- Add Closer Modal -->
<div id="add-closer-modal" class="modal" style="display: none;">
    <div class="modal-overlay" data-action="closeAddCloserModal"></div>
    <div class="glass rounded-3xl p-8 max-w-lg w-full mx-4 relative z-10">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-2xl font-bold text-white flex items-center gap-2">
                <i data-lucide="user-plus" class="w-6 h-6 text-t2-purple"></i>
                Neuen Closer hinzufügen
            </h3>
            <button data-action="closeAddCloserModal" class="text-gray-400 hover:text-white">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>

        <form id="add-closer-form" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">Kurzer Name</label>
                <input type="text" id="add-name" required
                       class="w-full px-4 py-2 rounded-xl bg-white/5 border border-white/20 text-white focus:border-t2-purple"
                       placeholder="z.B. Alex">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">Vollständiger Name</label>
                <input type="text" id="add-full-name" required
                       class="w-full px-4 py-2 rounded-xl bg-white/5 border border-white/20 text-white focus:border-t2-purple"
                       placeholder="z.B. Alexander">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">Farbe (Hex)</label>
                <div class="flex gap-2">
                    <input type="color" id="add-color-picker" value="#2196F3"
                           class="w-16 h-10 rounded-xl bg-white/5 border border-white/20">
                    <input type="text" id="add-color" required value="#2196F3"
                           class="flex-1 px-4 py-2 rounded-xl bg-white/5 border border-white/20 text-white focus:border-t2-purple"
                           placeholder="#2196F3">
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">Standard-Wahrscheinlichkeit</label>
                <input type="number" id="add-probability" required min="0" max="100" step="0.1" value="1.0"
                       class="w-full px-4 py-2 rounded-xl bg-white/5 border border-white/20 text-white focus:border-t2-purple">
            </div>

            <div class="flex gap-3 pt-4">
                <button type="submit" class="btn btn-success flex-1 gap-2">
                    <i data-lucide="check" class="w-5 h-5"></i>
                    <span>Hinzufügen</span>
                </button>
                <button type="button" data-action="closeAddCloserModal" class="btn btn-ghost flex-1">
                    Abbrechen
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Closer Modal -->
<div id="edit-closer-modal" class="modal" style="display: none;">
    <div class="modal-overlay" data-action="closeEditCloserModal"></div>
    <div class="glass rounded-3xl p-8 max-w-lg w-full mx-4 relative z-10">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-2xl font-bold text-white flex items-center gap-2">
                <i data-lucide="edit-2" class="w-6 h-6 text-t2-purple"></i>
                Closer bearbeiten
            </h3>
            <button data-action="closeEditCloserModal" class="text-gray-400 hover:text-white">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>

        <form id="edit-closer-form" class="space-y-4">
            <input type="hidden" id="edit-name-original">
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">Name</label>
                <input type="text" id="edit-name" disabled
                       class="w-full px-4 py-2 rounded-xl bg-white/10 border border-white/20 text-gray-400"
                       placeholder="Name kann nicht geändert werden">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">Vollständiger Name</label>
                <input type="text" id="edit-full-name" required
                       class="w-full px-4 py-2 rounded-xl bg-white/5 border border-white/20 text-white focus:border-t2-purple">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">Farbe (Hex)</label>
                <div class="flex gap-2">
                    <input type="color" id="edit-color-picker" value="#2196F3"
                           class="w-16 h-10 rounded-xl bg-white/5 border border-white/20">
                    <input type="text" id="edit-color" required
                           class="flex-1 px-4 py-2 rounded-xl bg-white/5 border border-white/20 text-white focus:border-t2-purple"
                           placeholder="#2196F3">
                </div>
            </div>

            <div class="flex gap-3 pt-4">
                <button type="submit" class="btn btn-primary flex-1 gap-2">
                    <i data-lucide="check" class="w-5 h-5"></i>
                    <span>Speichern</span>
                </button>
                <button type="button" data-action="closeEditCloserModal" class="btn btn-ghost flex-1">
                    Abbrechen
                </button>
            </div>
        </form>
    </div>
</div>

<style nonce="{{ csp_nonce }}">
.modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Dark Mode Overlay */
[data-theme="dark"] .modal-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(5px);
}

/* Light Mode Overlay */
[data-theme="light"] .modal-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(120, 113, 108, 0.5);
    backdrop-filter: blur(5px);
}

/* Light Mode Input Styles */
[data-theme="light"] input[type="text"],
[data-theme="light"] input[type="number"],
[data-theme="light"] input[type="color"] {
    color: #1c1917 !important;
}

[data-theme="light"] input::placeholder {
    color: #78716c !important;
}

/* Light Mode Button Styles */
[data-theme="light"] .btn-ghost {
    color: #1c1917 !important;
}

[data-theme="light"] .btn-ghost:hover {
    background: rgba(212, 175, 106, 0.2) !important;
}

/* Light Mode Table Border Colors */
[data-theme="light"] .border-white\/20,
[data-theme="light"] .border-white\/10 {
    border-color: rgba(212, 175, 106, 0.25) !important;
}

/* Light Mode Text Colors in Tables */
[data-theme="light"] .text-gray-300,
[data-theme="light"] .text-gray-400 {
    color: #57534e !important;
}

/* Light Mode Hover States */
[data-theme="light"] .hover\:bg-white\/5:hover {
    background: rgba(212, 175, 106, 0.1) !important;
}

[data-theme="light"] .hover\:bg-white\/10:hover {
    background: rgba(212, 175, 106, 0.15) !important;
}

/* Light Mode Border Colors for Info Boxes */
[data-theme="light"] .border-blue-500\/30 {
    border-color: rgba(59, 130, 246, 0.4) !important;
}

[data-theme="light"] .border-yellow-500\/30 {
    border-color: rgba(234, 179, 8, 0.4) !important;
}

/* Light Mode Icon Colors */
[data-theme="light"] .text-blue-400 {
    color: #3b82f6 !important;
}

[data-theme="light"] .text-yellow-400 {
    color: #eab308 !important;
}

[data-theme="light"] .text-t2-purple {
    color: #d4af6a !important;
}
</style>
{% endblock %}

{% block extra_js %}
<script nonce="{{ csp_nonce }}">
// CSP-compliant wrappers for data-action
window.updateBucketProbability = function(e, closerName) {
    updateProbability(closerName);
};
window.updateBucketSizeAction = function(e) {
    updateBucketSize();
};
window.resetBucketAction = function(e) {
    resetBucket();
};
window.openAddCloserModal = function(e) {
    _openAddCloserModal();
};
window.closeAddCloserModal = function(e) {
    _closeAddCloserModal();
};
window.openEditCloserModal = function(e, name, fullName, color) {
    _openEditCloserModal(name, fullName, color);
};
window.closeEditCloserModal = function(e) {
    _closeEditCloserModal();
};
window.confirmRemoveCloser = function(e, name) {
    _confirmRemoveCloser(name);
};

function updateProbability(closerName) {
    const inputField = document.getElementById(`prob-${closerName}`);
    const newValue = parseFloat(inputField.value);

    if (isNaN(newValue) || newValue < 0) {
        showError('Wahrscheinlichkeit kann nicht negativ sein');
        return;
    }

    if (newValue > 100) {
        showError('Wahrscheinlichkeit kann nicht über 100 liegen');
        return;
    }

    fetch('/t2/api/admin/update-probability', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            closer_name: closerName,
            probability: newValue
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess(`Wahrscheinlichkeit aktualisiert für ${closerName}`);
            setTimeout(() => window.location.reload(), 1000);
        } else {
            showError(data.message || 'Update fehlgeschlagen');
        }
    })
    .catch(error => {
        showError('Fehler beim Aktualisieren der Wahrscheinlichkeit');
    });
}

function resetBucket() {
    if (!confirm('Bist du sicher, dass du den Bucket zurücksetzen möchtest? Dies wird ihn basierend auf aktuellen Wahrscheinlichkeiten neu aufbauen.')) {
        return;
    }

    fetch('/t2/api/admin/reset-bucket', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess('Bucket erfolgreich zurückgesetzt');
            setTimeout(() => window.location.reload(), 1000);
        } else {
            showError(data.message || 'Reset fehlgeschlagen');
        }
    })
    .catch(error => {
        showError('Fehler beim Zurücksetzen des Buckets');
    });
}

function showSuccess(message) {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = 'fixed top-4 right-4 z-50 glass rounded-2xl p-6 max-w-sm transform transition-all duration-300 border-2 border-green-500';
    notification.innerHTML = `
        <div class="flex items-center gap-3">
            <i data-lucide="check-circle" class="w-6 h-6 text-green-500"></i>
            <span class="text-white font-semibold text-lg">${message}</span>
        </div>
    `;
    document.body.appendChild(notification);

    // Re-init Lucide icons
    lucide.createIcons();

    // Remove after 3 seconds
    setTimeout(() => {
        notification.style.opacity = '0';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

function showError(message) {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = 'fixed top-4 right-4 z-50 glass rounded-2xl p-6 max-w-sm transform transition-all duration-300 border-2 border-red-500';
    notification.innerHTML = `
        <div class="flex items-center gap-3">
            <i data-lucide="alert-circle" class="w-6 h-6 text-red-500"></i>
            <span class="text-white font-semibold text-lg">${message}</span>
        </div>
    `;
    document.body.appendChild(notification);

    // Re-init Lucide icons
    lucide.createIcons();

    // Remove after 3 seconds
    setTimeout(() => {
        notification.style.opacity = '0';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

function updateBucketSize() {
    const inputField = document.getElementById('bucket-size-input');
    const newSize = parseInt(inputField.value);

    if (isNaN(newSize) || newSize < 1) {
        showError('Bucket-Größe muss mindestens 1 sein');
        return;
    }

    if (newSize > 100) {
        showError('Bucket-Größe kann nicht über 100 liegen');
        return;
    }

    if (!confirm(`Bist du sicher, dass du die Bucket-Größe auf ${newSize} ändern möchtest? Dies wird den Bucket zurücksetzen.`)) {
        return;
    }

    fetch('/t2/api/admin/update-bucket-size', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            bucket_size: newSize
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess(`Bucket-Größe erfolgreich auf ${newSize} aktualisiert`);
            setTimeout(() => window.location.reload(), 1000);
        } else {
            showError(data.message || 'Update fehlgeschlagen');
        }
    })
    .catch(error => {
        showError('Fehler beim Aktualisieren der Bucket-Größe');
    });
}

// ========== CLOSER MANAGEMENT ==========

// Add Closer Modal
function _openAddCloserModal() {
    document.getElementById('add-closer-modal').style.display = 'flex';
    lucide.createIcons();

    // Sync color picker with text input
    const colorPicker = document.getElementById('add-color-picker');
    const colorInput = document.getElementById('add-color');

    colorPicker.addEventListener('input', (e) => {
        colorInput.value = e.target.value;
    });

    colorInput.addEventListener('input', (e) => {
        if (e.target.value.match(/^#[0-9A-F]{6}$/i)) {
            colorPicker.value = e.target.value;
        }
    });
}

function _closeAddCloserModal() {
    document.getElementById('add-closer-modal').style.display = 'none';
}

document.getElementById('add-closer-form').addEventListener('submit', function(e) {
    e.preventDefault();

    const name = document.getElementById('add-name').value.trim();
    const fullName = document.getElementById('add-full-name').value.trim();
    const color = document.getElementById('add-color').value.trim();
    const probability = parseFloat(document.getElementById('add-probability').value);

    fetch('/t2/api/admin/add-closer', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            name: name,
            full_name: fullName,
            color: color,
            default_probability: probability
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess(`Closer "${name}" erfolgreich hinzugefügt`);
            setTimeout(() => window.location.reload(), 1000);
        } else {
            showError(data.message || 'Hinzufügen fehlgeschlagen');
        }
    })
    .catch(error => {
        showError('Fehler beim Hinzufügen des Closers');
    });
});

// Edit Closer Modal
function _openEditCloserModal(name, fullName, color) {
    document.getElementById('edit-closer-modal').style.display = 'flex';
    document.getElementById('edit-name-original').value = name;
    document.getElementById('edit-name').value = name;
    document.getElementById('edit-full-name').value = fullName;
    document.getElementById('edit-color').value = color;
    document.getElementById('edit-color-picker').value = color;
    lucide.createIcons();

    // Sync color picker with text input
    const colorPicker = document.getElementById('edit-color-picker');
    const colorInput = document.getElementById('edit-color');

    colorPicker.addEventListener('input', (e) => {
        colorInput.value = e.target.value;
    });

    colorInput.addEventListener('input', (e) => {
        if (e.target.value.match(/^#[0-9A-F]{6}$/i)) {
            colorPicker.value = e.target.value;
        }
    });
}

function _closeEditCloserModal() {
    document.getElementById('edit-closer-modal').style.display = 'none';
}

document.getElementById('edit-closer-form').addEventListener('submit', function(e) {
    e.preventDefault();

    const name = document.getElementById('edit-name-original').value;
    const fullName = document.getElementById('edit-full-name').value.trim();
    const color = document.getElementById('edit-color').value.trim();

    fetch('/t2/api/admin/update-closer-info', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            name: name,
            full_name: fullName,
            color: color
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess(`Closer "${name}" erfolgreich aktualisiert`);
            setTimeout(() => window.location.reload(), 1000);
        } else {
            showError(data.message || 'Aktualisierung fehlgeschlagen');
        }
    })
    .catch(error => {
        showError('Fehler beim Aktualisieren des Closers');
    });
});

// Remove Closer
function _confirmRemoveCloser(name) {
    if (!confirm(`Bist du sicher, dass du Closer "${name}" entfernen möchtest? Dies setzt den Bucket zurück.`)) {
        return;
    }

    fetch('/t2/api/admin/remove-closer', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            name: name
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess(`Closer "${name}" erfolgreich entfernt`);
            setTimeout(() => window.location.reload(), 1000);
        } else {
            showError(data.message || 'Entfernen fehlgeschlagen');
        }
    })
    .catch(error => {
        showError('Fehler beim Entfernen des Closers');
    });
}
</script>
{% endblock %}
