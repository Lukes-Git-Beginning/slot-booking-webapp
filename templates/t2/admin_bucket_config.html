{% extends "t2/base.html" %}

{% block title %}T2 Bucket Konfiguration{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="glass rounded-3xl p-8 mb-8" data-aos="fade-up">
    <div class="text-center">
        <h1 class="text-4xl md:text-5xl font-bold text-white mb-2">
            <i data-lucide="settings" class="inline w-10 h-10 mr-3"></i>
            T2 Bucket System - Admin
        </h1>
        <p class="text-lg text-gray-300">
            Wahrscheinlichkeits-Mappings & Bucket-Verwaltung
        </p>
    </div>
</div>

<!-- Quick Stats -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8" data-aos="fade-up" data-aos-delay="100">
    <div class="glass rounded-2xl p-6 text-center hover:bg-white/5 transition-all">
        <div class="text-5xl font-bold text-t2-purple mb-2">{{ bucket_stats.current_bucket_size }}</div>
        <div class="text-gray-400 text-lg">Tickets im Bucket</div>
    </div>
    <div class="glass rounded-2xl p-6 text-center hover:bg-white/5 transition-all">
        <div class="text-5xl font-bold text-yellow-500 mb-2">{{ bucket_stats.draws_until_reset }}</div>
        <div class="text-gray-400 text-lg">Draws bis Reset</div>
    </div>
    <div class="glass rounded-2xl p-6 text-center hover:bg-white/5 transition-all">
        <div class="text-5xl font-bold text-green-500 mb-2">{{ system_stats.total_all_time_draws }}</div>
        <div class="text-gray-400 text-lg">Total Draws (All-Time)</div>
    </div>
</div>

<!-- Main Container -->
<div class="max-w-7xl mx-auto">

    <!-- Probability Mappings -->
    <div class="glass rounded-3xl p-8 mb-8" data-aos="fade-up" data-aos-delay="200">
        <h2 class="text-3xl font-bold text-white mb-8 flex items-center gap-3">
            <i data-lucide="sliders" class="w-8 h-8 text-t2-purple"></i>
            Wahrscheinlichkeits-Mappings
        </h2>

        <div class="overflow-x-auto">
            <table class="w-full">
                <thead>
                    <tr class="border-b border-white/20">
                        <th class="text-left p-4 text-lg font-bold text-gray-300">Closer</th>
                        <th class="text-center p-4 text-lg font-bold text-gray-300">Aktuelle / Default</th>
                        <th class="text-center p-4 text-lg font-bold text-gray-300">Tickets im Bucket</th>
                        <th class="text-center p-4 text-lg font-bold text-gray-300">Update Wahrscheinlichkeit</th>
                    </tr>
                </thead>
                <tbody>
                    {% for closer_name, closer_info in closers.items() %}
                    <tr class="border-b border-white/10 hover:bg-white/5 transition-all">
                        <td class="p-4">
                            <div class="flex items-center gap-3">
                                <div class="w-4 h-4 rounded-full" style="background: {{ closer_info.color }};"></div>
                                <span class="text-white font-semibold text-xl">{{ closer_name }}</span>
                            </div>
                        </td>
                        <td class="p-4 text-center">
                            <div class="flex flex-col items-center gap-1">
                                <span class="text-4xl font-bold text-t2-purple">
                                    {{ "%.1f"|format(probabilities.get(closer_name, 1.0)) }}
                                </span>
                                <span class="text-sm text-gray-400">
                                    (Standard: {{ "%.1f"|format(bucket_composition.default_probabilities.get(closer_name, 1.0)) }})
                                </span>
                            </div>
                        </td>
                        <td class="p-4 text-center">
                            <span class="text-2xl font-semibold text-white">
                                {{ bucket_composition.composition.get(closer_name, 0) }}
                            </span>
                        </td>
                        <td class="p-4">
                            <div class="flex gap-2 justify-center items-center">
                                <input
                                    type="number"
                                    id="prob-{{ closer_name }}"
                                    min="0.1"
                                    max="100"
                                    step="0.1"
                                    value="{{ probabilities.get(closer_name, 1.0) }}"
                                    class="input input-bordered w-24 text-center text-lg font-bold bg-white/5 border-white/20 text-white focus:border-t2-purple"
                                >
                                <button
                                    onclick="updateProbability('{{ closer_name }}')"
                                    class="btn btn-primary gap-2">
                                    <i data-lucide="check" class="w-5 h-5"></i>
                                    <span class="text-base">Update</span>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="mt-8 glass rounded-2xl p-6 flex items-start gap-3 border border-blue-500/30">
            <i data-lucide="info" class="w-6 h-6 text-blue-400 flex-shrink-0 mt-1"></i>
            <div class="text-gray-300 text-base">
                <strong class="text-white">Info:</strong> Wahrscheinlichkeit bestimmt die Anzahl der Tickets im Bucket. Höhere Werte = mehr Tickets = höhere Wahrscheinlichkeit gezogen zu werden. Minimum: 0.1
            </div>
        </div>
    </div>

    <!-- Bucket Configuration -->
    <div class="glass rounded-3xl p-8 mb-8" data-aos="fade-up" data-aos-delay="250">
        <h2 class="text-3xl font-bold text-white mb-6 flex items-center gap-3">
            <i data-lucide="settings" class="w-8 h-8 text-t2-purple"></i>
            Bucket Konfiguration
        </h2>

        <div class="max-w-md">
            <label for="bucket-size-input" class="block text-base font-medium text-gray-300 mb-3">
                Max. Anzahl Draws bis Bucket Reset
            </label>
            <div class="flex gap-3">
                <input
                    type="number"
                    id="bucket-size-input"
                    min="1"
                    max="100"
                    step="1"
                    value="{{ bucket_composition.max_draws_before_reset }}"
                    class="input input-bordered flex-1 text-center text-xl font-bold bg-white/5 border-white/20 text-white focus:border-t2-purple"
                >
                <button
                    onclick="updateBucketSize()"
                    class="btn btn-primary gap-2">
                    <i data-lucide="check" class="w-5 h-5"></i>
                    <span class="text-base">Aktualisieren</span>
                </button>
            </div>
            <p class="text-xs text-gray-400 mt-2">
                Nach dieser Anzahl Draws wird der Bucket zurückgesetzt und Wahrscheinlichkeiten auf Standard-Werte wiederhergestellt. (Min: 1, Max: 100)
            </p>
        </div>
    </div>

    <!-- Current Bucket Composition -->
    <div class="glass rounded-3xl p-8 mb-8" data-aos="fade-up" data-aos-delay="300">
        <div class="flex justify-between items-center mb-8 flex-wrap gap-4">
            <h2 class="text-3xl font-bold text-white flex items-center gap-3">
                <i data-lucide="archive" class="w-8 h-8 text-t2-purple"></i>
                Aktueller Bucket
            </h2>
            <button onclick="resetBucket()" class="btn btn-error gap-2">
                <i data-lucide="rotate-ccw" class="w-5 h-5"></i>
                <span class="text-base">Bucket Reset</span>
            </button>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-6 mb-8">
            {% for closer_name, ticket_count in bucket_composition.items() %}
            <div class="glass rounded-2xl p-6 text-center hover:bg-white/5 transition-all">
                <div class="w-6 h-6 rounded-full mx-auto mb-3" style="background: {{ closers[closer_name].color }};"></div>
                <div class="text-white font-semibold text-lg mb-2">{{ closer_name }}</div>
                <div class="text-4xl font-bold text-t2-purple mb-1">{{ ticket_count }}</div>
                <div class="text-gray-400 text-sm">Tickets</div>
            </div>
            {% endfor %}
        </div>

        <!-- Draws Progress -->
        <div class="glass rounded-2xl p-6 text-center">
            <div class="text-gray-400 text-base mb-2">Draws dieser Cycle</div>
            <div class="text-5xl font-bold text-white mb-4">
                {{ bucket_stats.draws_this_cycle }} / {{ bucket_composition.max_draws_before_reset }}
            </div>
            <div class="w-full glass rounded-xl h-8 relative overflow-hidden">
                <div class="bg-gradient-to-r from-t2-purple to-pink-600 h-full transition-all duration-500"
                     style="width: {{ (bucket_stats.draws_this_cycle / bucket_composition.max_draws_before_reset * 100)|int }}%;"></div>
            </div>
        </div>
    </div>

    <!-- All-Time Distribution -->
    <div class="glass rounded-3xl p-8 mb-8" data-aos="fade-up" data-aos-delay="400">
        <h2 class="text-3xl font-bold text-white mb-8 flex items-center gap-3">
            <i data-lucide="bar-chart-2" class="w-8 h-8 text-t2-purple"></i>
            All-Time Verteilung
        </h2>

        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-6">
            {% for closer_name, draw_count in system_stats.closer_distribution.items() %}
            <div class="glass rounded-2xl p-6 text-center hover:bg-white/5 transition-all">
                <div class="w-6 h-6 rounded-full mx-auto mb-3" style="background: {{ closers[closer_name].color }};"></div>
                <div class="text-white font-semibold text-lg mb-2">{{ closer_name }}</div>
                <div class="text-4xl font-bold text-t2-purple mb-1">{{ draw_count }}</div>
                <div class="text-gray-400 text-sm">Total Draws</div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Recent Draw History -->
    <div class="glass rounded-3xl p-8 mb-8" data-aos="fade-up" data-aos-delay="500">
        <h2 class="text-3xl font-bold text-white mb-8 flex items-center gap-3">
            <i data-lucide="history" class="w-8 h-8 text-t2-purple"></i>
            Letzte Ziehungen (20)
        </h2>

        <div class="overflow-x-auto">
            <table class="w-full">
                <thead>
                    <tr class="border-b border-white/20">
                        <th class="text-left p-4 text-base font-bold text-gray-300">User</th>
                        <th class="text-left p-4 text-base font-bold text-gray-300">Kundenname</th>
                        <th class="text-center p-4 text-base font-bold text-gray-300">Gezogener Closer</th>
                        <th class="text-center p-4 text-base font-bold text-gray-300">Prob. After</th>
                        <th class="text-center p-4 text-base font-bold text-gray-300">Typ</th>
                        <th class="text-center p-4 text-base font-bold text-gray-300">Zeitstempel</th>
                        <th class="text-center p-4 text-base font-bold text-gray-300">Bucket Size After</th>
                    </tr>
                </thead>
                <tbody>
                    {% for draw in system_stats.recent_draws[::-1] %}
                    <tr class="border-b border-white/10 hover:bg-white/5 transition-all">
                        <td class="p-4 text-white text-base">{{ draw.user }}</td>
                        <td class="p-4 text-gray-300 text-base">
                            {% if draw.customer_name %}
                                <span class="px-2 py-1 bg-blue-500/20 border border-blue-500/40 rounded-lg text-blue-300 text-sm">
                                    <i data-lucide="user" class="inline w-3 h-3 mr-1"></i>{{ draw.customer_name }}
                                </span>
                            {% else %}
                                <span class="text-gray-500 text-sm italic">-</span>
                            {% endif %}
                        </td>
                        <td class="p-4 text-center">
                            <div class="inline-flex items-center gap-2">
                                <div class="w-3 h-3 rounded-full" style="background: {{ closers[draw.closer].color }};"></div>
                                <span class="text-white font-semibold">{{ draw.closer }}</span>
                            </div>
                        </td>
                        <td class="p-4 text-center">
                            {% if draw.probability_after %}
                                <span class="text-t2-purple font-bold text-base">{{ "%.1f"|format(draw.probability_after) }}</span>
                            {% else %}
                                <span class="text-gray-500 text-sm">-</span>
                            {% endif %}
                        </td>
                        <td class="p-4 text-center">
                            <span class="px-2 py-1 bg-green-500/20 border border-green-500/50 text-green-400 rounded-lg text-xs font-semibold">
                                {{ draw.draw_type }}
                            </span>
                        </td>
                        <td class="p-4 text-center text-gray-400 text-sm">
                            {{ draw.timestamp[:19].replace('T', ' ') }}
                        </td>
                        <td class="p-4 text-center text-white font-semibold">
                            {{ draw.bucket_size_after }}
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="7" class="text-center p-8 text-gray-400 text-lg">
                            Noch keine Ziehungen vorhanden
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Back Button -->
    <div class="text-center" data-aos="fade-up" data-aos-delay="600">
        <a href="{{ url_for('t2.dashboard') }}" class="btn btn-primary btn-lg gap-3">
            <i data-lucide="arrow-left" class="w-6 h-6"></i>
            <span class="text-lg">Zurück zum Dashboard</span>
        </a>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function updateProbability(closerName) {
    const inputField = document.getElementById(`prob-${closerName}`);
    const newValue = parseFloat(inputField.value);

    if (isNaN(newValue) || newValue < 0.1) {
        showError('Wahrscheinlichkeit muss mindestens 0.1 sein');
        return;
    }

    if (newValue > 100) {
        showError('Wahrscheinlichkeit kann nicht über 100 liegen');
        return;
    }

    fetch('/t2/api/admin/update-probability', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            closer_name: closerName,
            probability: newValue
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess(`Wahrscheinlichkeit aktualisiert für ${closerName}`);
            setTimeout(() => window.location.reload(), 1000);
        } else {
            showError(data.message || 'Update fehlgeschlagen');
        }
    })
    .catch(error => {
        showError('Fehler beim Aktualisieren der Wahrscheinlichkeit');
    });
}

function resetBucket() {
    if (!confirm('Bist du sicher, dass du den Bucket zurücksetzen möchtest? Dies wird ihn basierend auf aktuellen Wahrscheinlichkeiten neu aufbauen.')) {
        return;
    }

    fetch('/t2/api/admin/reset-bucket', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess('Bucket erfolgreich zurückgesetzt');
            setTimeout(() => window.location.reload(), 1000);
        } else {
            showError(data.message || 'Reset fehlgeschlagen');
        }
    })
    .catch(error => {
        showError('Fehler beim Zurücksetzen des Buckets');
    });
}

function showSuccess(message) {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = 'fixed top-4 right-4 z-50 glass rounded-2xl p-6 max-w-sm transform transition-all duration-300 border-2 border-green-500';
    notification.innerHTML = `
        <div class="flex items-center gap-3">
            <i data-lucide="check-circle" class="w-6 h-6 text-green-500"></i>
            <span class="text-white font-semibold text-lg">${message}</span>
        </div>
    `;
    document.body.appendChild(notification);

    // Re-init Lucide icons
    lucide.createIcons();

    // Remove after 3 seconds
    setTimeout(() => {
        notification.style.opacity = '0';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

function showError(message) {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = 'fixed top-4 right-4 z-50 glass rounded-2xl p-6 max-w-sm transform transition-all duration-300 border-2 border-red-500';
    notification.innerHTML = `
        <div class="flex items-center gap-3">
            <i data-lucide="alert-circle" class="w-6 h-6 text-red-500"></i>
            <span class="text-white font-semibold text-lg">${message}</span>
        </div>
    `;
    document.body.appendChild(notification);

    // Re-init Lucide icons
    lucide.createIcons();

    // Remove after 3 seconds
    setTimeout(() => {
        notification.style.opacity = '0';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

function updateBucketSize() {
    const inputField = document.getElementById('bucket-size-input');
    const newSize = parseInt(inputField.value);

    if (isNaN(newSize) || newSize < 1) {
        showError('Bucket-Größe muss mindestens 1 sein');
        return;
    }

    if (newSize > 100) {
        showError('Bucket-Größe kann nicht über 100 liegen');
        return;
    }

    if (!confirm(`Bist du sicher, dass du die Bucket-Größe auf ${newSize} ändern möchtest? Dies wird den Bucket zurücksetzen.`)) {
        return;
    }

    fetch('/t2/api/admin/update-bucket-size', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            bucket_size: newSize
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess(`Bucket-Größe erfolgreich auf ${newSize} aktualisiert`);
            setTimeout(() => window.location.reload(), 1000);
        } else {
            showError(data.message || 'Update fehlgeschlagen');
        }
    })
    .catch(error => {
        showError('Fehler beim Aktualisieren der Bucket-Größe');
    });
}
</script>
{% endblock %}
